const e="Trystero",t=(e,t)=>Array(e).fill().map(t),r="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",i=e=>t(e,(()=>r[Math.floor(62*Math.random())])).join(""),n=i(20),s=Promise.all.bind(Promise),{entries:a,fromEntries:o,keys:h}=Object,d=()=>{},c=t=>Error(`${e}: ${t}`),l=new TextEncoder,u=new TextDecoder,p=e=>l.encode(e),f=e=>u.decode(e),_=(...e)=>e.join("@"),m=JSON.stringify,g=JSON.parse,y={},b="AES-GCM",w={},C=async e=>{if(w[e])return w[e];const t=Array.from(new Uint8Array(await crypto.subtle.digest("SHA-1",p(e)))).map((e=>e.toString(36))).join("");return w[e]=t,t},S=async(e,t)=>{const r=crypto.getRandomValues(new Uint8Array(16));return r.join(",")+"$"+(i=await crypto.subtle.encrypt({name:b,iv:r},await e,p(t)),btoa(String.fromCharCode.apply(null,new Uint8Array(i))));var i},v=async(e,t)=>{const[r,i]=t.split("$");return f(await crypto.subtle.decrypt({name:b,iv:new Uint8Array(r.split(","))},await e,(e=>{const t=atob(e);return new Uint8Array(t.length).map(((e,r)=>t.charCodeAt(r))).buffer})(i)))};function E(e){return e&&e.__esModule&&{}.hasOwnProperty.call(e,"default")?e.default:e}var x,T,k={exports:{}};function R(){if(T)return x;T=1;var e=1e3,t=60*e,r=60*t,i=24*r,n=7*i,s=365.25*i;function a(e,t,r,i){var n=t>=1.5*r;return Math.round(e/r)+" "+i+(n?"s":"")}return x=(o,h)=>{h=h||{};var d=typeof o;if("string"===d&&o.length>0)return function(a){if((a+="").length>100)return;var o=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(a);if(!o)return;var h=parseFloat(o[1]);switch((o[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return h*s;case"weeks":case"week":case"w":return h*n;case"days":case"day":case"d":return h*i;case"hours":case"hour":case"hrs":case"hr":case"h":return h*r;case"minutes":case"minute":case"mins":case"min":case"m":return h*t;case"seconds":case"second":case"secs":case"sec":case"s":return h*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}(o);if("number"===d&&isFinite(o))return h.long?function(n){var s=Math.abs(n);if(s>=i)return a(n,s,i,"day");if(s>=r)return a(n,s,r,"hour");if(s>=t)return a(n,s,t,"minute");if(s>=e)return a(n,s,e,"second");return n+" ms"}(o):function(n){var s=Math.abs(n);if(s>=i)return Math.round(n/i)+"d";if(s>=r)return Math.round(n/r)+"h";if(s>=t)return Math.round(n/t)+"m";if(s>=e)return Math.round(n/e)+"s";return n+"ms"}(o);throw Error("val is not a non-empty string or a valid number. val="+JSON.stringify(o))}}var A=function(e){function t(e){let i,n,s,a=null;function o(...e){if(!o.enabled)return;const r=o,n=Number(new Date),s=n-(i||n);r.diff=s,r.prev=i,r.curr=n,i=n,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((i,n)=>{if("%%"===i)return"%";a++;const s=t.formatters[n];if("function"==typeof s){const t=e[a];i=s.call(r,t),e.splice(a,1),a--}return i})),t.formatArgs.call(r,e);(r.log||t.log).apply(r,e)}return o.namespace=e,o.useColors=t.useColors(),o.color=t.selectColor(e),o.extend=r,o.destroy=t.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get(){return null!==a?a:(n!==t.namespaces&&(n=t.namespaces,s=t.enabled(e)),s)},set(e){a=e}}),"function"==typeof t.init&&t.init(o),o}function r(e,r){const i=t(this.namespace+(void 0===r?":":r)+e);return i.log=this.log,i}function i(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(i),...t.skips.map(i).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let r;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const i=("string"==typeof e?e:"").split(/[\s,]+/),n=i.length;for(r=0;r<n;r++)i[r]&&("-"===(e=i[r].replace(/\*/g,".*?"))[0]?t.skips.push(RegExp("^"+e.slice(1)+"$")):t.names.push(RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let r,i;for(r=0,i=t.skips.length;r<i;r++)if(t.skips[r].test(e))return!1;for(r=0,i=t.names.length;r<i;r++)if(t.names[r].test(e))return!0;return!1},t.humanize=R(),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((r=>{t[r]=e[r]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.enable(t.load()),t};!function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;t.splice(1,0,r,"color: inherit");let i=0,n=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(i++,"%c"===e&&(n=i))})),t.splice(n,0,r)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=A(t);const{formatters:r}=e.exports;r.j=e=>{try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(k,k.exports);var N=E(k.exports);const L="undefined"!=typeof window?window:self,F=L.RTCPeerConnection||L.mozRTCPeerConnection||L.webkitRTCPeerConnection,P=L.RTCSessionDescription||L.mozRTCSessionDescription||L.webkitRTCSessionDescription,O=L.RTCIceCandidate||L.mozRTCIceCandidate||L.webkitRTCIceCandidate;var I,D={exports:{}},M="object"==typeof Reflect?Reflect:null,j=M&&"function"==typeof M.apply?M.apply:function(e,t,r){return function(){}.apply.call(e,t,r)};I=M&&"function"==typeof M.ownKeys?M.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var U=Number.isNaN||function(e){return e!=e};function q(){q.init.call(this)}D.exports=q,D.exports.once=function(e,t){return new Promise(((r,i)=>{function n(r){e.removeListener(t,s),i(r)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",n),r([].slice.call(arguments))}V(e,t,s,{once:!0}),"error"!==t&&function(e,t,r){"function"==typeof e.on&&V(e,"error",t,r)}(e,n,{once:!0})}))},q.EventEmitter=q,q.prototype._events=void 0,q.prototype._eventsCount=0,q.prototype._maxListeners=void 0;var W=10;function $(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function B(e){return void 0===e._maxListeners?q.defaultMaxListeners:e._maxListeners}function H(e,t,r,i){var n,s,a,o;if($(r),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),a=s[t]),void 0===a)a=s[t]=r,++e._eventsCount;else if("function"==typeof a?a=s[t]=i?[r,a]:[a,r]:i?a.unshift(r):a.push(r),(n=B(e))>0&&a.length>n&&!a.warned){a.warned=!0;var h=Error("Possible EventEmitter memory leak detected. "+a.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");h.name="MaxListenersExceededWarning",h.emitter=e,h.type=t,h.count=a.length,o=h,console&&console.warn&&console.warn(o)}return e}function Y(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function z(e,t,r){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},n=Y.bind(i);return n.listener=r,i.wrapFn=n,n}function J(e,t,r){var i=e._events;if(void 0===i)return[];var n=i[t];return void 0===n?[]:"function"==typeof n?r?[n.listener||n]:[n]:r?function(e){for(var t=Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(n):G(n,n.length)}function K(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function G(e,t){for(var r=Array(t),i=0;i<t;++i)r[i]=e[i];return r}function V(e,t,r,i){if("function"==typeof e.on)i.once?e.once(t,r):e.on(t,r);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function n(s){i.once&&e.removeEventListener(t,n),r(s)}))}}Object.defineProperty(q,"defaultMaxListeners",{enumerable:!0,get(){return W},set(e){if("number"!=typeof e||e<0||U(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");W=e}}),q.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},q.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||U(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},q.prototype.getMaxListeners=function(){return B(this)},q.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var i="error"===e,n=this._events;if(void 0!==n)i=i&&void 0===n.error;else if(!i)return!1;if(i){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var o=n[e];if(void 0===o)return!1;if("function"==typeof o)j(o,this,t);else{var h=o.length,d=G(o,h);for(r=0;r<h;++r)j(d[r],this,t)}return!0},q.prototype.addListener=function(e,t){return H(this,e,t,!1)},q.prototype.on=q.prototype.addListener,q.prototype.prependListener=function(e,t){return H(this,e,t,!0)},q.prototype.once=function(e,t){return $(t),this.on(e,z(this,e,t)),this},q.prototype.prependOnceListener=function(e,t){return $(t),this.prependListener(e,z(this,e,t)),this},q.prototype.removeListener=function(e,t){var r,i,n,s,a;if($(t),void 0===(i=this._events))return this;if(void 0===(r=i[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(n=-1,s=r.length-1;s>=0;s--)if(r[s]===t||r[s].listener===t){a=r[s].listener,n=s;break}if(n<0)return this;0===n?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,n),1===r.length&&(i[e]=r[0]),void 0!==i.removeListener&&this.emit("removeListener",e,a||t)}return this},q.prototype.off=q.prototype.removeListener,q.prototype.removeAllListeners=function(e){var t,r,i;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var n,s=Object.keys(r);for(i=0;i<s.length;++i)"removeListener"!==(n=s[i])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},q.prototype.listeners=function(e){return J(this,e,!0)},q.prototype.rawListeners=function(e){return J(this,e,!1)},q.listenerCount=(e,t)=>"function"==typeof e.listenerCount?e.listenerCount(t):K.call(e,t),q.prototype.listenerCount=K,q.prototype.eventNames=function(){return this._eventsCount>0?I(this._events):[]};var Z=D.exports,X="function"==typeof queueMicrotask?queueMicrotask:e=>Promise.resolve().then(e);const Q=class{constructor(e){if(!(e>0)||e-1&e)throw Error("Max size for a FixedFIFO should be a power of two");this.buffer=Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}clear(){this.top=this.btm=0,this.next=null,this.buffer.fill(void 0)}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}peek(){return this.buffer[this.btm]}isEmpty(){return void 0===this.buffer[this.btm]}};var ee=class{constructor(e){this.decoder=new TextDecoder("utf16le"===e?"utf16-le":e)}decode(e){return this.decoder.decode(e,{stream:!0})}flush(){return this.decoder.decode(new Uint8Array(0))}};const te=ee,re=ee;const{EventEmitter:ie}=Z,ne=Error("Stream was destroyed"),se=X,ae=class{constructor(e){this.hwm=e||16,this.head=new Q(this.hwm),this.tail=this.head,this.length=0}clear(){this.head=this.tail,this.head.clear(),this.length=0}push(e){if(this.length++,!this.head.push(e)){const t=this.head;this.head=t.next=new Q(2*this.head.buffer.length),this.head.push(e)}}shift(){0!==this.length&&this.length--;const e=this.tail.shift();if(void 0===e&&this.tail.next){const e=this.tail.next;return this.tail.next=null,this.tail=e,this.tail.shift()}return e}peek(){const e=this.tail.peek();return void 0===e&&this.tail.next?this.tail.next.peek():e}isEmpty(){return 0===this.length}},oe=class{constructor(e="utf8"){switch(this.encoding=function(e){switch(e=e.toLowerCase()){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:throw Error("Unknown encoding: "+e)}}(e),this.encoding){case"utf8":this.decoder=new re;break;case"utf16le":case"base64":throw Error("Unsupported encoding: "+this.encoding);default:this.decoder=new te(this.encoding)}}push(e){return"string"==typeof e?e:this.decoder.decode(e)}write(e){return this.push(e)}end(e){let t="";return e&&(t=this.push(e)),t+=this.decoder.flush(),t}},he=536870911,de=1^he,ce=2^he,le=64,ue=128,pe=256,fe=1024,_e=2048,me=4096,ge=8192,ye=16384,be=32768,we=131072,Ce=131328,Se=16^he,ve=768^he,Ee=536838143,xe=32^he,Te=536739839,ke=2<<18,Re=4<<18,Ae=8<<18,Ne=16<<18,Le=32<<18,Fe=64<<18,Pe=128<<18,Oe=512<<18,Ie=1024<<18,De=469499903,Me=535822335,je=503316479,Ue=268435455,qe=262160,We=536608751,$e=8404992,Be=14,He=15,Ye=8405006,ze=33587200,Je=33587215,Ke=2359296,Ge=270794767,Ve=Symbol.asyncIterator||Symbol();class Ze{constructor(e,{highWaterMark:t=16384,map:r=null,mapWritable:i,byteLength:n,byteLengthWritable:s}={}){this.stream=e,this.queue=new ae,this.highWaterMark=t,this.buffered=0,this.error=null,this.pipeline=null,this.drains=null,this.byteLength=s||n||_t,this.map=i||r,this.afterWrite=it.bind(this),this.afterUpdateNextTick=at.bind(this)}get ended(){return!!(this.stream._duplexState&Le)}push(e){return null!==this.map&&(e=this.map(e)),this.buffered+=this.byteLength(e),this.queue.push(e),this.buffered<this.highWaterMark?(this.stream._duplexState|=Ae,!0):(this.stream._duplexState|=6291456,!1)}shift(){const e=this.queue.shift();return this.buffered-=this.byteLength(e),0===this.buffered&&(this.stream._duplexState&=534773759),e}end(e){"function"==typeof e?this.stream.once("finish",e):null!=e&&this.push(e),this.stream._duplexState=(this.stream._duplexState|Oe)&Me}autoBatch(e,t){const r=[],i=this.stream;for(r.push(e);(i._duplexState&Ge)===Ke;)r.push(i._writableState.shift());if(i._duplexState&He)return t(null);i._writev(r,t)}update(){const e=this.stream;e._duplexState|=ke;do{for(;(e._duplexState&Ge)===Ae;){const t=this.shift();e._duplexState|=67371008,e._write(t,this.afterWrite)}1310720&e._duplexState||this.updateNonPrimary()}while(!0===this.continueUpdate());e._duplexState&=536346623}updateNonPrimary(){const e=this.stream;if((144965647&e._duplexState)===Oe)return e._duplexState=402653183&e._duplexState|262144,void e._final(tt.bind(this));4!=(e._duplexState&Be)?1==(e._duplexState&Je)&&(e._duplexState=(e._duplexState|qe)&de,e._open(ot.bind(this))):e._duplexState&ze||(e._duplexState|=qe,e._destroy(rt.bind(this)))}continueUpdate(){return!!(this.stream._duplexState&Pe)&&(this.stream._duplexState&=je,!0)}updateCallback(){(35127311&this.stream._duplexState)===Re?this.update():this.updateNextTick()}updateNextTick(){this.stream._duplexState&Pe||(this.stream._duplexState|=Pe,this.stream._duplexState&ke||se(this.afterUpdateNextTick))}}class Xe{constructor(e,{highWaterMark:t=16384,map:r=null,mapReadable:i,byteLength:n,byteLengthReadable:s}={}){this.stream=e,this.queue=new ae,this.highWaterMark=0===t?1:t,this.buffered=0,this.readAhead=t>0,this.error=null,this.pipeline=null,this.byteLength=s||n||_t,this.map=i||r,this.pipeTo=null,this.afterRead=nt.bind(this),this.afterUpdateNextTick=st.bind(this)}get ended(){return!!(this.stream._duplexState&ye)}pipe(e,t){if(null!==this.pipeTo)throw Error("Can only pipe to one destination");if("function"!=typeof t&&(t=null),this.stream._duplexState|=512,this.pipeTo=e,this.pipeline=new Qe(this.stream,e,t),t&&this.stream.on("error",mt),ft(e))e._writableState.pipeline=this.pipeline,t&&e.on("error",mt),e.on("finish",this.pipeline.finished.bind(this.pipeline));else{const t=this.pipeline.done.bind(this.pipeline,e),r=this.pipeline.done.bind(this.pipeline,e,null);e.on("error",t),e.on("close",r),e.on("finish",this.pipeline.finished.bind(this.pipeline))}e.on("drain",et.bind(this)),this.stream.emit("piping",e),e.emit("pipe",this.stream)}push(e){const t=this.stream;return null===e?(this.highWaterMark=0,t._duplexState=536805311&t._duplexState|1024,!1):(null!==this.map&&null===(e=this.map(e))||(this.buffered+=this.byteLength(e),this.queue.push(e),t._duplexState=536805375&t._duplexState|128),this.buffered<this.highWaterMark)}shift(){const e=this.queue.shift();return this.buffered-=this.byteLength(e),0===this.buffered&&(this.stream._duplexState&=536862591),e}unshift(e){const t=[null!==this.map?this.map(e):e];for(;this.buffered>0;)t.push(this.shift());for(let e=0;e<t.length-1;e++){const r=t[e];this.buffered+=this.byteLength(r),this.queue.push(r)}this.push(t[t.length-1])}read(){const e=this.stream;if((16527&e._duplexState)===ue){const t=this.shift();return null!==this.pipeTo&&!1===this.pipeTo.write(t)&&(e._duplexState&=ve),e._duplexState&_e&&e.emit("data",t),t}return!1===this.readAhead&&(e._duplexState|=we,this.updateNextTick()),null}drain(){const e=this.stream;for(;(16527&e._duplexState)===ue&&768&e._duplexState;){const t=this.shift();null!==this.pipeTo&&!1===this.pipeTo.write(t)&&(e._duplexState&=ve),e._duplexState&_e&&e.emit("data",t)}}update(){const e=this.stream;e._duplexState|=32;do{for(this.drain();this.buffered<this.highWaterMark&&(214047&e._duplexState)===we;)e._duplexState|=65552,e._read(this.afterRead),this.drain();4224==(12431&e._duplexState)&&(e._duplexState|=ge,e.emit("readable")),80&e._duplexState||this.updateNonPrimary()}while(!0===this.continueUpdate());e._duplexState&=xe}updateNonPrimary(){const e=this.stream;(1167&e._duplexState)===fe&&(e._duplexState=536869887&e._duplexState|16384,e.emit("end"),(e._duplexState&Ye)===$e&&(e._duplexState|=4),null!==this.pipeTo&&this.pipeTo.end()),4!=(e._duplexState&Be)?1==(e._duplexState&Je)&&(e._duplexState=(e._duplexState|qe)&de,e._open(ot.bind(this))):e._duplexState&ze||(e._duplexState|=qe,e._destroy(rt.bind(this)))}continueUpdate(){return!!(this.stream._duplexState&be)&&(this.stream._duplexState&=Ee,!0)}updateCallback(){(32879&this.stream._duplexState)===le?this.update():this.updateNextTick()}updateNextTick(){this.stream._duplexState&be||(this.stream._duplexState|=be,32&this.stream._duplexState||se(this.afterUpdateNextTick))}}class Qe{constructor(e,t,r){this.from=e,this.to=t,this.afterPipe=r,this.error=null,this.pipeToFinished=!1}finished(){this.pipeToFinished=!0}done(e,t){t&&(this.error=t),e!==this.to||(this.to=null,null===this.from)?e!==this.from||(this.from=null,null===this.to)?(null!==this.afterPipe&&this.afterPipe(this.error),this.to=this.from=this.afterPipe=null):e._duplexState&ye||this.to.destroy(this.error||Error("Readable stream closed before ending")):this.from._duplexState&ye&&this.pipeToFinished||this.from.destroy(this.error||Error("Writable stream closed prematurely"))}}function et(){this.stream._duplexState|=512,this.updateCallback()}function tt(e){const t=this.stream;e&&t.destroy(e),t._duplexState&Be||(t._duplexState|=Le,t.emit("finish")),(t._duplexState&Ye)===$e&&(t._duplexState|=4),t._duplexState&=De,t._duplexState&ke?this.updateNextTick():this.update()}function rt(e){const t=this.stream;e||this.error===ne||(e=this.error),e&&t.emit("error",e),t._duplexState|=8,t.emit("close");const r=t._readableState,i=t._writableState;if(null!==r&&null!==r.pipeline&&r.pipeline.done(t,e),null!==i){for(;null!==i.drains&&i.drains.length>0;)i.drains.shift().resolve(!1);null!==i.pipeline&&i.pipeline.done(t,e)}}function it(e){const t=this.stream;e&&t.destroy(e),t._duplexState&=De,null!==this.drains&&function(e){for(let t=0;t<e.length;t++)0==--e[t].writes&&(e.shift().resolve(!0),t--)}(this.drains),(6553615&t._duplexState)===Ne&&(t._duplexState&=532676607,(t._duplexState&Fe)===Fe&&t.emit("drain")),this.updateCallback()}function nt(e){e&&this.stream.destroy(e),this.stream._duplexState&=Se,!1!==this.readAhead||this.stream._duplexState&pe||(this.stream._duplexState&=Te),this.updateCallback()}function st(){32&this.stream._duplexState||(this.stream._duplexState&=Ee,this.update())}function at(){this.stream._duplexState&ke||(this.stream._duplexState&=je,this.update())}function ot(e){const t=this.stream;e&&t.destroy(e),4&t._duplexState||(17423&t._duplexState||(t._duplexState|=le),142606351&t._duplexState||(t._duplexState|=Re),t.emit("open")),t._duplexState&=We,null!==t._writableState&&t._writableState.updateCallback(),null!==t._readableState&&t._readableState.updateCallback()}function ht(e){null!==this._readableState&&("data"===e&&(this._duplexState|=133376,this._readableState.updateNextTick()),"readable"===e&&(this._duplexState|=me,this._readableState.updateNextTick())),null!==this._writableState&&"drain"===e&&(this._duplexState|=Fe,this._writableState.updateNextTick())}class dt extends ie{constructor(e){super(),this._duplexState=0,this._readableState=null,this._writableState=null,e&&(e.open&&(this._open=e.open),e.destroy&&(this._destroy=e.destroy),e.predestroy&&(this._predestroy=e.predestroy),e.signal&&e.signal.addEventListener("abort",gt.bind(this))),this.on("newListener",ht)}_open(e){e(null)}_destroy(e){e(null)}_predestroy(){}get readable(){return null!==this._readableState||void 0}get writable(){return null!==this._writableState||void 0}get destroyed(){return!!(8&this._duplexState)}get destroying(){return!!(this._duplexState&Be)}destroy(e){this._duplexState&Be||(e||(e=ne),this._duplexState=535822271&this._duplexState|4,null!==this._readableState&&(this._readableState.highWaterMark=0,this._readableState.error=e),null!==this._writableState&&(this._writableState.highWaterMark=0,this._writableState.error=e),this._duplexState|=2,this._predestroy(),this._duplexState&=ce,null!==this._readableState&&this._readableState.updateNextTick(),null!==this._writableState&&this._writableState.updateNextTick())}}class ct extends dt{constructor(e){super(e),this._duplexState|=8519681,this._readableState=new Xe(this,e),e&&(!1===this._readableState.readAhead&&(this._duplexState&=Te),e.read&&(this._read=e.read),e.eagerOpen&&this._readableState.updateNextTick(),e.encoding&&this.setEncoding(e.encoding))}setEncoding(e){const t=new oe(e),r=this._readableState.map||ut;return this._readableState.map=function(e){const i=t.push(e);return""===i?null:r(i)},this}_read(e){e(null)}pipe(e,t){return this._readableState.updateNextTick(),this._readableState.pipe(e,t),e}read(){return this._readableState.updateNextTick(),this._readableState.read()}push(e){return this._readableState.updateNextTick(),this._readableState.push(e)}unshift(e){return this._readableState.updateNextTick(),this._readableState.unshift(e)}resume(){return this._duplexState|=Ce,this._readableState.updateNextTick(),this}pause(){return this._duplexState&=!1===this._readableState.readAhead?536739583:536870655,this}static _fromAsyncIterator(e,t){let r;const i=new ct({...t,read(t){e.next().then(n).then(t.bind(null,null)).catch(t)},predestroy(){r=e.return()},destroy(e){if(!r)return e(null);r.then(e.bind(null,null)).catch(e)}});return i;function n(e){e.done?i.push(null):i.push(e.value)}}static from(e,t){if(ft(r=e)&&r.readable)return e;var r;if(e[Ve])return this._fromAsyncIterator(e[Ve](),t);Array.isArray(e)||(e=void 0===e?[]:[e]);let i=0;return new ct({...t,read(t){this.push(i===e.length?null:e[i++]),t(null)}})}static isBackpressured(e){return!!(17422&e._duplexState)||e._readableState.buffered>=e._readableState.highWaterMark}static isPaused(e){return!(e._duplexState&pe)}[Ve](){const e=this;let t=null,r=null,i=null;return this.on("error",(e=>{t=e})),this.on("readable",(function(){null!==r&&n(e.read())})),this.on("close",(function(){null!==r&&n(null)})),{[Ve](){return this},next:()=>new Promise(((t,s)=>{r=t,i=s;const a=e.read();null!==a?n(a):8&e._duplexState&&n(null)})),return:()=>s(null),throw:e=>s(e)};function n(n){null!==i&&(t?i(t):null!==n||e._duplexState&ye?r({value:n,done:null===n}):i(ne),i=r=null)}function s(t){return e.destroy(t),new Promise(((r,i)=>{if(8&e._duplexState)return r({value:void 0,done:!0});e.once("close",(()=>{t?i(t):r({value:void 0,done:!0})}))}))}}}class lt extends ct{constructor(e){super(e),this._duplexState=1|this._duplexState&we,this._writableState=new Ze(this,e),e&&(e.writev&&(this._writev=e.writev),e.write&&(this._write=e.write),e.final&&(this._final=e.final))}cork(){this._duplexState|=Ie}uncork(){this._duplexState&=Ue,this._writableState.updateNextTick()}_writev(e,t){t(null)}_write(e,t){this._writableState.autoBatch(e,t)}_final(e){e(null)}write(e){return this._writableState.updateNextTick(),this._writableState.push(e)}end(e){return this._writableState.updateNextTick(),this._writableState.end(e),this}}function ut(e){return e}function pt(e){return!!e._readableState||!!e._writableState}function ft(e){return"number"==typeof e._duplexState&&pt(e)}function _t(e){return function(e){return"object"==typeof e&&null!==e&&"number"==typeof e.byteLength}(e)?e.byteLength:1024}function mt(){}function gt(){this.destroy(Error("Stream aborted."))}var yt=lt;function bt(e,t){for(const r in t)Object.defineProperty(e,r,{value:t[r],enumerable:!0,configurable:!0});return e}var wt=E((function(e,t,r){if(!e||"string"==typeof e)throw new TypeError("Please pass an Error to err-code");r||(r={}),"object"==typeof t&&(r=t,t=""),t&&(r.code=t);try{return bt(e,r)}catch(t){r.message=e.message,r.stack=e.stack;const i=()=>{};i.prototype=Object.create(Object.getPrototypeOf(e));return bt(new i,r)}}));const Ct="0123456789abcdef",St=[];for(let e=0;e<256;e++)St[e]=Ct[e>>4&15]+Ct[15&e];const vt=e=>{const t=e.length;let r="",i=0;for(;i<t;)r+=St[e[i++]];return r};for(var Et="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",xt="undefined"==typeof Uint8Array?[]:new Uint8Array(256),Tt=0;Tt<64;Tt++)xt[Et.charCodeAt(Tt)]=Tt;new TextDecoder;const kt=new TextEncoder,Rt="undefined"!=typeof window?window:self,At=Rt.crypto||Rt.msCrypto||{};At.subtle||At.webkitSubtle;const Nt=e=>{const t=new Uint8Array(e);return At.getRandomValues(t)},Lt=N("simple-peer"),Ft=65536;function Pt(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}let Ot=class e extends yt{_pc;constructor(t){if(super(t=Object.assign({allowHalfOpen:!1},t)),this.__objectMode=!!t.objectMode,this._id=vt(Nt(4)).slice(0,7),this._debug("new peer %o",t),this.channelName=t.initiator?t.channelName||vt(Nt(20)):null,this.initiator=t.initiator||!1,this.channelConfig=t.channelConfig||e.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},e.config,t.config),this.offerOptions=t.offerOptions||{},this.answerOptions=t.answerOptions||{},this.sdpTransform=t.sdpTransform||(e=>e),this.trickle=void 0===t.trickle||t.trickle,this.allowHalfTrickle=void 0!==t.allowHalfTrickle&&t.allowHalfTrickle,this.iceCompleteTimeout=t.iceCompleteTimeout||5e3,this._destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,!F)throw"undefined"==typeof window?wt(Error("No WebRTC support: Specify `opts.wrtc` option in this environment"),"ERR_WEBRTC_SUPPORT"):wt(Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new F(this.config)}catch(e){return void this.__destroy(wt(e,"ERR_PC_CONSTRUCTOR"))}this._isReactNativeWebrtc="number"==typeof this._pc._peerConnectionId,this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},"object"==typeof this._pc.peerIdentity&&this._pc.peerIdentity.catch((e=>{this.__destroy(wt(e,"ERR_PC_PEER_IDENTITY"))})),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(e){if(!this._destroying){if(this.destroyed)throw wt(Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}this._debug("signal()"),e.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),e.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(e.transceiverRequest.kind,e.transceiverRequest.init)),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new P(e)).then((()=>{this.destroyed||(this._pendingCandidates.forEach((e=>{this._addIceCandidate(e)})),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())})).catch((e=>{this.__destroy(wt(e,"ERR_SET_REMOTE_DESCRIPTION"))})),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.__destroy(wt(Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(e){const t=new O(e);this._pc.addIceCandidate(t).catch((e=>{!t.address||t.address.endsWith(".local")?console.warn("Ignoring unsupported ICE candidate."):this.__destroy(wt(e,"ERR_ADD_ICE_CANDIDATE"))}))}send(e){if(!this._destroying){if(this.destroyed)throw wt(Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(e)}}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,queueMicrotask((()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1})))}negotiate(){if(!this._destroying){if(this.destroyed)throw wt(Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout((()=>{this._createOffer()}),0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}_final(e){this._readableState.ended||this.push(null),e(null)}__destroy(e){this.end(),this._destroy((()=>{}),e)}_destroy(e,t){this.destroyed||this._destroying||(this._destroying=!0,this._debug("destroying (error: %s)",t&&(t.message||t)),setTimeout((()=>{if(this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,t&&this.emit("error",t),e()}),0))}_setupData(e){if(!e.channel)return this.__destroy(wt(Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=Ft),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=e=>{const t=e.error instanceof Error?e.error:Error(`Datachannel error: ${e.message} ${e.filename}:${e.lineno}:${e.colno}`);this.__destroy(wt(t,"ERR_DATA_CHANNEL"))};let t=!1;this._closingInterval=setInterval((()=>{this._channel&&"closing"===this._channel.readyState?(t&&this._onChannelClose(),t=!0):t=!1}),5e3)}_write(e,t){if(this.destroyed)return t(wt(Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(e)}catch(e){return this.__destroy(wt(e,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>Ft?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=t):t(null)}else this._debug("write before connect"),this._chunk=e,this._cb=t}_onFinish(){if(this.destroyed)return;const e=()=>{setTimeout((()=>this.__destroy()),1e3)};this._connected?e():this.once("connect",e)}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout((()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))}),this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=Pt(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.__destroy(wt(e,"ERR_SET_LOCAL_DESCRIPTION"))}))})).catch((e=>{this.__destroy(wt(e,"ERR_CREATE_OFFER"))}))}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=Pt(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp}),this.initiator||this._requestMissingTransceivers?.()};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.__destroy(wt(e,"ERR_SET_LOCAL_DESCRIPTION"))}))})).catch((e=>{this.__destroy(wt(e,"ERR_CREATE_ANSWER"))}))}_onConnectionStateChange(){this.destroyed||this._destroying||"failed"===this._pc.connectionState&&this.__destroy(wt(Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;const e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",e,t),this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.__destroy(wt(Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),"closed"===e&&this.__destroy(wt(Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(e){const t=e=>("[object Array]"==={}.toString.call(e.values)&&e.values.forEach((t=>{Object.assign(e,t)})),e);0===this._pc.getStats.length||this._isReactNativeWebrtc?this._pc.getStats().then((r=>{const i=[];r.forEach((e=>{i.push(t(e))})),e(null,i)}),(t=>e(t))):this._pc.getStats.length>0?this._pc.getStats((r=>{if(this.destroyed)return;const i=[];r.result().forEach((e=>{const r={};e.names().forEach((t=>{r[t]=e.stat(t)})),r.id=e.id,r.type=e.type,r.timestamp=e.timestamp,i.push(t(r))})),e(null,i)}),(t=>e(t))):e(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{this.destroyed||this._destroying||this.getStats(((t,r)=>{if(this.destroyed||this._destroying)return;t&&(r=[]);const i={},n={},s={};let a=!1;r.forEach((e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(i[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(n[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(s[e.id]=e)}));const o=e=>{a=!0;let t=n[e.localCandidateId];t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let r=i[e.remoteCandidateId];r&&(r.ip||r.address)?(this.remoteAddress=r.ip||r.address,this.remotePort=Number(r.port)):r&&r.ipAddress?(this.remoteAddress=r.ipAddress,this.remotePort=Number(r.portNumber)):"string"==typeof e.googRemoteAddress&&(r=e.googRemoteAddress.split(":"),this.remoteAddress=r[0],this.remotePort=Number(r[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(r.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId&&o(s[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&o(e)})),a||Object.keys(s).length&&!Object.keys(n).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(t){return this.__destroy(wt(t,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');const e=this._cb;this._cb=null,e(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}else setTimeout(e,100)}))};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>Ft||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach((e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0})),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(this.destroyed)return;let t=e.data;var r;t instanceof ArrayBuffer?t=new Uint8Array(t):!1===this.__objectMode&&(r=t,t=kt.encode(r)),this.push(t)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);const e=this._cb;this._cb=null,e(null)}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.__destroy())}_debug(){const e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],Lt.apply(null,e)}};Ot.WEBRTC_SUPPORT=!!F,Ot.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},Ot.channelConfig={};class It extends Ot{constructor(e={}){super(e),this._pc&&(this.streams=e.streams||(e.stream?[e.stream]:[]),this._senderMap=new Map,this.streams&&this.streams.forEach((e=>{this.addStream(e)})),this._pc.ontrack=e=>{this._onTrack(e)})}addTransceiver(e,t){if(!this._destroying){if(this.destroyed)throw wt(Error("cannot addTransceiver after peer is destroyed"),"ERR_DESTROYED");if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(e,t),this._needsNegotiation()}catch(e){this.__destroy(wt(e,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:e,init:t}})}}addStream(e){if(!this._destroying){if(this.destroyed)throw wt(Error("cannot addStream after peer is destroyed"),"ERR_DESTROYED");this._debug("addStream()"),e.getTracks().forEach((t=>{this.addTrack(t,e)}))}}addTrack(e,t){if(this._destroying)return;if(this.destroyed)throw wt(Error("cannot addTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("addTrack()");const r=this._senderMap.get(e)||new Map;let i=r.get(t);if(i)throw i.removed?wt(Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED"):wt(Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED");i=this._pc.addTrack(e,t),r.set(t,i),this._senderMap.set(e,r),this._needsNegotiation()}replaceTrack(e,t,r){if(this._destroying)return;if(this.destroyed)throw wt(Error("cannot replaceTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("replaceTrack()");const i=this._senderMap.get(e),n=i?i.get(r):null;if(!n)throw wt(Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");t&&this._senderMap.set(t,i),null!=n.replaceTrack?n.replaceTrack(t):this.__destroy(wt(Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(e,t){if(this._destroying)return;if(this.destroyed)throw wt(Error("cannot removeTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSender()");const r=this._senderMap.get(e),i=r?r.get(t):null;if(!i)throw wt(Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{i.removed=!0,this._pc.removeTrack(i)}catch(e){"NS_ERROR_UNEXPECTED"===e.name?this._sendersAwaitingStable.push(i):this.__destroy(wt(e,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(e){if(!this._destroying){if(this.destroyed)throw wt(Error("cannot removeStream after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSenders()"),e.getTracks().forEach((t=>{this.removeTrack(t,e)}))}}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach((e=>{e.mid||!e.sender.track||e.requested||(e.requested=!0,this.addTransceiver(e.sender.track.kind))}))}_onTrack(e){this.destroyed||e.streams.forEach((t=>{this._debug("on track"),this.emit("track",e.track,t),this._remoteTracks.push({track:e.track,stream:t}),this._remoteStreams.some((e=>e.id===t.id))||(this._remoteStreams.push(t),queueMicrotask((()=>{this._debug("on stream"),this.emit("stream",t)})))}))}}const Dt="data",Mt="signal";var jt=(e,t)=>{const r=new It({iceServers:[{urls:Ut}],...t,initiator:e,trickle:!1}),i=e=>n.push(e);let n=[];return r.on(Dt,i),{id:r._id,created:Date.now(),connection:r._pc,get channel(){return r._channel},get isDead(){return r.destroyed},signal(t){return new Promise((i=>{e||r.on(Mt,i),r.signal(t)}))},sendData(e){return r.send(e)},destroy(){return r.destroy()},setHandlers(e){return Object.entries(e).forEach((([e,t])=>r.on(e,t)))},offerPromise:e?new Promise((e=>r.on(Mt,e))):Promise.resolve(),addStream(e){return r.addStream(e)},removeStream(e){return r.removeStream(e)},addTrack(e,t){return r.addTrack(e,t)},removeTrack(e,t){return r.removeTrack(e,t)},replaceTrack(e,t,i){return r.replaceTrack(e,t,i)},drainEarlyData(e){r.off(Dt,i),n.forEach(e),n=null}}};const Ut=[...t(5,((e,t)=>`stun:stun${t||""}.l.google.com:19302`)),"stun:global.stun.twilio.com:3478"],qt=Object.getPrototypeOf(Uint8Array),Wt=16369,$t=255,Bt="bufferedamountlow",Ht=e=>"@_"+e;const Yt={},zt={},Jt={},Kt={},Gt={},Vt={},Zt={},Xt={},Qt=async e=>{if(zt[e])return zt[e];const t=(await C(e)).slice(0,20);return zt[e]=t,Jt[t]=e,t},er=async(e,t,r)=>e.send(m({action:"announce",info_hash:await Qt(t),peer_id:n,...r})),tr=(t,r,i)=>console.warn(`${e}: torrent tracker ${i?"failure":"warning"} from ${t} - ${r}`),rr=(({init:r,subscribe:i,announce:l})=>{const u={};let y,w,E,x=!1;return(T,k,R)=>{const{appId:A}=T;if(u[A]?.[k])return u[A][k];const N={},L={},F=_(e,A,k),P=C(F),O=C(_(F,n)),I=T.password&&(async(e,t,r)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},p(`${e}:${t}:${r}`)),{name:b},!1,["encrypt","decrypt"]))(T.password,A,k),D=e=>async t=>I?{type:t.type,sdp:await e(I,t.sdp)}:t,M=D(v),j=D(S),U=()=>jt(!0,T.rtcConfig),q=(e,t,r)=>{L[t]?L[t]!==e&&e.destroy():(L[t]=e,K(e,t),N[t]?.forEach(((e,t)=>{t!==r&&e.destroy()})),delete N[t])},W=(e,t)=>{L[t]===e&&delete L[t]},$=e=>(w.push(...t(e,U)),s(w.splice(0,e).map((e=>e.offerPromise.then(j).then((t=>({peer:e,offer:t}))))))),B=(e,t)=>R?.({error:`incorrect password (${T.password}) when decrypting ${t}`,appId:A,peerId:e,roomId:k}),H=e=>async(t,r,i)=>{const[a,o]=await s([P,O]);if(t!==a&&t!==o)return;const{peerId:h,offer:d,answer:c,peer:l}="string"==typeof r?g(r):r;if(h!==n&&!L[h])if(!h||d||c){if(d){const t=N[h]?.[e];if(t&&n>h)return;const r=jt(!1,T.rtcConfig);let a;r.setHandlers({connect(){return q(r,h,e)},close(){return W(r,h)}});try{a=await M(d)}catch(e){return void B(h,"offer")}if(r.isDead)return;const[o,c]=await s([C(_(F,h)),r.signal(a)]);i(o,m({peerId:n,answer:await j(c)}))}else if(c){let t;try{t=await M(c)}catch(e){return void B(h,"answer")}if(l)l.setHandlers({connect(){return q(l,h,e)},close(){return W(l,h)}}),l.signal(t);else{const r=N[h]?.[e];r&&!r.isDead&&r.signal(t)}}}else{if(N[h]?.[e])return;const[[{peer:t,offer:r}],a]=await s([$(1),C(_(F,h))]);N[h]||=[],N[h][e]=t,setTimeout((()=>((e,t)=>{if(L[e])return;const r=N[e]?.[t];r&&(delete N[e][t],r.destroy())})(h,e)),.9*Y[e]),t.setHandlers({connect(){return q(t,h,e)},close(){return W(t,h)}}),i(a,m({peerId:n,offer:r}))}};if(!T)throw c("requires a config map as the first argument");if(!A&&!T.firebaseApp)throw c("config map is missing appId field");if(!k)throw c("roomId argument required");if(!x){const e=r(T);w=t(20,U),y=Array.isArray(e)?e:[e],x=!0,E=setInterval((()=>w=w.filter((e=>{const t=Date.now()-e.created<57333;return t||e.destroy(),t}))),59052.99)}const Y=y.map((()=>5333)),z=[],J=y.map((async(e,t)=>i(await e,await P,await O,H(t),$)));s([P,O]).then((([e,t])=>{const r=async(i,n)=>{const s=await l(i,e,t);"number"==typeof s&&(Y[n]=s),z[n]=setTimeout((()=>r(i,n)),Y[n])};J.forEach((async(e,t)=>{await e,r(await y[t],t)}))}));let K=d;return u[A]||={},u[A][k]=((r,i,n)=>{const l={},u={},_={},y={},b={},w={},C={onPeerJoin:d,onPeerLeave:d,onPeerStream:d,onPeerTrack:d},S=(t,r)=>(t?Array.isArray(t)?t:[t]:h(l)).flatMap((t=>{const i=l[t];return i?r(t,i):(console.warn(`${e}: no peer with id ${t} found`),[])})),v=e=>{l[e]&&(delete l[e],delete _[e],delete y[e],C.onPeerLeave(e),i(e))},E=e=>{if(u[e])return[u[e].send,u[e].setOnComplete,u[e].setOnProgress];if(!e)throw c("action type argument is required");const r=p(e);if(r.byteLength>12)throw c(`action type string "${e}" (${r.byteLength}b) exceeds byte limit (12). Hint: choose a shorter name.`);const i=new Uint8Array(12);i.set(r);let n=0;return u[e]={onComplete:d,onProgress:d,setOnComplete:t=>u[e]={...u[e],onComplete:t},setOnProgress:t=>u[e]={...u[e],onProgress:t},async send(e,r,a,o){if(a&&"object"!=typeof a)throw c("action meta argument must be an object");const h=typeof e;if("undefined"===h)throw c("action data cannot be undefined");const d="string"!==h,u=e instanceof Blob,f=u||e instanceof ArrayBuffer||e instanceof qt;if(a&&!f)throw c("action meta argument can only be used with binary data");const _=f?new Uint8Array(u?await e.arrayBuffer():e):p(d?m(e):e),g=a?p(m(a)):null,y=Math.ceil(_.byteLength/Wt)+(a?1:0)||1,b=t(y,((e,t)=>{const r=t===y-1,s=a&&0===t,o=new Uint8Array(15+(s?g.byteLength:r?_.byteLength-Wt*(y-(a?2:1)):Wt));return o.set(i),o.set([n],12),o.set([r|s<<1|f<<2|d<<3],13),o.set([Math.round((t+1)/y*$t)],14),o.set(a?s?g:_.subarray((t-1)*Wt,t*Wt):_.subarray(t*Wt,(t+1)*Wt),15),o}));return n=n+1&$t,s(S(r,(async(e,t)=>{const{channel:r}=t;let i=0;for(;i<y;){const n=b[i];if(r.bufferedAmount>r.bufferedAmountLowThreshold&&await new Promise((e=>{const t=()=>{r.removeEventListener(Bt,t),e()};r.addEventListener(Bt,t)})),!l[e])break;t.sendData(n),i++,o?.(n[14]/$t,e,a)}})))}},[u[e].send,u[e].setOnComplete,u[e].setOnProgress]},x=(t,r)=>{const i=new Uint8Array(r),n=f(i.subarray(0,12)).replaceAll("\0",""),[s]=i.subarray(12,13),[a]=i.subarray(13,14),[o]=i.subarray(14,15),h=i.subarray(15),d=!!(1&a),c=!!(2&a),l=!!(4&a),p=!!(8&a);if(!u[n])return void console.warn(`${e}: received message with unregistered type (${n})`);_[t]||={},_[t][n]||={};const m=_[t][n][s]||={chunks:[]};if(c?m.meta=g(f(h)):m.chunks.push(h),u[n].onProgress(o/$t,t,m.meta),!d)return;const y=new Uint8Array(m.chunks.reduce(((e,t)=>e+t.byteLength),0));if(m.chunks.reduce(((e,t)=>(y.set(t,e),e+t.byteLength)),0),delete _[t][n][s],l)u[n].onComplete(y,t,m.meta);else{const e=f(y);u[n].onComplete(p?g(e):e,t)}},[T,k]=E(Ht("ping")),[R,A]=E(Ht("pong")),[N,L]=E(Ht("signal")),[F,P]=E(Ht("stream")),[O,I]=E(Ht("track")),[D,M]=E(Ht("leave"));return r(((e,t)=>{l[t]||(l[t]=e,e.setHandlers({data:e=>x(t,e),stream(e){C.onPeerStream(e,t,b[t]),delete b[t]},track(e,r){C.onPeerTrack(e,r,t,w[t]),delete w[t]},signal:e=>N(e,t),close:()=>v(t),error:()=>v(t)}),C.onPeerJoin(t),e.drainEarlyData?.((e=>x(t,e))))})),k(((e,t)=>R("",t))),A(((e,t)=>{y[t]?.(),delete y[t]})),L(((e,t)=>l[t]?.signal(e))),P(((e,t)=>b[t]=e)),I(((e,t)=>w[t]=e)),M(((e,t)=>v(t))),{makeAction:E,async ping(e){if(!e)throw c("ping() must be called with target peer ID");const t=Date.now();return T("",e),await new Promise((t=>y[e]=t)),Date.now()-t},async leave(){await D(""),await new Promise((e=>setTimeout(e,99))),a(l).forEach((([e,t])=>{t.destroy(),delete l[e]})),n()},getPeers:()=>o(a(l).map((([e,t])=>[e,t.connection]))),addStream:(e,t,r)=>S(t,(async(t,i)=>{r&&await F(r,t),i.addStream(e)})),removeStream:(e,t)=>S(t,((t,r)=>r.removeStream(e))),addTrack:(e,t,r,i)=>S(r,(async(r,n)=>{i&&await O(i,r),n.addTrack(e,t)})),removeTrack:(e,t,r)=>S(r,((r,i)=>i.removeTrack(e,t))),replaceTrack:(e,t,r,i,n)=>S(i,(async(i,s)=>{n&&await O(n,i),s.replaceTrack(e,t,r)})),onPeerJoin:e=>C.onPeerJoin=e,onPeerLeave:e=>C.onPeerLeave=e,onPeerStream:e=>C.onPeerStream=e,onPeerTrack:e=>C.onPeerTrack=e}})((e=>K=e),(e=>delete L[e]),(()=>{delete u[A][k],z.forEach(clearTimeout),J.forEach((async e=>(await e)())),clearInterval(E)}))}})({init(e){return((e,t,r)=>(e.relayUrls||t).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||r))(e,sr,3).map((e=>{const t=((e,t)=>{const r={},i=()=>{const n=new WebSocket(e);n.onclose=()=>{y[e]??=3333,setTimeout(i,y[e]),y[e]*=2},n.onmessage=e=>t(e.data),r.socket=n,r.url=n.url,r.ready=new Promise((t=>n.onopen=()=>{t(r),y[e]=3333})),r.send=e=>{1===n.readyState&&n.send(e)}};return i(),r})(e,(e=>{const t=g(e),i=t["failure reason"],n=t["warning message"],{interval:s}=t,a=Jt[t.info_hash];if(i)tr(r,i,!0);else{if(n&&tr(r,n),s&&1e3*s>Vt[r]&&Gt[r][a]){const e=Math.min(1e3*s,120333);clearInterval(Kt[r][a]),Vt[r]=e,Kt[r][a]=setInterval(Gt[r][a],e)}Zt[t.offer_id]||(t.offer||t.answer)&&(Zt[t.offer_id]=!0,Xt[r][a]?.(t))}})),{url:r}=t;return Yt[r]=t,Xt[r]={},t.ready}))},subscribe(e,t,r,n,s){const{url:h}=e,d=async()=>{const r=o((await s(10)).map((e=>[i(20),e])));Xt[e.url][t]=i=>{if(i.offer)n(t,{offer:i.offer,peerId:i.peer_id},((r,n)=>er(e,t,{answer:g(n).answer,offer_id:i.offer_id,to_peer_id:i.peer_id})));else if(i.answer){const e=r[i.offer_id];e&&n(t,{answer:i.answer,peerId:i.peer_id,peer:e.peer})}},er(e,t,{numwant:10,offers:a(r).map((([e,{offer:t}])=>({offer_id:e,offer:t})))})};return Vt[h]=33333,Gt[h]||={},Gt[h][t]=d,Kt[h]||={},Kt[h][t]=setInterval(d,Vt[h]),d(),()=>{clearInterval(Kt[h][t]),delete Xt[h][t],delete Gt[h][t]}},announce(e){return Vt[e.url]}}),ir=(nr=Yt,()=>o(a(nr).map((([e,t])=>[e,t.socket]))));var nr;const sr=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.files.fm:7073/announce","tracker.btorrent.xyz"].map((e=>"wss://"+e));export{sr as defaultRelayUrls,ir as getRelaySockets,rr as joinRoom,n as selfId};