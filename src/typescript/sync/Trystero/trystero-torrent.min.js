const{floor:e,random:r}=Math,t="Trystero",n=(e,r)=>Array(e).fill().map(r),a="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",o=t=>n(t,(()=>a[e(62*r())])).join(""),s=o(20),i=Promise.all.bind(Promise),c="undefined"!=typeof window,{entries:l,fromEntries:d,keys:f}=Object,p=()=>{},u=e=>Error(`${t}: ${e}`),y=new TextEncoder,m=new TextDecoder,w=e=>y.encode(e),g=e=>m.decode(e),h=(...e)=>e.join("@"),b=JSON.stringify,v=JSON.parse,k={},P="AES-GCM",T={},S=async e=>T[e]||(T[e]=Array.from(new Uint8Array(await crypto.subtle.digest("SHA-1",w(e)))).map((e=>e.toString(36))).join("")),A=async(e,r)=>{const t=crypto.getRandomValues(new Uint8Array(16));return t.join(",")+"$"+(n=await crypto.subtle.encrypt({name:P,iv:t},await e,w(r)),btoa(String.fromCharCode.apply(null,new Uint8Array(n))));var n},D=async(e,r)=>{const[t,n]=r.split("$");return g(await crypto.subtle.decrypt({name:P,iv:new Uint8Array(t.split(","))},await e,(e=>{const r=atob(e);return new Uint8Array(r.length).map(((e,t)=>r.charCodeAt(t))).buffer})(n)))},L="icegatheringstatechange",$=e=>e.replace(/a=ice-options:trickle\s\n/g,"");var E=(e,{rtcConfig:r,rtcPolyfill:t,turnConfig:n})=>{const a=new(t||RTCPeerConnection)({iceServers:I.concat(n||[]),...r}),o={},s=e=>{e.binaryType="arraybuffer",e.bufferedAmountLowThreshold=65535,e.onmessage=e=>o.data?.(e.data),e.onopen=()=>o.connect?.(),e.onclose=()=>o.close?.(),e.onerror=e=>o.error?.(e)},i=async e=>{if(!e.localDescription)throw Error("No local description available");return await Promise.race([new Promise((r=>{const t=()=>{"complete"===e.iceGatheringState&&(e.removeEventListener(L,t),r())};e.addEventListener(L,t),t()})),new Promise((e=>setTimeout(e,5e3)))]),{type:e.localDescription.type,sdp:$(e.localDescription.sdp)}};let c=!1,l=null,d=!1;return e?(l=a.createDataChannel("data"),s(l)):a.ondatachannel=({channel:e})=>{l=e,s(e)},a.onnegotiationneeded=async()=>{try{c=!0,await a.setLocalDescription();const e=await i(a);o.signal?.({type:e.type,sdp:$(e.sdp)})}catch(e){o.error?.(e)}finally{c=!1}},a.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(a.connectionState)&&o.close?.()},a.ontrack=e=>{o.track?.(e.track,e.streams[0]),o.stream?.(e.streams[0])},a.onremovestream=e=>{o.stream?.(e.stream,{removed:!0})},{created:Date.now(),connection:a,get channel(){return l},get isDead(){return"closed"===a.connectionState},async signal(r){if("open"!==l?.readyState)try{if("offer"===r.type){if((c||"stable"!==a.signalingState)&&(d=!e,d))return;await a.setRemoteDescription(r),await a.setLocalDescription();const t=await i(a),n=$(t.sdp);return o.signal?.({type:t.type,sdp:n}),{type:t.type,sdp:n}}"answer"!==r.type||"have-local-offer"!==a.signalingState&&"have-remote-offer"!==a.signalingState||await a.setRemoteDescription(r)}catch(e){o.error?.(e)}else if(("offer"===r.type||"stable"!==a.signalingState)&&(await a.setRemoteDescription(r),"offer"===r.type)){await a.setLocalDescription();const e=await i(a);return o.signal?.({type:e.type,sdp:e.sdp}),{type:e.type,sdp:e.sdp}}},sendData(e){return l.send(e)},destroy(){l&&l.close(),a.close()},setHandlers(e){return Object.assign(o,e)},offerPromise:e?new Promise((e=>{o.signal=r=>{"offer"===r.type&&e(r)}})):Promise.resolve(),addStream(e){e.getTracks().forEach((r=>a.addTrack(r,e)))},removeStream(e){a.getSenders().filter((r=>e.getTracks().includes(r.track))).forEach((e=>a.removeTrack(e)))},addTrack(e,r){return a.addTrack(e,r)},removeTrack(e){const r=a.getSenders().find((r=>r.track===e));r&&a.removeTrack(r)},async replaceTrack(e,r){const t=a.getSenders().find((r=>r.track===e));t&&await t.replaceTrack(r)}}};const I=[...n(3,((e,r)=>`stun:stun${r||""}.l.google.com:19302`)),"stun:global.stun.twilio.com:3478"].map((e=>({urls:e}))),C=Object.getPrototypeOf(Uint8Array),U=16369,_=255,O="bufferedamountlow",j=e=>"@_"+e;const H={},J={},M={},R={},x={},q={},B={},N={},G=async e=>{if(J[e])return J[e];const r=(await S(e)).slice(0,20);return J[e]=r,M[r]=e,r},z=async(e,r,t)=>e.send(b({action:"announce",info_hash:await G(r),peer_id:s,...t})),K=(e,r,n)=>console.warn(`${t}: torrent tracker ${n?"failure":"warning"} from ${e} - ${r}`),V=(({init:e,subscribe:r,announce:a})=>{const o={};let y,m,k,T=!1;return(L,$,I)=>{const{appId:H}=L;if(o[H]?.[$])return o[H][$];const J={},M={},R=h(t,H,$),x=S(R),q=S(h(R,s)),B=(async(e,r,t)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},w(`${e}:${r}:${t}`)),{name:P},!1,["encrypt","decrypt"]))(L.password||"",H,$),N=e=>async r=>({type:r.type,sdp:await e(B,r.sdp)}),G=N(D),z=N(A),K=()=>E(!0,L),V=(e,r,t)=>{M[r]?M[r]!==e&&e.destroy():(M[r]=e,re(e,r),J[r]?.forEach(((e,r)=>{r!==t&&e.destroy()})),delete J[r])},W=(e,r)=>{M[r]===e&&delete M[r]},F=e=>(m.push(...n(e,K)),i(m.splice(0,e).map((e=>e.offerPromise.then(z).then((r=>({peer:e,offer:r}))))))),Q=(e,r)=>I?.({error:`incorrect password (${L.password}) when decrypting ${r}`,appId:H,peerId:e,roomId:$}),X=e=>async(r,t,n)=>{const[a,o]=await i([x,q]);if(r!==a&&r!==o)return;const{peerId:c,offer:l,answer:d,peer:f}="string"==typeof t?v(t):t;if(c!==s&&!M[c])if(!c||l||d){if(l){const r=J[c]?.[e];if(r&&s>c)return;const t=E(!1,L);let a;t.setHandlers({connect(){return V(t,c,e)},close(){return W(t,c)}});try{a=await G(l)}catch{return void Q(c,"offer")}if(t.isDead)return;const[o,d]=await i([S(h(R,c)),t.signal(a)]);n(o,b({peerId:s,answer:await z(d)}))}else if(d){let r;try{r=await G(d)}catch(e){return void Q(c,"answer")}if(f)f.setHandlers({connect(){return V(f,c,e)},close(){return W(f,c)}}),f.signal(r);else{const t=J[c]?.[e];t&&!t.isDead&&t.signal(r)}}}else{if(J[c]?.[e])return;const[[{peer:r,offer:t}],a]=await i([F(1),S(h(R,c))]);J[c]||=[],J[c][e]=r,setTimeout((()=>((e,r)=>{if(M[e])return;const t=J[e]?.[r];t&&(delete J[e][r],t.destroy())})(c,e)),.9*Y[e]),r.setHandlers({connect(){return V(r,c,e)},close(){return W(r,c)}}),n(a,b({peerId:s,offer:t}))}};if(!L)throw u("requires a config map as the first argument");if(!H&&!L.firebaseApp)throw u("config map is missing appId field");if(!$)throw u("roomId argument required");if(!T){const r=e(L);m=n(20,K),y=Array.isArray(r)?r:[r],T=!0,k=setInterval((()=>m=m.filter((e=>{const r=Date.now()-e.created<57333;return r||e.destroy(),r}))),59052.99)}const Y=y.map((()=>5333)),Z=[],ee=y.map((async(e,t)=>r(await e,await x,await q,X(t),F)));i([x,q]).then((([e,r])=>{const t=async(n,o)=>{const s=await a(n,e,r);"number"==typeof s&&(Y[o]=s),Z[o]=setTimeout((()=>t(n,o)),Y[o])};ee.forEach((async(e,r)=>{await e,t(await y[r],r)}))}));let re=p;return o[H]||={},o[H][$]=((e,r,a)=>{const o={},s={},y={},m={},h={},k={},P={},T={onPeerJoin:p,onPeerLeave:p,onPeerStream:p,onPeerTrack:p},S=(e,r)=>(e?Array.isArray(e)?e:[e]:f(o)).flatMap((e=>{const n=o[e];return n?r(e,n):(console.warn(`${t}: no peer with id ${e} found`),[])})),A=e=>{o[e]&&(delete o[e],delete m[e],delete h[e],T.onPeerLeave(e),r(e))},D=e=>{if(s[e])return y[e];if(!e)throw u("action type argument is required");const r=w(e);if(r.byteLength>12)throw u(`action type string "${e}" (${r.byteLength}b) exceeds byte limit (12). Hint: choose a shorter name.`);const t=new Uint8Array(12);t.set(r);let a=0;return s[e]={onComplete:p,onProgress:p,setOnComplete:r=>s[e]={...s[e],onComplete:r},setOnProgress:r=>s[e]={...s[e],onProgress:r},async send(e,r,s,c){if(s&&"object"!=typeof s)throw u("action meta argument must be an object");const l=typeof e;if("undefined"===l)throw u("action data cannot be undefined");const d="string"!==l,f=e instanceof Blob,p=f||e instanceof ArrayBuffer||e instanceof C;if(s&&!p)throw u("action meta argument can only be used with binary data");const y=p?new Uint8Array(f?await e.arrayBuffer():e):w(d?b(e):e),m=s?w(b(s)):null,g=Math.ceil(y.byteLength/U)+(s?1:0)||1,h=n(g,((e,r)=>{const n=r===g-1,o=s&&0===r,i=new Uint8Array(15+(o?m.byteLength:n?y.byteLength-U*(g-(s?2:1)):U));return i.set(t),i.set([a],12),i.set([n|o<<1|p<<2|d<<3],13),i.set([Math.round((r+1)/g*_)],14),i.set(s?o?m:y.subarray((r-1)*U,r*U):y.subarray(r*U,(r+1)*U),15),i}));return a=a+1&_,i(S(r,(async(e,r)=>{const{channel:t}=r;let n=0;for(;n<g;){const a=h[n];if(t.bufferedAmount>t.bufferedAmountLowThreshold&&await new Promise((e=>{const r=()=>{t.removeEventListener(O,r),e()};t.addEventListener(O,r)})),!o[e])break;r.sendData(a),n++,c?.(a[14]/_,e,s)}})))}},y[e]||=[s[e].send,s[e].setOnComplete,s[e].setOnProgress]},L=(e,r)=>{const n=new Uint8Array(r),a=g(n.subarray(0,12)).replaceAll("\0",""),[o]=n.subarray(12,13),[i]=n.subarray(13,14),[c]=n.subarray(14,15),l=n.subarray(15),d=!!(1&i),f=!!(2&i),p=!!(4&i),u=!!(8&i);if(!s[a])return void console.warn(`${t}: received message with unregistered type (${a})`);m[e]||={},m[e][a]||={};const y=m[e][a][o]||={chunks:[]};if(f?y.meta=v(g(l)):y.chunks.push(l),s[a].onProgress(c/_,e,y.meta),!d)return;const w=new Uint8Array(y.chunks.reduce(((e,r)=>e+r.byteLength),0));if(y.chunks.reduce(((e,r)=>(w.set(r,e),e+r.byteLength)),0),delete m[e][a][o],p)s[a].onComplete(w,e,y.meta);else{const r=g(w);s[a].onComplete(u?v(r):r,e)}},$=async()=>{await G(""),await new Promise((e=>setTimeout(e,99))),l(o).forEach((([e,r])=>{r.destroy(),delete o[e]})),a()},[E,I]=D(j("ping")),[H,J]=D(j("pong")),[M,R]=D(j("signal")),[x,q]=D(j("stream")),[B,N]=D(j("track")),[G,z]=D(j("leave"));return e(((e,r)=>{o[r]||(o[r]=e,e.setHandlers({data:e=>L(r,e),stream(e){T.onPeerStream(e,r,k[r]),delete k[r]},track(e,t){T.onPeerTrack(e,t,r,P[r]),delete P[r]},signal:e=>M(e,r),close:()=>A(r),error:()=>A(r)}),T.onPeerJoin(r),e.drainEarlyData?.((e=>L(r,e))))})),I(((e,r)=>H("",r))),J(((e,r)=>{h[r]?.(),delete h[r]})),R(((e,r)=>o[r]?.signal(e))),q(((e,r)=>k[r]=e)),N(((e,r)=>P[r]=e)),z(((e,r)=>A(r))),c&&addEventListener("beforeunload",$),{makeAction:D,leave:$,async ping(e){if(!e)throw u("ping() must be called with target peer ID");const r=Date.now();return E("",e),await new Promise((r=>h[e]=r)),Date.now()-r},getPeers:()=>d(l(o).map((([e,r])=>[e,r.connection]))),addStream:(e,r,t)=>S(r,(async(r,n)=>{t&&await x(t,r),n.addStream(e)})),removeStream:(e,r)=>S(r,((r,t)=>t.removeStream(e))),addTrack:(e,r,t,n)=>S(t,(async(t,a)=>{n&&await B(n,t),a.addTrack(e,r)})),removeTrack:(e,r,t)=>S(t,((t,n)=>n.removeTrack(e,r))),replaceTrack:(e,r,t,n,a)=>S(n,(async(n,o)=>{a&&await B(a,n),o.replaceTrack(e,r,t)})),onPeerJoin:e=>T.onPeerJoin=e,onPeerLeave:e=>T.onPeerLeave=e,onPeerStream:e=>T.onPeerStream=e,onPeerTrack:e=>T.onPeerTrack=e}})((e=>re=e),(e=>delete M[e]),(()=>{delete o[H][$],Z.forEach(clearTimeout),ee.forEach((async e=>(await e)())),clearInterval(k)}))}})({init(e){return((e,r,t)=>(e.relayUrls||r).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||t))(e,Q,3).map((e=>{const r=((e,r)=>{const t={},n=()=>{const a=new WebSocket(e);a.onclose=()=>{k[e]??=3333,setTimeout(n,k[e]),k[e]*=2},a.onmessage=e=>r(e.data),t.socket=a,t.url=a.url,t.ready=new Promise((r=>a.onopen=()=>{r(t),k[e]=3333})),t.send=e=>{1===a.readyState&&a.send(e)}};return n(),t})(e,(e=>{const r=v(e),n=r["failure reason"],a=r["warning message"],{interval:o}=r,s=M[r.info_hash];if(n)K(t,n,!0);else{if(a&&K(t,a),o&&1e3*o>q[t]&&x[t][s]){const e=Math.min(1e3*o,120333);clearInterval(R[t][s]),q[t]=e,R[t][s]=setInterval(x[t][s],e)}B[r.offer_id]||(r.offer||r.answer)&&(B[r.offer_id]=!0,N[t][s]?.(r))}})),{url:t}=r;return H[t]=r,N[t]={},r.ready}))},subscribe(e,r,t,n,a){const{url:s}=e,i=async()=>{const t=d((await a(10)).map((e=>[o(20),e])));N[e.url][r]=a=>{if(a.offer)n(r,{offer:a.offer,peerId:a.peer_id},((t,n)=>z(e,r,{answer:v(n).answer,offer_id:a.offer_id,to_peer_id:a.peer_id})));else if(a.answer){const e=t[a.offer_id];e&&n(r,{answer:a.answer,peerId:a.peer_id,peer:e.peer})}},z(e,r,{numwant:10,offers:l(t).map((([e,{offer:r}])=>({offer_id:e,offer:r})))})};return q[s]=33333,x[s]||={},x[s][r]=i,R[s]||={},R[s][r]=setInterval(i,q[s]),i(),()=>{clearInterval(R[s][r]),delete N[s][r],delete x[s][r]}},announce(e){return q[e.url]}}),W=(F=H,()=>d(l(F).map((([e,r])=>[e,r.socket]))));var F;const Q=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map((e=>"wss://"+e));export{Q as defaultRelayUrls,W as getRelaySockets,V as joinRoom,s as selfId};