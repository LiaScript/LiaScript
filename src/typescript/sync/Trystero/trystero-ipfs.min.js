function e(e=0){return new Uint8Array(e)}function t(e=0){return new Uint8Array(e)}const r=268435456,n=34359738368,s=4398046511104,i=Math.pow(2,49),o=128,a=127;function c(e){if(e<128)return 1;if(e<16384)return 2;if(e<2097152)return 3;if(e<r)return 4;if(e<n)return 5;if(e<s)return 6;if(e<i)return 7;if(null!=Number.MAX_SAFE_INTEGER&&e>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function l(e,t,r=0){switch(c(e)){case 8:t[r++]=255&e|o,e/=128;case 7:t[r++]=255&e|o,e/=128;case 6:t[r++]=255&e|o,e/=128;case 5:t[r++]=255&e|o,e/=128;case 4:t[r++]=255&e|o,e>>>=7;case 3:t[r++]=255&e|o,e>>>=7;case 2:t[r++]=255&e|o,e>>>=7;case 1:t[r++]=255&e,e>>>=7;break;default:throw Error("unreachable")}return t}function u(e,t){let c=e[t],l=0;if(l+=c&a,c<o)return l;if(c=e[t+1],l+=(c&a)<<7,c<o)return l;if(c=e[t+2],l+=(c&a)<<14,c<o)return l;if(c=e[t+3],l+=(c&a)<<21,c<o)return l;if(c=e[t+4],l+=(c&a)*r,c<o)return l;if(c=e[t+5],l+=(c&a)*n,c<o)return l;if(c=e[t+6],l+=(c&a)*s,c<o)return l;if(c=e[t+7],l+=(c&a)*i,c<o)return l;throw new RangeError("Could not decode varint")}function h(e,r,n=0){return null==r&&(r=t(c(e))),r instanceof Uint8Array?l(e,r,n):function(e,t,r=0){switch(c(e)){case 8:t.set(r++,255&e|o),e/=128;case 7:t.set(r++,255&e|o),e/=128;case 6:t.set(r++,255&e|o),e/=128;case 5:t.set(r++,255&e|o),e/=128;case 4:t.set(r++,255&e|o),e>>>=7;case 3:t.set(r++,255&e|o),e>>>=7;case 2:t.set(r++,255&e|o),e>>>=7;case 1:t.set(r++,255&e),e>>>=7;break;default:throw Error("unreachable")}return t}(e,r,n)}function d(e,t=0){return e instanceof Uint8Array?u(e,t):function(e,t){let c=e.get(t),l=0;if(l+=c&a,c<o)return l;if(c=e.get(t+1),l+=(c&a)<<7,c<o)return l;if(c=e.get(t+2),l+=(c&a)<<14,c<o)return l;if(c=e.get(t+3),l+=(c&a)<<21,c<o)return l;if(c=e.get(t+4),l+=(c&a)*r,c<o)return l;if(c=e.get(t+5),l+=(c&a)*n,c<o)return l;if(c=e.get(t+6),l+=(c&a)*s,c<o)return l;if(c=e.get(t+7),l+=(c&a)*i,c<o)return l;throw new RangeError("Could not decode varint")}(e,t)}const p=new Float32Array([-0]),f=new Uint8Array(p.buffer);function g(e,t,r){p[0]=e,t[r]=f[0],t[r+1]=f[1],t[r+2]=f[2],t[r+3]=f[3]}const m=new Float64Array([-0]),y=new Uint8Array(m.buffer);function b(e,t,r){m[0]=e,t[r]=y[0],t[r+1]=y[1],t[r+2]=y[2],t[r+3]=y[3],t[r+4]=y[4],t[r+5]=y[5],t[r+6]=y[6],t[r+7]=y[7]}const w=BigInt(Number.MAX_SAFE_INTEGER),v=BigInt(Number.MIN_SAFE_INTEGER);class E{lo;hi;constructor(e,t){this.lo=0|e,this.hi=0|t}toNumber(e=!1){if(!e&&this.hi>>>31>0){const e=1+~this.lo>>>0;let t=~this.hi>>>0;return 0===e&&(t=t+1>>>0),-(e+4294967296*t)}return this.lo+4294967296*this.hi}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31!=0){const e=1+~this.lo>>>0;let t=~this.hi>>>0;return 0===e&&(t=t+1>>>0),-(BigInt(e)+(BigInt(t)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return 0===r?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:r<128?9:10}static fromBigInt(e){if(0n===e)return S;if(e<w&&e>v)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let r=e>>32n,n=e-(r<<32n);return t&&(r=0n|~r,n=0n|~n,++n>A&&(n=0n,++r>A&&(r=0n))),new E(Number(n),Number(r))}static fromNumber(e){if(0===e)return S;const t=e<0;t&&(e=-e);let r=e>>>0,n=(e-r)/4294967296>>>0;return t&&(n=~n>>>0,r=~r>>>0,++r>4294967295&&(r=0,++n>4294967295&&(n=0))),new E(r,n)}static from(e){return"number"==typeof e?E.fromNumber(e):"bigint"==typeof e?E.fromBigInt(e):"string"==typeof e?E.fromBigInt(BigInt(e)):null!=e.low||null!=e.high?new E(e.low>>>0,e.high>>>0):S}}const S=new E(0,0);S.toBigInt=()=>0n,S.zzEncode=S.zzDecode=function(){return this},S.length=()=>1;const A=4294967296n;function I(e,t,r){const n=r;let s,i;for(let n=0;n<e.length;++n)s=e.charCodeAt(n),s<128?t[r++]=s:s<2048?(t[r++]=s>>6|192,t[r++]=63&s|128):55296==(64512&s)&&56320==(64512&(i=e.charCodeAt(n+1)))?(s=65536+((1023&s)<<10)+(1023&i),++n,t[r++]=s>>18|240,t[r++]=s>>12&63|128,t[r++]=s>>6&63|128,t[r++]=63&s|128):(t[r++]=s>>12|224,t[r++]=s>>6&63|128,t[r++]=63&s|128);return r-n}function _(e,t){return RangeError(`index out of range: ${e.pos} + ${t??1} > ${e.len}`)}function C(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}class x{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return e;if((this.pos+=5)>this.len)throw this.pos=this.len,_(this,10);return e}int32(){return 0|this.uint32()}sint32(){const e=this.uint32();return e>>>1^-(1&e)}bool(){return 0!==this.uint32()}fixed32(){if(this.pos+4>this.len)throw _(this,4);return C(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw _(this,4);return 0|C(this.buf,this.pos+=4)}float(){if(this.pos+4>this.len)throw _(this,4);const e=(t=this.buf,r=this.pos,f[0]=t[r],f[1]=t[r+1],f[2]=t[r+2],f[3]=t[r+3],p[0]);var t,r;return this.pos+=4,e}double(){if(this.pos+8>this.len)throw _(this,4);const e=(t=this.buf,r=this.pos,y[0]=t[r],y[1]=t[r+1],y[2]=t[r+2],y[3]=t[r+3],y[4]=t[r+4],y[5]=t[r+5],y[6]=t[r+6],y[7]=t[r+7],m[0]);var t,r;return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,r=this.pos+e;if(r>this.len)throw _(this,e);return this.pos+=e,t===r?new Uint8Array(0):this.buf.subarray(t,r)}string(){const e=this.bytes();return function(e,t,r){if(r-t<1)return"";let n;const s=[];let i,o=0;for(;t<r;)i=e[t++],i<128?s[o++]=i:i>191&&i<224?s[o++]=(31&i)<<6|63&e[t++]:i>239&&i<365?(i=((7&i)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,s[o++]=55296+(i>>10),s[o++]=56320+(1023&i)):s[o++]=(15&i)<<12|(63&e[t++])<<6|63&e[t++],o>8191&&((n??(n=[])).push(String.fromCharCode.apply(String,s)),o=0);return null!=n?(o>0&&n.push(String.fromCharCode.apply(String,s.slice(0,o))),n.join("")):String.fromCharCode.apply(String,s.slice(0,o))}(e,0,e.length)}skip(e){if("number"==typeof e){if(this.pos+e>this.len)throw _(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw _(this)}while(128&this.buf[this.pos++]);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new E(0,0);let t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw _(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw _(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw _(this,8);const e=C(this.buf,this.pos+=4),t=C(this.buf,this.pos+=4);return new E(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=u(this.buf,this.pos);return this.pos+=c(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function k(e,t,r){const n=function(e){return new x(e instanceof Uint8Array?e:e.subarray())}(e);return t.decode(n,void 0,r)}function T(e){if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw Error("Unknown type, must be binary type")}var P=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var r=new Uint8Array(256),n=0;n<r.length;n++)r[n]=255;for(var s=0;s<e.length;s++){var i=e.charAt(s),o=i.charCodeAt(0);if(255!==r[o])throw new TypeError(i+" is ambiguous");r[o]=s}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var n=0,s=0;e[t]===c;)n++,t++;for(var i=(e.length-t)*l+1>>>0,o=new Uint8Array(i);e[t];){var u=r[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=i-1;(0!==u||h<s)&&-1!==d;d--,h++)u+=a*o[d]>>>0,o[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw Error("Non-zero carry");s=h,t++}if(" "!==e[t]){for(var p=i-s;p!==i&&0===o[p];)p++;for(var f=new Uint8Array(n+(i-p)),g=n;p!==i;)f[g++]=o[p++];return f}}}return{encode(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var r=0,n=0,s=0,i=t.length;s!==i&&0===t[s];)s++,r++;for(var o=(i-s)*u+1>>>0,l=new Uint8Array(o);s!==i;){for(var h=t[s],d=0,p=o-1;(0!==h||d<n)&&-1!==p;p--,d++)h+=256*l[p]>>>0,l[p]=h%a>>>0,h=h/a>>>0;if(0!==h)throw Error("Non-zero carry");n=d,s++}for(var f=o-n;f!==o&&0===l[f];)f++;for(var g=c.repeat(r);f<o;++f)g+=e.charAt(l[f]);return g},decodeUnsafe:h,decode(e){var r=h(e);if(r)return r;throw Error(`Non-${t} character`)}}},R=P;let L=class{name;prefix;baseEncode;constructor(e,t,r){this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},D=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,r){this.name=e,this.prefix=t;const n=t.codePointAt(0);if(void 0===n)throw Error("Invalid prefix character");this.prefixCodePoint=n,this.baseDecode=r}decode(e){if("string"==typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return N(this,e)}};class M{decoders;constructor(e){this.decoders=e}or(e){return N(this,e)}decode(e){const t=e[0],r=this.decoders[t];if(null!=r)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function N(e,t){return new M({...e.decoders??{[e.prefix]:e},...t.decoders??{[t.prefix]:t}})}class O{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,r,n){this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=n,this.encoder=new L(e,t,r),this.decoder=new D(e,t,n)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function U({name:e,prefix:t,encode:r,decode:n}){return new O(e,t,r,n)}function F({name:e,prefix:t,alphabet:r}){const{encode:n,decode:s}=R(r,e);return U({prefix:t,name:e,encode:n,decode(e){return T(s(e))}})}function B({name:e,prefix:t,bitsPerChar:r,alphabet:n}){const s=function(e){const t={};for(let r=0;r<e.length;++r)t[e[r]]=r;return t}(n);return U({prefix:t,name:e,encode:e=>function(e,t,r){const n="="===t[t.length-1],s=(1<<r)-1;let i="",o=0,a=0;for(let n=0;n<e.length;++n)for(a=a<<8|e[n],o+=8;o>r;)o-=r,i+=t[s&a>>o];if(0!==o&&(i+=t[s&a<<r-o]),n)for(;i.length*r&7;)i+="=";return i}(e,n,r),decode:t=>function(e,t,r,n){let s=e.length;for(;"="===e[s-1];)--s;const i=new Uint8Array(s*r/8|0);let o=0,a=0,c=0;for(let l=0;l<s;++l){const s=t[e[l]];if(void 0===s)throw new SyntaxError(`Non-${n} character`);a=a<<r|s,o+=r,o>=8&&(o-=8,i[c++]=255&a>>o)}if(o>=r||255&a<<8-o)throw new SyntaxError("Unexpected end of data");return i}(t,s,r,e)})}const q=F({prefix:"9",name:"base10",alphabet:"0123456789"});var $=Object.freeze({__proto__:null,base10:q});const z=B({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),j=B({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var V=Object.freeze({__proto__:null,base16:z,base16upper:j});const K=B({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var H=Object.freeze({__proto__:null,base2:K});const G=Array.from("ðŸš€ðŸªâ˜„ðŸ›°ðŸŒŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒðŸŒðŸŒŽðŸ‰â˜€ðŸ’»ðŸ–¥ðŸ’¾ðŸ’¿ðŸ˜‚â¤ðŸ˜ðŸ¤£ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ‘ðŸ˜…ðŸ‘ðŸ˜ðŸ”¥ðŸ¥°ðŸ’”ðŸ’–ðŸ’™ðŸ˜¢ðŸ¤”ðŸ˜†ðŸ™„ðŸ’ªðŸ˜‰â˜ºðŸ‘ŒðŸ¤—ðŸ’œðŸ˜”ðŸ˜ŽðŸ˜‡ðŸŒ¹ðŸ¤¦ðŸŽ‰ðŸ’žâœŒâœ¨ðŸ¤·ðŸ˜±ðŸ˜ŒðŸŒ¸ðŸ™ŒðŸ˜‹ðŸ’—ðŸ’šðŸ˜ðŸ’›ðŸ™‚ðŸ’“ðŸ¤©ðŸ˜„ðŸ˜€ðŸ–¤ðŸ˜ƒðŸ’¯ðŸ™ˆðŸ‘‡ðŸŽ¶ðŸ˜’ðŸ¤­â£ðŸ˜œðŸ’‹ðŸ‘€ðŸ˜ªðŸ˜‘ðŸ’¥ðŸ™‹ðŸ˜žðŸ˜©ðŸ˜¡ðŸ¤ªðŸ‘ŠðŸ¥³ðŸ˜¥ðŸ¤¤ðŸ‘‰ðŸ’ƒðŸ˜³âœ‹ðŸ˜šðŸ˜ðŸ˜´ðŸŒŸðŸ˜¬ðŸ™ƒðŸ€ðŸŒ·ðŸ˜»ðŸ˜“â­âœ…ðŸ¥ºðŸŒˆðŸ˜ˆðŸ¤˜ðŸ’¦âœ”ðŸ˜£ðŸƒðŸ’â˜¹ðŸŽŠðŸ’˜ðŸ˜ â˜ðŸ˜•ðŸŒºðŸŽ‚ðŸŒ»ðŸ˜ðŸ–•ðŸ’ðŸ™ŠðŸ˜¹ðŸ—£ðŸ’«ðŸ’€ðŸ‘‘ðŸŽµðŸ¤žðŸ˜›ðŸ”´ðŸ˜¤ðŸŒ¼ðŸ˜«âš½ðŸ¤™â˜•ðŸ†ðŸ¤«ðŸ‘ˆðŸ˜®ðŸ™†ðŸ»ðŸƒðŸ¶ðŸ’ðŸ˜²ðŸŒ¿ðŸ§¡ðŸŽâš¡ðŸŒžðŸŽˆâŒâœŠðŸ‘‹ðŸ˜°ðŸ¤¨ðŸ˜¶ðŸ¤ðŸš¶ðŸ’°ðŸ“ðŸ’¢ðŸ¤ŸðŸ™ðŸš¨ðŸ’¨ðŸ¤¬âœˆðŸŽ€ðŸºðŸ¤“ðŸ˜™ðŸ’ŸðŸŒ±ðŸ˜–ðŸ‘¶ðŸ¥´â–¶âž¡â“ðŸ’ŽðŸ’¸â¬‡ðŸ˜¨ðŸŒšðŸ¦‹ðŸ˜·ðŸ•ºâš ðŸ™…ðŸ˜ŸðŸ˜µðŸ‘ŽðŸ¤²ðŸ¤ ðŸ¤§ðŸ“ŒðŸ”µðŸ’…ðŸ§ðŸ¾ðŸ’ðŸ˜—ðŸ¤‘ðŸŒŠðŸ¤¯ðŸ·â˜ŽðŸ’§ðŸ˜¯ðŸ’†ðŸ‘†ðŸŽ¤ðŸ™‡ðŸ‘â„ðŸŒ´ðŸ’£ðŸ¸ðŸ’ŒðŸ“ðŸ¥€ðŸ¤¢ðŸ‘…ðŸ’¡ðŸ’©ðŸ‘ðŸ“¸ðŸ‘»ðŸ¤ðŸ¤®ðŸŽ¼ðŸ¥µðŸš©ðŸŽðŸŠðŸ‘¼ðŸ’ðŸ“£ðŸ¥‚"),W=G.reduce(((e,t,r)=>(e[r]=t,e)),[]),X=G.reduce(((e,t,r)=>{const n=t.codePointAt(0);if(null==n)throw Error("Invalid character: "+t);return e[n]=r,e}),[]);const Z=U({prefix:"ðŸš€",name:"base256emoji",encode(e){return e.reduce(((e,t)=>e+=W[t]),"")},decode(e){const t=[];for(const r of e){const e=r.codePointAt(0);if(null==e)throw Error("Invalid character: "+r);const n=X[e];if(null==n)throw Error("Non-base256emoji character: "+r);t.push(n)}return new Uint8Array(t)}});var Y=Object.freeze({__proto__:null,base256emoji:Z});const Q=B({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),J=B({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),ee=B({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),te=B({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),re=B({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ne=B({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),se=B({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),ie=B({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),oe=B({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var ae=Object.freeze({__proto__:null,base32:Q,base32hex:re,base32hexpad:se,base32hexpadupper:ie,base32hexupper:ne,base32pad:ee,base32padupper:te,base32upper:J,base32z:oe});const ce=F({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),le=F({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var ue=Object.freeze({__proto__:null,base36:ce,base36upper:le});const he=F({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),de=F({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var pe=Object.freeze({__proto__:null,base58btc:he,base58flickr:de});const fe=B({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),ge=B({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),me=B({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),ye=B({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var be=Object.freeze({__proto__:null,base64:fe,base64pad:ge,base64url:me,base64urlpad:ye});const we=B({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var ve=Object.freeze({__proto__:null,base8:we});const Ee=U({prefix:"\0",name:"identity",encode(e){return t=e,(new TextDecoder).decode(t);var t},decode(e){return function(e){return(new TextEncoder).encode(e)}(e)}});var Se=Object.freeze({__proto__:null,identity:Ee});new TextEncoder,new TextDecoder;var Ae=function e(t,r,n){r=r||[];var s=n=n||0;for(;t>=Ce;)r[n++]=255&t|Ie,t/=128;for(;t&_e;)r[n++]=255&t|Ie,t>>>=7;return r[n]=0|t,e.bytes=n-s+1,r},Ie=128,_e=-128,Ce=2147483648;var xe=function e(t,r){var n,s=0,i=0,o=r=r||0,a=t.length;do{if(o>=a)throw e.bytes=0,new RangeError("Could not decode varint");n=t[o++],s+=i<28?(n&Te)<<i:(n&Te)*Math.pow(2,i),i+=7}while(n>=ke);return e.bytes=o-r,s},ke=128,Te=127;var Pe=Math.pow(2,63),Re={encode:Ae,decode:xe,encodingLength(e){return e<128?1:e<16384?2:e<2097152?3:e<268435456?4:e<34359738368?5:e<4398046511104?6:e<562949953421312?7:e<72057594037927940?8:e<Pe?9:10}};function Le(e,t=0){return[Re.decode(e,t),Re.decode.bytes]}function De(e,t,r=0){return Re.encode(e,t,r),t}function Me(e){return Re.encodingLength(e)}function Ne(e,t){const r=t.byteLength,n=Me(e),s=n+Me(r),i=new Uint8Array(s+r);return De(e,i,0),De(r,i,n),i.set(t,s),new Ue(e,r,t,i)}function Oe(e){const t=T(e),[r,n]=Le(t),[s,i]=Le(t.subarray(n)),o=t.subarray(n+i);if(o.byteLength!==s)throw Error("Incorrect length");return new Ue(r,s,o,t)}class Ue{code;size;digest;bytes;constructor(e,t,r,n){this.code=e,this.size=t,this.digest=r,this.bytes=n}}const Fe=T;const Be={code:0,name:"identity",encode:Fe,digest(e){return Ne(0,Fe(e))}};class qe{name;code;encode;constructor(e,t,r){this.name=e,this.code=t,this.encode=r}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Ne(this.code,t):t.then((e=>Ne(this.code,e)))}throw Error("Unknown type, must be binary type")}}const $e=function({name:e,code:t,encode:r}){return new qe(e,t,r)}({name:"sha2-256",code:18,encode:function(e){return async t=>new Uint8Array(await crypto.subtle.digest(e,t))}("SHA-256")});function ze(e,t){const{bytes:r,version:n}=e;return 0===n?function(e,t,r){const{prefix:n}=r;if(n!==he.prefix)throw Error(`Cannot string encode V0 in ${r.name} encoding`);const s=t.get(n);if(null==s){const s=r.encode(e).slice(1);return t.set(n,s),s}return s}(r,Ve(e),t??he.encoder):function(e,t,r){const{prefix:n}=r,s=t.get(n);if(null==s){const s=r.encode(e);return t.set(n,s),s}return s}(r,Ve(e),t??Q.encoder)}const je=new WeakMap;function Ve(e){const t=je.get(e);if(null==t){const t=new Map;return je.set(e,t),t}return t}class Ke{code;version;multihash;bytes;"/";constructor(e,t,r,n){this.code=t,this.version=e,this.multihash=r,this.bytes=n,this["/"]=n}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==He)throw Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Ge)throw Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ke.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,r=Ne(e,t);return Ke.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Ke.equals(this,e)}static equals(e,t){const r=t;return null!=r&&e.code===r.code&&e.version===r.version&&function(e,t){if(e===t)return!0;{const r=t;return e.code===r.code&&e.size===r.size&&r.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0})(e.bytes,r.bytes)}}(e.multihash,r.multihash)}toString(e){return ze(this,e)}toJSON(){return{"/":ze(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(null==e)return null;const t=e;if(t instanceof Ke)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:r,multihash:n,bytes:s}=t;return new Ke(e,r,n,s??We(e,r,n.bytes))}if(!0===t[Xe]){const{version:e,multihash:r,code:n}=t,s=Oe(r);return Ke.create(e,n,s)}return null}static create(e,t,r){if("number"!=typeof t)throw Error("String codecs are no longer supported");if(!(r.bytes instanceof Uint8Array))throw Error("Invalid digest");switch(e){case 0:if(t!==He)throw Error(`Version 0 CID must use dag-pb (code: ${He}) block encoding`);return new Ke(e,t,r,r.bytes);case 1:{const n=We(e,t,r.bytes);return new Ke(e,t,r,n)}default:throw Error("Invalid version")}}static createV0(e){return Ke.create(0,He,e)}static createV1(e,t){return Ke.create(1,e,t)}static decode(e){const[t,r]=Ke.decodeFirst(e);if(0!==r.length)throw Error("Incorrect length");return t}static decodeFirst(e){const t=Ke.inspectBytes(e),r=t.size-t.multihashSize,n=T(e.subarray(r,r+t.multihashSize));if(n.byteLength!==t.multihashSize)throw Error("Incorrect length");const s=n.subarray(t.multihashSize-t.digestSize),i=new Ue(t.multihashCode,t.digestSize,s,n);return[0===t.version?Ke.createV0(i):Ke.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0;const r=()=>{const[r,n]=Le(e.subarray(t));return t+=n,r};let n=r(),s=He;if(18===n?(n=0,t=0):s=r(),0!==n&&1!==n)throw new RangeError("Invalid CID version "+n);const i=t,o=r(),a=r(),c=t+a;return{version:n,codec:s,multihashCode:o,digestSize:a,multihashSize:c-i,size:c}}static parse(e,t){const[r,n]=function(e,t){switch(e[0]){case"Q":{const r=t??he;return[he.prefix,r.decode(`${he.prefix}${e}`)]}case he.prefix:{const r=t??he;return[he.prefix,r.decode(e)]}case Q.prefix:{const r=t??Q;return[Q.prefix,r.decode(e)]}case ce.prefix:{const r=t??ce;return[ce.prefix,r.decode(e)]}default:if(null==t)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}}(e,t),s=Ke.decode(n);if(0===s.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return Ve(s).set(r,e),s}}const He=112,Ge=18;function We(e,t,r){const n=Me(e),s=n+Me(t),i=new Uint8Array(s+r.byteLength);return De(e,i,0),De(t,i,n),i.set(r,s),i}const Xe=Symbol.for("@ipld/js-cid/CID"),Ze={...Se,...H,...ve,...$,...V,...ae,...ue,...pe,...be,...Y};function Ye(e,t,r,n){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:r},decoder:{decode:n}}}const Qe=Ye("utf8","u",(e=>"u"+new TextDecoder("utf8").decode(e)),(e=>(new TextEncoder).encode(e.substring(1)))),Je=Ye("ascii","a",(e=>{let t="a";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}),(e=>{const r=t((e=e.substring(1)).length);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t);return r})),et={utf8:Qe,"utf-8":Qe,hex:Ze.base16,latin1:Je,ascii:Je,binary:Je,...Ze};function tt(e,t="utf8"){const r=et[t];if(null==r)throw Error(`Unsupported encoding "${t}"`);return r.decoder.decode(`${r.prefix}${e}`)}class rt{fn;len;next;val;constructor(e,t,r){this.fn=e,this.len=t,this.next=void 0,this.val=r}}function nt(){}class st{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const it=function(){const e=8192;let r,n=e;return function(s){if(s<1||s>4096)return t(s);n+s>e&&(r=t(e),n=0);const i=r.subarray(n,n+=s);return 7&n&&(n=1+(7|n)),i}}();class ot{len;head;tail;states;constructor(){this.len=0,this.head=new rt(nt,0,0),this.tail=this.head,this.states=null}_push(e,t,r){return this.tail=this.tail.next=new rt(e,t,r),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new lt((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(ut,10,E.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=E.fromBigInt(e);return this._push(ut,t.length(),t)}uint64Number(e){return this._push(l,c(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=E.fromBigInt(e).zzEncode();return this._push(ut,t.length(),t)}sint64Number(e){const t=E.fromNumber(e).zzEncode();return this._push(ut,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(at,1,e?1:0)}fixed32(e){return this._push(ht,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=E.fromBigInt(e);return this._push(ht,4,t.lo)._push(ht,4,t.hi)}fixed64Number(e){const t=E.fromNumber(e);return this._push(ht,4,t.lo)._push(ht,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(g,4,e)}double(e){return this._push(b,8,e)}bytes(e){const t=e.length>>>0;return 0===t?this._push(at,1,0):this.uint32(t)._push(dt,t,e)}string(e){const t=function(e){let t=0,r=0;for(let n=0;n<e.length;++n)r=e.charCodeAt(n),r<128?t+=1:r<2048?t+=2:55296==(64512&r)&&56320==(64512&e.charCodeAt(n+1))?(++n,t+=4):t+=3;return t}(e);return 0!==t?this.uint32(t)._push(I,t,e):this._push(at,1,0)}fork(){return this.states=new st(this),this.head=this.tail=new rt(nt,0,0),this.len=0,this}reset(){return null!=this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new rt(nt,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,r=this.len;return this.reset().uint32(r),0!==r&&(this.tail.next=e.next,this.tail=t,this.len+=r),this}finish(){let e=this.head.next;const r=(n=this.len,null!=globalThis.Buffer?t(n):it(n));var n;let s=0;for(;null!=e;)e.fn(e.val,r,s),s+=e.len,e=e.next;return r}}function at(e,t,r){t[r]=255&e}function ct(e,t,r){for(;e>127;)t[r++]=127&e|128,e>>>=7;t[r]=e}class lt extends rt{next;constructor(e,t){super(ct,e,t),this.next=void 0}}function ut(e,t,r){for(;0!==e.hi;)t[r++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[r++]=127&e.lo|128,e.lo=e.lo>>>7;t[r++]=e.lo}function ht(e,t,r){t[r]=255&e,t[r+1]=e>>>8&255,t[r+2]=e>>>16&255,t[r+3]=e>>>24}function dt(e,t,r){t.set(e,r)}function pt(e,t,r){t.set(e,r)}function ft(e,t,r){e.length<40?I(e,t,r):null!=t.utf8Write?t.utf8Write(e,r):t.set(tt(e),r)}function gt(e,t){const r=new ot;return t.encode(e,r,{lengthDelimited:!1}),r.finish()}var mt,yt,bt,wt,vt,Et,St,At,It,_t,Ct,xt,kt,Tt,Pt,Rt,Lt,Dt,Mt,Nt,Ot,Ut,Ft,Bt,qt,$t,zt,jt,Vt,Kt,Ht,Gt,Wt,Xt;function Zt(e,t,r,n){return{name:e,type:t,encode:r,decode:n}}function Yt(e){function t(t){if(null==e[t.toString()])throw Error("Invalid enum value");return e[t]}return Zt("enum",mt.VARINT,(function(e,r){const n=t(e);r.int32(n)}),(function(e){return t(e.int32())}))}function Qt(e,t){return Zt("message",mt.LENGTH_DELIMITED,e,t)}null!=globalThis.Buffer&&(ot.prototype.bytes=function(e){const t=e.length>>>0;return this.uint32(t),t>0&&this._push(pt,t,e),this},ot.prototype.string=function(e){const t=globalThis.Buffer.byteLength(e);return this.uint32(t),t>0&&this._push(ft,t,e),this}),(e=>{e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"})(mt||(mt={}));class Jt extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class er extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}function tr(e){return!!e}(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.proof&&e.proof.byteLength>0&&(t.uint32(10),t.bytes(e.proof)),null!=e.merkleRoot&&e.merkleRoot.byteLength>0&&(t.uint32(18),t.bytes(e.merkleRoot)),null!=e.epoch&&e.epoch.byteLength>0&&(t.uint32(26),t.bytes(e.epoch)),null!=e.shareX&&e.shareX.byteLength>0&&(t.uint32(34),t.bytes(e.shareX)),null!=e.shareY&&e.shareY.byteLength>0&&(t.uint32(42),t.bytes(e.shareY)),null!=e.nullifier&&e.nullifier.byteLength>0&&(t.uint32(50),t.bytes(e.nullifier)),null!=e.rlnIdentifier&&e.rlnIdentifier.byteLength>0&&(t.uint32(58),t.bytes(e.rlnIdentifier)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r)=>{const n={proof:e(0),merkleRoot:e(0),epoch:e(0),shareX:e(0),shareY:e(0),nullifier:e(0),rlnIdentifier:e(0)},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const e=t.uint32();switch(e>>>3){case 1:n.proof=t.bytes();break;case 2:n.merkleRoot=t.bytes();break;case 3:n.epoch=t.bytes();break;case 4:n.shareX=t.bytes();break;case 5:n.shareY=t.bytes();break;case 6:n.nullifier=t.bytes();break;case 7:n.rlnIdentifier=t.bytes();break;default:t.skipType(7&e)}}return n}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(yt||(yt={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(10),t.bytes(e.payload)),null!=e.contentTopic&&""!==e.contentTopic&&(t.uint32(18),t.string(e.contentTopic)),null!=e.version&&(t.uint32(24),t.uint32(e.version)),null!=e.timestamp&&(t.uint32(80),t.sint64(e.timestamp)),null!=e.meta&&(t.uint32(90),t.bytes(e.meta)),null!=e.rateLimitProof&&(t.uint32(170),yt.codec().encode(e.rateLimitProof,t)),null!=e.ephemeral&&(t.uint32(248),t.bool(e.ephemeral)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r,n={})=>{const s={payload:e(0),contentTopic:""},i=null==r?t.len:t.pos+r;for(;t.pos<i;){const e=t.uint32();switch(e>>>3){case 1:s.payload=t.bytes();break;case 2:s.contentTopic=t.string();break;case 3:s.version=t.uint32();break;case 10:s.timestamp=t.sint64();break;case 11:s.meta=t.bytes();break;case 21:s.rateLimitProof=yt.codec().decode(t,t.uint32(),{limits:n.limits?.rateLimitProof});break;case 31:s.ephemeral=t.bool();break;default:t.skipType(7&e)}}return s}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(bt||(bt={})),(e=>{let t;(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.contentTopic&&""!==e.contentTopic&&(t.uint32(10),t.string(e.contentTopic)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={contentTopic:""},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();if(t>>>3==1)r.contentTopic=e.string();else e.skipType(7&t)}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(e.ContentFilter||(e.ContentFilter={})),e.codec=()=>(null==t&&(t=Qt(((t,r,n={})=>{if(!1!==n.lengthDelimited&&r.fork(),null!=t.subscribe&&!1!==t.subscribe&&(r.uint32(8),r.bool(t.subscribe)),null!=t.topic&&""!==t.topic&&(r.uint32(18),r.string(t.topic)),null!=t.contentFilters)for(const n of t.contentFilters)r.uint32(26),e.ContentFilter.codec().encode(n,r);!1!==n.lengthDelimited&&r.ldelim()}),((t,r,n={})=>{const s={subscribe:!1,topic:"",contentFilters:[]},i=null==r?t.len:t.pos+r;for(;t.pos<i;){const r=t.uint32();switch(r>>>3){case 1:s.subscribe=t.bool();break;case 2:s.topic=t.string();break;case 3:if(null!=n.limits?.contentFilters&&s.contentFilters.length===n.limits.contentFilters)throw new Jt('Decode error - map field "contentFilters" had too many elements');s.contentFilters.push(e.ContentFilter.codec().decode(t,t.uint32(),{limits:n.limits?.contentFilters$}));break;default:t.skipType(7&r)}}return s}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(wt||(wt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.messages)for(const r of e.messages)t.uint32(10),At.codec().encode(r,t);!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={messages:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();if(t>>>3==1){if(null!=r.limits?.messages&&n.messages.length===r.limits.messages)throw new Jt('Decode error - map field "messages" had too many elements');n.messages.push(At.codec().decode(e,e.uint32(),{limits:r.limits?.messages$}))}else e.skipType(7&t)}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(vt||(vt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.requestId&&""!==e.requestId&&(t.uint32(10),t.string(e.requestId)),null!=e.request&&(t.uint32(18),wt.codec().encode(e.request,t)),null!=e.push&&(t.uint32(26),vt.codec().encode(e.push,t)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={requestId:""},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.requestId=e.string();break;case 2:n.request=wt.codec().decode(e,e.uint32(),{limits:r.limits?.request});break;case 3:n.push=vt.codec().decode(e,e.uint32(),{limits:r.limits?.push});break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Et||(Et={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.proof&&e.proof.byteLength>0&&(t.uint32(10),t.bytes(e.proof)),null!=e.merkleRoot&&e.merkleRoot.byteLength>0&&(t.uint32(18),t.bytes(e.merkleRoot)),null!=e.epoch&&e.epoch.byteLength>0&&(t.uint32(26),t.bytes(e.epoch)),null!=e.shareX&&e.shareX.byteLength>0&&(t.uint32(34),t.bytes(e.shareX)),null!=e.shareY&&e.shareY.byteLength>0&&(t.uint32(42),t.bytes(e.shareY)),null!=e.nullifier&&e.nullifier.byteLength>0&&(t.uint32(50),t.bytes(e.nullifier)),null!=e.rlnIdentifier&&e.rlnIdentifier.byteLength>0&&(t.uint32(58),t.bytes(e.rlnIdentifier)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r)=>{const n={proof:e(0),merkleRoot:e(0),epoch:e(0),shareX:e(0),shareY:e(0),nullifier:e(0),rlnIdentifier:e(0)},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const e=t.uint32();switch(e>>>3){case 1:n.proof=t.bytes();break;case 2:n.merkleRoot=t.bytes();break;case 3:n.epoch=t.bytes();break;case 4:n.shareX=t.bytes();break;case 5:n.shareY=t.bytes();break;case 6:n.nullifier=t.bytes();break;case 7:n.rlnIdentifier=t.bytes();break;default:t.skipType(7&e)}}return n}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(St||(St={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(10),t.bytes(e.payload)),null!=e.contentTopic&&""!==e.contentTopic&&(t.uint32(18),t.string(e.contentTopic)),null!=e.version&&(t.uint32(24),t.uint32(e.version)),null!=e.timestamp&&(t.uint32(80),t.sint64(e.timestamp)),null!=e.meta&&(t.uint32(90),t.bytes(e.meta)),null!=e.rateLimitProof&&(t.uint32(170),St.codec().encode(e.rateLimitProof,t)),null!=e.ephemeral&&(t.uint32(248),t.bool(e.ephemeral)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r,n={})=>{const s={payload:e(0),contentTopic:""},i=null==r?t.len:t.pos+r;for(;t.pos<i;){const e=t.uint32();switch(e>>>3){case 1:s.payload=t.bytes();break;case 2:s.contentTopic=t.string();break;case 3:s.version=t.uint32();break;case 10:s.timestamp=t.sint64();break;case 11:s.meta=t.bytes();break;case 21:s.rateLimitProof=St.codec().decode(t,t.uint32(),{limits:n.limits?.rateLimitProof});break;case 31:s.ephemeral=t.bool();break;default:t.skipType(7&e)}}return s}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(At||(At={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.contentTopic&&""!==e.contentTopic&&(t.uint32(18),t.string(e.contentTopic)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={contentTopic:""},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();if(t>>>3==2)r.contentTopic=e.string();else e.skipType(7&t)}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(It||(It={})),(e=>{let t,r,n;(e=>{e.SUBSCRIBER_PING="SUBSCRIBER_PING",e.SUBSCRIBE="SUBSCRIBE",e.UNSUBSCRIBE="UNSUBSCRIBE",e.UNSUBSCRIBE_ALL="UNSUBSCRIBE_ALL"})(t=e.FilterSubscribeType||(e.FilterSubscribeType={})),(e=>{e[e.SUBSCRIBER_PING=0]="SUBSCRIBER_PING",e[e.SUBSCRIBE=1]="SUBSCRIBE",e[e.UNSUBSCRIBE=2]="UNSUBSCRIBE",e[e.UNSUBSCRIBE_ALL=3]="UNSUBSCRIBE_ALL"})(r||(r={})),(e=>{e.codec=()=>Yt(r)})(t=e.FilterSubscribeType||(e.FilterSubscribeType={})),e.codec=()=>(null==n&&(n=Qt(((t,n,s={})=>{if(!1!==s.lengthDelimited&&n.fork(),null!=t.requestId&&""!==t.requestId&&(n.uint32(10),n.string(t.requestId)),null!=t.filterSubscribeType&&0!==r[t.filterSubscribeType]&&(n.uint32(16),e.FilterSubscribeType.codec().encode(t.filterSubscribeType,n)),null!=t.pubsubTopic&&(n.uint32(82),n.string(t.pubsubTopic)),null!=t.contentTopics)for(const e of t.contentTopics)n.uint32(90),n.string(e);!1!==s.lengthDelimited&&n.ldelim()}),((r,n,s={})=>{const i={requestId:"",filterSubscribeType:t.SUBSCRIBER_PING,contentTopics:[]},o=null==n?r.len:r.pos+n;for(;r.pos<o;){const t=r.uint32();switch(t>>>3){case 1:i.requestId=r.string();break;case 2:i.filterSubscribeType=e.FilterSubscribeType.codec().decode(r);break;case 10:i.pubsubTopic=r.string();break;case 11:if(null!=s.limits?.contentTopics&&i.contentTopics.length===s.limits.contentTopics)throw new Jt('Decode error - map field "contentTopics" had too many elements');i.contentTopics.push(r.string());break;default:r.skipType(7&t)}}return i}))),n),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(_t||(_t={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.requestId&&""!==e.requestId&&(t.uint32(10),t.string(e.requestId)),null!=e.statusCode&&0!==e.statusCode&&(t.uint32(80),t.uint32(e.statusCode)),null!=e.statusDesc&&(t.uint32(90),t.string(e.statusDesc)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={requestId:"",statusCode:0},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.requestId=e.string();break;case 10:r.statusCode=e.uint32();break;case 11:r.statusDesc=e.string();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Ct||(Ct={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.wakuMessage&&(t.uint32(10),Tt.codec().encode(e.wakuMessage,t)),null!=e.pubsubTopic&&(t.uint32(18),t.string(e.pubsubTopic)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.wakuMessage=Tt.codec().decode(e,e.uint32(),{limits:r.limits?.wakuMessage});break;case 2:n.pubsubTopic=e.string();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(xt||(xt={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.proof&&e.proof.byteLength>0&&(t.uint32(10),t.bytes(e.proof)),null!=e.merkleRoot&&e.merkleRoot.byteLength>0&&(t.uint32(18),t.bytes(e.merkleRoot)),null!=e.epoch&&e.epoch.byteLength>0&&(t.uint32(26),t.bytes(e.epoch)),null!=e.shareX&&e.shareX.byteLength>0&&(t.uint32(34),t.bytes(e.shareX)),null!=e.shareY&&e.shareY.byteLength>0&&(t.uint32(42),t.bytes(e.shareY)),null!=e.nullifier&&e.nullifier.byteLength>0&&(t.uint32(50),t.bytes(e.nullifier)),null!=e.rlnIdentifier&&e.rlnIdentifier.byteLength>0&&(t.uint32(58),t.bytes(e.rlnIdentifier)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r)=>{const n={proof:e(0),merkleRoot:e(0),epoch:e(0),shareX:e(0),shareY:e(0),nullifier:e(0),rlnIdentifier:e(0)},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const e=t.uint32();switch(e>>>3){case 1:n.proof=t.bytes();break;case 2:n.merkleRoot=t.bytes();break;case 3:n.epoch=t.bytes();break;case 4:n.shareX=t.bytes();break;case 5:n.shareY=t.bytes();break;case 6:n.nullifier=t.bytes();break;case 7:n.rlnIdentifier=t.bytes();break;default:t.skipType(7&e)}}return n}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(kt||(kt={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(10),t.bytes(e.payload)),null!=e.contentTopic&&""!==e.contentTopic&&(t.uint32(18),t.string(e.contentTopic)),null!=e.version&&(t.uint32(24),t.uint32(e.version)),null!=e.timestamp&&(t.uint32(80),t.sint64(e.timestamp)),null!=e.meta&&(t.uint32(90),t.bytes(e.meta)),null!=e.rateLimitProof&&(t.uint32(170),kt.codec().encode(e.rateLimitProof,t)),null!=e.ephemeral&&(t.uint32(248),t.bool(e.ephemeral)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r,n={})=>{const s={payload:e(0),contentTopic:""},i=null==r?t.len:t.pos+r;for(;t.pos<i;){const e=t.uint32();switch(e>>>3){case 1:s.payload=t.bytes();break;case 2:s.contentTopic=t.string();break;case 3:s.version=t.uint32();break;case 10:s.timestamp=t.sint64();break;case 11:s.meta=t.bytes();break;case 21:s.rateLimitProof=kt.codec().decode(t,t.uint32(),{limits:n.limits?.rateLimitProof});break;case 31:s.ephemeral=t.bool();break;default:t.skipType(7&e)}}return s}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(Tt||(Tt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.pubsubTopic&&""!==e.pubsubTopic&&(t.uint32(10),t.string(e.pubsubTopic)),null!=e.message&&(t.uint32(18),Ot.codec().encode(e.message,t)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={pubsubTopic:""},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.pubsubTopic=e.string();break;case 2:n.message=Ot.codec().decode(e,e.uint32(),{limits:r.limits?.message});break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Pt||(Pt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.isSuccess&&!1!==e.isSuccess&&(t.uint32(8),t.bool(e.isSuccess)),null!=e.info&&(t.uint32(18),t.string(e.info)),null!=e.statusCode&&(t.uint32(80),t.uint32(e.statusCode)),null!=e.statusDesc&&(t.uint32(90),t.string(e.statusDesc)),null!=e.relayPeerCount&&(t.uint32(96),t.uint32(e.relayPeerCount)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={isSuccess:!1},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.isSuccess=e.bool();break;case 2:r.info=e.string();break;case 10:r.statusCode=e.uint32();break;case 11:r.statusDesc=e.string();break;case 12:r.relayPeerCount=e.uint32();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Rt||(Rt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.requestId&&""!==e.requestId&&(t.uint32(10),t.string(e.requestId)),null!=e.request&&(t.uint32(18),Pt.codec().encode(e.request,t)),null!=e.response&&(t.uint32(26),Rt.codec().encode(e.response,t)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={requestId:""},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.requestId=e.string();break;case 2:n.request=Pt.codec().decode(e,e.uint32(),{limits:r.limits?.request});break;case 3:n.response=Rt.codec().decode(e,e.uint32(),{limits:r.limits?.response});break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Lt||(Lt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.requestId&&""!==e.requestId&&(t.uint32(10),t.string(e.requestId)),null!=e.pubsubTopic&&(t.uint32(162),t.string(e.pubsubTopic)),null!=e.message&&(t.uint32(170),Ot.codec().encode(e.message,t)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={requestId:""},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.requestId=e.string();break;case 20:n.pubsubTopic=e.string();break;case 21:n.message=Ot.codec().decode(e,e.uint32(),{limits:r.limits?.message});break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Dt||(Dt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.requestId&&""!==e.requestId&&(t.uint32(10),t.string(e.requestId)),null!=e.statusCode&&0!==e.statusCode&&(t.uint32(80),t.uint32(e.statusCode)),null!=e.statusDesc&&(t.uint32(90),t.string(e.statusDesc)),null!=e.relayPeerCount&&(t.uint32(96),t.uint32(e.relayPeerCount)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={requestId:"",statusCode:0},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.requestId=e.string();break;case 10:r.statusCode=e.uint32();break;case 11:r.statusDesc=e.string();break;case 12:r.relayPeerCount=e.uint32();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Mt||(Mt={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.proof&&e.proof.byteLength>0&&(t.uint32(10),t.bytes(e.proof)),null!=e.merkleRoot&&e.merkleRoot.byteLength>0&&(t.uint32(18),t.bytes(e.merkleRoot)),null!=e.epoch&&e.epoch.byteLength>0&&(t.uint32(26),t.bytes(e.epoch)),null!=e.shareX&&e.shareX.byteLength>0&&(t.uint32(34),t.bytes(e.shareX)),null!=e.shareY&&e.shareY.byteLength>0&&(t.uint32(42),t.bytes(e.shareY)),null!=e.nullifier&&e.nullifier.byteLength>0&&(t.uint32(50),t.bytes(e.nullifier)),null!=e.rlnIdentifier&&e.rlnIdentifier.byteLength>0&&(t.uint32(58),t.bytes(e.rlnIdentifier)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r)=>{const n={proof:e(0),merkleRoot:e(0),epoch:e(0),shareX:e(0),shareY:e(0),nullifier:e(0),rlnIdentifier:e(0)},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const e=t.uint32();switch(e>>>3){case 1:n.proof=t.bytes();break;case 2:n.merkleRoot=t.bytes();break;case 3:n.epoch=t.bytes();break;case 4:n.shareX=t.bytes();break;case 5:n.shareY=t.bytes();break;case 6:n.nullifier=t.bytes();break;case 7:n.rlnIdentifier=t.bytes();break;default:t.skipType(7&e)}}return n}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(Nt||(Nt={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(10),t.bytes(e.payload)),null!=e.contentTopic&&""!==e.contentTopic&&(t.uint32(18),t.string(e.contentTopic)),null!=e.version&&(t.uint32(24),t.uint32(e.version)),null!=e.timestamp&&(t.uint32(80),t.sint64(e.timestamp)),null!=e.meta&&(t.uint32(90),t.bytes(e.meta)),null!=e.rateLimitProof&&(t.uint32(170),Nt.codec().encode(e.rateLimitProof,t)),null!=e.ephemeral&&(t.uint32(248),t.bool(e.ephemeral)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r,n={})=>{const s={payload:e(0),contentTopic:""},i=null==r?t.len:t.pos+r;for(;t.pos<i;){const e=t.uint32();switch(e>>>3){case 1:s.payload=t.bytes();break;case 2:s.contentTopic=t.string();break;case 3:s.version=t.uint32();break;case 10:s.timestamp=t.sint64();break;case 11:s.meta=t.bytes();break;case 21:s.rateLimitProof=Nt.codec().decode(t,t.uint32(),{limits:n.limits?.rateLimitProof});break;case 31:s.ephemeral=t.bool();break;default:t.skipType(7&e)}}return s}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(Ot||(Ot={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.messageHash&&(t.uint32(10),t.bytes(e.messageHash)),null!=e.message&&(t.uint32(18),$t.codec().encode(e.message,t)),null!=e.pubsubTopic&&(t.uint32(26),t.string(e.pubsubTopic)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.messageHash=e.bytes();break;case 2:n.message=$t.codec().decode(e,e.uint32(),{limits:r.limits?.message});break;case 3:n.pubsubTopic=e.string();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Ut||(Ut={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.requestId&&""!==e.requestId&&(t.uint32(10),t.string(e.requestId)),null!=e.includeData&&!1!==e.includeData&&(t.uint32(16),t.bool(e.includeData)),null!=e.pubsubTopic&&(t.uint32(82),t.string(e.pubsubTopic)),null!=e.contentTopics)for(const r of e.contentTopics)t.uint32(90),t.string(r);if(null!=e.timeStart&&(t.uint32(96),t.sint64(e.timeStart)),null!=e.timeEnd&&(t.uint32(104),t.sint64(e.timeEnd)),null!=e.messageHashes)for(const r of e.messageHashes)t.uint32(162),t.bytes(r);null!=e.paginationCursor&&(t.uint32(410),t.bytes(e.paginationCursor)),null!=e.paginationForward&&!1!==e.paginationForward&&(t.uint32(416),t.bool(e.paginationForward)),null!=e.paginationLimit&&(t.uint32(424),t.uint64(e.paginationLimit)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={requestId:"",includeData:!1,contentTopics:[],messageHashes:[],paginationForward:!1},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.requestId=e.string();break;case 2:n.includeData=e.bool();break;case 10:n.pubsubTopic=e.string();break;case 11:if(null!=r.limits?.contentTopics&&n.contentTopics.length===r.limits.contentTopics)throw new Jt('Decode error - map field "contentTopics" had too many elements');n.contentTopics.push(e.string());break;case 12:n.timeStart=e.sint64();break;case 13:n.timeEnd=e.sint64();break;case 20:if(null!=r.limits?.messageHashes&&n.messageHashes.length===r.limits.messageHashes)throw new Jt('Decode error - map field "messageHashes" had too many elements');n.messageHashes.push(e.bytes());break;case 51:n.paginationCursor=e.bytes();break;case 52:n.paginationForward=e.bool();break;case 53:n.paginationLimit=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Ft||(Ft={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.requestId&&""!==e.requestId&&(t.uint32(10),t.string(e.requestId)),null!=e.statusCode&&(t.uint32(80),t.uint32(e.statusCode)),null!=e.statusDesc&&(t.uint32(90),t.string(e.statusDesc)),null!=e.messages)for(const r of e.messages)t.uint32(162),Ut.codec().encode(r,t);null!=e.paginationCursor&&(t.uint32(410),t.bytes(e.paginationCursor)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={requestId:"",messages:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.requestId=e.string();break;case 10:n.statusCode=e.uint32();break;case 11:n.statusDesc=e.string();break;case 20:if(null!=r.limits?.messages&&n.messages.length===r.limits.messages)throw new Jt('Decode error - map field "messages" had too many elements');n.messages.push(Ut.codec().decode(e,e.uint32(),{limits:r.limits?.messages$}));break;case 51:n.paginationCursor=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Bt||(Bt={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.proof&&e.proof.byteLength>0&&(t.uint32(10),t.bytes(e.proof)),null!=e.merkleRoot&&e.merkleRoot.byteLength>0&&(t.uint32(18),t.bytes(e.merkleRoot)),null!=e.epoch&&e.epoch.byteLength>0&&(t.uint32(26),t.bytes(e.epoch)),null!=e.shareX&&e.shareX.byteLength>0&&(t.uint32(34),t.bytes(e.shareX)),null!=e.shareY&&e.shareY.byteLength>0&&(t.uint32(42),t.bytes(e.shareY)),null!=e.nullifier&&e.nullifier.byteLength>0&&(t.uint32(50),t.bytes(e.nullifier)),null!=e.rlnIdentifier&&e.rlnIdentifier.byteLength>0&&(t.uint32(58),t.bytes(e.rlnIdentifier)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r)=>{const n={proof:e(0),merkleRoot:e(0),epoch:e(0),shareX:e(0),shareY:e(0),nullifier:e(0),rlnIdentifier:e(0)},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const e=t.uint32();switch(e>>>3){case 1:n.proof=t.bytes();break;case 2:n.merkleRoot=t.bytes();break;case 3:n.epoch=t.bytes();break;case 4:n.shareX=t.bytes();break;case 5:n.shareY=t.bytes();break;case 6:n.nullifier=t.bytes();break;case 7:n.rlnIdentifier=t.bytes();break;default:t.skipType(7&e)}}return n}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(qt||(qt={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(10),t.bytes(e.payload)),null!=e.contentTopic&&""!==e.contentTopic&&(t.uint32(18),t.string(e.contentTopic)),null!=e.version&&(t.uint32(24),t.uint32(e.version)),null!=e.timestamp&&(t.uint32(80),t.sint64(e.timestamp)),null!=e.meta&&(t.uint32(90),t.bytes(e.meta)),null!=e.rateLimitProof&&(t.uint32(170),qt.codec().encode(e.rateLimitProof,t)),null!=e.ephemeral&&(t.uint32(248),t.bool(e.ephemeral)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r,n={})=>{const s={payload:e(0),contentTopic:""},i=null==r?t.len:t.pos+r;for(;t.pos<i;){const e=t.uint32();switch(e>>>3){case 1:s.payload=t.bytes();break;case 2:s.contentTopic=t.string();break;case 3:s.version=t.uint32();break;case 10:s.timestamp=t.sint64();break;case 11:s.meta=t.bytes();break;case 21:s.rateLimitProof=qt.codec().decode(t,t.uint32(),{limits:n.limits?.rateLimitProof});break;case 31:s.ephemeral=t.bool();break;default:t.skipType(7&e)}}return s}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})($t||($t={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.enr&&(t.uint32(10),t.bytes(e.enr)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();if(t>>>3==1)r.enr=e.bytes();else e.skipType(7&t)}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(zt||(zt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.numPeers&&(t.uint32(8),t.uint64(e.numPeers)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();if(t>>>3==1)r.numPeers=e.uint64();else e.skipType(7&t)}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(jt||(jt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.peerInfos)for(const r of e.peerInfos)t.uint32(10),zt.codec().encode(r,t);!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={peerInfos:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();if(t>>>3==1){if(null!=r.limits?.peerInfos&&n.peerInfos.length===r.limits.peerInfos)throw new Jt('Decode error - map field "peerInfos" had too many elements');n.peerInfos.push(zt.codec().decode(e,e.uint32(),{limits:r.limits?.peerInfos$}))}else e.skipType(7&t)}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Vt||(Vt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.query&&(t.uint32(10),jt.codec().encode(e.query,t)),null!=e.response&&(t.uint32(18),Vt.codec().encode(e.response,t)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.query=jt.codec().decode(e,e.uint32(),{limits:r.limits?.query});break;case 2:n.response=Vt.codec().decode(e,e.uint32(),{limits:r.limits?.response});break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Kt||(Kt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.clusterId&&(t.uint32(8),t.uint32(e.clusterId)),null!=e.shards)for(const r of e.shards)t.uint32(16),t.uint32(r);!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={shards:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.clusterId=e.uint32();break;case 2:if(null!=r.limits?.shards&&n.shards.length===r.limits.shards)throw new Jt('Decode error - map field "shards" had too many elements');n.shards.push(e.uint32());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Ht||(Ht={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.clusterId&&(t.uint32(8),t.uint32(e.clusterId)),null!=e.shards)for(const r of e.shards)t.uint32(16),t.uint32(r);!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={shards:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.clusterId=e.uint32();break;case 2:if(null!=r.limits?.shards&&n.shards.length===r.limits.shards)throw new Jt('Decode error - map field "shards" had too many elements');n.shards.push(e.uint32());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Gt||(Gt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.messageId&&""!==e.messageId&&(t.uint32(10),t.string(e.messageId)),null!=e.retrievalHint&&(t.uint32(18),t.bytes(e.retrievalHint)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={messageId:""},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.messageId=e.string();break;case 2:r.retrievalHint=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Wt||(Wt={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.senderId&&""!==e.senderId&&(t.uint32(10),t.string(e.senderId)),null!=e.messageId&&""!==e.messageId&&(t.uint32(18),t.string(e.messageId)),null!=e.channelId&&""!==e.channelId&&(t.uint32(26),t.string(e.channelId)),null!=e.lamportTimestamp&&(t.uint32(80),t.int32(e.lamportTimestamp)),null!=e.causalHistory)for(const r of e.causalHistory)t.uint32(90),Wt.codec().encode(r,t);null!=e.bloomFilter&&(t.uint32(98),t.bytes(e.bloomFilter)),null!=e.content&&(t.uint32(162),t.bytes(e.content)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={senderId:"",messageId:"",channelId:"",causalHistory:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.senderId=e.string();break;case 2:n.messageId=e.string();break;case 3:n.channelId=e.string();break;case 10:n.lamportTimestamp=e.int32();break;case 11:if(null!=r.limits?.causalHistory&&n.causalHistory.length===r.limits.causalHistory)throw new Jt('Decode error - map field "causalHistory" had too many elements');n.causalHistory.push(Wt.codec().decode(e,e.uint32(),{limits:r.limits?.causalHistory$}));break;case 12:n.bloomFilter=e.bytes();break;case 20:n.content=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(Xt||(Xt={}));const rr=e=>e.length/1048576<=1;const nr="object"==typeof globalThis&&"crypto"in globalThis?globalThis.crypto:void 0;function sr(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&"Uint8Array"===e.constructor.name}function ir(e){if(!Number.isSafeInteger(e)||e<0)throw Error("positive integer expected, got "+e)}function or(e,...t){if(!sr(e))throw Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw Error("Uint8Array expected of length "+t+", got length="+e.length)}function ar(e){if("function"!=typeof e||"function"!=typeof e.create)throw Error("Hash should be wrapped by utils.createHasher");ir(e.outputLen),ir(e.blockLen)}function cr(e,t=!0){if(e.destroyed)throw Error("Hash instance has been destroyed");if(t&&e.finished)throw Error("Hash#digest() has already been called")}function lr(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function ur(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function hr(e,t){return e<<32-t|e>>>t}const dr=(()=>"function"==typeof Uint8Array.from([]).toHex&&"function"==typeof Uint8Array.fromHex)(),pr=Array.from({length:256},((e,t)=>t.toString(16).padStart(2,"0")));function fr(e){if(or(e),dr)return e.toHex();let t="";for(let r=0;r<e.length;r++)t+=pr[e[r]];return t}const gr=48,mr=57,yr=65,br=70,wr=97,vr=102;function Er(e){return e>=gr&&e<=mr?e-gr:e>=yr&&e<=br?e-(yr-10):e>=wr&&e<=vr?e-(wr-10):void 0}function Sr(e){if("string"!=typeof e)throw Error("hex string expected, got "+typeof e);if(dr)return Uint8Array.fromHex(e);const t=e.length,r=t/2;if(t%2)throw Error("hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(r);for(let t=0,s=0;t<r;t++,s+=2){const r=Er(e.charCodeAt(s)),i=Er(e.charCodeAt(s+1));if(void 0===r||void 0===i){const t=e[s]+e[s+1];throw Error('hex string expected, got non-hex character "'+t+'" at index '+s)}n[t]=16*r+i}return n}function Ar(e){return"string"==typeof e&&(e=function(e){if("string"!=typeof e)throw Error("string expected");return new Uint8Array((new TextEncoder).encode(e))}(e)),or(e),e}function Ir(...e){let t=0;for(let r=0;r<e.length;r++){const n=e[r];or(n),t+=n.length}const r=new Uint8Array(t);for(let t=0,n=0;t<e.length;t++){const s=e[t];r.set(s,n),n+=s.length}return r}class _r{}function Cr(e){const t=t=>e().update(Ar(t)).digest(),r=e();return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=()=>e(),t}function xr(e=32){if(nr&&"function"==typeof nr.getRandomValues)return nr.getRandomValues(new Uint8Array(e));if(nr&&"function"==typeof nr.randomBytes)return Uint8Array.from(nr.randomBytes(e));throw Error("crypto.getRandomValues must be defined")}function kr(e,t,r){return e&t^e&r^t&r}class Tr extends _r{constructor(e,t,r,n){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=r,this.isLE=n,this.buffer=new Uint8Array(e),this.view=ur(this.buffer)}update(e){cr(this),or(e=Ar(e));const{view:t,buffer:r,blockLen:n}=this,s=e.length;for(let i=0;i<s;){const o=Math.min(n-this.pos,s-i);if(o!==n)r.set(e.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===n&&(this.process(t,0),this.pos=0);else{const t=ur(e);for(;n<=s-i;i+=n)this.process(t,i)}}return this.length+=e.length,this.roundClean(),this}digestInto(e){cr(this),function(e,t){or(e);const r=t.outputLen;if(e.length<r)throw Error("digestInto() expects output buffer of length at least "+r)}(e,this),this.finished=!0;const{buffer:t,view:r,blockLen:n,isLE:s}=this;let{pos:i}=this;t[i++]=128,lr(this.buffer.subarray(i)),this.padOffset>n-i&&(this.process(r,0),i=0);for(let e=i;e<n;e++)t[e]=0;!function(e,t,r,n){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,r,n);const s=BigInt(32),i=BigInt(4294967295),o=Number(r>>s&i),a=Number(r&i),c=n?4:0,l=n?0:4;e.setUint32(t+c,o,n),e.setUint32(t+l,a,n)}(r,n-8,BigInt(8*this.length),s),this.process(r,0);const o=ur(e),a=this.outputLen;if(a%4)throw Error("_sha2: outputLen should be aligned to 32bit");const c=a/4,l=this.get();if(c>l.length)throw Error("_sha2: outputLen bigger than state");for(let e=0;e<c;e++)o.setUint32(4*e,l[e],s)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:r,length:n,finished:s,destroyed:i,pos:o}=this;return e.destroyed=i,e.finished=s,e.length=n,e.pos=o,n%t&&e.buffer.set(r),e}clone(){return this._cloneInto()}}const Pr=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Rr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Lr=BigInt(2**32-1),Dr=BigInt(32);function Mr(e,t=!1){return t?{h:Number(e&Lr),l:Number(e>>Dr&Lr)}:{h:0|Number(e>>Dr&Lr),l:0|Number(e&Lr)}}const Nr=(e,t,r)=>e>>>r,Or=(e,t,r)=>e<<32-r|t>>>r,Ur=(e,t,r)=>e>>>r|t<<32-r,Fr=(e,t,r)=>e<<32-r|t>>>r,Br=(e,t,r)=>e<<64-r|t>>>r-32,qr=(e,t,r)=>e>>>r-32|t<<64-r;function $r(e,t,r,n){const s=(t>>>0)+(n>>>0);return{h:e+r+(s/2**32|0)|0,l:0|s}}const zr=(e,t,r)=>(e>>>0)+(t>>>0)+(r>>>0),jr=(e,t,r,n)=>t+r+n+(e/2**32|0)|0,Vr=(e,t,r,n)=>(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0),Kr=(e,t,r,n,s)=>t+r+n+s+(e/2**32|0)|0,Hr=(e,t,r,n,s)=>(e>>>0)+(t>>>0)+(r>>>0)+(n>>>0)+(s>>>0),Gr=(e,t,r,n,s,i)=>t+r+n+s+i+(e/2**32|0)|0,Wr=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Xr=new Uint32Array(64);class Zr extends Tr{constructor(e=32){super(64,e,8,!1),this.A=0|Pr[0],this.B=0|Pr[1],this.C=0|Pr[2],this.D=0|Pr[3],this.E=0|Pr[4],this.F=0|Pr[5],this.G=0|Pr[6],this.H=0|Pr[7]}get(){const{A:e,B:t,C:r,D:n,E:s,F:i,G:o,H:a}=this;return[e,t,r,n,s,i,o,a]}set(e,t,r,n,s,i,o,a){this.A=0|e,this.B=0|t,this.C=0|r,this.D=0|n,this.E=0|s,this.F=0|i,this.G=0|o,this.H=0|a}process(e,t){for(let r=0;r<16;r++,t+=4)Xr[r]=e.getUint32(t,!1);for(let e=16;e<64;e++){const t=Xr[e-15],r=Xr[e-2],n=hr(t,7)^hr(t,18)^t>>>3,s=hr(r,17)^hr(r,19)^r>>>10;Xr[e]=s+Xr[e-7]+n+Xr[e-16]|0}let{A:r,B:n,C:s,D:i,E:o,F:a,G:c,H:l}=this;for(let e=0;e<64;e++){const t=l+(hr(o,6)^hr(o,11)^hr(o,25))+((u=o)&a^~u&c)+Wr[e]+Xr[e]|0,h=(hr(r,2)^hr(r,13)^hr(r,22))+kr(r,n,s)|0;l=c,c=a,a=o,o=i+t|0,i=s,s=n,n=r,r=t+h|0}var u;r=r+this.A|0,n=n+this.B|0,s=s+this.C|0,i=i+this.D|0,o=o+this.E|0,a=a+this.F|0,c=c+this.G|0,l=l+this.H|0,this.set(r,n,s,i,o,a,c,l)}roundClean(){lr(Xr)}destroy(){this.set(0,0,0,0,0,0,0,0),lr(this.buffer)}}const Yr=(()=>function(e,t=!1){const r=e.length;let n=new Uint32Array(r),s=new Uint32Array(r);for(let i=0;i<r;i++){const{h:r,l:o}=Mr(e[i],t);[n[i],s[i]]=[r,o]}return[n,s]}(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map((e=>BigInt(e)))))(),Qr=(()=>Yr[0])(),Jr=(()=>Yr[1])(),en=new Uint32Array(80),tn=new Uint32Array(80);class rn extends Tr{constructor(e=64){super(128,e,16,!1),this.Ah=0|Rr[0],this.Al=0|Rr[1],this.Bh=0|Rr[2],this.Bl=0|Rr[3],this.Ch=0|Rr[4],this.Cl=0|Rr[5],this.Dh=0|Rr[6],this.Dl=0|Rr[7],this.Eh=0|Rr[8],this.El=0|Rr[9],this.Fh=0|Rr[10],this.Fl=0|Rr[11],this.Gh=0|Rr[12],this.Gl=0|Rr[13],this.Hh=0|Rr[14],this.Hl=0|Rr[15]}get(){const{Ah:e,Al:t,Bh:r,Bl:n,Ch:s,Cl:i,Dh:o,Dl:a,Eh:c,El:l,Fh:u,Fl:h,Gh:d,Gl:p,Hh:f,Hl:g}=this;return[e,t,r,n,s,i,o,a,c,l,u,h,d,p,f,g]}set(e,t,r,n,s,i,o,a,c,l,u,h,d,p,f,g){this.Ah=0|e,this.Al=0|t,this.Bh=0|r,this.Bl=0|n,this.Ch=0|s,this.Cl=0|i,this.Dh=0|o,this.Dl=0|a,this.Eh=0|c,this.El=0|l,this.Fh=0|u,this.Fl=0|h,this.Gh=0|d,this.Gl=0|p,this.Hh=0|f,this.Hl=0|g}process(e,t){for(let r=0;r<16;r++,t+=4)en[r]=e.getUint32(t),tn[r]=e.getUint32(t+=4);for(let e=16;e<80;e++){const t=0|en[e-15],r=0|tn[e-15],n=Ur(t,r,1)^Ur(t,r,8)^Nr(t,0,7),s=Fr(t,r,1)^Fr(t,r,8)^Or(t,r,7),i=0|en[e-2],o=0|tn[e-2],a=Ur(i,o,19)^Br(i,o,61)^Nr(i,0,6),c=Fr(i,o,19)^qr(i,o,61)^Or(i,o,6),l=Vr(s,c,tn[e-7],tn[e-16]),u=Kr(l,n,a,en[e-7],en[e-16]);en[e]=0|u,tn[e]=0|l}let{Ah:r,Al:n,Bh:s,Bl:i,Ch:o,Cl:a,Dh:c,Dl:l,Eh:u,El:h,Fh:d,Fl:p,Gh:f,Gl:g,Hh:m,Hl:y}=this;for(let e=0;e<80;e++){const t=Ur(u,h,14)^Ur(u,h,18)^Br(u,h,41),b=Fr(u,h,14)^Fr(u,h,18)^qr(u,h,41),w=u&d^~u&f,v=Hr(y,b,h&p^~h&g,Jr[e],tn[e]),E=Gr(v,m,t,w,Qr[e],en[e]),S=0|v,A=Ur(r,n,28)^Br(r,n,34)^Br(r,n,39),I=Fr(r,n,28)^qr(r,n,34)^qr(r,n,39),_=r&s^r&o^s&o,C=n&i^n&a^i&a;m=0|f,y=0|g,f=0|d,g=0|p,d=0|u,p=0|h,({h:u,l:h}=$r(0|c,0|l,0|E,0|S)),c=0|o,l=0|a,o=0|s,a=0|i,s=0|r,i=0|n;const x=zr(S,I,C);r=jr(x,E,A,_),n=0|x}({h:r,l:n}=$r(0|this.Ah,0|this.Al,0|r,0|n)),({h:s,l:i}=$r(0|this.Bh,0|this.Bl,0|s,0|i)),({h:o,l:a}=$r(0|this.Ch,0|this.Cl,0|o,0|a)),({h:c,l}=$r(0|this.Dh,0|this.Dl,0|c,0|l)),({h:u,l:h}=$r(0|this.Eh,0|this.El,0|u,0|h)),({h:d,l:p}=$r(0|this.Fh,0|this.Fl,0|d,0|p)),({h:f,l:g}=$r(0|this.Gh,0|this.Gl,0|f,0|g)),({h:m,l:y}=$r(0|this.Hh,0|this.Hl,0|m,0|y)),this.set(r,n,s,i,o,a,c,l,u,h,d,p,f,g,m,y)}roundClean(){lr(en,tn)}destroy(){lr(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const nn=Cr((()=>new Zr)),sn=Cr((()=>new rn)),on=nn;function an(e,t="utf8"){const r=et[t];if(null==r)throw Error(`Unsupported encoding "${t}"`);return r.encoder.encode(e).substring(1)}function cn(e){if("string"==typeof e){return tt(e.replace(/^0x/i,"").toLowerCase(),"base16")}return e}function ln(e){const t=new ArrayBuffer(8),r=new DataView(t);return"number"==typeof e?r.setFloat64(0,e,!1):r.setBigInt64(0,e,!1),new Uint8Array(t)}const un=e=>an(e,"base16"),hn=e=>an(e,"utf8"),dn=e=>tt(e,"utf8");function pn(e){const t=e.reduce(((e,t)=>e+t.length),0),r=new Uint8Array(t);let n=0;for(const t of e)r.set(t,n),n+=t.length;return r}const fn=(e,t)=>`/waku/2/rs/${e}/${t}`,gn=e=>{const t=e.split("/");if(6!=t.length||"waku"!==t[1]||"2"!==t[2]||"rs"!==t[3])throw Error("Invalid pubsub topic");const r=parseInt(t[4]),n=parseInt(t[5]);if(isNaN(r)||isNaN(n))throw Error("Invalid clusterId or shard");return{clusterId:r,shard:n}};function mn(e){const t=e.split("/");if(t.length<5||t.length>6)throw Error("Content topic format is invalid: "+e);let r=0;if(6==t.length){if(r=parseInt(t[1]),isNaN(r))throw Error("Invalid generation field in content topic: "+e);if(r>0)throw Error("Generation greater than 0 is not supported: "+e)}const n=t.splice(-4);if(0==n[0].length)throw Error("Application field cannot be empty: "+e);if(0==n[1].length)throw Error("Version field cannot be empty: "+e);if(0==n[2].length)throw Error("Topic name field cannot be empty: "+e);if(0==n[3].length)throw Error("Encoding field cannot be empty: "+e);return{generation:r,application:n[0],version:n[1],topicName:n[2],encoding:n[3]}}class yn{networkConfig;pubsubTopic;shardId;constructor(e,t,r){this.networkConfig=e,this.pubsubTopic=t,this.shardId=r}}class bn extends yn{networkConfig;pubsubTopic;shardId;contentTopic;static fromContentTopic(e,t){mn(e);const r=function(e,t){const{application:r,version:n}=mn(e),s=on(pn([dn(r),dn(n)])),i=new DataView(s.buffer.slice(-8));return Number(i.getBigUint64(0,!1)%BigInt(t))}(e,t.numShardsInCluster),n=fn(t.clusterId,r);return new bn(t,n,r,e)}constructor(e,t,r,n){super(e,t,r),this.networkConfig=e,this.pubsubTopic=t,this.shardId=r,this.contentTopic=n}get clusterId(){return this.networkConfig.clusterId}get isAutoSharding(){return!0}get isStaticSharding(){return!1}}class wn extends yn{networkConfig;pubsubTopic;shardId;static fromShard(e,t){const r=fn(t.clusterId,e);return new wn(t,r,e)}static fromPubsubTopic(e,t){const{clusterId:r,shard:n}=gn(e);if(r!=t.clusterId)throw"Pubsub topic does not match network config's cluster id";return new wn(t,e,n)}constructor(e,t,r){super(e,t,r),this.networkConfig=e,this.pubsubTopic=t,this.shardId=r}get clusterId(){return this.networkConfig.clusterId}get isAutoSharding(){return!1}get isStaticSharding(){return!0}}function vn(e,t){if("clusterId"in(r=e)&&"numShardsInCluster"in r){if(t.contentTopic)return bn.fromContentTopic(t.contentTopic,e);throw Error("AutoSharding requires contentTopic")}if(void 0!==t.shardId)return wn.fromShard(t.shardId,e);if(t.pubsubTopic)return wn.fromPubsubTopic(t.pubsubTopic,e);throw Error("StaticSharding requires shardId or pubsubTopic");var r}const En=e=>{if((e=new Uint8Array(e)).length<3)throw Error("Insufficient data");const t=new DataView(e.buffer),r=t.getUint16(0),n=[];if(130===e.length)for(let e=0;e<1024;e++){const r=Math.floor(e/8)+2,s=7-e%8;t.getUint8(r)&1<<s&&n.push(e)}else{const r=t.getUint8(2);for(let s=0,i=3;s<r;s++,i+=2){if(i+1>=e.length)throw Error("Unexpected end of data");n.push(t.getUint16(i))}}return{clusterId:r,shards:n}},Sn=e=>{const{clusterId:t,shards:r}=e,n=r.length>=64?130:3+2*r.length,s=new ArrayBuffer(n),i=new DataView(s);if(i.setUint16(0,t),r.length>=64)for(const e of r){const t=Math.floor(e/8)+2,r=7-e%8;i.setUint8(t,i.getUint8(t)|1<<r)}else{i.setUint8(2,r.length);for(let e=0,t=3;e<r.length;e++,t+=2)i.setUint16(t,r[e])}return new Uint8Array(s)},An=Symbol.for("@libp2p/connection"),In=Symbol.for("@libp2p/content-routing"),_n=Symbol.for("@libp2p/peer-discovery"),Cn=Symbol.for("@libp2p/peer-id");function xn(e){return!!e?.[Cn]}const kn=Symbol.for("@libp2p/peer-routing"),Tn="keep-alive",Pn=Symbol.for("@libp2p/transport");var Rn;(e=>{e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"})(Rn||(Rn={}));let Ln=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}};class Dn extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}let Mn=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},Nn=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class On extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class Un extends Error{static name="ConnectionClosingError";constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}class Fn extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}class Bn extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}class qn extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class $n extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class zn extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}let jn=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}};class Vn extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let Kn=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};class Hn extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class Gn extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class Wn extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}class Xn extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}let Zn=class extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}},Yn=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class Qn extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}class Jn extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class es extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class ts extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}class rs extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}class ns extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}class ss extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return null==t?0:t.length}addEventListener(e,t,r){super.addEventListener(e,t,r);let n=this.#e.get(e);null==n&&(n=[],this.#e.set(e,n)),n.push({callback:t,once:(!0!==r&&!1!==r&&r?.once)??!1})}removeEventListener(e,t,r){super.removeEventListener(e.toString(),t??null,r);let n=this.#e.get(e);null!=n&&(n=n.filter((({callback:e})=>e!==t)),this.#e.set(e,n))}dispatchEvent(e){const t=super.dispatchEvent(e);let r=this.#e.get(e.type);return null==r||(r=r.filter((({once:e})=>!e)),this.#e.set(e.type,r)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}function is(e){return null!=e&&"function"==typeof e.start&&"function"==typeof e.stop}const os=Symbol.for("@libp2p/service-capabilities"),as=Symbol.for("@libp2p/service-dependencies");var cs="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function ls(e){return e&&e.__esModule&&{}.hasOwnProperty.call(e,"default")?e.default:e}var us,hs,ds,ps,fs,gs={exports:{}};function ms(){if(hs)return us;hs=1;var e=1e3,t=60*e,r=60*t,n=24*r,s=7*n,i=365.25*n;function o(e,t,r,n){var s=t>=1.5*r;return Math.round(e/r)+" "+n+(s?"s":"")}return us=(a,c)=>{c=c||{};var l=typeof a;if("string"===l&&a.length>0)return function(o){if((o+="").length>100)return;var a=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(o);if(!a)return;var c=parseFloat(a[1]);switch((a[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*i;case"weeks":case"week":case"w":return c*s;case"days":case"day":case"d":return c*n;case"hours":case"hour":case"hrs":case"hr":case"h":return c*r;case"minutes":case"minute":case"mins":case"min":case"m":return c*t;case"seconds":case"second":case"secs":case"sec":case"s":return c*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(a);if("number"===l&&isFinite(a))return c.long?function(s){var i=Math.abs(s);if(i>=n)return o(s,i,n,"day");if(i>=r)return o(s,i,r,"hour");if(i>=t)return o(s,i,t,"minute");if(i>=e)return o(s,i,e,"second");return s+" ms"}(a):function(s){var i=Math.abs(s);if(i>=n)return Math.round(s/n)+"d";if(i>=r)return Math.round(s/r)+"h";if(i>=t)return Math.round(s/t)+"m";if(i>=e)return Math.round(s/e)+"s";return s+"ms"}(a);throw Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))},us}var ys=(fs||(fs=1,function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;t.splice(1,0,r,"color: inherit");let n=0,s=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(n++,"%c"===e&&(s=n))})),t.splice(s,0,r)},t.save=e=>{try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=()=>{let e;try{e=t.storage.getItem("debug")||t.storage.getItem("DEBUG")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=()=>{if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=(()=>{try{return localStorage}catch(e){}})(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=(ps||(ps=1,ds=function(e){function t(e){let n,s,i,o=null;function a(...e){if(!a.enabled)return;const r=a,s=Number(new Date),i=s-(n||s);r.diff=i,r.prev=n,r.curr=s,n=s,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((n,s)=>{if("%%"===n)return"%";o++;const i=t.formatters[s];if("function"==typeof i){const t=e[o];n=i.call(r,t),e.splice(o,1),o--}return n})),t.formatArgs.call(r,e),(r.log||t.log).apply(r,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=r,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(s!==t.namespaces&&(s=t.namespaces,i=t.enabled(e)),i),set(e){o=e}}),"function"==typeof t.init&&t.init(a),a}function r(e,r){const n=t(this.namespace+(void 0===r?":":r)+e);return n.log=this.log,n}function n(e,t){let r=0,n=0,s=-1,i=0;for(;r<e.length;)if(n<t.length&&(t[n]===e[r]||"*"===t[n]))"*"===t[n]?(s=n,i=r,n++):(r++,n++);else{if(-1===s)return!1;n=s+1,i++,r=i}for(;n<t.length&&"*"===t[n];)n++;return n===t.length}return t.debug=t,t.default=t,t.coerce=e=>e instanceof Error?e.stack||e.message:e,t.disable=()=>{const e=[...t.names,...t.skips.map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=e=>{t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const e of r)"-"===e[0]?t.skips.push(e.slice(1)):t.names.push(e)},t.enabled=e=>{for(const r of t.skips)if(n(e,r))return!1;for(const r of t.names)if(n(e,r))return!0;return!1},t.humanize=ms(),t.destroy=()=>{console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((r=>{t[r]=e[r]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=e=>{let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.enable(t.load()),t}),ds)(t);const{formatters:r}=e.exports;r.j=e=>{try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(gs,gs.exports)),gs.exports),bs=ls(ys);const ws="waku";let vs=class e{_info;_warn;_error;static createDebugNamespace(e,t){return t?`${ws}:${t}:${e}`:`${ws}:${e}`}constructor(t){this._info=bs(e.createDebugNamespace("info",t)),this._warn=bs(e.createDebugNamespace("warn",t)),this._error=bs(e.createDebugNamespace("error",t))}get info(){return this._info}get warn(){return this._warn}get error(){return this._error}log(e,...t){(this[e]||this.log)(...t)}};function Es(e,t){const r=dn(e),n=dn(t.contentTopic),s=function(e){if(!e)return;let t;t="bigint"==typeof e?e:1000000n*BigInt(e.valueOf());return ln(t)}(t.timestamp),i=pn([r,t.payload,n,t.meta,s].filter(tr));return on(i)}function Ss(e,t){const r=Es(e,t);return un(r)}const As=new vs("message:version-0"),Is=BigInt(1e6);class _s{pubsubTopic;proto;_hash;_hashStr;constructor(e,t){this.pubsubTopic=e,this.proto=t}get ephemeral(){return!!this.proto.ephemeral}get payload(){return this.proto.payload}get contentTopic(){return this.proto.contentTopic}get hash(){return void 0===this._hash&&(this._hash=Es(this.pubsubTopic,this.proto)),this._hash}get hashStr(){return void 0===this._hashStr&&(this._hashStr=un(this.hash)),this._hashStr}get timestamp(){try{if(this.proto.timestamp){const e=this.proto.timestamp/Is;return new Date(Number(e))}return}catch(e){return}}get meta(){return this.proto.meta}get version(){return this.proto.version??0}get rateLimitProof(){return this.proto.rateLimitProof}}let Cs=class{contentTopic;ephemeral;routingInfo;metaSetter;constructor(e,t=!1,r,n){if(this.contentTopic=e,this.ephemeral=t,this.routingInfo=r,this.metaSetter=n,!e||""===e)throw Error("Content topic must be specified")}get pubsubTopic(){return this.routingInfo.pubsubTopic}async toWire(e){return bt.encode(await this.toProtoObj(e))}async toProtoObj(e){const t=e.timestamp??new Date,r={payload:e.payload,version:0,contentTopic:this.contentTopic,timestamp:BigInt(t.valueOf())*Is,meta:void 0,rateLimitProof:e.rateLimitProof,ephemeral:this.ephemeral};if(this.metaSetter){const e=this.metaSetter(r);return{...r,meta:e}}return r}};function xs({contentTopic:e,routingInfo:t,ephemeral:r,metaSetter:n}){return new Cs(e,r,t,n)}let ks=class{contentTopic;routingInfo;constructor(e,t){if(this.contentTopic=e,this.routingInfo=t,!e||""===e)throw Error("Content topic must be specified")}get pubsubTopic(){return this.routingInfo.pubsubTopic}fromWireToProtoObj(e){const t=bt.decode(e);return Promise.resolve({payload:t.payload,contentTopic:t.contentTopic,version:t.version??void 0,timestamp:t.timestamp??void 0,meta:t.meta??void 0,rateLimitProof:t.rateLimitProof??void 0,ephemeral:t.ephemeral??!1})}async fromProtoObj(e,t){return t.version?(As.error("Failed to decode due to incorrect version, expected:",0,", actual:",t.version),Promise.resolve(void 0)):new _s(e,t)}};var Ts,Ps,Rs,Ls,Ds,Ms,Ns;(e=>{e[e.SUCCESS=200]="SUCCESS",e[e.BAD_REQUEST=400]="BAD_REQUEST",e[e.PAYLOAD_TOO_LARGE=413]="PAYLOAD_TOO_LARGE",e[e.INVALID_MESSAGE=420]="INVALID_MESSAGE",e[e.UNSUPPORTED_TOPIC=421]="UNSUPPORTED_TOPIC",e[e.TOO_MANY_REQUESTS=429]="TOO_MANY_REQUESTS",e[e.INTERNAL_ERROR=500]="INTERNAL_ERROR",e[e.UNAVAILABLE=503]="UNAVAILABLE",e[e.NO_RLN_PROOF=504]="NO_RLN_PROOF",e[e.NO_PEERS=505]="NO_PEERS"})(Ts||(Ts={})),Ts.SUCCESS,Ts.BAD_REQUEST,Ts.PAYLOAD_TOO_LARGE,Ts.INVALID_MESSAGE,Ts.UNSUPPORTED_TOPIC,Ts.TOO_MANY_REQUESTS,Ts.INTERNAL_ERROR,Ts.UNAVAILABLE,Ts.NO_RLN_PROOF,Ts.NO_PEERS,(e=>{e.Relay="relay",e.Store="store",e.LightPush="lightpush",e.Filter="filter"})(Ps||(Ps={})),(e=>{e.GENERIC_FAIL="Generic error",e.DECODE_FAILED="Failed to decode",e.NO_PEER_AVAILABLE="No peer available",e.NO_STREAM_AVAILABLE="No stream available",e.NO_RESPONSE="No response received",e.STREAM_ABORTED="Stream aborted",e.ENCODE_FAILED="Failed to encode",e.EMPTY_PAYLOAD="Payload is empty",e.SIZE_TOO_BIG="Size is too big",e.TOPIC_NOT_CONFIGURED="Topic not configured",e.RLN_PROOF_GENERATION="Proof generation failed",e.REMOTE_PEER_REJECTED="Remote peer rejected",e.BAD_REQUEST="Bad request format",e.PAYLOAD_TOO_LARGE="Message payload exceeds maximum size",e.INVALID_MESSAGE="Message validation failed",e.UNSUPPORTED_TOPIC="Unsupported pubsub topic",e.TOO_MANY_REQUESTS="Rate limit exceeded",e.INTERNAL_ERROR="Internal server error",e.UNAVAILABLE="Service temporarily unavailable",e.NO_RLN_PROOF="RLN proof generation failed",e.NO_PEERS="No relay peers available"})(Rs||(Rs={})),(e=>{e.GENERIC_FAIL="Generic error",e.DECODE_FAILED="Failed to decode",e.NO_PEER_AVAILABLE="No peer available",e.NO_STREAM_AVAILABLE="No stream available",e.NO_RESPONSE="No response received",e.STREAM_ABORTED="Stream aborted",e.REMOTE_PEER_REJECTED="Remote peer rejected",e.TOPIC_NOT_CONFIGURED="Topic not configured",e.SUBSCRIPTION_FAILED="Subscription failed",e.UNSUBSCRIBE_FAILED="Unsubscribe failed",e.PING_FAILED="Ping failed",e.TOPIC_DECODER_MISMATCH="Topic decoder mismatch",e.INVALID_DECODER_TOPICS="Invalid decoder topics",e.SUBSCRIPTION_LIMIT_EXCEEDED="Subscription limit exceeded",e.INVALID_CONTENT_TOPIC="Invalid content topic",e.PUSH_MESSAGE_FAILED="Push message failed",e.EMPTY_MESSAGE="Empty message received",e.MISSING_PUBSUB_TOPIC="Pubsub topic missing from push message"})(Ls||(Ls={})),(e=>{e.GENERIC_FAIL="Generic error",e.REMOTE_PEER_REJECTED="Remote peer rejected",e.DECODE_FAILED="Failed to decode",e.NO_PEER_AVAILABLE="No peer available",e.NO_STREAM_AVAILABLE="No stream available",e.NO_RESPONSE="No response received",e.ENCODE_FAILED="Failed to encode",e.EMPTY_PAYLOAD="Payload is empty",e.SIZE_TOO_BIG="Size is too big",e.TOPIC_NOT_CONFIGURED="Topic not configured",e.STREAM_ABORTED="Stream aborted",e.RLN_PROOF_GENERATION="Proof generation failed",e.TOPIC_DECODER_MISMATCH="Topic decoder mismatch",e.INVALID_DECODER_TOPICS="Invalid decoder topics"})(Ds||(Ds={})),(e=>{e.Connection="waku:connection",e.Health="waku:health"})(Ms||(Ms={})),(e=>{e.BOOTSTRAP="bootstrap",e.PEER_EXCHANGE="peer-exchange",e.PEER_CACHE="peer-cache"})(Ns||(Ns={}));const Os="locked",Us={clusterId:1,numShardsInCluster:8};var Fs;function Bs(e){if(null!=e[Symbol.asyncIterator])return(async()=>{const t=[];for await(const r of e)t.push(r);return t})();const t=[];for(const r of e)t.push(r);return t}function qs(e,r){null==r&&(r=e.reduce(((e,t)=>e+t.length),0));const n=t(r);let s=0;for(const t of e)n.set(t,s),s+=t.length;return n}function $s(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0}(e=>{e.Unhealthy="Unhealthy",e.MinimallyHealthy="MinimallyHealthy",e.SufficientlyHealthy="SufficientlyHealthy"})(Fs||(Fs={}));const zs=Symbol.for("@achingbrain/uint8arraylist");function js(e,t){if(null==t||t<0)throw new RangeError("index is out of bounds");let r=0;for(const n of e){const e=r+n.byteLength;if(t<e)return{buf:n,index:t-r};r=e}throw new RangeError("index is out of bounds")}function Vs(e){return!!e?.[zs]}class Ks{bufs;length;[zs]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const r of e)if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.push(r);else{if(!Vs(r))throw Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");t+=r.byteLength,this.bufs.push(...r.bufs)}this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const r of e.reverse())if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.unshift(r);else{if(!Vs(r))throw Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");t+=r.byteLength,this.bufs.unshift(...r.bufs)}this.length+=t}get(e){const t=js(this.bufs,e);return t.buf[t.index]}set(e,t){const r=js(this.bufs,e);r.buf[r.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let r=0;r<e.length;r++)this.set(t+r,e[r]);else{if(!Vs(e))throw Error("Could not write value, must be an Uint8Array or a Uint8ArrayList");for(let r=0;r<e.length;r++)this.set(t+r,e.get(r))}}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength)return this.bufs=[],void(this.length=0);for(;this.bufs.length>0;){if(!(e>=this.bufs[0].byteLength)){this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift()}}}slice(e,t){const{bufs:r,length:n}=this._subList(e,t);return qs(r,n)}subarray(e,t){const{bufs:r,length:n}=this._subList(e,t);return 1===r.length?r[0]:qs(r,n)}sublist(e,t){const{bufs:r,length:n}=this._subList(e,t),s=new Ks;return s.length=n,s.bufs=[...r],s}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(0===e&&t===this.length)return{bufs:this.bufs,length:this.length};const r=[];let n=0;for(let s=0;s<this.bufs.length;s++){const i=this.bufs[s],o=n,a=o+i.byteLength;if(n=a,e>=a)continue;const c=e>=o&&e<a,l=t>o&&t<=a;if(c&&l){if(e===o&&t===a){r.push(i);break}const n=e-o;r.push(i.subarray(n,n+(t-e)));break}if(c){if(0===e){r.push(i);continue}r.push(i.subarray(e-o))}else{if(l){if(t===a){r.push(i);break}r.push(i.subarray(0,t-o));break}r.push(i)}}return{bufs:r,length:t-e}}indexOf(e,t=0){if(!(Vs(e)||e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const r=e instanceof Uint8Array?e:e.subarray();if(isNaN(t=Number(t??0))&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),0===e.length)return t>this.length?this.length:t;const n=r.byteLength;if(0===n)throw new TypeError("search must be at least 1 byte long");const s=new Int32Array(256);for(let e=0;e<256;e++)s[e]=-1;for(let e=0;e<n;e++)s[r[e]]=e;const i=s,o=this.byteLength-r.byteLength,a=r.byteLength-1;let c;for(let e=t;e<=o;e+=c){c=0;for(let t=a;t>=0;t--){const n=this.get(e+t);if(r[t]!==n){c=Math.max(1,t-i[n]);break}}if(0===c)return e}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,r){const n=t(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,r),this.write(n,e)}getInt16(e,t){const r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,t)}setInt16(t,r,n){const s=e(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,r,n),this.write(s,t)}getInt32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,t)}setInt32(t,r,n){const s=e(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,r,n),this.write(s,t)}getBigInt64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,t)}setBigInt64(t,r,n){const s=e(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,r,n),this.write(s,t)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,r){const n=t(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,r),this.write(n,e)}getUint16(e,t){const r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,t)}setUint16(t,r,n){const s=e(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,r,n),this.write(s,t)}getUint32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,t)}setUint32(t,r,n){const s=e(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,r,n),this.write(s,t)}getBigUint64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,t)}setBigUint64(t,r,n){const s=e(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,r,n),this.write(s,t)}getFloat32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,t)}setFloat32(t,r,n){const s=e(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,r,n),this.write(s,t)}getFloat64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,t)}setFloat64(t,r,n){const s=e(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,r,n),this.write(s,t)}equals(e){if(null==e)return!1;if(!(e instanceof Ks))return!1;if(e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!$s(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const r=new Ks;return r.bufs=e,null==t&&(t=e.reduce(((e,t)=>e+t.byteLength),0)),r.length=t,r}}function Hs(e){return null!=e[Symbol.asyncIterator]}const Gs=e=>{const r=c(e),n=t(r);return h(e,n),Gs.bytes=r,n};function Ws(e,t){const r=(t=t??{}).lengthEncoder??Gs;function*n(e){const t=r(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return Hs(e)?async function*(){for await(const t of e)yield*n(t)}():function*(){for(const t of e)yield*n(t)}()}Gs.bytes=0,Ws.single=(e,t)=>{const r=(t=t??{}).lengthEncoder??Gs;return new Ks(r(e.byteLength),e)};let Xs=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Zs=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Ys=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},Qs=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};var Js;(e=>{e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"})(Js||(Js={}));const ei=e=>{const t=d(e);return ei.bytes=c(t),t};function ti(e,t){const r=new Ks;let n=Js.LENGTH,s=-1;const i=t?.lengthDecoder??ei,o=t?.maxLengthLength??8,a=t?.maxDataLength??4194304;function*c(){for(;r.byteLength>0;){if(n===Js.LENGTH)try{if(s=i(r),s<0)throw new Xs("Invalid message length");if(s>a)throw new Zs("Message length too long");const e=i.bytes;r.consume(e),null!=t?.onLength&&t.onLength(s),n=Js.DATA}catch(e){if(e instanceof RangeError){if(r.byteLength>o)throw new Ys("Message length length too long");break}throw e}if(n===Js.DATA){if(r.byteLength<s)break;const e=r.sublist(0,s);r.consume(s),null!=t?.onData&&t.onData(e),yield e,n=Js.LENGTH}}}return Hs(e)?async function*(){for await(const t of e)r.append(t),yield*c();if(r.byteLength>0)throw new Qs("Unexpected end of input")}():function*(){for(const t of e)r.append(t),yield*c();if(r.byteLength>0)throw new Qs("Unexpected end of input")}()}function ri(){const e={};return e.promise=new Promise(((t,r)=>{e.resolve=t,e.reject=r})),e}ei.bytes=0,ti.fromReader=(e,t)=>{let r=1;return ti(async function*(){for(;;)try{const{done:t,value:n}=await e.next(r);if(!0===t)return;null!=n&&(yield n)}catch(e){if("ERR_UNDER_READ"===e.code)return{done:!0,value:null};throw e}finally{r=1}}(),{...t??{},onLength(e){r=e}})};class ni{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw Error("Max size for a FixedFIFO should be a power of two");this.buffer=Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class si{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new ni(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=e?.byteLength?e.byteLength:1}push(e){if(null!=e?.value&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new ni(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(void 0===e&&null!=this.tail.next){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return null!=e?.value&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let ii=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function oi(e={}){return function(e,t){t=t??{};let r,n,s,i=t.onEnd,o=new si,a=ri();const c=async()=>{try{return o.isEmpty()?s?{done:!0}:await new Promise(((t,s)=>{n=i=>{n=null,o.push(i);try{t(e(o))}catch(e){s(e)}return r}})):e(o)}finally{o.isEmpty()&&queueMicrotask((()=>{a.resolve(),a=ri()}))}},l=e=>null!=n?n(e):(o.push(e),r),u=e=>(o=new si,null!=n?n({error:e}):(o.push({error:e}),r)),h=e=>{if(s)return r;if(!0!==t?.objectMode&&null==e?.byteLength)throw Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:e})},d=e=>s?r:(s=!0,null!=e?u(e):l({done:!0})),p=()=>(o=new si,d(),{done:!0}),f=e=>(d(e),{done:!0});if(r={[Symbol.asyncIterator](){return this},next:c,return:p,throw:f,push:h,end:d,get readableLength(){return o.size},async onEmpty(e){const t=e?.signal;if(t?.throwIfAborted(),o.isEmpty())return;let r,n;null!=t&&(r=new Promise(((e,r)=>{n=()=>{r(new ii)},t.addEventListener("abort",n)})));try{await Promise.race([a.promise,r])}finally{null!=n&&null!=t&&t?.removeEventListener("abort",n)}}},null==i)return r;const g=r;return r={[Symbol.asyncIterator](){return this},next:()=>g.next(),throw:e=>(g.throw(e),null!=i&&(i(e),i=void 0),{done:!0}),return:()=>(g.return(),null!=i&&(i(),i=void 0),{done:!0}),push:h,end:e=>(g.end(e),null!=i&&(i(e),i=void 0),r),get readableLength(){return g.readableLength},onEmpty(e){return g.onEmpty(e)}},r}((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),e)}let ai=class extends Error{type;code;constructor(e,t,r){super(e??"The operation was aborted"),this.type="aborted",this.name=r??"AbortError",this.code=t??"ABORT_ERR"}};async function ci(e,t,r){if(null==t)return e;if(t.aborted)return e.catch((()=>{})),Promise.reject(new ai(r?.errorMessage,r?.errorCode,r?.errorName));let n;const s=new ai(r?.errorMessage,r?.errorCode,r?.errorName);try{return await Promise.race([e,new Promise(((e,r)=>{n=()=>{r(s)},t.addEventListener("abort",n)}))])}finally{null!=n&&t.removeEventListener("abort",n)}}class li{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=ri(),this.haveNext=ri()}[Symbol.asyncIterator](){return this}async next(){if(null==this.nextResult&&await this.haveNext.promise,null==this.nextResult)throw Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=ri(),e}async throw(e){this.ended=!0,this.error=e,null!=e&&(this.haveNext.promise.catch((()=>{})),this.haveNext.reject(e));return{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){null!=e?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(null!=e&&this.ended)throw this.error??Error("Cannot push value onto an ended pushable");for(;null!=this.nextResult;)await this.readNext.promise;null!=e?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=ri(),await ci(this.readNext.promise,t?.signal,t)}}function ui(){return new li}async function*hi(e){const t=new AbortController,r=ui();(async function(e,t,r){try{await Promise.all(e.map((async e=>{for await(const n of e)await t.push(n,{signal:r}),r.throwIfAborted()}))),await t.end(void 0,{signal:r})}catch(e){await t.end(e,{signal:r}).catch((()=>{}))}})(e,r,t.signal).catch((()=>{}));try{yield*r}finally{t.abort()}}function di(...e){const t=[];for(const r of e)null==r[Symbol.asyncIterator]&&t.push(r);return t.length===e.length?function*(e){for(const t of e)yield*t}(t):hi(e)}function pi(e,...t){if(null==e)throw Error("Empty pipeline");if(yi(e)){const t=e;e=()=>t.source}else if(mi(e)||gi(e)){const t=e;e=()=>t}const r=[e,...t];if(r.length>1&&yi(r[r.length-1])&&(r[r.length-1]=r[r.length-1].sink),r.length>2)for(let e=1;e<r.length-1;e++)yi(r[e])&&(r[e]=bi(r[e]));return fi(...r)}const fi=(...e)=>{let t;for(;e.length>0;)t=e.shift()(t);return t},gi=e=>null!=e?.[Symbol.asyncIterator],mi=e=>null!=e?.[Symbol.iterator],yi=e=>null!=e&&(null!=e.sink&&null!=e.source),bi=e=>t=>{const r=e.sink(t);if(null!=r?.then){const t=oi({objectMode:!0});let n;r.then((()=>{t.end()}),(e=>{t.end(e)}));const s=e.source;if(gi(s))n=async function*(){yield*s,t.end()};else{if(!mi(s))throw Error("Unknown duplex source type - must be Iterable or AsyncIterable");n=function*(){yield*s,t.end()}}return di(t,n())}return e.source};function wi(e){return e.filter((e=>"open"===e.status)).sort(((e,t)=>t.timeline.open-e.timeline.open)).at(0)}const vi="consumed";class Ei{multicodec;libp2p;log;ongoingCreation=new Set;streamPool=new Map;constructor(e,t){this.multicodec=e,this.libp2p=t,this.log=new vs("stream-manager:"+e),this.libp2p.events.addEventListener("peer:update",this.handlePeerUpdateStreamPool)}async getStream(e){try{const t=e.toString(),r=this.streamPool.get(t);r&&(this.streamPool.delete(t),await r);const n=this.getOpenStreamForCodec(e)||await this.createStream(e);if(!n)return;return this.log.info(`Using stream for peerId=${t} multicodec=${this.multicodec}`),this.lockStream(t,n),n}catch(e){return void this.log.error("Failed to getStream:",e)}}async createStream(e,t=0){const r=wi(this.libp2p.connectionManager.getConnections(e));if(!r)return void this.log.error(`Failed to get a connection to the peer peerId=${e.toString()} multicodec=${this.multicodec}`);let n,s;for(let i=0;i<t+1;i++)try{this.log.info(`Attempting to create a stream for peerId=${e.toString()} multicodec=${this.multicodec}`),s=await r.newStream(this.multicodec),this.log.info(`Created stream for peerId=${e.toString()} multicodec=${this.multicodec}`);break}catch(e){n=e}if(s)return s;this.log.error(`Failed to create a new stream for ${e.toString()} -- `+n)}async createStreamWithLock(e){const t=e.id.toString();if(this.ongoingCreation.has(t))this.log.info(`Skipping creation of a stream due to lock for peerId=${t} multicodec=${this.multicodec}`);else try{this.ongoingCreation.add(t),await this.createStream(e.id)}catch(e){this.log.error("Failed to createStreamWithLock:",e)}finally{this.ongoingCreation.delete(t)}}handlePeerUpdateStreamPool=e=>{const{peer:t}=e.detail;if(!t.protocols.includes(this.multicodec))return;this.getOpenStreamForCodec(t.id)||this.scheduleNewStream(t)};scheduleNewStream(e){this.log.info(`Scheduling creation of a stream for peerId=${e.id.toString()} multicodec=${this.multicodec}`),this.streamPool.has(e.id.toString())&&this.streamPool.delete(e.id.toString()),this.streamPool.set(e.id.toString(),this.createStreamWithLock(e))}getOpenStreamForCodec(e){const t=wi(this.libp2p.connectionManager.getConnections(e));if(!t)return void this.log.info(`No open connection found for peerId=${e.toString()} multicodec=${this.multicodec}`);const r=t.streams.find((e=>e.protocol===this.multicodec));if(!r)return void this.log.info(`No open stream found for peerId=${e.toString()} multicodec=${this.multicodec}`);if(!["done","closed","closing"].includes(r.writeStatus||"")&&!this.isStreamLocked(r))return this.log.info(`Found open stream for peerId=${e.toString()} multicodec=${this.multicodec}`),r;this.log.info(`Stream for peerId=${e.toString()} multicodec=${this.multicodec} is unusable`)}lockStream(e,t){this.log.info(`Locking stream for peerId:${e}\tstreamId:${t.id}`),t.metadata[vi]=!0}isStreamLocked(e){return!!e.metadata[vi]}}let Si;const Ai=new Uint8Array(16);function Ii(){if(!Si&&(Si="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Si))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Si(Ai)}const _i=[];for(let e=0;e<256;++e)_i.push((e+256).toString(16).slice(1));var Ci={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function xi(e){if(Ci.randomUUID&&!e)return Ci.randomUUID();const t=(e=e||{}).random||(e.rng||Ii)();return t[6]=15&t[6]|64,t[8]=63&t[8]|128,function(e,t=0){return _i[e[t+0]]+_i[e[t+1]]+_i[e[t+2]]+_i[e[t+3]]+"-"+_i[e[t+4]]+_i[e[t+5]]+"-"+_i[e[t+6]]+_i[e[t+7]]+"-"+_i[e[t+8]]+_i[e[t+9]]+"-"+_i[e[t+10]]+_i[e[t+11]]+_i[e[t+12]]+_i[e[t+13]]+_i[e[t+14]]+_i[e[t+15]]}(t)}class ki{proto;constructor(e){this.proto=e}static decode(e){const t=xt.decode(e);return new ki(t)}encode(){return xt.encode(this.proto)}get wakuMessage(){return this.proto.wakuMessage}get pubsubTopic(){return this.proto.pubsubTopic}}class Ti{proto;constructor(e){this.proto=e}static createSubscribeRequest(e,t){return new Ti({requestId:xi(),filterSubscribeType:_t.FilterSubscribeType.SUBSCRIBE,pubsubTopic:e,contentTopics:t})}static createUnsubscribeRequest(e,t){return new Ti({requestId:xi(),filterSubscribeType:_t.FilterSubscribeType.UNSUBSCRIBE,pubsubTopic:e,contentTopics:t})}static createUnsubscribeAllRequest(e){return new Ti({requestId:xi(),filterSubscribeType:_t.FilterSubscribeType.UNSUBSCRIBE_ALL,pubsubTopic:e,contentTopics:[]})}static createSubscriberPingRequest(){return new Ti({requestId:xi(),filterSubscribeType:_t.FilterSubscribeType.SUBSCRIBER_PING,pubsubTopic:"",contentTopics:[]})}static decode(e){const t=_t.decode(e);return new Ti(t)}encode(){return _t.encode(this.proto)}get filterSubscribeType(){return this.proto.filterSubscribeType}get requestId(){return this.proto.requestId}get pubsubTopic(){return this.proto.pubsubTopic}get contentTopics(){return this.proto.contentTopics}}class Pi{proto;constructor(e){this.proto=e}static decode(e){const t=Ct.decode(e);return new Pi(t)}encode(){return Ct.encode(this.proto)}get statusCode(){return this.proto.statusCode}get statusDesc(){return this.proto.statusDesc}get requestId(){return this.proto.requestId}}const Ri=new vs("filter-core"),Li="/vac/waku/filter-subscribe/2.0.0-beta1",Di="/vac/waku/filter-push/2.0.0-beta1";class Mi{handleIncomingMessage;libp2p;streamManager;multicodec=Li;constructor(e,t){this.handleIncomingMessage=e,this.libp2p=t,this.streamManager=new Ei(Li,t.components)}async start(){try{await this.libp2p.handle(Di,this.onRequest.bind(this),{maxInboundStreams:100})}catch(e){Ri.error("Failed to register ",Di,e)}}async stop(){try{await this.libp2p.unhandle(Di)}catch(e){Ri.error("Failed to unregister ",Di,e)}}async subscribe(e,t,r){const n=await this.streamManager.getStream(t);if(!n)return{success:null,failure:{error:Ls.NO_STREAM_AVAILABLE,peerId:t}};const s=Ti.createSubscribeRequest(e,r);let i;try{if(i=await pi([s.encode()],Ws,n,ti,(async e=>await Bs(e))),!i?.length)throw Error("Received no response from subscription request.")}catch(e){return Ri.error("Failed to send subscribe request",e),{success:null,failure:{error:Ls.GENERIC_FAIL,peerId:t}}}const{statusCode:o,requestId:a,statusDesc:c}=Pi.decode(i[0].slice());return o<200||o>=300?(Ri.error(`Filter subscribe request ${a} failed with status code ${o}: ${c}`),{failure:{error:Ls.REMOTE_PEER_REJECTED,peerId:t},success:null}):{failure:null,success:t}}async unsubscribe(e,t,r){const n=await this.streamManager.getStream(t);if(!n)return Ri.error("Failed to get a stream for remote peer:"+t.toString()),{success:null,failure:{error:Ls.NO_STREAM_AVAILABLE,peerId:t}};const s=Ti.createUnsubscribeRequest(e,r);try{await pi([s.encode()],Ws,n.sink)}catch(e){return Ri.error("Failed to send unsubscribe request",e),{success:null,failure:{error:Ls.GENERIC_FAIL,peerId:t}}}return{success:t,failure:null}}async unsubscribeAll(e,t){const r=await this.streamManager.getStream(t);if(!r)return Ri.error("Failed to get a stream for remote peer:"+t.toString()),{success:null,failure:{error:Ls.NO_STREAM_AVAILABLE,peerId:t}};const n=Ti.createUnsubscribeAllRequest(e),s=await pi([n.encode()],Ws,r,ti,(async e=>await Bs(e)));if(!s||!s.length)return{failure:{error:Ls.NO_RESPONSE,peerId:t},success:null};const{statusCode:i,requestId:o,statusDesc:a}=Pi.decode(s[0].slice());return i<200||i>=300?(Ri.error(`Filter unsubscribe all request ${o} failed with status code ${i}: ${a}`),{failure:{error:Ls.REMOTE_PEER_REJECTED,peerId:t},success:null}):{failure:null,success:t}}async ping(e){const t=await this.streamManager.getStream(e);if(!t)return Ri.error("Failed to get a stream for remote peer:"+e.toString()),{success:null,failure:{error:Ls.NO_STREAM_AVAILABLE,peerId:e}};const r=Ti.createSubscriberPingRequest();let n;try{n=await pi([r.encode()],Ws,t,ti,(async e=>await Bs(e)))}catch(t){return Ri.error("Failed to send ping request",t),{success:null,failure:{error:Ls.GENERIC_FAIL,peerId:e}}}if(!n||!n.length)return{success:null,failure:{error:Ls.NO_RESPONSE,peerId:e}};const{statusCode:s,requestId:i,statusDesc:o}=Pi.decode(n[0].slice());return s<200||s>=300?(Ri.error(`Filter ping request ${i} failed with status code ${s}: ${o}`),{success:null,failure:{error:Ls.REMOTE_PEER_REJECTED,peerId:e}}):{success:e,failure:null}}onRequest(e){const{connection:t,stream:r}=e,{remotePeer:n}=t;Ri.info("Received message from "+n.toString());try{pi(r,ti,(async e=>{for await(const r of e){const e=ki.decode(r.slice()),{pubsubTopic:n,wakuMessage:s}=e;if(!s)return void Ri.error("Received empty message");if(!n)return void Ri.error("Pubsub topic missing from push message");await this.handleIncomingMessage(n,s,t.remotePeer.toString())}})).then((()=>{Ri.info("Receiving pipe closed.")}),(async e=>{Ri.error(`Error with receiving pipe on peer:${t.remotePeer.toString()} -- stream:${r.id} -- protocol:${r.protocol}: `,e)}))}catch(e){Ri.error("Error decoding message",e)}}}const Ni="/vac/waku/lightpush/2.0.0-beta1",Oi="/vac/waku/lightpush/3.0.0",Ui=Ni,Fi=Oi;class Bi{proto;constructor(e){this.proto=e}static createRequest(e,t){return new Bi({requestId:xi(),request:{message:e,pubsubTopic:t},response:void 0})}static decode(e){const t=Lt.decode(e);return new Bi(t)}encode(){return Lt.encode(this.proto)}get query(){return this.proto.request}get response(){return this.proto.response}}class qi{proto;constructor(e){this.proto=e}static createRequest(e,t){return new qi({requestId:xi(),pubsubTopic:t,message:e})}static createResponse(e,t,r,n){return new qi({requestId:e,statusCode:t,statusDesc:r,relayPeerCount:n})}static decodeRequest(e){const t=Dt.decode(e);return new qi(t)}static decodeResponse(e){const t=Mt.decode(e);return new qi(t)}encode(){return this.isRequest()?Dt.encode(this.proto):Mt.encode(this.proto)}get request(){return this.isRequest()?this.proto:void 0}get response(){return this.isResponse()?this.proto:void 0}get requestId(){return this.proto.requestId}get pubsubTopic(){return this.isRequest()?this.proto.pubsubTopic:void 0}get message(){return this.isRequest()?this.proto.message:void 0}get statusCode(){return this.isResponse()?this.proto.statusCode:void 0}get statusDesc(){return this.isResponse()?this.proto.statusDesc:void 0}get relayPeerCount(){return this.isResponse()?this.proto.relayPeerCount:void 0}isRequest(){return"pubsubTopic"in this.proto&&"message"in this.proto}isResponse(){return"statusCode"in this.proto}}const $i=new vs("light-push:protocol-handler");class zi{static async preparePushMessage(e,t,r){try{if(!t.payload||0===t.payload.length)return $i.error("Failed to send waku light push: payload is empty"),{rpc:null,error:Rs.EMPTY_PAYLOAD};if(!await async function(e,t){const r=await e.toWire(t);return!!r&&rr(r)}(e,t))return $i.error("Failed to send waku light push: message is bigger than 1MB"),{rpc:null,error:Rs.SIZE_TOO_BIG};const n=await e.toProtoObj(t);return n?r===Oi?($i.info("Creating v3 RPC message"),{rpc:zi.createV3Rpc(n,e.pubsubTopic),error:null}):($i.info("Creating v2 RPC message"),{rpc:zi.createV2Rpc(n,e.pubsubTopic),error:null}):($i.error("Failed to encode to protoMessage, aborting push"),{rpc:null,error:Rs.ENCODE_FAILED})}catch(e){return $i.error("Failed to prepare push message",e),{rpc:null,error:Rs.GENERIC_FAIL}}}static handleResponse(e,t,r){return t===Oi?zi.handleV3Response(e,r):zi.handleV2Response(e,r)}static handleV3Response(e,t){try{const r=qi.decodeResponse(e),n=r.statusCode,s=r.statusDesc;if(n!==Ts.SUCCESS){const e=Rs.REMOTE_PEER_REJECTED;return $i.error(`Remote peer rejected with v3 status code ${n}: ${s}`),{success:null,failure:{error:e,peerId:t}}}return void 0!==r.relayPeerCount&&$i.info(`Message relayed to ${r.relayPeerCount} peers`),{success:t,failure:null}}catch(e){return{success:null,failure:{error:Rs.DECODE_FAILED,peerId:t}}}}static handleV2Response(e,t){let r;try{r=Bi.decode(e).response}catch(e){return{success:null,failure:{error:Rs.DECODE_FAILED,peerId:t}}}return r?(n=r.info)&&(n.includes("could not generate rln proof")||n.includes("could not get new message id to generate an rln proof")||n.includes("RLN validation failed"))?($i.error("Remote peer fault: RLN generation"),{success:null,failure:{error:Rs.RLN_PROOF_GENERATION,peerId:t}}):r.isSuccess?{success:t,failure:null}:($i.error("Remote peer rejected the message: ",r.info),{success:null,failure:{error:Rs.REMOTE_PEER_REJECTED,peerId:t}}):{success:null,failure:{error:Rs.NO_RESPONSE,peerId:t}};var n}static createV2Rpc(e,t){const r=Bi.createRequest(e,t);return Object.assign(r,{version:"v2"})}static createV3Rpc(e,t){e.timestamp||(e.timestamp=BigInt(Date.now())*BigInt(1e6));const r=qi.createRequest(e,t);return Object.assign(r,{version:"v3"})}}const ji=new vs("light-push");class Vi{libp2p;streamManager;streamManagerV2;multicodec=[Oi,Ni];constructor(e){this.libp2p=e,this.streamManagerV2=new Ei(Ni,e.components),this.streamManager=new Ei(Oi,e.components)}async send(e,t,r,n=!1){const s=await this.getProtocol(r,n);if(ji.info(`Sending light push request to peer:${r.toString()}, protocol:${s}`),!s)return{success:null,failure:{error:Rs.GENERIC_FAIL,peerId:r}};const{rpc:i,error:o}=await zi.preparePushMessage(e,t,s);if(o)return{success:null,failure:{error:o,peerId:r}};const a=await this.getStream(r,s);if(!a)return ji.error("Failed to get a stream for remote peer:"+r.toString()),{success:null,failure:{error:Rs.NO_STREAM_AVAILABLE,peerId:r}};let c;try{c=await pi([i.encode()],Ws,a,ti,(async e=>await Bs(e)))}catch(e){return ji.error("Failed to send waku light push request",e),{success:null,failure:{error:Rs.STREAM_ABORTED,peerId:r}}}const l=new Ks;return c.forEach((e=>l.append(e))),0===l.length?{success:null,failure:{error:Rs.NO_RESPONSE,peerId:r}}:zi.handleResponse(l,s,r)}async getProtocol(e,t){try{const r=await this.libp2p.peerStore.get(e);if(t||!r.protocols.includes(Oi)&&r.protocols.includes(Ni))return Ni;if(r.protocols.includes(Oi))return Oi;throw Error("No supported protocol found")}catch(e){return void ji.error("Failed to get protocol",e)}}async getStream(e,t){switch(t){case Ni:return this.streamManagerV2.getStream(e);case Oi:return this.streamManager.getStream(e);default:return}}}const Ki={payload:new Uint8Array,contentTopic:"",version:void 0,timestamp:void 0,meta:void 0,rateLimitProof:void 0,ephemeral:void 0};const Hi=864e5,Gi=1e6;class Wi{proto;constructor(e){this.proto=e}static create(e){const t=new Wi({...e,contentTopics:e.contentTopics||[],requestId:xi(),timeStart:e.timeStart?BigInt(e.timeStart.getTime()*Gi):void 0,timeEnd:e.timeEnd?BigInt(e.timeEnd.getTime()*Gi):void 0,messageHashes:e.messageHashes||[],paginationLimit:e.paginationLimit?BigInt(e.paginationLimit):void 0}),r=e.messageHashes&&e.messageHashes.length>0,n=e.contentTopics&&e.contentTopics.length>0,s=e.timeStart||e.timeEnd;if(r){if(n||s)throw Error("Message hash lookup queries cannot include content filter criteria (contentTopics, timeStart, or timeEnd)")}else if(e.pubsubTopic&&(!e.contentTopics||0===e.contentTopics.length)||!e.pubsubTopic&&e.contentTopics&&e.contentTopics.length>0)throw Error("Both pubsubTopic and contentTopics must be set together for content-filtered queries");return t}static decode(e){const t=Ft.decode(e);return new Wi(t)}encode(){return Ft.encode(this.proto)}}class Xi{proto;constructor(e){this.proto=e}static decode(e){const t=Bt.decode(e);return new Xi(t)}encode(){return Bt.encode(this.proto)}get statusCode(){return this.proto.statusCode}get statusDesc(){return this.proto.statusDesc}get messages(){return this.proto.messages}get paginationCursor(){return this.proto.paginationCursor}}const Zi=new vs("store"),Yi="/vac/waku/store-query/3.0.0";class Qi{streamManager;multicodec=Yi;constructor(e){this.streamManager=new Ei(Yi,e.components)}get maxTimeLimit(){return Hi}async*queryPerPage(e,t,r){if(e.timeStart&&e.timeEnd){if(e.timeEnd.getTime()-e.timeStart.getTime()>Hi)throw Error("Time range bigger than 24h")}if(!(e.messageHashes&&e.messageHashes.length>0)&&e.contentTopics&&e.contentTopics.toString()!==Array.from(t.keys()).toString())throw Error("Internal error, the decoders should match the query's content topics");let n=e.paginationCursor;for(;;){const s=Wi.create({...e,paginationCursor:n});Zi.info("Sending store query request:",{hasMessageHashes:!!e.messageHashes?.length,messageHashCount:e.messageHashes?.length,pubsubTopic:e.pubsubTopic,contentTopics:e.contentTopics});const i=await this.streamManager.getStream(r);if(!i){Zi.error("Failed to get a stream for remote peer:"+r.toString());break}const o=await pi([s.encode()],Ws,i,ti,(async e=>await Bs(e))),a=new Ks;o.forEach((e=>{a.append(e)}));const c=Xi.decode(a);if(!c.statusCode||c.statusCode>=300){const e=`Store query failed with status code: ${c.statusCode}, description: ${c.statusDesc}`;throw Zi.error(e),Error(e)}if(!c.messages||!c.messages.length){Zi.warn("Stopping pagination due to empty messages in response");break}Zi.info(c.messages.length+" messages retrieved from store");const l=c.messages.map((e=>{if(!e.message)return Promise.resolve(void 0);const r=e.message.contentTopic;if(r){const s=t.get(r);if(s)return s.fromProtoObj(e.pubsubTopic||"",(n=e.message,{...Ki,...n}))}var n;return Promise.resolve(void 0)}));if(yield l,n=e.paginationForward?c.messages[c.messages.length-1].messageHash:c.messages[0].messageHash,c.messages.length>100&&c.messages.length<(e.paginationLimit||20))break}}}const Ji=parseInt("11111",2),eo=parseInt("10000000",2),to=parseInt("01111111",2),ro={0:io,1:io,2(e,t){const r=so(e,t),n=t.offset,s=t.offset+r,i=[];for(let t=n;t<s;t++)t===n&&0===e[t]||i.push(e[t]);return t.offset+=r,Uint8Array.from(i)},3(e,t){const r=so(e,t),n=e[t.offset];t.offset++;const s=e.subarray(t.offset,t.offset+r-1);if(t.offset+=r,0!==n)throw Error("Unused bits in bit string is unimplemented");return s},4(e,t){const r=so(e,t),n=e.subarray(t.offset,t.offset+r);return t.offset+=r,n},5(e,t){return t.offset++,null},6(e,t){const r=so(e,t),n=t.offset+r,s=e[t.offset];t.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;t.offset<n;){const r=e[t.offset];if(t.offset++,c.push(127&r),r<128){c.reverse();let e=0;for(let t=0;t<c.length;t++)e+=c[t]<<7*t;a+="."+e,c=[]}}return a},16:io,22:io,48:io};function no(e,t={offset:0}){const r=e[t.offset]&Ji;if(t.offset++,null!=ro[r])return ro[r](e,t);throw Error("No decoder for tag "+r)}function so(e,t){let r=0;if((e[t.offset]&eo)===eo){const n=e[t.offset]&to;let s="0x";t.offset++;for(let r=0;r<n;r++,t.offset++)s+=e[t.offset].toString(16).padStart(2,"0");r=parseInt(s,16)}else r=e[t.offset],t.offset++;return r}function io(e,t){so(e,t);const r=[];for(;!(t.offset>=e.byteLength);){const n=no(e,t);if(null===n)break;r.push(n)}return r}function oo(e){if(e.byteLength<128)return Uint8Array.from([e.byteLength]);const t=function(e){let t=e.toString(16);t.length%2==1&&(t="0"+t);const r=new Ks;for(let e=0;e<t.length;e+=2)r.append(Uint8Array.from([parseInt(`${t[e]}${t[e+1]}`,16)]));return r}(e.byteLength);return new Ks(Uint8Array.from([t.byteLength|eo]),t)}function ao(e){const t=new Ks;return!(128&~e.subarray()[0])&&t.append(Uint8Array.from([0])),t.append(e),new Ks(Uint8Array.from([2]),oo(t),t)}function co(e){const t=Uint8Array.from([0]),r=new Ks(t,e);return new Ks(Uint8Array.from([3]),oo(r),r)}function lo(e,t=48){const r=new Ks;for(const t of e)r.append(t);return new Ks(Uint8Array.from([t]),oo(r),r)}const uo=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),ho=Uint8Array.from([6,5,43,129,4,0,34]),po=Uint8Array.from([6,5,43,129,4,0,35]),fo={ext:!0,kty:"EC",crv:"P-256"},go={ext:!0,kty:"EC",crv:"P-384"},mo={ext:!0,kty:"EC",crv:"P-521"},yo=32,bo=48,wo=66;function vo(e){return function(e){const t=e[1][1][0],r=1;let n,s;if(65===t.byteLength)return n=an(t.subarray(r,r+yo),"base64url"),s=an(t.subarray(r+yo),"base64url"),new So({...fo,key_ops:["verify"],x:n,y:s});if(97===t.byteLength)return n=an(t.subarray(r,r+bo),"base64url"),s=an(t.subarray(r+bo),"base64url"),new So({...go,key_ops:["verify"],x:n,y:s});if(133===t.byteLength)return n=an(t.subarray(r,r+wo),"base64url"),s=an(t.subarray(r+wo),"base64url"),new So({...mo,key_ops:["verify"],x:n,y:s});throw new Nn(`coordinates were wrong length, got ${t.byteLength}, expected 65, 97 or 133`)}(no(e))}function Eo(e){if("P-256"===e)return uo;if("P-384"===e)return ho;if("P-521"===e)return po;throw new Nn("Invalid curve "+e)}let So=class{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){var e;return null==this._raw&&(this._raw=(e=this.jwk,lo([ao(Uint8Array.from([1])),lo([Eo(e.crv)],160),lo([co(new Ks(Uint8Array.from([4]),tt(e.x??"","base64url"),tt(e.y??"","base64url")))],161)]).subarray())),this._raw}toMultihash(){return Be.digest(Gc(this))}toCID(){return Ke.createV1(114,this.toMultihash())}toString(){return he.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&$s(this.raw,e.raw)}async verify(e,t,r){return async function(e,t,r,n){const s=await crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:e.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,t,r.subarray());return n?.signal?.throwIfAborted(),i}(this.jwk,t,e,r)}};const Ao=BigInt(0),Io=BigInt(1);function _o(e,t=""){if("boolean"!=typeof e){throw Error((t&&`"${t}"`)+"expected boolean, got type="+typeof e)}return e}function Co(e,t,r=""){const n=sr(e),s=e?.length,i=void 0!==t;if(!n||i&&s!==t){throw Error((r&&`"${r}" `)+"expected Uint8Array"+(i?" of length "+t:"")+", got "+(n?"length="+s:"type="+typeof e))}return e}function xo(e){const t=e.toString(16);return 1&t.length?"0"+t:t}function ko(e){if("string"!=typeof e)throw Error("hex string expected, got "+typeof e);return""===e?Ao:BigInt("0x"+e)}function To(e){return ko(fr(e))}function Po(e){return or(e),ko(fr(Uint8Array.from(e).reverse()))}function Ro(e,t){return Sr(e.toString(16).padStart(2*t,"0"))}function Lo(e,t){return Ro(e,t).reverse()}function Do(e,t,r){let n;if("string"==typeof t)try{n=Sr(t)}catch(t){throw Error(e+" must be hex string or Uint8Array, cause: "+t)}else{if(!sr(t))throw Error(e+" must be hex string or Uint8Array");n=Uint8Array.from(t)}const s=n.length;if("number"==typeof r&&s!==r)throw Error(e+" of length "+r+" expected, got "+s);return n}function Mo(e){return Uint8Array.from(e)}const No=e=>"bigint"==typeof e&&Ao<=e;function Oo(e,t,r,n){if(!function(e,t,r){return No(e)&&No(t)&&No(r)&&t<=e&&e<r}(t,r,n))throw Error("expected valid "+e+": "+r+" <= n < "+n+", got "+t)}function Uo(e){let t;for(t=0;e>Ao;e>>=Io,t+=1);return t}const Fo=e=>(Io<<BigInt(e))-Io;function Bo(e,t,r={}){if(!e||"object"!=typeof e)throw Error("expected valid options object");function n(t,r,n){const s=e[t];if(n&&void 0===s)return;const i=typeof s;if(i!==r||null===s)throw Error(`param "${t}" is invalid: expected ${r}, got ${i}`)}Object.entries(t).forEach((([e,t])=>n(e,t,!1))),Object.entries(r).forEach((([e,t])=>n(e,t,!0)))}function qo(e){const t=new WeakMap;return(r,...n)=>{const s=t.get(r);if(void 0!==s)return s;const i=e(r,...n);return t.set(r,i),i}}const $o=BigInt(0),zo=BigInt(1),jo=BigInt(2),Vo=BigInt(3),Ko=BigInt(4),Ho=BigInt(5),Go=BigInt(7),Wo=BigInt(8),Xo=BigInt(9),Zo=BigInt(16);function Yo(e,t){const r=e%t;return r>=$o?r:t+r}function Qo(e,t,r){let n=e;for(;t-- >$o;)n*=n,n%=r;return n}function Jo(e,t){if(e===$o)throw Error("invert: expected non-zero number");if(t<=$o)throw Error("invert: expected positive modulus, got "+t);let r=Yo(e,t),n=t,s=$o,i=zo;for(;r!==$o;){const e=n%r,t=s-i*(n/r);n=r,r=e,s=i,i=t}if(n!==zo)throw Error("invert: does not exist");return Yo(s,t)}function ea(e,t,r){if(!e.eql(e.sqr(t),r))throw Error("Cannot find square root")}function ta(e,t){const r=(e.ORDER+zo)/Ko,n=e.pow(t,r);return ea(e,n,t),n}function ra(e,t){const r=(e.ORDER-Ho)/Wo,n=e.mul(t,jo),s=e.pow(n,r),i=e.mul(t,s),o=e.mul(e.mul(i,jo),s),a=e.mul(i,e.sub(o,e.ONE));return ea(e,a,t),a}function na(e){if(e<Vo)throw Error("sqrt is not defined for small field");let t=e-zo,r=0;for(;t%jo===$o;)t/=jo,r++;let n=jo;const s=la(e);for(;1===aa(s,n);)if(n++>1e3)throw Error("Cannot find square root: probably non-prime P");if(1===r)return ta;let i=s.pow(n,t);const o=(t+zo)/jo;return function(e,n){if(e.is0(n))return n;if(1!==aa(e,n))throw Error("Cannot find square root");let s=r,a=e.mul(e.ONE,i),c=e.pow(n,t),l=e.pow(n,o);for(;!e.eql(c,e.ONE);){if(e.is0(c))return e.ZERO;let t=1,r=e.sqr(c);for(;!e.eql(r,e.ONE);)if(t++,r=e.sqr(r),t===s)throw Error("Cannot find square root");const n=zo<<BigInt(s-t-1),i=e.pow(a,n);s=t,a=e.sqr(i),c=e.mul(c,a),l=e.mul(l,i)}return l}}function sa(e){return e%Ko===Vo?ta:e%Wo===Ho?ra:e%Zo===Xo?function(e){const t=la(e),r=na(e),n=r(t,t.neg(t.ONE)),s=r(t,n),i=r(t,t.neg(n)),o=(e+Go)/Zo;return(e,t)=>{let r=e.pow(t,o),a=e.mul(r,n);const c=e.mul(r,s),l=e.mul(r,i),u=e.eql(e.sqr(a),t),h=e.eql(e.sqr(c),t);r=e.cmov(r,a,u),a=e.cmov(l,c,h);const d=e.eql(e.sqr(a),t),p=e.cmov(r,a,d);return ea(e,p,t),p}}(e):na(e)}const ia=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function oa(e,t,r=!1){const n=Array(t.length).fill(r?e.ZERO:void 0),s=t.reduce(((t,r,s)=>e.is0(r)?t:(n[s]=t,e.mul(t,r))),e.ONE),i=e.inv(s);return t.reduceRight(((t,r,s)=>e.is0(r)?t:(n[s]=e.mul(t,n[s]),e.mul(t,r))),i),n}function aa(e,t){const r=(e.ORDER-zo)/jo,n=e.pow(t,r),s=e.eql(n,e.ONE),i=e.eql(n,e.ZERO),o=e.eql(n,e.neg(e.ONE));if(!s&&!i&&!o)throw Error("invalid Legendre symbol result");return s?1:i?0:-1}function ca(e,t){void 0!==t&&ir(t);const r=void 0!==t?t:e.toString(2).length;return{nBitLength:r,nByteLength:Math.ceil(r/8)}}function la(e,t,r=!1,n={}){if(e<=$o)throw Error("invalid field: expected ORDER > 0, got "+e);let s,i,o,a=!1;if("object"==typeof t&&null!=t){if(n.sqrt||r)throw Error("cannot specify opts in two arguments");const e=t;e.BITS&&(s=e.BITS),e.sqrt&&(i=e.sqrt),"boolean"==typeof e.isLE&&(r=e.isLE),"boolean"==typeof e.modFromBytes&&(a=e.modFromBytes),o=e.allowedLengths}else"number"==typeof t&&(s=t),n.sqrt&&(i=n.sqrt);const{nBitLength:c,nByteLength:l}=ca(e,s);if(l>2048)throw Error("invalid field: expected ORDER of <= 2048 bytes");let u;const h=Object.freeze({ORDER:e,isLE:r,BITS:c,BYTES:l,MASK:Fo(c),ZERO:$o,ONE:zo,allowedLengths:o,create(t){return Yo(t,e)},isValid(t){if("bigint"!=typeof t)throw Error("invalid field element: expected bigint, got "+typeof t);return $o<=t&&t<e},is0(e){return e===$o},isValidNot0(e){return!h.is0(e)&&h.isValid(e)},isOdd(e){return(e&zo)===zo},neg(t){return Yo(-t,e)},eql(e,t){return e===t},sqr(t){return Yo(t*t,e)},add(t,r){return Yo(t+r,e)},sub(t,r){return Yo(t-r,e)},mul(t,r){return Yo(t*r,e)},pow(e,t){return function(e,t,r){if(r<$o)throw Error("invalid exponent, negatives unsupported");if(r===$o)return e.ONE;if(r===zo)return t;let n=e.ONE,s=t;for(;r>$o;)r&zo&&(n=e.mul(n,s)),s=e.sqr(s),r>>=zo;return n}(h,e,t)},div(t,r){return Yo(t*Jo(r,e),e)},sqrN(e){return e*e},addN(e,t){return e+t},subN(e,t){return e-t},mulN(e,t){return e*t},inv(t){return Jo(t,e)},sqrt:i||(t=>(u||(u=sa(e)),u(h,t))),toBytes(e){return r?Lo(e,l):Ro(e,l)},fromBytes(t,n=!0){if(o){if(!o.includes(t.length)||t.length>l)throw Error("Field.fromBytes: expected "+o+" bytes, got "+t.length);const e=new Uint8Array(l);e.set(t,r?0:e.length-t.length),t=e}if(t.length!==l)throw Error("Field.fromBytes: expected "+l+" bytes, got "+t.length);let s=r?Po(t):To(t);if(a&&(s=Yo(s,e)),!n&&!h.isValid(s))throw Error("invalid field element: outside of range 0..ORDER");return s},invertBatch(e){return oa(h,e)},cmov(e,t,r){return r?t:e}});return Object.freeze(h)}function ua(e){if("bigint"!=typeof e)throw Error("field order must be bigint");const t=e.toString(2).length;return Math.ceil(t/8)}function ha(e){const t=ua(e);return t+Math.ceil(t/2)}const da=BigInt(0),pa=BigInt(1);function fa(e,t){const r=t.negate();return e?r:t}function ga(e,t){const r=oa(e.Fp,t.map((e=>e.Z)));return t.map(((t,n)=>e.fromAffine(t.toAffine(r[n]))))}function ma(e,t){if(!Number.isSafeInteger(e)||e<=0||e>t)throw Error("invalid window size, expected [1.."+t+"], got W="+e)}function ya(e,t){ma(e,t);const r=2**e;return{windows:Math.ceil(t/e)+1,windowSize:2**(e-1),mask:Fo(e),maxNumber:r,shiftBy:BigInt(e)}}function ba(e,t,r){const{windowSize:n,mask:s,maxNumber:i,shiftBy:o}=r;let a=Number(e&s),c=e>>o;a>n&&(a-=i,c+=pa);const l=t*n;return{nextN:c,offset:l+Math.abs(a)-1,isZero:0===a,isNeg:a<0,isNegF:t%2!=0,offsetF:l}}const wa=new WeakMap,va=new WeakMap;function Ea(e){return va.get(e)||1}function Sa(e){if(e!==da)throw Error("invalid wNAF")}class Aa{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,r=this.ZERO){let n=e;for(;t>da;)t&pa&&(r=r.add(n)),n=n.double(),t>>=pa;return r}precomputeWindow(e,t){const{windows:r,windowSize:n}=ya(t,this.bits),s=[];let i=e,o=i;for(let e=0;e<r;e++){o=i,s.push(o);for(let e=1;e<n;e++)o=o.add(i),s.push(o);i=o.double()}return s}wNAF(e,t,r){if(!this.Fn.isValid(r))throw Error("invalid scalar");let n=this.ZERO,s=this.BASE;const i=ya(e,this.bits);for(let e=0;e<i.windows;e++){const{nextN:o,offset:a,isZero:c,isNeg:l,isNegF:u,offsetF:h}=ba(r,e,i);r=o,c?s=s.add(fa(u,t[h])):n=n.add(fa(l,t[a]))}return Sa(r),{p:n,f:s}}wNAFUnsafe(e,t,r,n=this.ZERO){const s=ya(e,this.bits);for(let e=0;e<s.windows&&r!==da;e++){const{nextN:i,offset:o,isZero:a,isNeg:c}=ba(r,e,s);if(r=i,!a){const e=t[o];n=n.add(c?e.negate():e)}}return Sa(r),n}getPrecomputes(e,t,r){let n=wa.get(t);return n||(n=this.precomputeWindow(t,e),1!==e&&("function"==typeof r&&(n=r(n)),wa.set(t,n))),n}cached(e,t,r){const n=Ea(e);return this.wNAF(n,this.getPrecomputes(n,e,r),t)}unsafe(e,t,r,n){const s=Ea(e);return 1===s?this._unsafeLadder(e,t,n):this.wNAFUnsafe(s,this.getPrecomputes(s,e,r),t,n)}createCache(e,t){ma(t,this.bits),va.set(e,t),wa.delete(e)}hasCache(e){return 1!==Ea(e)}}function Ia(e,t,r,n){!function(e,t){if(!Array.isArray(e))throw Error("array expected");e.forEach(((e,r)=>{if(!(e instanceof t))throw Error("invalid point at index "+r)}))}(r,e),function(e,t){if(!Array.isArray(e))throw Error("array of scalars expected");e.forEach(((e,r)=>{if(!t.isValid(e))throw Error("invalid scalar at index "+r)}))}(n,t);const s=r.length,i=n.length;if(s!==i)throw Error("arrays of points and scalars must have equal length");const o=e.ZERO,a=Uo(BigInt(s));let c=1;a>12?c=a-3:a>4?c=a-2:a>0&&(c=2);const l=Fo(c),u=Array(Number(l)+1).fill(o);let h=o;for(let e=Math.floor((t.BITS-1)/c)*c;e>=0;e-=c){u.fill(o);for(let t=0;t<i;t++){const s=n[t],i=Number(s>>BigInt(e)&l);u[i]=u[i].add(r[t])}let t=o;for(let e=u.length-1,r=o;e>0;e--)r=r.add(u[e]),t=t.add(r);if(h=h.add(t),0!==e)for(let e=0;e<c;e++)h=h.double()}return h}function _a(e,t,r){if(t){if(t.ORDER!==e)throw Error("Field.ORDER must match order: Fp == p, Fn == n");return function(e){const t=ia.reduce(((e,t)=>(e[t]="function",e)),{ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"});Bo(e,t)}(t),t}return la(e,{isLE:r})}function Ca(e,t,r={},n){if(void 0===n&&(n="edwards"===e),!t||"object"!=typeof t)throw Error(`expected valid ${e} CURVE object`);for(const e of["p","n","h"]){const r=t[e];if(!("bigint"==typeof r&&r>da))throw Error(`CURVE.${e} must be positive bigint`)}const s=_a(t.p,r.Fp,n),i=_a(t.n,r.Fn,n),o=["Gx","Gy","a","weierstrass"===e?"b":"d"];for(const e of o)if(!s.isValid(t[e]))throw Error(`CURVE.${e} must be valid field element of CURVE.Fp`);return{CURVE:t=Object.freeze(Object.assign({},t)),Fp:s,Fn:i}}const xa=BigInt(0),ka=BigInt(1),Ta=BigInt(2),Pa=BigInt(8);function Ra(e,t,r={}){if("function"!=typeof t)throw Error('"hash" function param is required');Bo(r,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:n}=r,{BASE:s,Fp:i,Fn:o}=e,a=r.randomBytes||xr,c=r.adjustScalarBytes||(e=>e),l=r.domain||((e,t,r)=>{if(_o(r,"phflag"),t.length||r)throw Error("Contexts/pre-hash are not supported");return e});function u(e){return o.create(Po(e))}function h(e){const{head:r,prefix:n,scalar:i}=function(e){const r=m.secretKey;e=Do("private key",e,r);const n=Do("hashed private key",t(e),2*r),s=c(n.slice(0,r));return{head:s,prefix:n.slice(r,2*r),scalar:u(s)}}(e),o=s.multiply(i),a=o.toBytes();return{head:r,prefix:n,scalar:i,point:o,pointBytes:a}}function d(e){return h(e).pointBytes}function p(e=Uint8Array.of(),...r){const s=Ir(...r);return u(t(l(s,Do("context",e),!!n)))}const f={zip215:!0};const g=i.BYTES,m={secretKey:g,publicKey:g,signature:2*g,seed:g};function y(e=a(m.seed)){return Co(e,m.seed,"seed")}const b={getExtendedPublicKey:h,randomSecretKey:y,isValidSecretKey(e){return sr(e)&&e.length===o.BYTES},isValidPublicKey(t,r){try{return!!e.fromBytes(t,r)}catch(e){return!1}},toMontgomery(t){const{y:r}=e.fromBytes(t),n=m.publicKey,s=32===n;if(!s&&57!==n)throw Error("only defined for 25519 and 448");const o=s?i.div(ka+r,ka-r):i.div(r-ka,r+ka);return i.toBytes(o)},toMontgomerySecret(e){const r=m.secretKey;Co(e,r);const n=t(e.subarray(0,r));return c(n).subarray(0,r)},randomPrivateKey:y,precompute:(t=8,r=e.BASE)=>r.precompute(t,!1)};return Object.freeze({keygen(e){const t=b.randomSecretKey(e);return{secretKey:t,publicKey:d(t)}},getPublicKey:d,sign(e,t,r={}){e=Do("message",e),n&&(e=n(e));const{prefix:i,scalar:a,pointBytes:c}=h(t),l=p(r.context,i,e),u=s.multiply(l).toBytes(),d=p(r.context,u,c,e),f=o.create(l+d*a);if(!o.isValid(f))throw Error("sign failed: invalid s");return Co(Ir(u,o.toBytes(f)),m.signature,"result")},verify(t,r,i,o=f){const{context:a,zip215:c}=o,l=m.signature;t=Do("signature",t,l),r=Do("message",r),i=Do("publicKey",i,m.publicKey),void 0!==c&&_o(c,"zip215"),n&&(r=n(r));const u=l/2,h=t.subarray(0,u),d=Po(t.subarray(u,l));let g,y,b;try{g=e.fromBytes(i,c),y=e.fromBytes(h,c),b=s.multiplyUnsafe(d)}catch(e){return!1}if(!c&&g.isSmallOrder())return!1;const w=p(a,y.toBytes(),g.toBytes(),r);return y.add(g.multiplyUnsafe(w)).subtract(b).clearCofactor().is0()},utils:b,Point:e,lengths:m})}function La(e){const{CURVE:t,curveOpts:r,hash:n,eddsaOpts:s}=function(e){const t={a:e.a,d:e.d,p:e.Fp.ORDER,n:e.n,h:e.h,Gx:e.Gx,Gy:e.Gy},r={Fp:e.Fp,Fn:la(t.n,e.nBitLength,!0),uvRatio:e.uvRatio},n={randomBytes:e.randomBytes,adjustScalarBytes:e.adjustScalarBytes,domain:e.domain,prehash:e.prehash,mapToCurve:e.mapToCurve};return{CURVE:t,curveOpts:r,hash:e.hash,eddsaOpts:n}}(e),i=function(e,t={}){const r=Ca("edwards",e,t,t.FpFnLE),{Fp:n,Fn:s}=r;let i=r.CURVE;const{h:o}=i;Bo(t,{},{uvRatio:"function"});const a=Ta<<BigInt(8*s.BYTES)-ka,c=e=>n.create(e),l=t.uvRatio||((e,t)=>{try{return{isValid:!0,value:n.sqrt(n.div(e,t))}}catch(e){return{isValid:!1,value:xa}}});if(!((e,t,r,n)=>{const s=e.sqr(r),i=e.sqr(n),o=e.add(e.mul(t.a,s),i),a=e.add(e.ONE,e.mul(t.d,e.mul(s,i)));return e.eql(o,a)})(n,i,i.Gx,i.Gy))throw Error("bad curve params: generator point");function u(e,t,r=!1){return Oo("coordinate "+e,t,r?ka:xa,a),t}function h(e){if(!(e instanceof f))throw Error("ExtendedPoint expected")}const d=qo(((e,t)=>{const{X:r,Y:s,Z:i}=e,o=e.is0();null==t&&(t=o?Pa:n.inv(i));const a=c(r*t),l=c(s*t),u=n.mul(i,t);if(o)return{x:xa,y:ka};if(u!==ka)throw Error("invZ was invalid");return{x:a,y:l}})),p=qo((e=>{const{a:t,d:r}=i;if(e.is0())throw Error("bad point: ZERO");const{X:n,Y:s,Z:o,T:a}=e,l=c(n*n),u=c(s*s),h=c(o*o),d=c(h*h),p=c(l*t);if(c(h*c(p+u))!==c(d+c(r*c(l*u))))throw Error("bad point: equation left != right (1)");if(c(n*s)!==c(o*a))throw Error("bad point: equation left != right (2)");return!0}));class f{constructor(e,t,r,n){this.X=u("x",e),this.Y=u("y",t),this.Z=u("z",r,!0),this.T=u("t",n),Object.freeze(this)}static CURVE(){return i}static fromAffine(e){if(e instanceof f)throw Error("extended point not allowed");const{x:t,y:r}=e||{};return u("x",t),u("y",r),new f(t,r,ka,c(t*r))}static fromBytes(e,t=!1){const r=n.BYTES,{a:s,d:o}=i;e=Mo(Co(e,r,"point")),_o(t,"zip215");const u=Mo(e),h=e[r-1];u[r-1]=-129&h;const d=Po(u),p=t?a:n.ORDER;Oo("point.y",d,xa,p);const g=c(d*d),m=c(g-ka),y=c(o*g-s);let{isValid:b,value:w}=l(m,y);if(!b)throw Error("bad point: invalid y coordinate");const v=(w&ka)===ka,E=!!(128&h);if(!t&&w===xa&&E)throw Error("bad point: x=0 and x_0=1");return E!==v&&(w=c(-w)),f.fromAffine({x:w,y:d})}static fromHex(e,t=!1){return f.fromBytes(Do("point",e),t)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(e=8,t=!0){return g.createCache(this,e),t||this.multiply(Ta),this}assertValidity(){p(this)}equals(e){h(e);const{X:t,Y:r,Z:n}=this,{X:s,Y:i,Z:o}=e,a=c(t*o),l=c(s*n),u=c(r*o),d=c(i*n);return a===l&&u===d}is0(){return this.equals(f.ZERO)}negate(){return new f(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:e}=i,{X:t,Y:r,Z:n}=this,s=c(t*t),o=c(r*r),a=c(Ta*c(n*n)),l=c(e*s),u=t+r,h=c(c(u*u)-s-o),d=l+o,p=d-a,g=l-o,m=c(h*p),y=c(d*g),b=c(h*g),w=c(p*d);return new f(m,y,w,b)}add(e){h(e);const{a:t,d:r}=i,{X:n,Y:s,Z:o,T:a}=this,{X:l,Y:u,Z:d,T:p}=e,g=c(n*l),m=c(s*u),y=c(a*r*p),b=c(o*d),w=c((n+s)*(l+u)-g-m),v=b-y,E=b+y,S=c(m-t*g),A=c(w*v),I=c(E*S),_=c(w*S),C=c(v*E);return new f(A,I,C,_)}subtract(e){return this.add(e.negate())}multiply(e){if(!s.isValidNot0(e))throw Error("invalid scalar: expected 1 <= sc < curve.n");const{p:t,f:r}=g.cached(this,e,(e=>ga(f,e)));return ga(f,[t,r])[0]}multiplyUnsafe(e,t=f.ZERO){if(!s.isValid(e))throw Error("invalid scalar: expected 0 <= sc < curve.n");return e===xa?f.ZERO:this.is0()||e===ka?this:g.unsafe(this,e,(e=>ga(f,e)),t)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return g.unsafe(this,i.n).is0()}toAffine(e){return d(this,e)}clearCofactor(){return o===ka?this:this.multiplyUnsafe(o)}toBytes(){const{x:e,y:t}=this.toAffine(),r=n.toBytes(t);return r[r.length-1]|=e&ka?128:0,r}toHex(){return fr(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get ex(){return this.X}get ey(){return this.Y}get ez(){return this.Z}get et(){return this.T}static normalizeZ(e){return ga(f,e)}static msm(e,t){return Ia(f,s,e,t)}_setWindowSize(e){this.precompute(e)}toRawBytes(){return this.toBytes()}}f.BASE=new f(i.Gx,i.Gy,ka,c(i.Gx*i.Gy)),f.ZERO=new f(xa,ka,ka,xa),f.Fp=n,f.Fn=s;const g=new Aa(f,s.BITS);return f.BASE.precompute(8),f}(t,r);return function(e,t){const r=t.Point;return Object.assign({},t,{ExtendedPoint:r,CURVE:e,nBitLength:r.Fn.BITS,nByteLength:r.Fn.BYTES})}(e,Ra(i,n,s))}const Da=BigInt(0),Ma=BigInt(1),Na=BigInt(2);function Oa(e){const t=(Bo(r=e,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...r}));var r;const{P:n,type:s,adjustScalarBytes:i,powPminus2:o,randomBytes:a}=t,c="x25519"===s;if(!c&&"x448"!==s)throw Error("invalid type");const l=a||xr,u=c?255:448,h=c?32:56,d=c?BigInt(9):BigInt(5),p=c?BigInt(121665):BigInt(39081),f=c?Na**BigInt(254):Na**BigInt(447),g=c?BigInt(8)*Na**BigInt(251)-Ma:BigInt(4)*Na**BigInt(445)-Ma,m=f+g+Ma,y=e=>Yo(e,n),b=w(d);function w(e){return Lo(y(e),h)}function v(e,t){const r=function(e,t){Oo("u",e,Da,n),Oo("scalar",t,f,m);const r=t,s=e;let i=Ma,a=Da,c=e,l=Ma,h=Da;for(let e=BigInt(u-1);e>=Da;e--){const t=r>>e&Ma;h^=t,({x_2:i,x_3:c}=S(h,i,c)),({x_2:a,x_3:l}=S(h,a,l)),h=t;const n=i+a,o=y(n*n),u=i-a,d=y(u*u),f=o-d,g=c+l,m=y((c-l)*n),b=y(g*u),w=m+b,v=m-b;c=y(w*w),l=y(s*y(v*v)),i=y(o*d),a=y(f*(o+y(p*f)))}({x_2:i,x_3:c}=S(h,i,c)),({x_2:a,x_3:l}=S(h,a,l));const d=o(a);return y(i*d)}(function(e){const t=Do("u coordinate",e,h);return c&&(t[31]&=127),y(Po(t))}(t),function(e){return Po(i(Do("scalar",e,h)))}(e));if(r===Da)throw Error("invalid private or public key received");return w(r)}function E(e){return v(e,b)}function S(e,t,r){const n=y(e*(t-r));return{x_2:t=y(t-n),x_3:r=y(r+n)}}const A={secretKey:h,publicKey:h,seed:h},I=(e=l(h))=>(or(e,A.seed),e);const _={randomSecretKey:I,randomPrivateKey:I};return{keygen(e){const t=I(e);return{secretKey:t,publicKey:E(t)}},getSharedSecret(e,t){return v(e,t)},getPublicKey(e){return E(e)},scalarMult:v,scalarMultBase:E,utils:_,GuBytes:b.slice(),lengths:A}}const Ua=BigInt(1),Fa=BigInt(2),Ba=BigInt(3),qa=BigInt(5),$a=BigInt(8),za=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),ja=(()=>({p:za,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:$a,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")}))();function Va(e){const t=BigInt(10),r=BigInt(20),n=BigInt(40),s=BigInt(80),i=za,o=e*e%i*e%i,a=Qo(o,Fa,i)*o%i,c=Qo(a,Ua,i)*e%i,l=Qo(c,qa,i)*c%i,u=Qo(l,t,i)*l%i,h=Qo(u,r,i)*u%i,d=Qo(h,n,i)*h%i,p=Qo(d,s,i)*d%i,f=Qo(p,s,i)*d%i,g=Qo(f,t,i)*l%i;return{pow_p_5_8:Qo(g,Fa,i)*e%i,b2:o}}function Ka(e){return e[0]&=248,e[31]&=127,e[31]|=64,e}const Ha=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function Ga(e,t){const r=za,n=Yo(t*t*t,r),s=Yo(n*n*t,r);let i=Yo(e*n*Va(e*s).pow_p_5_8,r);const o=Yo(t*i*i,r),a=i,c=Yo(i*Ha,r),l=o===e,u=o===Yo(-e,r),h=o===Yo(-e*Ha,r);return l&&(i=a),(u||h)&&(i=c),(Yo(i,r)&zo)===zo&&(i=Yo(-i,r)),{isValid:l||u,value:i}}const Wa=(()=>la(ja.p,{isLE:!0}))(),Xa=(()=>({...ja,Fp:Wa,hash:sn,adjustScalarBytes:Ka,uvRatio:Ga}))(),Za=(()=>La(Xa))(),Ya=(()=>{const e=Wa.ORDER;return Oa({P:e,type:"x25519",powPminus2(t){const{pow_p_5_8:r,b2:n}=Va(t);return Yo(Qo(r,Ba,e)*n,e)},adjustScalarBytes:Ka})})();let Qa=class extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}},Ja=class extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}};var ec={get(e=globalThis){const t=e.crypto;if(null==t?.subtle)throw new Ja("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return t}};let tc;const rc=(async()=>{try{return await ec.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function nc(){const e=Za.utils.randomPrivateKey(),t=Za.getPublicKey(e),r=function(e,t){const r=new Uint8Array(64);for(let n=0;n<32;n++)r[n]=e[n],r[32+n]=t[n];return r}(e,t);return{privateKey:r,publicKey:t}}async function sc(e,t){return null==tc&&(tc=await rc),tc?async function(e,t){let r;r=64===e.length?e.subarray(0,32):e;const n={crv:"Ed25519",kty:"OKP",x:an(e.subarray(32),"base64url"),d:an(r,"base64url"),ext:!0,key_ops:["sign"]},s=await ec.get().subtle.importKey("jwk",n,{name:"Ed25519"},!0,["sign"]),i=await ec.get().subtle.sign({name:"Ed25519"},s,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(i,0,i.byteLength)}(e,t):function(e,t){const r=e.subarray(0,32);return Za.sign(t instanceof Uint8Array?t:t.subarray(),r)}(e,t)}async function ic(e,t,r){return null==tc&&(tc=await rc),tc?async function(e,t,r){if(e.buffer instanceof ArrayBuffer){const n=await ec.get().subtle.importKey("raw",e.buffer,{name:"Ed25519"},!1,["verify"]);return await ec.get().subtle.verify({name:"Ed25519"},n,t,r instanceof Uint8Array?r:r.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}(e,t,r):function(e,t,r){return Za.verify(t,r instanceof Uint8Array?r:r.subarray(),e)}(e,t,r)}function oc(e){return null!=e&&("function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally)}let ac=class{type="Ed25519";raw;constructor(e){this.raw=uc(e,32)}toMultihash(){return Be.digest(Gc(this))}toCID(){return Ke.createV1(114,this.toMultihash())}toString(){return he.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&$s(this.raw,e.raw)}verify(e,t,r){r?.signal?.throwIfAborted();const n=ic(this.raw,t,e);return oc(n)?n.then((e=>(r?.signal?.throwIfAborted(),e))):n}};class cc{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=uc(e,64),this.publicKey=new ac(t)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&$s(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const r=sc(this.raw,e);return oc(r)?r.then((e=>(t?.signal?.throwIfAborted(),e))):(t?.signal?.throwIfAborted(),r)}}function lc(e){return e=uc(e,32),new ac(e)}function uc(e,t){if((e=Uint8Array.from(e??[])).length!==t)throw new Nn(`Key must be a Uint8Array of length ${t}, got ${e.length}`);return e}var hc,dc,pc,fc;function gc(e){if(isNaN(e)||e<=0)throw new Nn("random bytes length must be a Number bigger than 0");return xr(e)}(e=>{e.RSA="RSA",e.Ed25519="Ed25519",e.secp256k1="secp256k1",e.ECDSA="ECDSA"})(hc||(hc={})),(e=>{e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.secp256k1=2]="secp256k1",e[e.ECDSA=3]="ECDSA"})(dc||(dc={})),(hc||(hc={})).codec=()=>Yt(dc),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),hc.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.Type=hc.codec().decode(e);break;case 2:r.Data=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(pc||(pc={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),hc.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.Type=hc.codec().decode(e);break;case 2:r.Data=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(fc||(fc={}));let mc=class{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return null==this._raw&&(this._raw=function(e){if(null==e.n||null==e.e)throw new Nn("JWK was missing components");return lo([yc,co(lo([ao(tt(e.n,"base64url")),ao(tt(e.e,"base64url"))]))]).subarray()}(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return Ke.createV1(114,this._multihash)}toString(){return he.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&$s(this.raw,e.raw)}verify(e,t,r){return async function(e,t,r,n){const s=await ec.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await ec.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,t,r instanceof Uint8Array?r:r.subarray());return n?.signal?.throwIfAborted(),i}(this.jwk,t,e,r)}};const yc=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function bc(e,t){if(e.byteLength>=1062)throw new On("Key size is too large");return function(e,t,r){const n=function(e){const t=no(e[1],{offset:0});return{kty:"RSA",n:an(t[0],"base64url"),e:an(t[1],"base64url")}}(e);if(null==r){r=Ne(18,on(pc.encode({Type:hc.RSA,Data:t})))}return new mc(n,r)}(no(e,{offset:0}),e,t)}class wc extends _r{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,ar(e);const r=Ar(t);if(this.iHash=e.create(),"function"!=typeof this.iHash.update)throw Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const n=this.blockLen,s=new Uint8Array(n);s.set(r.length>n?e.create().update(r).digest():r);for(let e=0;e<s.length;e++)s[e]^=54;this.iHash.update(s),this.oHash=e.create();for(let e=0;e<s.length;e++)s[e]^=106;this.oHash.update(s),lr(s)}update(e){return cr(this),this.iHash.update(e),this}digestInto(e){cr(this),or(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:r,finished:n,destroyed:s,blockLen:i,outputLen:o}=this;return e.finished=n,e.destroyed=s,e.blockLen=i,e.outputLen=o,e.oHash=t._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const vc=(e,t,r)=>new wc(e,t).update(r).digest();vc.create=(e,t)=>new wc(e,t);const Ec=(e,t)=>(e+(e>=0?t:-t)/xc)/t;function Sc(e){if(!["compact","recovered","der"].includes(e))throw Error('Signature format must be "compact", "recovered", or "der"');return e}function Ac(e,t){const r={};for(let n of Object.keys(t))r[n]=void 0===e[n]?t[n]:e[n];return _o(r.lowS,"lowS"),_o(r.prehash,"prehash"),void 0!==r.format&&Sc(r.format),r}const Ic={Err:class extends Error{constructor(e=""){super(e)}},_tlv:{encode(e,t){const{Err:r}=Ic;if(e<0||e>256)throw new r("tlv.encode: wrong tag");if(1&t.length)throw new r("tlv.encode: unpadded data");const n=t.length/2,s=xo(n);if(s.length/2&128)throw new r("tlv.encode: long form length too big");const i=n>127?xo(s.length/2|128):"";return xo(e)+i+s+t},decode(e,t){const{Err:r}=Ic;let n=0;if(e<0||e>256)throw new r("tlv.encode: wrong tag");if(t.length<2||t[n++]!==e)throw new r("tlv.decode: wrong tlv");const s=t[n++];let i=0;if(!!(128&s)){const e=127&s;if(!e)throw new r("tlv.decode(long): indefinite length not supported");if(e>4)throw new r("tlv.decode(long): byte length is too big");const o=t.subarray(n,n+e);if(o.length!==e)throw new r("tlv.decode: length bytes not complete");if(0===o[0])throw new r("tlv.decode(long): zero leftmost byte");for(const e of o)i=i<<8|e;if(n+=e,i<128)throw new r("tlv.decode(long): not minimal encoding")}else i=s;const o=t.subarray(n,n+i);if(o.length!==i)throw new r("tlv.decode: wrong value length");return{v:o,l:t.subarray(n+i)}}},_int:{encode(e){const{Err:t}=Ic;if(e<_c)throw new t("integer: negative integers are not allowed");let r=xo(e);if(8&Number.parseInt(r[0],16)&&(r="00"+r),1&r.length)throw new t("unexpected DER parsing assertion: unpadded hex");return r},decode(e){const{Err:t}=Ic;if(128&e[0])throw new t("invalid signature integer: negative");if(0===e[0]&&!(128&e[1]))throw new t("invalid signature integer: unnecessary leading zero");return To(e)}},toSig(e){const{Err:t,_int:r,_tlv:n}=Ic,s=Do("signature",e),{v:i,l:o}=n.decode(48,s);if(o.length)throw new t("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,i),{v:l,l:u}=n.decode(2,c);if(u.length)throw new t("invalid signature: left bytes after parsing");return{r:r.decode(a),s:r.decode(l)}},hexFromSig(e){const{_tlv:t,_int:r}=Ic,n=t.encode(2,r.encode(e.r))+t.encode(2,r.encode(e.s));return t.encode(48,n)}},_c=BigInt(0),Cc=BigInt(1),xc=BigInt(2),kc=BigInt(3),Tc=BigInt(4);function Pc(e,t){const{BYTES:r}=e;let n;if("bigint"==typeof t)n=t;else{let s=Do("private key",t);try{n=e.fromBytes(s)}catch(e){throw Error(`invalid private key: expected ui8a of size ${r}, got ${typeof t}`)}}if(!e.isValidNot0(n))throw Error("invalid private key: out of range [1..N-1]");return n}function Rc(e,t={}){const r=Ca("weierstrass",e,t),{Fp:n,Fn:s}=r;let i=r.CURVE;const{h:o,n:a}=i;Bo(t,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:c}=t;if(c&&(!n.is0(i.a)||"bigint"!=typeof c.beta||!Array.isArray(c.basises)))throw Error('invalid endo: expected "beta": bigint and "basises": array');const l=Dc(n,s);function u(){if(!n.isOdd)throw Error("compression is not supported: Field does not have .isOdd()")}const h=t.toBytes||function(e,t,r){const{x:s,y:i}=t.toAffine(),o=n.toBytes(s);if(_o(r,"isCompressed"),r){u();return Ir(Lc(!n.isOdd(i)),o)}return Ir(Uint8Array.of(4),o,n.toBytes(i))},d=t.fromBytes||function(e){Co(e,void 0,"Point");const{publicKey:t,publicKeyUncompressed:r}=l,s=e.length,i=e[0],o=e.subarray(1);if(s!==t||2!==i&&3!==i){if(s===r&&4===i){const e=n.BYTES,t=n.fromBytes(o.subarray(0,e)),r=n.fromBytes(o.subarray(e,2*e));if(!f(t,r))throw Error("bad point: is not on curve");return{x:t,y:r}}throw Error(`bad point: got length ${s}, expected compressed=${t} or uncompressed=${r}`)}{const e=n.fromBytes(o);if(!n.isValid(e))throw Error("bad point: is not on curve, wrong x");const t=p(e);let r;try{r=n.sqrt(t)}catch(e){const t=e instanceof Error?": "+e.message:"";throw Error("bad point: is not on curve, sqrt error"+t)}u();return!(1&~i)!==n.isOdd(r)&&(r=n.neg(r)),{x:e,y:r}}};function p(e){const t=n.sqr(e),r=n.mul(t,e);return n.add(n.add(r,n.mul(e,i.a)),i.b)}function f(e,t){const r=n.sqr(t),s=p(e);return n.eql(r,s)}if(!f(i.Gx,i.Gy))throw Error("bad curve params: generator point");const g=n.mul(n.pow(i.a,kc),Tc),m=n.mul(n.sqr(i.b),BigInt(27));if(n.is0(n.add(g,m)))throw Error("bad curve params: a or b");function y(e,t,r=!1){if(!n.isValid(t)||r&&n.is0(t))throw Error("bad point coordinate "+e);return t}function b(e){if(!(e instanceof A))throw Error("ProjectivePoint expected")}function w(e){if(!c||!c.basises)throw Error("no endo");return function(e,t,r){const[[n,s],[i,o]]=t,a=Ec(o*e,r),c=Ec(-s*e,r);let l=e-a*n-c*i,u=-a*s-c*o;const h=l<_c,d=u<_c;h&&(l=-l),d&&(u=-u);const p=Fo(Math.ceil(Uo(r)/2))+Cc;if(l<_c||l>=p||u<_c||u>=p)throw Error("splitScalar (endomorphism): failed, k="+e);return{k1neg:h,k1:l,k2neg:d,k2:u}}(e,c.basises,s.ORDER)}const v=qo(((e,t)=>{const{X:r,Y:s,Z:i}=e;if(n.eql(i,n.ONE))return{x:r,y:s};const o=e.is0();null==t&&(t=o?n.ONE:n.inv(i));const a=n.mul(r,t),c=n.mul(s,t),l=n.mul(i,t);if(o)return{x:n.ZERO,y:n.ZERO};if(!n.eql(l,n.ONE))throw Error("invZ was invalid");return{x:a,y:c}})),E=qo((e=>{if(e.is0()){if(t.allowInfinityPoint&&!n.is0(e.Y))return;throw Error("bad point: ZERO")}const{x:r,y:s}=e.toAffine();if(!n.isValid(r)||!n.isValid(s))throw Error("bad point: x or y not field elements");if(!f(r,s))throw Error("bad point: equation left != right");if(!e.isTorsionFree())throw Error("bad point: not in prime-order subgroup");return!0}));function S(e,t,r,s,i){return r=new A(n.mul(r.X,e),r.Y,r.Z),t=fa(s,t),r=fa(i,r),t.add(r)}class A{constructor(e,t,r){this.X=y("x",e),this.Y=y("y",t,!0),this.Z=y("z",r),Object.freeze(this)}static CURVE(){return i}static fromAffine(e){const{x:t,y:r}=e||{};if(!e||!n.isValid(t)||!n.isValid(r))throw Error("invalid affine point");if(e instanceof A)throw Error("projective point not allowed");return n.is0(t)&&n.is0(r)?A.ZERO:new A(t,r,n.ONE)}static fromBytes(e){const t=A.fromAffine(d(Co(e,void 0,"point")));return t.assertValidity(),t}static fromHex(e){return A.fromBytes(Do("pointHex",e))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(e=8,t=!0){return _.createCache(this,e),t||this.multiply(kc),this}assertValidity(){E(this)}hasEvenY(){const{y:e}=this.toAffine();if(!n.isOdd)throw Error("Field doesn't support isOdd");return!n.isOdd(e)}equals(e){b(e);const{X:t,Y:r,Z:s}=this,{X:i,Y:o,Z:a}=e,c=n.eql(n.mul(t,a),n.mul(i,s)),l=n.eql(n.mul(r,a),n.mul(o,s));return c&&l}negate(){return new A(this.X,n.neg(this.Y),this.Z)}double(){const{a:e,b:t}=i,r=n.mul(t,kc),{X:s,Y:o,Z:a}=this;let c=n.ZERO,l=n.ZERO,u=n.ZERO,h=n.mul(s,s),d=n.mul(o,o),p=n.mul(a,a),f=n.mul(s,o);return f=n.add(f,f),u=n.mul(s,a),u=n.add(u,u),c=n.mul(e,u),l=n.mul(r,p),l=n.add(c,l),c=n.sub(d,l),l=n.add(d,l),l=n.mul(c,l),c=n.mul(f,c),u=n.mul(r,u),p=n.mul(e,p),f=n.sub(h,p),f=n.mul(e,f),f=n.add(f,u),u=n.add(h,h),h=n.add(u,h),h=n.add(h,p),h=n.mul(h,f),l=n.add(l,h),p=n.mul(o,a),p=n.add(p,p),h=n.mul(p,f),c=n.sub(c,h),u=n.mul(p,d),u=n.add(u,u),u=n.add(u,u),new A(c,l,u)}add(e){b(e);const{X:t,Y:r,Z:s}=this,{X:o,Y:a,Z:c}=e;let l=n.ZERO,u=n.ZERO,h=n.ZERO;const d=i.a,p=n.mul(i.b,kc);let f=n.mul(t,o),g=n.mul(r,a),m=n.mul(s,c),y=n.add(t,r),w=n.add(o,a);y=n.mul(y,w),w=n.add(f,g),y=n.sub(y,w),w=n.add(t,s);let v=n.add(o,c);return w=n.mul(w,v),v=n.add(f,m),w=n.sub(w,v),v=n.add(r,s),l=n.add(a,c),v=n.mul(v,l),l=n.add(g,m),v=n.sub(v,l),h=n.mul(d,w),l=n.mul(p,m),h=n.add(l,h),l=n.sub(g,h),h=n.add(g,h),u=n.mul(l,h),g=n.add(f,f),g=n.add(g,f),m=n.mul(d,m),w=n.mul(p,w),g=n.add(g,m),m=n.sub(f,m),m=n.mul(d,m),w=n.add(w,m),f=n.mul(g,w),u=n.add(u,f),f=n.mul(v,w),l=n.mul(y,l),l=n.sub(l,f),f=n.mul(y,g),h=n.mul(v,h),h=n.add(h,f),new A(l,u,h)}subtract(e){return this.add(e.negate())}is0(){return this.equals(A.ZERO)}multiply(e){const{endo:r}=t;if(!s.isValidNot0(e))throw Error("invalid scalar: out of range");let n,i;const o=e=>_.cached(this,e,(e=>ga(A,e)));if(r){const{k1neg:t,k1:s,k2neg:a,k2:c}=w(e),{p:l,f:u}=o(s),{p:h,f:d}=o(c);i=u.add(d),n=S(r.beta,l,h,t,a)}else{const{p:t,f:r}=o(e);n=t,i=r}return ga(A,[n,i])[0]}multiplyUnsafe(e){const{endo:r}=t,n=this;if(!s.isValid(e))throw Error("invalid scalar: out of range");if(e===_c||n.is0())return A.ZERO;if(e===Cc)return n;if(_.hasCache(this))return this.multiply(e);if(r){const{k1neg:t,k1:s,k2neg:i,k2:o}=w(e),{p1:a,p2:c}=function(e,t,r,n){let s=t,i=e.ZERO,o=e.ZERO;for(;r>da||n>da;)r&pa&&(i=i.add(s)),n&pa&&(o=o.add(s)),s=s.double(),r>>=pa,n>>=pa;return{p1:i,p2:o}}(A,n,s,o);return S(r.beta,a,c,t,i)}return _.unsafe(n,e)}multiplyAndAddUnsafe(e,t,r){const n=this.multiplyUnsafe(t).add(e.multiplyUnsafe(r));return n.is0()?void 0:n}toAffine(e){return v(this,e)}isTorsionFree(){const{isTorsionFree:e}=t;return o===Cc||(e?e(A,this):_.unsafe(this,a).is0())}clearCofactor(){const{clearCofactor:e}=t;return o===Cc?this:e?e(A,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(e=!0){return _o(e,"isCompressed"),this.assertValidity(),h(A,this,e)}toHex(e=!0){return fr(this.toBytes(e))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(e=!0){return this.toBytes(e)}_setWindowSize(e){this.precompute(e)}static normalizeZ(e){return ga(A,e)}static msm(e,t){return Ia(A,s,e,t)}static fromPrivateKey(e){return A.BASE.multiply(Pc(s,e))}}A.BASE=new A(i.Gx,i.Gy,n.ONE),A.ZERO=new A(n.ZERO,n.ONE,n.ZERO),A.Fp=n,A.Fn=s;const I=s.BITS,_=new Aa(A,t.endo?Math.ceil(I/2):I);return A.BASE.precompute(8),A}function Lc(e){return Uint8Array.of(e?2:3)}function Dc(e,t){return{secretKey:t.BYTES,publicKey:1+e.BYTES,publicKeyUncompressed:1+2*e.BYTES,publicKeyHasPrefix:!0,signature:2*t.BYTES}}function Mc(e,t={}){const{Fn:r}=e,n=t.randomBytes||xr,s=Object.assign(Dc(e.Fp,r),{seed:ha(r.ORDER)});function i(e){try{return!!Pc(r,e)}catch(e){return!1}}function o(e=n(s.seed)){return function(e,t,r=!1){const n=e.length,s=ua(t),i=ha(t);if(n<16||n<i||n>1024)throw Error("expected "+i+"-1024 bytes of input, got "+n);const o=Yo(r?Po(e):To(e),t-zo)+zo;return r?Lo(o,s):Ro(o,s)}(Co(e,s.seed,"seed"),r.ORDER)}function a(t,n=!0){return e.BASE.multiply(Pc(r,t)).toBytes(n)}function c(t){if("bigint"==typeof t)return!1;if(t instanceof e)return!0;const{secretKey:n,publicKey:i,publicKeyUncompressed:o}=s;if(r.allowedLengths||n===i)return;const a=Do("key",t).length;return a===i||a===o}const l={isValidSecretKey:i,isValidPublicKey(t,r){const{publicKey:n,publicKeyUncompressed:i}=s;try{const s=t.length;return(!0!==r||s===n)&&((!1!==r||s===i)&&!!e.fromBytes(t))}catch(e){return!1}},randomSecretKey:o,isValidPrivateKey:i,randomPrivateKey:o,normPrivateKeyToScalar(e){return Pc(r,e)},precompute:(t=8,r=e.BASE)=>r.precompute(t,!1)};return Object.freeze({getPublicKey:a,getSharedSecret(t,n,s=!0){if(!0===c(t))throw Error("first arg must be private key");if(!1===c(n))throw Error("second arg must be public key");const i=Pc(r,t);return e.fromHex(n).multiply(i).toBytes(s)},keygen(e){const t=o(e);return{secretKey:t,publicKey:a(t)}},Point:e,utils:l,lengths:s})}function Nc(e,t,r={}){ar(t),Bo(r,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=r.randomBytes||xr,s=r.hmac||((e,...r)=>vc(t,e,Ir(...r))),{Fp:i,Fn:o}=e,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:u,getSharedSecret:h,utils:d,lengths:p}=Mc(e,r),f={prehash:!1,lowS:"boolean"==typeof r.lowS&&r.lowS,format:void 0,extraEntropy:!1},g="compact";function m(e){return e>a>>Cc}function y(e,t){if(!o.isValidNot0(t))throw Error(`invalid signature ${e}: out of range 1..Point.Fn.ORDER`);return t}class b{constructor(e,t,r){this.r=y("r",e),this.s=y("s",t),null!=r&&(this.recovery=r),Object.freeze(this)}static fromBytes(e,t=g){let r;if(function(e,t){Sc(t);const r=p.signature;Co(e,"compact"===t?r:"recovered"===t?r+1:void 0,t+" signature")}(e,t),"der"===t){const{r:t,s:r}=Ic.toSig(Co(e));return new b(t,r)}"recovered"===t&&(r=e[0],t="compact",e=e.subarray(1));const n=o.BYTES,s=e.subarray(0,n),i=e.subarray(n,2*n);return new b(o.fromBytes(s),o.fromBytes(i),r)}static fromHex(e,t){return this.fromBytes(Sr(e),t)}addRecoveryBit(e){return new b(this.r,this.s,e)}recoverPublicKey(t){const r=i.ORDER,{r:n,s,recovery:c}=this;if(null==c||![0,1,2,3].includes(c))throw Error("recovery id invalid");if(a*xc<r&&c>1)throw Error("recovery id is ambiguous for h>1 curve");const l=2===c||3===c?n+a:n;if(!i.isValid(l))throw Error("recovery id 2 or 3 invalid");const u=i.toBytes(l),h=e.fromBytes(Ir(Lc(!(1&c)),u)),d=o.inv(l),p=v(Do("msgHash",t)),f=o.create(-p*d),g=o.create(s*d),m=e.BASE.multiplyUnsafe(f).add(h.multiplyUnsafe(g));if(m.is0())throw Error("point at infinify");return m.assertValidity(),m}hasHighS(){return m(this.s)}toBytes(e=g){if(Sc(e),"der"===e)return Sr(Ic.hexFromSig(this));const t=o.toBytes(this.r),r=o.toBytes(this.s);if("recovered"===e){if(null==this.recovery)throw Error("recovery bit must be present");return Ir(Uint8Array.of(this.recovery),t,r)}return Ir(t,r)}toHex(e){return fr(this.toBytes(e))}assertValidity(){}static fromCompact(e){return b.fromBytes(Do("sig",e),"compact")}static fromDER(e){return b.fromBytes(Do("sig",e),"der")}normalizeS(){return this.hasHighS()?new b(this.r,o.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return fr(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return fr(this.toBytes("compact"))}}const w=r.bits2int||function(e){if(e.length>8192)throw Error("input is too large");const t=To(e),r=8*e.length-c;return r>0?t>>BigInt(r):t},v=r.bits2int_modN||function(e){return o.create(w(e))},E=Fo(c);function S(e){return Oo("num < 2^"+c,e,_c,E),o.toBytes(e)}function A(e,r){return Co(e,void 0,"message"),r?Co(t(e),void 0,"prehashed message"):e}return Object.freeze({keygen:l,getPublicKey:u,getSharedSecret:h,utils:d,lengths:p,Point:e,sign(r,i,a={}){r=Do("message",r);const{seed:c,k2sig:l}=function(t,r,s){if(["recovered","canonical"].some((e=>e in s)))throw Error("sign() legacy options not supported");const{lowS:i,prehash:a,extraEntropy:c}=Ac(s,f);t=A(t,a);const l=v(t),u=Pc(o,r),h=[S(u),S(l)];if(null!=c&&!1!==c){const e=!0===c?n(p.secretKey):c;h.push(Do("extraEntropy",e))}const d=Ir(...h),g=l;return{seed:d,k2sig(t){const r=w(t);if(!o.isValidNot0(r))return;const n=o.inv(r),s=e.BASE.multiply(r).toAffine(),a=o.create(s.x);if(a===_c)return;const c=o.create(n*o.create(g+a*u));if(c===_c)return;let l=(s.x===a?0:2)|Number(s.y&Cc),h=c;return i&&m(c)&&(h=o.neg(c),l^=1),new b(a,h,l)}}}(r,i,a),u=function(e,t,r){if("number"!=typeof e||e<2)throw Error("hashLen must be a number");if("number"!=typeof t||t<2)throw Error("qByteLen must be a number");if("function"!=typeof r)throw Error("hmacFn must be a function");const n=e=>new Uint8Array(e),s=e=>Uint8Array.of(e);let i=n(e),o=n(e),a=0;const c=()=>{i.fill(1),o.fill(0),a=0},l=(...e)=>r(o,i,...e),u=(e=n(0))=>{o=l(s(0),e),i=l(),0!==e.length&&(o=l(s(1),e),i=l())},h=()=>{if(a++>=1e3)throw Error("drbg: tried 1000 values");let e=0;const r=[];for(;e<t;){i=l();const t=i.slice();r.push(t),e+=i.length}return Ir(...r)};return(e,t)=>{let r;for(c(),u(e);!(r=t(h()));)u();return c(),r}}(t.outputLen,o.BYTES,s);return u(c,l)},verify(t,r,n,s={}){const{lowS:i,prehash:a,format:c}=Ac(s,f);if(n=Do("publicKey",n),r=A(Do("message",r),a),"strict"in s)throw Error("options.strict was renamed to lowS");const l=void 0===c?function(e){let t;const r="string"==typeof e||sr(e),n=!r&&null!==e&&"object"==typeof e&&"bigint"==typeof e.r&&"bigint"==typeof e.s;if(!r&&!n)throw Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(n)t=new b(e.r,e.s);else if(r){try{t=b.fromBytes(Do("sig",e),"der")}catch(e){if(!(e instanceof Ic.Err))throw e}if(!t)try{t=b.fromBytes(Do("sig",e),"compact")}catch(e){return!1}}return t||!1}(t):b.fromBytes(Do("sig",t),c);if(!1===l)return!1;try{const t=e.fromBytes(n);if(i&&l.hasHighS())return!1;const{r:s,s:a}=l,c=v(r),u=o.inv(a),h=o.create(c*u),d=o.create(s*u),p=e.BASE.multiplyUnsafe(h).add(t.multiplyUnsafe(d));if(p.is0())return!1;return o.create(p.x)===s}catch(e){return!1}},recoverPublicKey(e,t,r={}){const{prehash:n}=Ac(r,f);return t=A(t,n),b.fromBytes(e,"recovered").recoverPublicKey(t).toBytes()},Signature:b,hash:t})}function Oc(e){const{CURVE:t,curveOpts:r}=function(e){const t={a:e.a,b:e.b,p:e.Fp.ORDER,n:e.n,h:e.h,Gx:e.Gx,Gy:e.Gy},r=e.Fp;let n=e.allowedPrivateKeyLengths?Array.from(new Set(e.allowedPrivateKeyLengths.map((e=>Math.ceil(e/2))))):void 0;return{CURVE:t,curveOpts:{Fp:r,Fn:la(t.n,{BITS:e.nBitLength,allowedLengths:n,modFromBytes:e.wrapPrivateKey}),allowInfinityPoint:e.allowInfinityPoint,endo:e.endo,isTorsionFree:e.isTorsionFree,clearCofactor:e.clearCofactor,fromBytes:e.fromBytes,toBytes:e.toBytes}}}(e),n={hmac:e.hmac,randomBytes:e.randomBytes,lowS:e.lowS,bits2int:e.bits2int,bits2int_modN:e.bits2int_modN};return{CURVE:t,curveOpts:r,hash:e.hash,ecdsaOpts:n}}function Uc(e){const{CURVE:t,curveOpts:r,hash:n,ecdsaOpts:s}=Oc(e);return function(e,t){const r=t.Point;return Object.assign({},t,{ProjectivePoint:r,CURVE:Object.assign({},e,ca(r.Fn.ORDER,r.Fn.BITS))})}(e,Nc(Rc(t,r),n,s))}const Fc={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Bc={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},qc=BigInt(2);const $c=la(Fc.p,{sqrt(e){const t=Fc.p,r=BigInt(3),n=BigInt(6),s=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=e*e*e%t,u=l*l*e%t,h=Qo(u,r,t)*u%t,d=Qo(h,r,t)*u%t,p=Qo(d,qc,t)*l%t,f=Qo(p,s,t)*p%t,g=Qo(f,i,t)*f%t,m=Qo(g,a,t)*g%t,y=Qo(m,c,t)*m%t,b=Qo(y,a,t)*g%t,w=Qo(b,r,t)*u%t,v=Qo(w,o,t)*f%t,E=Qo(v,n,t)*l%t,S=Qo(E,qc,t);if(!$c.eql($c.sqr(S),e))throw Error("Cannot find square root");return S}}),zc=function(e,t){const r=t=>Uc({...e,hash:t});return{...r(t),create:r}}({...Fc,Fp:$c,lowS:!0,endo:Bc},nn);let jc=class{type="secp256k1";raw;_key;constructor(e){this._key=function(e){try{return zc.ProjectivePoint.fromHex(e),e}catch(e){throw new On(e+"")}}(e),this.raw=function(e){const t=zc.ProjectivePoint.fromHex(e).toRawBytes(!0);return t}(this._key)}toMultihash(){return Be.digest(Gc(this))}toCID(){return Ke.createV1(114,this.toMultihash())}toString(){return he.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&$s(this.raw,e.raw)}verify(e,t,r){return function(e,t,r,n){const s=$e.digest(r instanceof Uint8Array?r:r.subarray());if(oc(s))return s.then((({digest:r})=>(n?.signal?.throwIfAborted(),zc.verify(t,r,e)))).catch((e=>{if("AbortError"===e.name)throw e;throw new Qa(e+"")}));try{return n?.signal?.throwIfAborted(),zc.verify(t,s.digest,e)}catch(e){throw new Qa(e+"")}}(this._key,t,e,r)}};function Vc(e){return new jc(e)}async function Kc(){return async function(){const{privateKey:e,publicKey:t}=nc();return new cc(e,t)}()}function Hc(e,t){const{Type:r,Data:n}=pc.decode(e),s=n??new Uint8Array;switch(r){case hc.RSA:return bc(s,t);case hc.Ed25519:return lc(s);case hc.secp256k1:return Vc(s);case hc.ECDSA:return vo(s);default:throw new ns}}function Gc(e){return pc.encode({Type:hc[e.type],Data:e.raw})}const Wc=Symbol.for("nodejs.util.inspect.custom");let Xc=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Cn]=!0;toString(){return null==this.string&&(this.string=he.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ke.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return $s(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return $s(this.multihash.bytes,e.toMultihash().bytes);throw Error("not valid Id")}[Wc](){return`PeerId(${this.toString()})`}},Zc=class extends Xc{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},Yc=class extends Xc{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},Qc=class extends Xc{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};class Jc{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=Be.digest(tt(this.url))}[Wc](){return`PeerId(${this.url})`}[Cn]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ke.createV1(2336,this.toMultihash())}toJSON(){return this.toString()}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=an(e)),e.toString()===this.toString())}}function el(e){let t;if("1"!==e.charAt(0)&&"Q"!==e.charAt(0)){if(e.startsWith("k51qzi5uqu5")||e.startsWith("kzwfwjn5ji4")||e.startsWith("k2k4r8")||e.startsWith("bafz"))return nl(Ke.parse(e));throw new Nn('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return t=Oe(he.decode("z"+e)),rl(t)}function tl(e){if("Ed25519"===e.type)return new Yc({multihash:e.toCID().multihash,publicKey:e});if("secp256k1"===e.type)return new Qc({multihash:e.toCID().multihash,publicKey:e});if("RSA"===e.type)return new Zc({multihash:e.toCID().multihash,publicKey:e});throw new ns}function rl(e){if(function(e){return e.code===$e.code}(e))return new Zc({multihash:e});if(function(e){return e.code===Be.code}(e))try{const t=function(e){const{Type:t,Data:r}=pc.decode(e.digest),n=r??new Uint8Array;switch(t){case hc.Ed25519:return lc(n);case hc.secp256k1:return Vc(n);case hc.ECDSA:return vo(n);default:throw new ns}}(e);if("Ed25519"===t.type)return new Yc({multihash:e,publicKey:t});if("secp256k1"===t.type)return new Qc({multihash:e,publicKey:t})}catch(t){const r=an(e.digest);return new Jc(new URL(r))}throw new Gn("Supplied PeerID Multihash is invalid")}function nl(e){if(null==e?.multihash||null==e.version||1===e.version&&114!==e.code&&2336!==e.code)throw new Hn("Supplied PeerID CID is invalid");if(2336===e.code){const t=an(e.multihash.digest);return new Jc(new URL(t))}return rl(e.multihash)}class sl extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class il extends Error{static name="ValidationError";name="ValidationError"}class ol extends Error{static name="InvalidParametersError";name="InvalidParametersError"}class al extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}const cl=new class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,r=e();return void 0===r&&(this.index=t),r}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically((()=>{const t=this.readChar();if(t===e)return t}))}readSeparator(e,t,r){return this.readAtomically((()=>{if(!(t>0&&void 0===this.readGivenChar(e)))return r()}))}readNumber(e,t,r,n){return this.readAtomically((()=>{let s=0,i=0;const o=this.peekChar();if(void 0===o)return;const a="0"===o,c=2**(8*n)-1;for(;;){const r=this.readAtomically((()=>{const t=this.readChar();if(void 0===t)return;const r=Number.parseInt(t,e);return Number.isNaN(r)?void 0:r}));if(void 0===r)break;if(s*=e,s+=r,s>c)return;if(i+=1,void 0!==t&&i>t)return}return 0===i||!r&&a&&i>1?void 0:s}))}readIPv4Addr(){return this.readAtomically((()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const r=this.readSeparator(".",t,(()=>this.readNumber(10,3,!1,1)));if(void 0===r)return;e[t]=r}return e}))}readIPv6Addr(){const e=e=>{for(let t=0;t<e.length/2;t++){const r=2*t;if(t<e.length-3){const n=this.readSeparator(":",t,(()=>this.readIPv4Addr()));if(void 0!==n)return e[r]=n[0],e[r+1]=n[1],e[r+2]=n[2],e[r+3]=n[3],[r+4,!0]}const n=this.readSeparator(":",t,(()=>this.readNumber(16,4,!0,2)));if(void 0===n)return[r,!1];e[r]=n>>8,e[r+1]=255&n}return[e.length,!1]};return this.readAtomically((()=>{const t=new Uint8Array(16),[r,n]=e(t);if(16===r)return t;if(n)return;if(void 0===this.readGivenChar(":"))return;if(void 0===this.readGivenChar(":"))return;const s=new Uint8Array(14),i=16-(r+2),[o]=e(s.subarray(0,i));return t.set(s.subarray(0,o),16-o),t}))}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};function ll(e){if(!(e.length>15))return cl.new(e).parseWith((()=>cl.readIPv4Addr()))}function ul(e){if(e.includes("%")&&(e=e.split("%")[0]),!(e.length>45))return cl.new(e).parseWith((()=>cl.readIPv6Addr()))}function hl(e,t=!1){if(e.includes("%")&&(e=e.split("%")[0]),e.length>45)return;const r=cl.new(e).parseWith((()=>cl.readIPAddr()));return r?t&&4===r.length?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,r[0],r[1],r[2],r[3]]):r:void 0}function dl(e){return!!ll(e)}function pl(e){return!!ul(e)}const fl=41,gl=42;function ml(e){return t=>an(t,e)}function yl(e){return t=>tt(t,e)}function bl(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function wl(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function vl(e){const t=e.subarray(0,e.length-2),r=e.subarray(e.length-2);return`${an(t,"base32")}:${bl(r)}`}const El=e=>{e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach(((e,r)=>{const n=parseInt(e,10);if(isNaN(n)||n<0||n>255)throw new sl("Invalid byte value in IP address");t[r]=n})),t};const Sl=Object.values(Ze).map((e=>e.decoder)),Al=(()=>{let e=Sl[0].or(Sl[1]);return Sl.slice(2).forEach((t=>e=e.or(t))),e})();const Il=function(...e){return t=>{for(const r of e)r(t)}}((function(e){if(parseInt(e).toString()!==e)throw new il("Value must be an integer")}),(function(e){if(e<0)throw new il("Value must be a positive integer, or zero")}),(_l=65535,e=>{if(e>_l)throw new il("Value must be smaller than or equal to "+_l)}));var _l;const Cl=-1;const xl=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new al(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach((t=>{this.protocolsByName.set(t,e)}))}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach((e=>{this.protocolsByName.delete(e)})))}},kl=[{code:4,name:"ip4",size:32,valueToBytes:El,bytesToValue(e){if(4!==e.byteLength)throw new sl("IPv4 address was incorrect length");const t=[];for(let r=0;r<e.byteLength;r++)t.push(e[r]);return t.join(".")},validate(e){if(!dl(e))throw new il(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:wl,bytesToValue:bl,validate:Il},{code:273,name:"udp",size:16,valueToBytes:wl,bytesToValue:bl,validate:Il},{code:33,name:"dccp",size:16,valueToBytes:wl,bytesToValue:bl,validate:Il},{code:fl,name:"ip6",size:128,valueToBytes(e){let t=0;const r=(e=e.toString().trim()).split(":",8);let n;for(n=0;n<r.length;n++){let e;dl(r[n])&&(e=El(r[n]),r[n]=an(e.subarray(0,2),"base16")),null!=e&&++n<8&&r.splice(n,0,an(e.subarray(2,4),"base16"))}if(""===r[0])for(;r.length<8;)r.unshift("0");else if(""===r[r.length-1])for(;r.length<8;)r.push("0");else if(r.length<8){for(n=0;n<r.length&&""!==r[n];n++);const e=[n,1];for(n=9-r.length;n>0;n--)e.push("0");r.splice.apply(r,e)}const s=new Uint8Array(t+16);for(n=0;n<r.length;n++){""===r[n]&&(r[n]="0");const e=parseInt(r[n],16);if(isNaN(e)||e<0||e>65535)throw new sl("Invalid byte value in IP address");s[t++]=e>>8&255,s[t++]=255&e}return s},bytesToValue(e){if(16!==e.byteLength)throw new sl("IPv6 address was incorrect length");const t=[];for(let r=0;r<e.byteLength;r+=2){const n=e[r],s=e[r+1],i=`${n.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}`;t.push(i)}const r=t.join(":");try{const e=new URL(`http://[${r}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new sl(`Invalid IPv6 address "${r}"`)}},stringToValue(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new sl(`Invalid IPv6 address "${e}"`)}},validate(e){if(!pl(e))throw new il(`Invalid IPv6 address "${e}"`)}},{code:gl,name:"ip6zone",size:Cl},{code:43,name:"ipcidr",size:8,bytesToValue:ml("base10"),valueToBytes:yl("base10")},{code:53,name:"dns",size:Cl,resolvable:!0},{code:54,name:"dns4",size:Cl,resolvable:!0},{code:55,name:"dns6",size:Cl,resolvable:!0},{code:56,name:"dnsaddr",size:Cl,resolvable:!0},{code:132,name:"sctp",size:16,valueToBytes:wl,bytesToValue:bl,validate:Il},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:Cl,path:!0,stringToValue(e){return decodeURIComponent(e)},valueToString(e){return encodeURIComponent(e)}},{code:421,name:"p2p",aliases:["ipfs"],size:Cl,bytesToValue:ml("base58btc"),valueToBytes(e){return e.startsWith("Q")||e.startsWith("1")?yl("base58btc")(e):Ke.parse(e).multihash.bytes}},{code:444,name:"onion",size:96,bytesToValue:vl,valueToBytes(e){const t=e.split(":");if(2!==t.length)throw Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const r=tt(t[0],"base32"),n=parseInt(t[1],10);if(n<1||n>65536)throw Error("Port number is not in range(1, 65536)");const s=wl(n);return qs([r,s],r.length+s.length)}},{code:445,name:"onion3",size:296,bytesToValue:vl,valueToBytes(e){const t=e.split(":");if(2!==t.length)throw Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const r=Q.decode("b"+t[0]),n=parseInt(t[1],10);if(n<1||n>65536)throw Error("Port number is not in range(1, 65536)");const s=wl(n);return qs([r,s],r.length+s.length)}},{code:446,name:"garlic64",size:Cl},{code:447,name:"garlic32",size:Cl},{code:448,name:"tls"},{code:449,name:"sni",size:Cl},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:Cl,bytesToValue:function(e){return t=>e.encoder.encode(t)}(me),valueToBytes(e){return Al.decode(e)}},{code:480,name:"http"},{code:481,name:"http-path",size:Cl,stringToValue(e){return"/"+decodeURIComponent(e)},valueToString(e){return encodeURIComponent(e.substring(1))}},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:Cl}];function Tl(e,t,r){return null==e.size||0===e.size?0:e.size>0?e.size/8:d(t,r)}kl.forEach((e=>{xl.addProtocol(e)}));const Pl=Symbol.for("nodejs.util.inspect.custom"),Rl=Symbol.for("@multiformats/multiaddr"),Ll=[53,54,55,56];class Dl extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}function Ml(e){if(null==e&&(e="/"),Kl(e))return e.getComponents();if(e instanceof Uint8Array)return function(e){const t=[];let r=0;for(;r<e.length;){const n=d(e,r),s=xl.getProtocol(n),i=c(n),o=Tl(s,e,r+i);let a=0;o>0&&s.size===Cl&&(a=c(o));const l=i+a+o,u={code:n,name:s.name,bytes:e.subarray(r,r+l)};if(o>0){const t=r+i+a,n=e.subarray(t,t+o);u.value=s.bytesToValue?.(n)??an(n)}t.push(u),r+=l}return t}(e);if("string"==typeof e)return""===(e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""))&&(e="/"),function(e){if("/"!==e.charAt(0))throw new sl('String multiaddr must start with "/"');const t=[];let r="protocol",n="",s="";for(let i=1;i<e.length;i++){const o=e.charAt(i);"/"!==o&&("protocol"===r?s+=e.charAt(i):n+=e.charAt(i));const a=i===e.length-1;if("/"===o||a){const e=xl.getProtocol(s);if("protocol"===r){if(null==e.size||0===e.size){t.push({code:e.code,name:e.name}),n="",s="",r="protocol";continue}if(a)throw new sl(`Component ${s} was missing value`);r="value"}else if("value"===r){const i={code:e.code,name:e.name};if(null!=e.size&&0!==e.size){if(""===n)throw new sl(`Component ${s} was missing value`);i.value=e.stringToValue?.(n)??n}t.push(i),n="",s="",r="protocol"}}}if(""!==s&&""!==n)throw new sl("Incomplete multiaddr");return t}(e);if(Array.isArray(e))return e;throw new sl("Must be a string, Uint8Array, Component[], or another Multiaddr")}class Nl{[Rl]=!0;#t;#r;#n;constructor(e="/",t={}){this.#t=Ml(e),!1!==t.validate&&function(e){e.getComponents().forEach((e=>{const t=xl.getProtocol(e.code);null!=e.value&&t.validate?.(e.value)}))}(this)}get bytes(){return null==this.#n&&(this.#n=function(e){let t=0;const r=[];for(const n of e){if(null==n.bytes){const e=xl.getProtocol(n.code),t=c(n.code);let r,s=0,i=0;null!=n.value&&(r=e.valueToBytes?.(n.value)??tt(n.value),s=r.byteLength,e.size===Cl&&(i=c(s)));const o=new Uint8Array(t+i+s);let a=0;l(n.code,o,a),a+=t,null!=r&&(e.size===Cl&&(l(s,o,a),a+=i),o.set(r,a)),n.bytes=o}r.push(n.bytes),t+=n.bytes.byteLength}return qs(r,t)}(this.#t)),this.#n}toString(){return null==this.#r&&(this.#r="/"+this.#t.flatMap((e=>{if(null==e.value)return e.name;const t=xl.getProtocol(e.code);if(null==t)throw new sl("Unknown protocol code "+e.code);return[e.name,t.valueToString?.(e.value)??e.value]})).join("/")),this.#r}toJSON(){return this.toString()}toOptions(){let e,t,r,n,s="";for(const{code:i,name:o,value:a}of this.#t)i===gl&&(s="%"+(a??"")),Ll.includes(i)&&(t="tcp",n=443,r=`${a??""}${s}`,e=55===i?6:4),6!==i&&273!==i||(t="tcp"===o?"tcp":"udp",n=parseInt(a??"")),4!==i&&i!==fl||(t="tcp",r=`${a??""}${s}`,e=i===fl?6:4);if(null==e||null==t||null==r||null==n)throw Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:r,transport:t,port:n}}getComponents(){return[...this.#t]}protos(){return this.#t.map((({code:e,value:t})=>{const r=xl.getProtocol(e);return{code:e,size:r.size??0,name:r.name,resolvable:!!r.resolvable,path:!!r.path}}))}protoCodes(){return this.#t.map((({code:e})=>e))}protoNames(){return this.#t.map((({name:e})=>e))}tuples(){return this.#t.map((({code:e,value:t})=>{if(null==t)return[e];const r=xl.getProtocol(e),n=[e];return null!=t&&n.push(r.valueToBytes?.(t)??tt(t)),n}))}stringTuples(){return this.#t.map((({code:e,value:t})=>null==t?[e]:[e,t]))}encapsulate(e){const t=new Nl(e);return new Nl([...this.#t,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),r=this.toString(),n=r.lastIndexOf(t);if(n<0)throw new ol(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Nl(r.slice(0,n),{validate:!1})}decapsulateCode(e){let t;for(let r=this.#t.length-1;r>-1;r--)if(this.#t[r].code===e){t=r;break}return new Nl(this.#t.slice(0,t),{validate:!1})}getPeerId(){try{let e=[];this.#t.forEach((({code:t,value:r})=>{421===t&&e.push([t,r]),290===t&&(e=[])}));const t=e.pop();if(null!=t?.[1]){const e=t[1];return"Q"===e[0]||"1"===e[0]?an(he.decode("z"+e),"base58btc"):an(Ke.parse(e).multihash.bytes,"base58btc")}return null}catch(e){return null}}getPath(){for(const e of this.#t){if(xl.getProtocol(e.code).path)return e.value??null}return null}equals(e){return $s(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find((e=>e.resolvable));if(null==t)return[this];const r=Vl.get(t.name);if(null==r)throw new Dl("no available resolver for "+t.name);return(await r(this,e)).map((e=>Hl(e)))}nodeAddress(){const e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return 2===this.#t.length&&((4===this.#t[0].code||this.#t[0].code===fl)&&(6===this.#t[1].code||273===this.#t[1].code))}[Pl](){return`Multiaddr(${this.toString()})`}}const Ol=4,Ul=16,Fl=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Bl(e,t){t.length===Ul&&e.length===Ol&&function(e,t,r){let n=0;for(const s of e)if(!(n<t)){if(n>r)break;if(255!==s)return!1;n++}return!0}(t,0,11)&&(t=t.slice(12)),t.length===Ol&&e.length===Ul&&function(e,t,r,n){let s=0;for(const i of e)if(!(s<r)){if(s>n)break;if(i!==t[s])return!1;s++}return!0}(e,Fl,0,11)&&(e=e.slice(12));const r=e.length;if(r!=t.length)throw Error("Failed to mask ip");const n=new Uint8Array(r);for(let s=0;s<r;s++)n[s]=e[s]&t[s];return n}function ql(e,t){if(t!==8*Ol&&t!==8*Ul)throw Error("Invalid CIDR mask");if(e<0||e>t)throw Error("Invalid CIDR mask");const r=t/8,n=new Uint8Array(r);for(let t=0;t<r;t++)e>=8?(n[t]=255,e-=8):(n[t]=255-(255>>e),e=0);return n}class $l{constructor(e,t){if(null==t)({network:this.network,mask:this.mask}=function(e){const[t,r]=e.split("/");if(!t||!r)throw Error("Failed to parse given CIDR: "+e);let n=Ol,s=ll(t);if(null==s&&(n=Ul,s=ul(t),null==s))throw Error("Failed to parse given CIDR: "+e);const i=parseInt(r,10);if(Number.isNaN(i)||(i+"").length!==r.length||i<0||i>8*n)throw Error("Failed to parse given CIDR: "+e);const o=ql(i,8*n);return{network:Bl(s,o),mask:o}}(e));else{const r=hl(e);if(null==r)throw Error("Failed to parse network");const n=parseInt(t+="",10);if(Number.isNaN(n)||(n+"").length!==t.length||n<0||n>8*r.length){const e=hl(t);if(null==e)throw Error("Failed to parse mask");this.mask=e}else this.mask=ql(n,8*r.length);this.network=Bl(r,this.mask)}}contains(e){return function(e,t){if("string"==typeof t&&(t=hl(t)),null==t)throw Error("Invalid ip");if(t.length!==e.network.length)return!1;for(let r=0;r<t.length;r++)if((e.network[r]&e.mask[r])!=(t[r]&e.mask[r]))return!1;return!0}({network:this.network,mask:this.mask},e)}toString(){const e=function(e){let t=0;for(let[r,n]of e.entries()){if(255!==n){for(;128&n;)t++,n<<=1;if(128&n)return-1;for(let t=r+1;t<e.length;t++)if(0!=e[t])return-1;break}t+=8}return t}(this.mask),t=-1!==e?e+"":function(e){let t="0x";for(const r of e)t+=(r>>4).toString(16)+(15&r).toString(16);return t}(this.mask);return function(e){switch(e.length){case Ol:return e.join(".");case Ul:{const t=[];for(let r=0;r<e.length;r++)r%2==0&&t.push(e[r].toString(16).padStart(2,"0")+e[r+1].toString(16).padStart(2,"0"));return t.join(":")}default:throw Error("Invalid ip length")}}(this.network)+"/"+t}}function zl(e,t){const r=xl.getProtocol(e);return r.bytesToValue?.(t)??an(t,"base16")}function jl(e,t){const r=xl.getProtocol(e);return r.valueToBytes?.(t)??tt(t,"base16")}const Vl=new Map;function Kl(e){return!!e?.[Rl]}function Hl(e){return new Nl(e)}function Gl(e){const t=xl.getProtocol(e);return{code:t.code,size:t.size??0,name:t.name,resolvable:!!t.resolvable,path:!!t.path}}const Wl=e=>{if(!e)return-1;try{const t=e.metadata.get("ping");return t?Number(hn(t)):-1}catch(e){return-1}},Xl=new vs("connection-limiter");class Zl{libp2p;events;networkMonitor;dialer;connectionMonitorInterval=null;options;constructor(e){this.libp2p=e.libp2p,this.events=e.events,this.networkMonitor=e.networkMonitor,this.dialer=e.dialer,this.options=e.options,this.onWakuConnectionEvent=this.onWakuConnectionEvent.bind(this),this.onDisconnectedEvent=this.onDisconnectedEvent.bind(this)}start(){this.dialPeersFromStore(),this.options.enableAutoRecovery&&null===this.connectionMonitorInterval&&(this.connectionMonitorInterval=setInterval((()=>{this.maintainConnections()}),5e3)),this.events.addEventListener(Ms.Connection,this.onWakuConnectionEvent),this.libp2p.addEventListener("peer:disconnect",this.onDisconnectedEvent)}stop(){this.events.removeEventListener(Ms.Connection,this.onWakuConnectionEvent),this.libp2p.removeEventListener("peer:disconnect",this.onDisconnectedEvent),this.connectionMonitorInterval&&(clearInterval(this.connectionMonitorInterval),this.connectionMonitorInterval=null)}onWakuConnectionEvent(){this.options.enableAutoRecovery?this.networkMonitor.isBrowserConnected()&&this.dialPeersFromStore():Xl.info("Auto recovery is disabled, skipping")}async maintainConnections(){await this.maintainConnectionsCount(),await this.maintainBootstrapConnections(),await this.maintainTTLConnectedPeers()}async onDisconnectedEvent(){0===this.libp2p.getConnections().length&&(Xl.info("No connections, dialing peers from store"),await this.dialPeersFromStore())}async maintainConnectionsCount(){Xl.info("Maintaining connections count");const e=this.libp2p.getConnections();if(e.length<=this.options.maxConnections){Xl.info(`Node has less than max connections ${this.options.maxConnections}, trying to dial more peers`);const t=await this.getPrioritizedPeers();if(0===t.length)return Xl.info("No peers to dial, skipping"),void await this.triggerBootstrap();const r=t.slice(0,this.options.maxConnections-e.length).map((e=>this.dialer.dial(e.id)));await Promise.all(r)}else{Xl.info(`Node has more than max connections ${this.options.maxConnections}, dropping connections`);try{const t=e.filter((e=>!e.tags.includes(Os))).slice(this.options.maxConnections);if(0===t.length)return void Xl.info("No connections to drop, skipping");const r=t.map((e=>this.libp2p.hangUp(e.remotePeer)));await Promise.all(r),Xl.info(`Dropped ${t.length} connections`)}catch(e){Xl.error("Unexpected error while maintaining connections",e)}}}async maintainBootstrapConnections(){Xl.info("Maintaining bootstrap connections");const e=await this.getBootstrapPeers();if(!(e.length<=this.options.maxBootstrapPeers))try{const t=e.slice(this.options.maxBootstrapPeers);Xl.info(`Dropping ${t.length} bootstrap connections because node has more than max bootstrap connections ${this.options.maxBootstrapPeers}`);const r=t.map((e=>this.libp2p.hangUp(e.id)));await Promise.all(r),Xl.info(`Dropped ${t.length} bootstrap connections`)}catch(e){Xl.error("Unexpected error while maintaining bootstrap connections",e)}}async maintainTTLConnectedPeers(){Xl.info("Maintaining TTL connected peers");const e=this.libp2p.getConnections().map((async e=>{try{await this.libp2p.peerStore.merge(e.remotePeer,{metadata:{ttl:ln(Date.now())}}),Xl.info("TTL updated for connected peer "+e.remotePeer.toString())}catch(e){Xl.error("Unexpected error while maintaining TTL connected peer",e)}}));await Promise.all(e)}async dialPeersFromStore(){Xl.info("Dialing peers from store");try{const e=await this.getPrioritizedPeers();if(0===e.length)return Xl.info("No peers to dial, skipping"),void await this.triggerBootstrap();const t=e.map((e=>this.dialer.dial(e.id)));Xl.info(`Dialing ${e.length} peers from store`),await Promise.all(t),Xl.info(`Dialed ${t.length} peers from store`)}catch(e){Xl.error("Unexpected error while dialing peer store peers",e)}}async getPrioritizedPeers(){const e=await this.libp2p.peerStore.all(),t=this.libp2p.getConnections();Xl.info(`Found ${e.length} peers in store, and found ${t.length} connections`);const r=e.filter((e=>!t.some((t=>t.remotePeer.equals(e.id)))&&((e,t)=>{const r=e?.components?.transportManager?.getTransports()||[];return 0!==r.length&&r.map((e=>e.dialFilter(t))).some((e=>e.length>0))})(this.libp2p,e.addresses.map((e=>e.multiaddr)))));return[...r.filter((e=>e.tags.has(Ns.BOOTSTRAP))),...r.filter((e=>e.tags.has(Ns.PEER_EXCHANGE))),...r.filter((e=>e.tags.has(Ns.PEER_CACHE))),...r.filter((e=>!e.tags.has(Ns.BOOTSTRAP)&&!e.tags.has(Ns.PEER_EXCHANGE)&&!e.tags.has(Ns.PEER_CACHE)))]}async getBootstrapPeers(){return(await Promise.all(this.libp2p.getConnections().map((e=>e.remotePeer)).map((e=>this.getPeer(e))))).filter((e=>e&&e.tags.has(Ns.BOOTSTRAP)))}async getPeer(e){try{return await this.libp2p.peerStore.get(e)}catch(t){return Xl.error(`Failed to get peer ${e}, error: ${t}`),null}}async triggerBootstrap(){Xl.info("Triggering bootstrap discovery");const e=Object.values(this.libp2p.components.components).filter((e=>!!e)).filter((e=>["@waku/"+Ns.BOOTSTRAP,"@waku/"+Ns.PEER_CACHE].includes(e?.[Symbol.toStringTag])));if(0===e.length)return void Xl.warn("No bootstrap components found to trigger");Xl.info(`Found ${e.length} bootstrap components, starting them`);const t=e.map((async e=>{try{await(e?.stop?.()),await(e?.start?.()),Xl.info("Successfully started bootstrap component")}catch(e){Xl.error("Failed to start bootstrap component",e)}}));await Promise.all(t)}}const Yl=new vs("dialer");class Ql{libp2p;shardReader;options;dialingQueue=[];dialHistory=new Map;failedDials=new Map;dialingInterval=null;isProcessing=!1;isImmediateDialing=!1;constructor(e){this.libp2p=e.libp2p,this.shardReader=e.shardReader,this.options=e.options}start(){Yl.info("Starting dialer"),this.dialingInterval||(this.dialingInterval=setInterval((()=>{this.processQueue()}),500)),this.dialHistory.clear(),this.failedDials.clear()}stop(){Yl.info("Stopping dialer"),this.dialingInterval&&(clearInterval(this.dialingInterval),this.dialingInterval=null),this.dialHistory.clear(),this.failedDials.clear()}async dial(e){if(await this.shouldSkipPeer(e))return void Yl.info("Skipping peer: "+e);const t=0===this.dialingQueue.length,r=!this.isProcessing&&!this.isImmediateDialing;t&&r?(this.isImmediateDialing=!0,Yl.info("Dialed peer immediately"),await this.dialPeer(e),this.isImmediateDialing=!1,Yl.info("Released immediate dial lock")):(this.dialingQueue.push(e),Yl.info("Added peer to dialing queue, queue size: "+this.dialingQueue.length))}async processQueue(){if(0!==this.dialingQueue.length&&!this.isProcessing){this.isProcessing=!0;try{const e=this.dialingQueue.slice(0,this.options.maxDialingPeers);this.dialingQueue=this.dialingQueue.slice(e.length),Yl.info(`Processing dial queue: dialing ${e.length} peers, ${this.dialingQueue.length} remaining in queue`),await Promise.all(e.map((e=>this.dialPeer(e))))}finally{this.isProcessing=!1}}}async dialPeer(e){try{Yl.info("Dialing peer from queue: "+e),await this.libp2p.dial(e),this.dialHistory.set(e.toString(),Date.now()),this.failedDials.delete(e.toString()),Yl.info("Successfully dialed peer from queue: "+e)}catch(t){Yl.error("Error dialing peer "+e,t),this.failedDials.set(e.toString(),Date.now())}}async shouldSkipPeer(e){if(this.libp2p.getPeers().some((t=>t.equals(e))))return Yl.info(`Skipping peer ${e} - already connected`),!0;if(this.isRecentlyDialed(e))return Yl.info(`Skipping peer ${e} - already dialed in the last 10 seconds`),!0;if(this.isRecentlyFailed(e))return Yl.info(`Skipping peer ${e} - recently failed to dial`),!0;try{if(!await this.shardReader.hasShardInfo(e))return Yl.info(`Skipping peer ${e} - no shard info`),!1;return!await this.shardReader.isPeerOnCluster(e)&&(Yl.info(`Skipping peer ${e} - not on same cluster`),!0)}catch(t){return Yl.error("Error checking shard info for peer "+e,t),!0}}isRecentlyDialed(e){const t=this.dialHistory.get(e.toString());return!!(t&&Date.now()-t<1e3*this.options.dialCooldown)}isRecentlyFailed(e){const t=this.failedDials.get(e.toString());return!!(t&&Date.now()-t<1e3*this.options.failedDialCooldown)}}const Jl=new vs("discovery-dialer");class eu{libp2p;dialer;constructor(e){this.libp2p=e.libp2p,this.dialer=e.dialer,this.onPeerDiscovery=this.onPeerDiscovery.bind(this)}start(){this.libp2p.addEventListener("peer:discovery",this.onPeerDiscovery)}stop(){this.libp2p.removeEventListener("peer:discovery",this.onPeerDiscovery)}async onPeerDiscovery(e){const t=e.detail.id;Jl.info("Discovered new peer: "+t);try{await this.updatePeerStore(t,e.detail.multiaddrs),await this.dialer.dial(t)}catch(e){Jl.error("Error dialing peer "+t,e)}}async updatePeerStore(e,t){try{Jl.info("Updating peer store for "+e);const r=await this.getPeer(e);if(!r)return Jl.info(`Peer ${e} not found in store, saving`),void await this.libp2p.peerStore.save(e,{multiaddrs:t});if(t.every((e=>r.addresses.some((t=>t.multiaddr.equals(e))))))return void Jl.info(`Peer ${e} has same addresses in peer store, skipping`);Jl.info(`Merging peer ${e} addresses in peer store`),await this.libp2p.peerStore.merge(e,{multiaddrs:t})}catch(t){Jl.error("Error updating peer store for "+e,t)}}async getPeer(e){try{return await this.libp2p.peerStore.get(e)}catch(t){return void Jl.error("Error getting peer info for "+e,t)}}}const tu="/relay-ping/1/ping/null",ru=new vs("keep-alive");class nu{relay;networkConfig;libp2p;options;pingKeepAliveTimers=new Map;relayKeepAliveTimers=new Map;constructor({options:e,relay:t,networkConfig:r,libp2p:n}){this.options=e,this.relay=t,this.networkConfig=r,this.libp2p=n,this.onPeerConnect=this.onPeerConnect.bind(this),this.onPeerDisconnect=this.onPeerDisconnect.bind(this)}start(){this.libp2p.addEventListener("peer:connect",this.onPeerConnect),this.libp2p.addEventListener("peer:disconnect",this.onPeerDisconnect)}stop(){this.libp2p.removeEventListener("peer:connect",this.onPeerConnect),this.libp2p.removeEventListener("peer:disconnect",this.onPeerDisconnect);for(const e of this.pingKeepAliveTimers.values())clearInterval(e);for(const e of this.relayKeepAliveTimers.values())for(const t of e)clearInterval(t);this.pingKeepAliveTimers.clear(),this.relayKeepAliveTimers.clear()}onPeerConnect(e){const t=e.detail;this.startPingForPeer(t)}onPeerDisconnect(e){const t=e.detail;this.stopPingForPeer(t)}startPingForPeer(e){this.stopPingForPeer(e),this.startLibp2pPing(e),this.startRelayPing(e)}stopPingForPeer(e){this.stopLibp2pPing(e),this.stopRelayPing(e)}startLibp2pPing(e){if(0===this.options.pingKeepAlive)return void ru.warn(`Ping keep alive is disabled pingKeepAlive:${this.options.pingKeepAlive}, skipping start for libp2p ping`);const t=e.toString();if(this.pingKeepAliveTimers.has(t))return void ru.warn(`Ping already started for peer: ${t}, skipping start for libp2p ping`);const r=setInterval((()=>{this.pingLibp2p(e)}),1e3*this.options.pingKeepAlive);this.pingKeepAliveTimers.set(t,r)}stopLibp2pPing(e){const t=e.toString();this.pingKeepAliveTimers.has(t)?(clearInterval(this.pingKeepAliveTimers.get(t)),this.pingKeepAliveTimers.delete(t)):ru.warn(`Ping not started for peer: ${t}, skipping stop for ping`)}startRelayPing(e){if(!this.relay)return;if(0===this.options.relayKeepAlive)return void ru.warn(`Relay keep alive is disabled relayKeepAlive:${this.options.relayKeepAlive}, skipping start for relay ping`);if(this.relayKeepAliveTimers.has(e.toString()))return void ru.warn(`Relay ping already started for peer: ${e.toString()}, skipping start for relay ping`);const t=[];for(const r of this.relay.pubsubTopics){if(!this.relay.getMeshPeers(r).includes(e.toString())){ru.warn(`Peer: ${e.toString()} is not in the mesh for topic: ${r}, skipping start for relay ping`);continue}const n=xs({routingInfo:vn(this.networkConfig,{contentTopic:tu,pubsubTopic:r}),contentTopic:tu,ephemeral:!0}),s=setInterval((()=>{this.pingRelay(n)}),1e3*this.options.relayKeepAlive);t.push(s)}this.relayKeepAliveTimers.set(e.toString(),t)}stopRelayPing(e){if(!this.relay)return;const t=e.toString();this.relayKeepAliveTimers.has(t)?(this.relayKeepAliveTimers.get(t)?.map(clearInterval),this.relayKeepAliveTimers.delete(t)):ru.warn(`Relay ping not started for peer: ${t}, skipping stop for relay ping`)}async pingRelay(e){try{ru.info("Sending Waku Relay ping message"),await this.relay.send(e,{payload:new Uint8Array([1])})}catch(e){ru.error("Failed to send relay ping",e)}}async pingLibp2p(e){try{ru.info(`Pinging libp2p peer (${e.toString()})`);const t=await this.libp2p.services.ping.ping(e);ru.info(`Ping succeeded (${e.toString()})`,t),await this.libp2p.peerStore.merge(e,{metadata:{ping:dn(t.toString())}}),ru.info(`Ping updated for peer (${e.toString()})`)}catch(t){ru.error(`Ping failed for peer (${e.toString()})`,t)}}}class su{libp2p;events;isNetworkConnected=!1;constructor(e){this.libp2p=e.libp2p,this.events=e.events,this.onConnectedEvent=this.onConnectedEvent.bind(this),this.onDisconnectedEvent=this.onDisconnectedEvent.bind(this),this.dispatchNetworkEvent=this.dispatchNetworkEvent.bind(this)}start(){this.libp2p.addEventListener("peer:connect",this.onConnectedEvent),this.libp2p.addEventListener("peer:disconnect",this.onDisconnectedEvent);try{globalThis.addEventListener("online",this.dispatchNetworkEvent),globalThis.addEventListener("offline",this.dispatchNetworkEvent)}catch(e){}}stop(){this.libp2p.removeEventListener("peer:connect",this.onConnectedEvent),this.libp2p.removeEventListener("peer:disconnect",this.onDisconnectedEvent);try{globalThis.removeEventListener("online",this.dispatchNetworkEvent),globalThis.removeEventListener("offline",this.dispatchNetworkEvent)}catch(e){}}isConnected(){return!!this.isBrowserConnected()&&this.isP2PConnected()}isP2PConnected(){return this.isNetworkConnected}isBrowserConnected(){try{if(globalThis?.navigator&&!globalThis?.navigator?.onLine)return!1}catch(e){}return!0}onConnectedEvent(){this.isNetworkConnected||(this.isNetworkConnected=!0,this.dispatchNetworkEvent())}onDisconnectedEvent(){this.isNetworkConnected&&0===this.libp2p.getConnections().length&&(this.isNetworkConnected=!1,this.dispatchNetworkEvent())}dispatchNetworkEvent(){this.events.dispatchEvent(new CustomEvent(Ms.Connection,{detail:this.isConnected()}))}}const iu=new vs("shard-reader");class ou{libp2p;clusterId;constructor(e){this.libp2p=e.libp2p,this.clusterId=e.networkConfig.clusterId}async isPeerOnCluster(e){const t=await this.getRelayShards(e);return!!t&&t.clusterId===this.clusterId}async hasShardInfo(e){return!!await this.getRelayShards(e)}async isPeerOnTopic(e,t){try{const{clusterId:r,shard:n}=gn(t);return r===this.clusterId&&await this.isPeerOnShard(e,n)}catch(r){return iu.error(`Error comparing pubsub topic ${t} with shard info for ${e}`,r),!1}}async isPeerOnShard(e,t){const r=await this.getRelayShards(e);return iu.info(`Checking if peer on same shard: this { clusterId: ${this.clusterId}, shardId: ${t} },${e} { clusterId: ${r?.clusterId}, shards: ${r?.shards} }`),!!r&&(r.clusterId===this.clusterId&&r.shards.includes(t))}async getRelayShards(e){try{const t=(await this.libp2p.peerStore.get(e)).metadata.get("shardInfo");if(!t)return;return En(t)}catch(t){return void iu.error("Error getting shard info for "+e,t)}}}const au=new vs("connection-manager");class cu{keepAliveManager;discoveryDialer;dialer;shardReader;networkMonitor;connectionLimiter;options;libp2p;constructor(e){this.libp2p=e.libp2p,this.options={maxBootstrapPeers:3,maxConnections:10,pingKeepAlive:300,relayKeepAlive:300,enableAutoRecovery:true,maxDialingPeers:3,failedDialCooldown:60,dialCooldown:10,...e.config},this.keepAliveManager=new nu({relay:e.relay,libp2p:e.libp2p,networkConfig:e.networkConfig,options:{pingKeepAlive:this.options.pingKeepAlive,relayKeepAlive:this.options.relayKeepAlive}}),this.shardReader=new ou({libp2p:e.libp2p,networkConfig:e.networkConfig}),this.dialer=new Ql({libp2p:e.libp2p,shardReader:this.shardReader,options:this.options}),this.discoveryDialer=new eu({libp2p:e.libp2p,dialer:this.dialer}),this.networkMonitor=new su({libp2p:e.libp2p,events:e.events}),this.connectionLimiter=new Zl({libp2p:e.libp2p,events:e.events,networkMonitor:this.networkMonitor,dialer:this.dialer,options:this.options})}start(){this.dialer.start(),this.networkMonitor.start(),this.discoveryDialer.start(),this.keepAliveManager.start(),this.connectionLimiter.start()}stop(){this.dialer.stop(),this.networkMonitor.stop(),this.discoveryDialer.stop(),this.keepAliveManager.stop(),this.connectionLimiter.stop()}isConnected(){return this.networkMonitor.isConnected()}async dial(e,t){const r=xn(n=e)?n:Hl(n);var n;au.info(`Dialing peer ${r.toString()} with protocols ${t}`);const s=await this.libp2p.dialProtocol(r,t);return au.info(`Dialed peer ${r.toString()} with protocols ${t}`),s}async hangUp(e){const t=xn(r=e)?r:el(Hl(r).getPeerId());var r;try{return au.info("Dropping connection with peer "+t.toString()),await this.libp2p.hangUp(t),au.info("Dropped connection with peer "+t.toString()),!0}catch(e){return au.error(`Error dropping connection with peer ${t.toString()} - ${e}`),!1}}async getConnectedPeers(e){const t=this.libp2p.getPeers();if(au.info("Getting connected peers for codec "+e),0===t.length)return au.info("No connected peers"),[];const r=(await Promise.all(t.map((async e=>{try{return await this.libp2p.peerStore.get(e)}catch(e){return null}})))).filter((e=>!!e)).filter((t=>!e||t.protocols.includes(e))).sort(((e,t)=>Wl(e)-Wl(t)));return au.info(`Found ${r.length} connected peers for codec ${e}`),r}async hasShardInfo(e){return this.shardReader.hasShardInfo(e)}async isPeerOnTopic(e,t){return this.shardReader.isPeerOnTopic(e,t)}async isPeerOnShard(e,t){return this.shardReader.isPeerOnShard(e,t)}}const lu=new vs("metadata"),uu="/vac/waku/metadata/1.0.0";class hu{clusterId;streamManager;libp2pComponents;handshakesConfirmed=new Map;multicodec=uu;constructor(e,t){this.clusterId=e,this.streamManager=new Ei(uu,t),this.libp2pComponents=t,t.registrar.handle(uu,(e=>{this.onRequest(e)}))}async query(e){const t=Ht.encode({clusterId:this.clusterId,shards:[]});if(!await this.libp2pComponents.peerStore.get(e))return{shardInfo:null,error:Ds.NO_PEER_AVAILABLE};const r=await this.streamManager.getStream(e);if(!r)return lu.error("Failed to get a stream for remote peer:"+e.toString()),{shardInfo:null,error:Ds.NO_STREAM_AVAILABLE};const n=await pi([t],Ws,r,ti,(async e=>await Bs(e))),{error:s,shardInfo:i}=this.decodeMetadataResponse(n);return s?{shardInfo:null,error:s}:(await this.savePeerShardInfo(e,i),{shardInfo:i,error:null})}async confirmOrAttemptHandshake(e){const t=this.handshakesConfirmed.get(e.toString());return t?{shardInfo:t,error:null}:await this.query(e)}async onRequest(e){try{const{stream:t,connection:r}=e,n=Gt.encode({clusterId:this.clusterId,shards:[]}),s=await pi([n],Ws,t,ti,(async e=>await Bs(e))),{error:i,shardInfo:o}=this.decodeMetadataResponse(s);if(i)return;await this.savePeerShardInfo(r.remotePeer,o)}catch(e){lu.error("Error handling metadata request",e)}}decodeMetadataResponse(e){const t=new Ks;e.forEach((e=>{t.append(e)}));const r=Gt.decode(t);return r?{shardInfo:r,error:null}:(lu.error("Error decoding metadata response"),{shardInfo:null,error:Ds.DECODE_FAILED})}async savePeerShardInfo(e,t){await this.libp2pComponents.peerStore.merge(e,{metadata:{shardInfo:Sn(t)}}),this.handshakesConfirmed.set(e.toString(),t)}}function du(e){return t=>new hu(e,t)}const pu=new vs("peer-manager");var fu;(e=>{e.FilterConnect="filter:connect",e.FilterDisconnect="filter:disconnect",e.StoreConnect="store:connect"})(fu||(fu={}));class gu{events=new ss;numPeersToUse;libp2p;connectionManager;lockedPeers=new Set;unlockedPeers=new Map;constructor(e){this.onConnected=this.onConnected.bind(this),this.onDisconnected=this.onDisconnected.bind(this),this.numPeersToUse=e?.config?.numPeersToUse||2,this.libp2p=e.libp2p,this.connectionManager=e.connectionManager}start(){this.libp2p.addEventListener("peer:identify",this.onConnected),this.libp2p.addEventListener("peer:disconnect",this.onDisconnected)}stop(){this.libp2p.removeEventListener("peer:identify",this.onConnected),this.libp2p.removeEventListener("peer:disconnect",this.onDisconnected)}async getPeers(e){pu.info(`Getting peers for protocol: ${e.protocol}, pubsubTopic: ${e.pubsubTopic}`);const t=await this.connectionManager.getConnectedPeers();pu.info(`Found ${t.length} connected peers`);let r=[];for(const n of t){const t=this.hasPeerProtocol(n,e.protocol),s=await this.isPeerOnPubsub(n.id,e.pubsubTopic),i=this.isPeerAvailableForUse(n.id);t&&s&&i&&(r.push(n),pu.info(`Peer ${n.id} qualifies for protocol ${e.protocol}`))}const n=r.filter((e=>this.isPeerLocked(e.id)));if(pu.info(`Found ${n.length} locked peers out of ${r.length} qualifying peers`),n.length>=this.numPeersToUse){const e=n.slice(0,this.numPeersToUse).map((e=>e.id));return pu.info(`Using ${e.length} locked peers: ${e.map((e=>e.toString()))}`),e}const s=r.filter((e=>!this.isPeerLocked(e.id)));pu.info(`Found ${s.length} unlocked peers, need ${this.numPeersToUse-n.length} more`),r=[...n,...s].slice(0,this.numPeersToUse).map((e=>(this.lockPeer(e.id),e)));const i=r.map((e=>e.id));return pu.info(`Selected ${i.length} peers: ${i.map((e=>e.toString()))}`),i}async renewPeer(e,t){pu.info(`Renewing peer ${e} for protocol: ${t.protocol}, pubsubTopic: ${t.pubsubTopic}`);const r=(await this.connectionManager.getConnectedPeers()).find((t=>t.id.equals(e)));r?(pu.info(`Found peer ${e} in connected peers, unlocking and getting new peers`),this.unlockPeer(r.id),await this.getPeers(t)):pu.warn(`Cannot renew peer:${e}, no connection to the peer.`)}async isPeerOnPubsub(e,t){return!await this.connectionManager.hasShardInfo(e)||this.connectionManager.isPeerOnTopic(e,t)}async onConnected(e){const t=e.detail,r=t.protocols.includes(this.getProtocolCodecs(Ps.Filter)),n=t.protocols.includes(this.getProtocolCodecs(Ps.Store));r&&this.dispatchFilterPeerConnect(t.peerId),n&&this.dispatchStorePeerConnect(t.peerId)}async onDisconnected(e){const t=e.detail;try{const e=await this.libp2p.peerStore.get(t);this.hasPeerProtocol(e,Ps.Filter)&&this.dispatchFilterPeerDisconnect(e.id)}catch(e){pu.error("Failed to dispatch Filter disconnect event:"+e)}}hasPeerProtocol(e,t){return e.protocols.includes(this.getProtocolCodecs(t))}lockPeer(e){pu.info("Locking peer "+e),this.lockedPeers.add(e.toString()),this.libp2p.getConnections().filter((t=>t.remotePeer.equals(e))).forEach((e=>e.tags.push(Os))),this.unlockedPeers.delete(e.toString())}isPeerLocked(e){return this.lockedPeers.has(e.toString())}unlockPeer(e){pu.info("Unlocking peer "+e),this.lockedPeers.delete(e.toString()),this.libp2p.getConnections().filter((t=>t.remotePeer.equals(e))).forEach((e=>{e.tags=e.tags.filter((e=>e!==Os))})),this.unlockedPeers.set(e.toString(),Date.now())}isPeerAvailableForUse(e){const t=this.unlockedPeers.get(e.toString());if(!t)return!0;const r=new Date(t).getTime();return Date.now()-r>=1e4}dispatchFilterPeerConnect(e){this.events.dispatchEvent(new CustomEvent(fu.FilterConnect,{detail:e}))}dispatchStorePeerConnect(e){this.events.dispatchEvent(new CustomEvent(fu.StoreConnect,{detail:e}))}dispatchFilterPeerDisconnect(e){this.events.dispatchEvent(new CustomEvent(fu.FilterDisconnect,{detail:e}))}getProtocolCodecs(e){if(e===Ps.Relay)throw Error("Relay protocol is not supported");return{[Ps.Filter]:Li,[Ps.LightPush]:Fi,[Ps.Store]:Yi,"light-push-v2":Ui}[e]}}class mu{ttlMs;cleanupIntervalId=null;entryTimestamps=new Map;constructor(e,t=5e3){this.ttlMs=e,this.startCleanupInterval(t)}dispose(){null!==this.cleanupIntervalId&&(clearInterval(this.cleanupIntervalId),this.cleanupIntervalId=null),this.entryTimestamps.clear()}add(e){return this.entryTimestamps.set(e,Date.now()),this}has(e){return this.entryTimestamps.has(e)}startCleanupInterval(e){this.cleanupIntervalId=setInterval((()=>{this.removeExpiredEntries()}),e)}removeExpiredEntries(){const e=Date.now();for(const[t,r]of this.entryTimestamps.entries())e-r>this.ttlMs&&this.entryTimestamps.delete(t)}}const yu=new vs("sdk:filter-subscription");class bu{pubsubTopic;protocol;peerManager;config;isStarted=!1;inProgress=!1;peers=new Map;peerFailures=new Map;receivedMessages=new mu(6e4);callbacks=new Map;messageEmitter=new ss;toSubscribeContentTopics=new Set;toUnsubscribeContentTopics=new Set;subscribeIntervalId=null;keepAliveIntervalId=null;get contentTopics(){const e=Array.from(this.callbacks.keys()).map((e=>e.contentTopic)),t=new Set(e).values();return Array.from(t)}constructor(e){this.config=e.config,this.pubsubTopic=e.pubsubTopic,this.protocol=e.protocol,this.peerManager=e.peerManager,this.onPeerConnected=this.onPeerConnected.bind(this),this.onPeerDisconnected=this.onPeerDisconnected.bind(this)}start(){yu.info("Starting subscription for pubsubTopic: "+this.pubsubTopic),this.isStarted||this.inProgress?yu.info("Subscription already started or in progress, skipping start"):(this.inProgress=!0,this.attemptSubscribe({useNewContentTopics:!1}),this.setupSubscriptionInterval(),this.setupKeepAliveInterval(),this.setupEventListeners(),this.isStarted=!0,this.inProgress=!1,yu.info("Subscription started for pubsubTopic: "+this.pubsubTopic))}stop(){yu.info("Stopping subscription for pubsubTopic: "+this.pubsubTopic),this.isStarted&&!this.inProgress?(this.inProgress=!0,this.disposeEventListeners(),this.disposeIntervals(),this.disposePeers(),this.disposeHandlers(),this.receivedMessages.dispose(),this.inProgress=!1,this.isStarted=!1,yu.info("Subscription stopped for pubsubTopic: "+this.pubsubTopic)):yu.info("Subscription not started or stop in progress, skipping stop")}isEmpty(){return 0===this.callbacks.size}async add(e,t){const r=Array.isArray(e)?e:[e];for(const e of r)this.addSingle(e,t);return!(this.toSubscribeContentTopics.size>0)||await this.attemptSubscribe({useNewContentTopics:!0})}async remove(e){const t=Array.isArray(e)?e:[e];for(const e of t)this.removeSingle(e);return!(this.toUnsubscribeContentTopics.size>0)||await this.attemptUnsubscribe({useNewContentTopics:!0})}invoke(e,t){this.isMessageReceived(e)?yu.info(`Skipping invoking callbacks for already received message: pubsubTopic:${this.pubsubTopic}, peerId:${t.toString()}, contentTopic:${e.contentTopic}`):(yu.info("Invoking message for contentTopic: "+e.contentTopic),this.messageEmitter.dispatchEvent(new CustomEvent(e.contentTopic,{detail:e})))}addSingle(e,t){yu.info("Adding subscription for contentTopic: "+e.contentTopic);const r=!this.contentTopics.includes(e.contentTopic);if(r&&this.toSubscribeContentTopics.add(e.contentTopic),this.callbacks.has(e)){yu.warn(`Replacing callback associated associated with decoder with pubsubTopic:${e.pubsubTopic} and contentTopic:${e.contentTopic}`);const t=this.callbacks.get(e);this.callbacks.delete(e),this.messageEmitter.removeEventListener(e.contentTopic,t)}const n=r=>{(async()=>{try{const n=await e.fromProtoObj(e.pubsubTopic,r.detail);t(n)}catch(e){yu.error("Error decoding message",e)}})()};this.callbacks.set(e,n),this.messageEmitter.addEventListener(e.contentTopic,n),yu.info(`Subscription added for contentTopic: ${e.contentTopic}, isNewContentTopic: ${r}`)}removeSingle(e){yu.info("Removing subscription for contentTopic: "+e.contentTopic);const t=this.callbacks.get(e);t||yu.warn(`No callback associated with decoder with pubsubTopic:${e.pubsubTopic} and contentTopic:${e.contentTopic}`),this.callbacks.delete(e),this.messageEmitter.removeEventListener(e.contentTopic,t);const r=!this.contentTopics.includes(e.contentTopic);r&&this.toUnsubscribeContentTopics.add(e.contentTopic),yu.info(`Subscription removed for contentTopic: ${e.contentTopic}, isCompletelyRemoved: ${r}`)}isMessageReceived(e){try{const t=Ss(this.pubsubTopic,e);if(this.receivedMessages.has(t))return!0;this.receivedMessages.add(t)}catch(e){}return!1}setupSubscriptionInterval(){yu.info("Setting up subscription interval with period 1000ms"),this.subscribeIntervalId=setInterval((()=>{(async()=>{this.toSubscribeContentTopics.size>0&&(yu.info(`Subscription interval: ${this.toSubscribeContentTopics.size} topics to subscribe`),await this.attemptSubscribe({useNewContentTopics:!0})),this.toUnsubscribeContentTopics.size>0&&(yu.info(`Subscription interval: ${this.toUnsubscribeContentTopics.size} topics to unsubscribe`),await this.attemptUnsubscribe({useNewContentTopics:!0}))})()}),1e3)}setupKeepAliveInterval(){yu.info(`Setting up keep-alive interval with period ${this.config.keepAliveIntervalMs}ms`),this.keepAliveIntervalId=setInterval((()=>{(async()=>{yu.info(`Keep-alive interval running for ${this.peers.size} peers`);let e=await Promise.all(Array.from(this.peers.values()).map((async e=>{if((await this.protocol.ping(e)).success)return yu.info("Ping successful for peer: "+e.toString()),void this.peerFailures.set(e.toString(),0);let t=this.peerFailures.get(e.toString())||0;return t+=1,this.peerFailures.set(e.toString(),t),yu.warn(`Ping failed for peer: ${e.toString()}, failures: ${t}/${this.config.pingsBeforePeerRenewed}`),t<this.config.pingsBeforePeerRenewed?void 0:(yu.info(`Peer ${e.toString()} exceeded max failures (${this.config.pingsBeforePeerRenewed}), will be replaced`),e)})));e=e.filter((e=>!!e)),await Promise.all(e.map((e=>(this.peers.delete(e?.toString()),this.peerFailures.delete(e?.toString()),this.requestUnsubscribe(e,this.contentTopics))))),e.length>0&&(yu.info(`Replacing ${e.length} failed peers`),await this.attemptSubscribe({useNewContentTopics:!1,useOnlyNewPeers:!0}))})()}),this.config.keepAliveIntervalMs)}setupEventListeners(){this.peerManager.events.addEventListener(fu.FilterConnect,this.onPeerConnected),this.peerManager.events.addEventListener(fu.FilterDisconnect,this.onPeerDisconnected)}disposeIntervals(){this.subscribeIntervalId&&clearInterval(this.subscribeIntervalId),this.keepAliveIntervalId&&clearInterval(this.keepAliveIntervalId)}disposeHandlers(){for(const[e,t]of this.callbacks.entries())this.messageEmitter.removeEventListener(e.contentTopic,t);this.callbacks.clear()}async disposePeers(){await this.attemptUnsubscribe({useNewContentTopics:!1}),this.peers.clear(),this.peerFailures=new Map}disposeEventListeners(){this.peerManager.events.removeEventListener(fu.FilterConnect,this.onPeerConnected),this.peerManager.events.removeEventListener(fu.FilterDisconnect,this.onPeerDisconnected)}async onPeerConnected(e){const t=e.detail?.toString();yu.info("Peer connected: "+t);await this.peerManager.isPeerOnPubsub(e.detail,this.pubsubTopic)?this.peers.has(t)?yu.info(`Peer ${t} already subscribed, skipping`):await this.attemptSubscribe({useNewContentTopics:!1,useOnlyNewPeers:!0}):yu.info(`Peer ${t} doesn't support pubsubTopic:${this.pubsubTopic}`)}async onPeerDisconnected(e){const t=e.detail?.toString();yu.info("Peer disconnected: "+t);await this.peerManager.isPeerOnPubsub(e.detail,this.pubsubTopic)?this.peers.has(t)?(yu.info(`Active peer ${t} disconnected, removing from peers list`),this.peers.delete(t),this.attemptSubscribe({useNewContentTopics:!1,useOnlyNewPeers:!0})):yu.info(`Disconnected peer ${t} not in use, ignoring`):yu.info(`Peer ${t} doesn't support pubsubTopic:${this.pubsubTopic}`)}async attemptSubscribe(e){const{useNewContentTopics:t,useOnlyNewPeers:r=!1}=e,n=t?Array.from(this.toSubscribeContentTopics):this.contentTopics;if(yu.info(`Attempting to subscribe: useNewContentTopics=${t}, useOnlyNewPeers=${r}, contentTopics=${n.length}`),!n.length)return yu.warn("Requested content topics is an empty array, skipping"),!1;const s=new Set(this.peers.keys()),i=await this.peerManager.getPeers({protocol:Ps.Filter,pubsubTopic:this.pubsubTopic});for(const e of i){if(this.peers.size>=this.config.numPeersToUse)break;this.peers.set(e.toString(),e)}const o=r?Array.from(this.peers.values()).filter((e=>!s.has(e.toString()))):Array.from(this.peers.values());if(yu.info(`Subscribing with ${o.length} peers for ${n.length} content topics`),r&&0===o.length)return yu.warn("Requested to use only new peers, but no peers found, skipping"),!1;const a=await Promise.all(o.map((e=>this.requestSubscribe(e,n)))),c=a.filter((e=>e)).length;return yu.info(`Subscribe attempts completed: ${c}/${a.length} successful`),t&&(this.toSubscribeContentTopics=new Set),a.some((e=>e))}async requestSubscribe(e,t){if(yu.info(`requestSubscribe: pubsubTopic:${this.pubsubTopic}\tcontentTopics:${t.join(",")}`),!t.length||!this.pubsubTopic)return yu.warn("requestSubscribe: no contentTopics or pubsubTopic provided, not sending subscribe request"),!1;const r=await this.protocol.subscribe(this.pubsubTopic,e,t);return r.failure?(yu.warn(`requestSubscribe: Failed to subscribe ${this.pubsubTopic} to ${e.toString()} with error:${r.failure.error} for contentTopics:${t}`),!1):(yu.info(`requestSubscribe: Subscribed ${this.pubsubTopic} to ${e.toString()} for contentTopics:${t}`),!0)}async attemptUnsubscribe(e){const{useNewContentTopics:t}=e,r=t?Array.from(this.toUnsubscribeContentTopics):this.contentTopics;if(yu.info(`Attempting to unsubscribe: useNewContentTopics=${t}, contentTopics=${r.length}`),!r.length)return yu.warn("Requested content topics is an empty array, skipping"),!1;const n=Array.from(this.peers.values()),s=await Promise.all(n.map((e=>this.requestUnsubscribe(e,t?r:void 0)))),i=s.filter((e=>e)).length;return yu.info(`Unsubscribe attempts completed: ${i}/${s.length} successful`),t&&(this.toUnsubscribeContentTopics=new Set),s.some((e=>e))}async requestUnsubscribe(e,t){const r=t?await this.protocol.unsubscribe(this.pubsubTopic,e,t):await this.protocol.unsubscribeAll(this.pubsubTopic,e);return r.failure?(yu.warn(`requestUnsubscribe: Failed to unsubscribe for pubsubTopic:${this.pubsubTopic} from peerId:${e.toString()} with error:${r.failure?.error} for contentTopics:${t}`),!1):(yu.info(`requestUnsubscribe: Unsubscribed pubsubTopic:${this.pubsubTopic} from peerId:${e.toString()} for contentTopics:${t}`),!0)}}const wu=new vs("sdk:filter");class vu{protocol;peerManager;config;subscriptions=new Map;constructor(e){this.config={numPeersToUse:2,pingsBeforePeerRenewed:3,keepAliveIntervalMs:6e4,...e.options},this.peerManager=e.peerManager,this.protocol=new Mi(this.onIncomingMessage.bind(this),e.libp2p)}get multicodec(){return this.protocol.multicodec}async start(){await this.protocol.start()}async stop(){await this.protocol.stop()}unsubscribeAll(){for(const e of this.subscriptions.values())e.stop();this.subscriptions.clear()}async subscribe(e,t){const r=Array.isArray(e)?e:[e];if(0===r.length)throw Error("Cannot subscribe with 0 decoders.");const n=r.map((e=>e.pubsubTopic)),s=n[0],i=r.map((e=>e.contentTopic));wu.info(`Subscribing to contentTopics: ${i}, pubsubTopic: ${s}`),this.throwIfTopicNotSame(n);let o=this.subscriptions.get(s);o||(o=new bu({pubsubTopic:s,protocol:this.protocol,config:this.config,peerManager:this.peerManager}),o.start());const a=await o.add(r,t);return this.subscriptions.set(s,o),wu.info(`Subscription ${a?"successful":"failed"} for content topic: ${i}`),a}async unsubscribe(e){const t=Array.isArray(e)?e:[e];if(0===t.length)throw Error("Cannot unsubscribe with 0 decoders.");const r=t.map((e=>e.pubsubTopic)),n=r[0],s=t.map((e=>e.contentTopic));wu.info(`Unsubscribing from contentTopics: ${s}, pubsubTopic: ${n}`),this.throwIfTopicNotSame(r);const i=this.subscriptions.get(n);if(!i)return wu.warn("No subscriptions associated with the decoder."),!1;const o=await i.remove(t);return i.isEmpty()&&(wu.warn("Subscription has no decoders anymore, terminating it."),i.stop(),this.subscriptions.delete(n)),wu.info(`Unsubscribing ${o?"successful":"failed"} for content topic: ${s}`),o}async onIncomingMessage(e,t,r){wu.info(`Received message for pubsubTopic:${e}, contentTopic:${t.contentTopic}, peerId:${r.toString()}`);const n=this.subscriptions.get(e);n?n.invoke(t,r):wu.error("No subscription locally registered for topic "+e)}throwIfTopicNotSame(e){const t=e[0];if(!e.every((e=>e===t)))throw Error("Cannot subscribe to more than one pubsub topic at the same time, got pubsubTopics:"+e)}}var Eu,Su;var Au=function(){if(Su)return Eu;Su=1;var e=/^\s+|\s+$/g,t=/^[-+]0x[0-9a-f]+$/i,r=/^0b[01]+$/i,n=/^0o[0-7]+$/i,s=parseInt,i="object"==typeof cs&&cs&&cs.Object===Object&&cs,o="object"==typeof self&&self&&self.Object===Object&&self,a=i||o||Function("return this")(),c=Object.prototype.toString,l=Math.max,u=Math.min,h=()=>a.Date.now();function d(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function p(i){if("number"==typeof i)return i;if(function(e){return"symbol"==typeof e||(e=>!!e&&"object"==typeof e)(e)&&"[object Symbol]"==c.call(e)}(i))return NaN;if(d(i)){var o="function"==typeof i.valueOf?i.valueOf():i;i=d(o)?o+"":o}if("string"!=typeof i)return 0===i?i:+i;i=i.replace(e,"");var a=r.test(i);return a||n.test(i)?s(i.slice(2),a?2:8):t.test(i)?NaN:+i}return Eu=function(e,t,r){var n,s,i,o,a,c,f=0,g=!1,m=!1,y=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function b(t){var r=n,i=s;return n=s=void 0,f=t,o=e.apply(i,r)}function w(e){var r=e-c;return void 0===c||r>=t||r<0||m&&e-f>=i}function v(){var e=h();if(w(e))return E(e);a=setTimeout(v,function(e){var r=t-(e-c);return m?u(r,i-(e-f)):r}(e))}function E(e){return a=void 0,y&&n?b(e):(n=s=void 0,o)}function S(){var e=h(),r=w(e);if(n=arguments,s=this,c=e,r){if(void 0===a)return function(e){return f=e,a=setTimeout(v,t),g?b(e):o}(c);if(m)return a=setTimeout(v,t),b(c)}return void 0===a&&(a=setTimeout(v,t)),o}return t=p(t)||0,d(r)&&(g=!!r.leading,i=(m="maxWait"in r)?l(p(r.maxWait)||0,t):i,y="trailing"in r?!!r.trailing:y),S.cancel=function(){void 0!==a&&clearTimeout(a),f=0,n=c=s=a=void 0},S.flush=function(){return void 0===a?o:E(h())},S},Eu}(),Iu=ls(Au);const _u=new vs("health-indicator");class Cu{isStarted=!1;libp2p;events;value=Fs.Unhealthy;debouncedAssessHealth;constructor(e){this.libp2p=e.libp2p,this.events=e.events,this.onPeerIdentify=this.onPeerIdentify.bind(this),this.onPeerDisconnected=this.onPeerDisconnected.bind(this),this.debouncedAssessHealth=Iu((()=>{this.assessHealth()}),100)}start(){this.isStarted||(this.isStarted=!0,_u.info("start: adding listeners to libp2p"),this.libp2p.addEventListener("peer:identify",this.onPeerIdentify),this.libp2p.addEventListener("peer:disconnect",this.onPeerDisconnected),this.debouncedAssessHealth())}stop(){this.isStarted&&(this.isStarted=!1,_u.info("stop: removing listeners to libp2p"),this.libp2p.removeEventListener("peer:identify",this.onPeerIdentify),this.libp2p.removeEventListener("peer:disconnect",this.onPeerDisconnected),this.debouncedAssessHealth.cancel())}toValue(){return this.value}onPeerDisconnected(e){_u.info("onPeerDisconnected: received libp2p event"),this.debouncedAssessHealth()}onPeerIdentify(e){_u.info("onPeerIdentify: received libp2p event"),this.debouncedAssessHealth()}async assessHealth(){const e=this.libp2p.getConnections();if(0===e.length)return _u.info("assessHealth: no connections, setting to Unhealthy"),void this.updateAndDispatchHealthEvent(Fs.Unhealthy);const t=await Promise.all(e.map((async e=>{try{return await this.libp2p.peerStore.get(e.remotePeer)}catch(t){return _u.warn(`assessHealth: failed to get peer ${e.remotePeer}, skipping`),null}}))),r=t.filter((e=>e?.protocols.includes(Li))).length,n=t.filter((e=>e?.protocols.includes(Fi))).length;let s;0===r||0===n?s=Fs.Unhealthy:r>=2&&n>=2?s=Fs.SufficientlyHealthy:1===r&&1===n?s=Fs.MinimallyHealthy:(_u.error(`assessHealth: unexpected state, cannot identify health status of the node: Filter:${r}; LightPush:${n}`),s=this.value),_u.info(`assessHealth: node identified as ${s} Filter:${r}; LightPush:${n}`),this.updateAndDispatchHealthEvent(s)}updateAndDispatchHealthEvent(e){this.value!==e&&(this.value=e,this.events.dispatchEvent(new CustomEvent(Ms.Health,{detail:this.value})))}}const xu=e=>new Promise(((t,r)=>setTimeout((()=>r(Error("Task timeout"))),e))),ku=new vs("sdk:retry-manager");class Tu{intervalID=null;retryIntervalMs;inProgress=0;queue=[];peerManager;constructor(e){this.peerManager=e.peerManager,this.retryIntervalMs=e.retryIntervalMs||1e3}start(){this.intervalID=setInterval((()=>{this.processQueue()}),this.retryIntervalMs)}stop(){this.intervalID&&(clearInterval(this.intervalID),this.intervalID=null)}push(e,t,r){this.queue.push({maxAttempts:t,callback:e,routingInfo:r})}processQueue(){if(0!==this.queue.length)for(;this.queue.length&&this.inProgress<5;){const e=this.queue.shift();e&&this.scheduleTask(e)}}scheduleTask(e){setTimeout((async()=>this.taskExecutor(e)),100)}async taskExecutor(e){if(e.maxAttempts<=0)return void ku.warn("scheduleTask: max attempts has reached, removing from queue");const t=(await this.peerManager.getPeers({protocol:Ps.LightPush,pubsubTopic:e.routingInfo.pubsubTopic}))[0];if(!t)return ku.warn("scheduleTask: no peers, putting back to queue"),void this.queue.push({...e,maxAttempts:e.maxAttempts-1});try{this.inProgress+=1;const r=await Promise.race([xu(1e4),e.callback(t)]);if(void 0===r)throw Error("Task timeout");if(r.failure)throw Error(r.failure.error);if(ku.info("scheduleTask: executed successfully"),0===e.maxAttempts)return void ku.warn("scheduleTask: discarded a task due to limit of max attempts");this.queue.push({...e,maxAttempts:e.maxAttempts-1})}catch(n){const s=n;if(ku.error("scheduleTask: task execution failed with error:",s),((r=s.message)===Rs.REMOTE_PEER_REJECTED||r===Rs.NO_RESPONSE||r===Rs.RLN_PROOF_GENERATION||r===Rs.NO_PEER_AVAILABLE)&&await this.peerManager.renewPeer(t,{protocol:Ps.LightPush,pubsubTopic:e.routingInfo.pubsubTopic}),0===e.maxAttempts)return void ku.warn("scheduleTask: discarded a task due to limit of max attempts");this.queue.push({...e,maxAttempts:e.maxAttempts-1})}finally{this.inProgress-=1}var r}}const Pu=new vs("sdk:light-push"),Ru={autoRetry:!0,retryIntervalMs:1e3,maxAttempts:3,numPeersToUse:1};class Lu{config;retryManager;peerManager;protocol;constructor(e){this.config={...Ru,...e.options||{}},this.peerManager=e.peerManager,this.protocol=new Vi(e.libp2p),this.retryManager=new Tu({peerManager:e.peerManager,retryIntervalMs:this.config.retryIntervalMs})}get multicodec(){return this.protocol.multicodec}start(){this.retryManager.start()}stop(){this.retryManager.stop()}async send(e,t,r={}){r={useLegacy:!1,...this.config,...r};const{pubsubTopic:n}=e;Pu.info("send: attempting to send a message to pubsubTopic:",n);const s=await this.peerManager.getPeers({protocol:r.useLegacy?"light-push-v2":Ps.LightPush,pubsubTopic:e.pubsubTopic}),i=s?.length>0?await Promise.all(s.map((n=>this.protocol.send(e,t,n,r.useLegacy).catch((()=>({success:null,failure:{error:Rs.GENERIC_FAIL}})))))):[],o=i.length?{successes:i.filter((e=>e.success)).map((e=>e.success)),failures:i.filter((e=>e.failure)).map((e=>e.failure))}:{successes:[],failures:[{error:Rs.NO_PEER_AVAILABLE}]};if(r.autoRetry&&0===o.successes.length){const n=n=>this.protocol.send(e,t,n,r.useLegacy);this.retryManager.push(n.bind(this),r.maxAttempts||3,e.routingInfo)}return o}}const Du=new vs("store-sdk");class Mu{options;libp2p;peerManager;protocol;constructor(e){this.options=e.options||{},this.peerManager=e.peerManager,this.libp2p=e.libp2p,this.protocol=new Qi(e.libp2p)}get multicodec(){return this.protocol.multicodec}async*queryGenerator(e,t){const{decodersAsMap:r,queryOptions:n}=this.buildQueryParams(e,t);for(const e of n){const n=t?.peerId??await this.getPeerToUse(e.pubsubTopic);if(!n)throw Du.error("No peers available to query"),Error("No peers available to query");Du.info("Querying store with options: "+JSON.stringify(e));const s=this.protocol.queryPerPage(e,r,n);for await(const e of s)yield e}}async queryWithOrderedCallback(e,t,r){Du.info("Querying store with ordered callback");for await(const n of this.queryGenerator(e,r))if(await this.processMessages(n,t))break}async queryWithPromiseCallback(e,t,r){Du.info("Querying store with promise callback");let n=!1;for await(const s of this.queryGenerator(e,r)){const e=s.map((async e=>{n||(n=!!await t(e))}));if(await Promise.all(e),n)break}}async processMessages(e,t){let r=!1;const n=(await Promise.all(e)).filter(tr);return await Promise.all(n.map((async e=>{e&&!r&&(r=!!await t(e))}))),r}createCursor(e){return Es(e.pubsubTopic,e)}validateDecodersAndPubsubTopic(e){if(0===e.length)throw Du.error("No decoders provided"),Error("No decoders provided");const t=Array.from(new Set(e.map((e=>e.pubsubTopic))));if(t.length>1)throw Du.error("API does not support querying multiple pubsub topics at once"),Error("API does not support querying multiple pubsub topics at once");const r=t[0],n=new Map;e.forEach((e=>{if(n.has(e.contentTopic))throw Du.error("API does not support different decoder per content topic"),Error("API does not support different decoder per content topic");n.set(e.contentTopic,e)}));const s=e.filter((e=>e.pubsubTopic===r)).map((e=>e.contentTopic));if(0===s.length)throw Du.error("No decoders found for topic "+r),Error("No decoders found for topic "+r);return{pubsubTopic:r,contentTopics:s,decodersAsMap:n}}async getPeerToUse(e){const t=await this.peerManager.getPeers({protocol:Ps.Store,pubsubTopic:e});return this.options.peers?await this.getPeerFromConfigurationOrFirst(t,this.options.peers):t[0]}async getPeerFromConfigurationOrFirst(e,t){const r=t.map(Hl),n=[];for(const t of r){const r=e.find((e=>e.toString()===t.getPeerId()?.toString()));if(r)return r;n.push(t)}for(;n.length;){const e=n.pop();if(!e)return;try{if(await this.libp2p.dial(e))return el(e.getPeerId())}catch(t){Du.warn(`Failed to dial peer from options.peers list for Store protocol. Peer:${e.getPeerId()}, error:${t}`)}}return Du.warn(`Passed node to use for Store not found: ${t.toString()}. Attempting to use first available peers.`),e[0]}buildQueryParams(e,t){let r,n,s;if(t?.messageHashes&&t.messageHashes.length>0)r=t.pubsubTopic||e[0]?.pubsubTopic||"",n=[],s=new Map,e.forEach((e=>{s.set(e.contentTopic,e)}));else{const t=this.validateDecodersAndPubsubTopic(e);r=t.pubsubTopic,n=t.contentTopics,s=t.decodersAsMap}const i=[];if(t?.timeStart&&t?.timeEnd){let e=t.timeStart;const r=t.timeEnd;for(;r.getTime()-e.getTime()>this.protocol.maxTimeLimit;){const t=new Date(e.getTime()+this.protocol.maxTimeLimit);i.push([e,t]),e=t}0===i.length&&(Du.info("Using single time range"),i.push([e,r]))}return 0===i.length?(Du.info("No sub time ranges"),{decodersAsMap:s,queryOptions:[{pubsubTopic:r,contentTopics:n,includeData:!0,paginationForward:!0,...t}]}):(Du.info(`Building ${i.length} sub time ranges`),{decodersAsMap:s,queryOptions:i.map((([e,s])=>({pubsubTopic:r,contentTopics:n,includeData:!0,paginationForward:!0,...t,timeStart:e,timeEnd:s})))})}}const Nu=new vs("wait-for-remote-peer");async function Ou(e,t,r){t=t?.length?t:function(e){const t=[];e.relay&&t.push(Ps.Relay);e.filter&&t.push(Ps.Filter);e.store&&t.push(Ps.Store);e.lightPush&&t.push(Ps.LightPush);return t}(e);const n=e.libp2p.getConnections();if(!e.isStarted())throw Error("Waku node is not started");for(const r of t)switch(r){case Ps.Relay:if(!e.relay)throw Error("Cannot wait for Relay peer: protocol not mounted");break;case Ps.LightPush:if(!e.lightPush)throw Error("Cannot wait for LightPush peer: protocol not mounted");break;case Ps.Store:if(!e.store)throw Error("Cannot wait for Store peer: protocol not mounted");break;case Ps.Filter:if(!e.filter)throw Error("Cannot wait for Filter peer: protocol not mounted")}const s=[Fu(e,t)];n.length>0&&!t.includes(Ps.Relay)&&s.push(async function(e,t){const r=e.libp2p.getPeers(),n=e.libp2p.services.metadata,s=function(e){const t=new Map,r={[Ps.Filter]:[Li],[Ps.LightPush]:[Fi,Ui],[Ps.Store]:[Yi]};for(const n of e)r[n]&&r[n].forEach((e=>{t.set(e,!1)}));return t}(t);if(!r.length||!n)return void Nu.info(`Skipping waitForMetadata due to missing connections:${r.length} or metadataService:${!!n}`);for(const t of r)try{const r=await e.libp2p.peerStore.get(t);if(r.protocols.some((e=>s.has(e)))){if(!(await n.confirmOrAttemptHandshake(t)).error){r.protocols.forEach((e=>{s.has(e)&&s.set(e,!0)}));if(Array.from(s.values()).every((e=>e)))return}}}catch(e){"ERR_CONNECTION_BEING_CLOSED"===e.code&&Nu.error("Connection closed. Some peers can be on different shard."),Nu.error("Error while iterating through peers: "+e);continue}}(e,t)),r?await async function(e,t,r){await Promise.race([e,Bu(t,r)])}(Promise.any(s),r,"Timed out waiting for a remote peer."):await Promise.any(s)}function Uu(e,t){return e.map((e=>async function(e,t){Nu.info(`Waiting for ${e} peer.`),await new Promise((r=>{const n=async s=>{if(s.detail?.protocols?.includes(e)){const e=t.services.metadata;if(!e)return t.removeEventListener("peer:identify",n),void r();try{await e.confirmOrAttemptHandshake(s.detail.peerId),t.removeEventListener("peer:identify",n),r()}catch(e){"ERR_CONNECTION_BEING_CLOSED"===e.code&&Nu.error("Connection closed. Some peers can be on different shard."),Nu.error("Error waiting for metadata: "+e)}}};t.addEventListener("peer:identify",n)}))}(e,t)))}async function Fu(e,t){const r=[];if(e.relay&&t.includes(Ps.Relay)&&r.push(e.relay.waitForPeers()),e.store&&t.includes(Ps.Store)&&r.push(...Uu([Yi],e.libp2p)),e.lightPush&&t.includes(Ps.LightPush)){const t=Uu([Fi,Ui],e.libp2p);r.push(Promise.any(t))}return e.filter&&t.includes(Ps.Filter)&&r.push(...Uu([Li],e.libp2p)),Promise.all(r)}const Bu=(e,t)=>new Promise(((r,n)=>setTimeout((()=>n(Error(t))),e)));const qu=new vs("sdk:waku");class $u{libp2p;relay;store;filter;lightPush;events=new ss;networkConfig;_nodeStateLock=!1;_nodeStarted=!1;connectionManager;peerManager;healthIndicator;constructor(e,t,r,n){this.relay=n,this.libp2p=t,this.networkConfig=e.networkConfig||Us,r={filter:!1,lightpush:!1,store:!1,...r};const s=this.libp2p.peerId.toString();this.connectionManager=new cu({libp2p:t,relay:this.relay,events:this.events,networkConfig:this.networkConfig,config:e?.connectionManager}),this.peerManager=new gu({libp2p:t,config:{numPeersToUse:e.numPeersToUse},connectionManager:this.connectionManager}),this.healthIndicator=new Cu({libp2p:t,events:this.events}),r.store&&(this.store=new Mu({libp2p:t,peerManager:this.peerManager,options:e?.store})),r.lightpush&&(this.lightPush=new Lu({libp2p:t,peerManager:this.peerManager,options:e?.lightPush})),r.filter&&(this.filter=new vu({libp2p:t,peerManager:this.peerManager,options:e.filter})),qu.info("Waku node created",s,`relay: ${!!this.relay}, store: ${!!this.store}, light push: ${!!this.lightPush}, filter: ${!!this.filter}`)}get peerId(){return this.libp2p.peerId}get protocols(){return this.libp2p.getProtocols()}get health(){return this.healthIndicator.toValue()}async dial(e,t){const r=t??[];void 0===t&&(this.relay&&r.push(Ps.Relay),this.store&&r.push(Ps.Store),this.filter&&r.push(Ps.Filter),this.lightPush&&r.push(Ps.LightPush));const n=[];return r.includes(Ps.Relay)&&(this.relay?this.relay.gossipSub.multicodecs.forEach((e=>n.push(e))):qu.error("Relay codec not included in dial codec: protocol not mounted locally")),r.includes(Ps.Store)&&(this.store?n.push(this.store.multicodec):qu.error("Store codec not included in dial codec: protocol not mounted locally")),r.includes(Ps.LightPush)&&(this.lightPush?n.push(...this.lightPush.multicodec):qu.error("Light Push codec not included in dial codec: protocol not mounted locally")),r.includes(Ps.Filter)&&(this.filter?n.push(this.filter.multicodec):qu.error("Filter codec not included in dial codec: protocol not mounted locally")),qu.info(`Dialing to ${e?.toString()} with protocols ${r}`),await this.connectionManager.dial(e,n)}async hangUp(e){return qu.info(`Hanging up peer:${e?.toString()}.`),this.connectionManager.hangUp(e)}async start(){this._nodeStateLock||this.isStarted()||(this._nodeStateLock=!0,await this.libp2p.start(),await(this.filter?.start()),this.connectionManager.start(),this.peerManager.start(),this.healthIndicator.start(),this.lightPush?.start(),this._nodeStateLock=!1,this._nodeStarted=!0)}async stop(){!this._nodeStateLock&&this.isStarted()&&(this._nodeStateLock=!0,this.lightPush?.stop(),await(this.filter?.stop()),this.healthIndicator.stop(),this.peerManager.stop(),this.connectionManager.stop(),await this.libp2p.stop(),this._nodeStateLock=!1,this._nodeStarted=!1)}async getConnectedPeers(){return this.connectionManager.getConnectedPeers()}async waitForPeers(e,t){return Ou(this,e,t)}isStarted(){return this._nodeStarted&&"started"===this.libp2p.status}isConnected(){return this.connectionManager.isConnected()}createDecoder(e){const t=this.createRoutingInfo(e.contentTopic,e.shardId);return function(e,t){return new ks(e,t)}(e.contentTopic,t)}createEncoder(e){const t=this.createRoutingInfo(e.contentTopic,e.shardId);return xs({contentTopic:e.contentTopic,ephemeral:e.ephemeral,routingInfo:t})}createRoutingInfo(e,t){return vn(this.networkConfig,{contentTopic:e,shardId:t})}}const zu=4194304;let ju=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Vu=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Ku=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},Hu=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function Gu(e){return null!=e[Symbol.asyncIterator]}function Wu(e,t){if(e.byteLength>t)throw new Vu("Message length too long")}const Xu=e=>{const r=c(e),n=t(r);return h(e,n),Xu.bytes=r,n};function Zu(e,t){const r=(t=t??{}).lengthEncoder??Xu,n=t?.maxDataLength??zu;function*s(e){Wu(e,n);const t=r(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return Gu(e)?async function*(){for await(const t of e)yield*s(t)}():function*(){for(const t of e)yield*s(t)}()}var Yu;Xu.bytes=0,Zu.single=(e,t)=>{const r=(t=t??{}).lengthEncoder??Xu;return Wu(e,t?.maxDataLength??zu),new Ks(r(e.byteLength),e)},(e=>{e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"})(Yu||(Yu={}));const Qu=e=>{const t=d(e);return Qu.bytes=c(t),t};function Ju(e,t){const r=new Ks;let n=Yu.LENGTH,s=-1;const i=t?.lengthDecoder??Qu,o=t?.maxLengthLength??8,a=t?.maxDataLength??zu;function*c(){for(;r.byteLength>0;){if(n===Yu.LENGTH)try{if(s=i(r),s<0)throw new ju("Invalid message length");if(s>a)throw new Vu("Message length too long");const e=i.bytes;r.consume(e),null!=t?.onLength&&t.onLength(s),n=Yu.DATA}catch(e){if(e instanceof RangeError){if(r.byteLength>o)throw new Ku("Message length length too long");break}throw e}if(n===Yu.DATA){if(r.byteLength<s)break;const e=r.sublist(0,s);r.consume(s),null!=t?.onData&&t.onData(e),yield e,n=Yu.LENGTH}}}return Gu(e)?async function*(){for await(const t of e)r.append(t),yield*c();if(r.byteLength>0)throw new Hu("Unexpected end of input")}():function*(){for(const t of e)r.append(t),yield*c();if(r.byteLength>0)throw new Hu("Unexpected end of input")}()}Qu.bytes=0,Ju.fromReader=(e,t)=>{let r=1;return Ju(async function*(){for(;;)try{const{done:t,value:n}=await e.next(r);if(!0===t)return;null!=n&&(yield n)}catch(e){if("ERR_UNDER_READ"===e.code)return{done:!0,value:null};throw e}finally{r=1}}(),{...t??{},onLength(e){r=e}})};class eh extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}function th(e,t){const r=ui();e.sink(r).catch((async e=>{await r.end(e)})),e.sink=async e=>{for await(const t of e)await r.push(t);await r.end()};let n=e.source;null!=e.source[Symbol.iterator]?n=e.source[Symbol.iterator]():null!=e.source[Symbol.asyncIterator]&&(n=e.source[Symbol.asyncIterator]());const s=new Ks;return{async read(e){if(e?.signal?.throwIfAborted(),null==e?.bytes){const{done:t,value:r}=await ci(n.next(),e?.signal);return!0===t?null:r}for(;s.byteLength<e.bytes;){const{value:t,done:r}=await ci(n.next(),e?.signal);if(!0===r)throw new eh("unexpected end of input");s.append(t)}const t=s.sublist(0,e.bytes);return s.consume(e.bytes),t},async write(e,t){t?.signal?.throwIfAborted(),e instanceof Uint8Array?await r.push(e,t):await r.push(e.subarray(),t)},unwrap(){if(s.byteLength>0){const r=e.source;e.source=async function*(){!1===t?.yieldBytes?yield s:yield*s,yield*r}()}return e}}}class rh extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class nh extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class sh extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}function ih(e,t={}){const r=th(e,t);null!=t.maxDataLength&&null==t.maxLengthLength&&(t.maxLengthLength=c(t.maxDataLength));const n=t?.lengthDecoder??d,s=t?.lengthEncoder??h;return{async read(e){let s=-1;const i=new Ks;for(;;){i.append(await r.read({...e,bytes:1}));try{s=n(i)}catch(e){if(e instanceof RangeError)continue;throw e}if(s<0)throw new rh("Invalid message length");if(null!=t?.maxLengthLength&&i.byteLength>t.maxLengthLength)throw new sh("message length length too long");if(s>-1)break}if(null!=t?.maxDataLength&&s>t.maxDataLength)throw new nh("message length too long");return r.read({...e,bytes:s})},async write(e,t){await r.write(new Ks(s(e.byteLength),e),t)},async writeV(e,t){const n=new Ks(...e.flatMap((e=>[s(e.byteLength),e])));await r.write(n,t)},unwrap(){return r.unwrap()}}}function oh(){const e=ri();let t=!1;return{async sink(r){if(t)throw Error("already piped");t=!0,e.resolve(r)},source:async function*(){const t=await e.promise;yield*t}()}}const ah=65535,ch=!!globalThis.process?.env?.DUMP_SESSION_KEYS;function lh(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&"Uint8Array"===e.constructor.name}function uh(e){if("boolean"!=typeof e)throw Error("boolean expected, not "+e)}function hh(e){if(!Number.isSafeInteger(e)||e<0)throw Error("positive integer expected, got "+e)}function dh(e,...t){if(!lh(e))throw Error("Uint8Array expected");if(t.length>0&&!t.includes(e.length))throw Error("Uint8Array expected of length "+t+", got length="+e.length)}function ph(e,t=!0){if(e.destroyed)throw Error("Hash instance has been destroyed");if(t&&e.finished)throw Error("Hash#digest() has already been called")}function fh(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function gh(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}const mh=(()=>68===new Uint8Array(new Uint32Array([287454020]).buffer)[0])();function yh(e){if("string"==typeof e)e=function(e){if("string"!=typeof e)throw Error("string expected");return new Uint8Array((new TextEncoder).encode(e))}(e);else{if(!lh(e))throw Error("Uint8Array expected, got "+typeof e);e=Sh(e)}return e}const bh=(e,t)=>{function r(r,...n){if(dh(r),!mh)throw Error("Non little-endian hardware is not yet supported");if(void 0!==e.nonceLength){const t=n[0];if(!t)throw Error("nonce / iv required");e.varSizeNonce?dh(t):dh(t,e.nonceLength)}const s=e.tagLength;s&&void 0!==n[1]&&dh(n[1]);const i=t(r,...n),o=(e,t)=>{if(void 0!==t){if(2!==e)throw Error("cipher output not supported");dh(t)}};let a=!1;return{encrypt(e,t){if(a)throw Error("cannot encrypt() twice with same key + nonce");return a=!0,dh(e),o(i.encrypt.length,t),i.encrypt(e,t)},decrypt(e,t){if(dh(e),s&&e.length<s)throw Error("invalid ciphertext length: smaller than tagLength="+s);return o(i.decrypt.length,t),i.decrypt(e,t)}}}return Object.assign(r,e),r};function wh(e,t,r=!0){if(void 0===t)return new Uint8Array(e);if(t.length!==e)throw Error("invalid output length, expected "+e+", got: "+t.length);if(r&&t.byteOffset%4!=0)throw Error("invalid output, must be aligned");return t}function vh(e,t,r,n){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,r,n);const s=BigInt(32),i=BigInt(4294967295),o=Number(r>>s&i),a=Number(r&i);e.setUint32(t+4,o,n),e.setUint32(t+0,a,n)}function Eh(e,t,r){uh(r);const n=new Uint8Array(16),s=(i=n,new DataView(i.buffer,i.byteOffset,i.byteLength));var i;return vh(s,0,BigInt(t),r),vh(s,8,BigInt(e),r),n}function Sh(e){return Uint8Array.from(e)}const Ah=e=>Uint8Array.from(e.split("").map((e=>e.charCodeAt(0)))),Ih=Ah("expand 16-byte k"),_h=Ah("expand 32-byte k"),Ch=fh(Ih),xh=fh(_h);function kh(e,t){return e<<t|e>>>32-t}function Th(e){return e.byteOffset%4==0}const Ph=2**32-1,Rh=new Uint32Array;function Lh(e,t){const{allowShortKeys:r,extendNonceFn:n,counterLength:s,counterRight:i,rounds:o}=function(e,t){if(null==t||"object"!=typeof t)throw Error("options must be defined");return Object.assign(e,t)}({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if("function"!=typeof e)throw Error("core must be a function");return hh(s),hh(o),uh(i),uh(r),(t,a,c,l,u=0)=>{dh(t),dh(a),dh(c);const h=c.length;if(void 0===l&&(l=new Uint8Array(h)),dh(l),hh(u),u<0||u>=Ph)throw Error("arx: counter overflow");if(l.length<h)throw Error(`arx: output (${l.length}) is shorter than data (${h})`);const d=[];let p,f,g=t.length;if(32===g)d.push(p=Sh(t)),f=xh;else{if(16!==g||!r)throw Error("arx: invalid 32-byte key, got length="+g);p=new Uint8Array(32),p.set(t),p.set(t,16),f=Ch,d.push(p)}Th(a)||d.push(a=Sh(a));const m=fh(p);if(n){if(24!==a.length)throw Error("arx: extended nonce must be 24 bytes");n(f,m,fh(a.subarray(0,16)),m),a=a.subarray(16)}const y=16-s;if(y!==a.length)throw Error(`arx: nonce must be ${y} or 16 bytes`);if(12!==y){const e=new Uint8Array(12);e.set(a,i?0:12-a.length),a=e,d.push(a)}const b=fh(a);return function(e,t,r,n,s,i,o,a){const c=s.length,l=new Uint8Array(64),u=fh(l),h=Th(s)&&Th(i),d=h?fh(s):Rh,p=h?fh(i):Rh;for(let f=0;f<c;o++){if(e(t,r,n,u,o,a),o>=Ph)throw Error("arx: counter overflow");const g=Math.min(64,c-f);if(h&&64===g){const e=f/4;if(f%4!=0)throw Error("arx: invalid block position");for(let t,r=0;r<16;r++)t=e+r,p[t]=d[t]^u[r];f+=64}else{for(let e,t=0;t<g;t++)e=f+t,i[e]=s[e]^l[t];f+=g}}}(e,f,m,b,c,l,u,o),gh(...d),l}}const Dh=(e,t)=>255&e[t++]|(255&e[t++])<<8;class Mh{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,dh(e=yh(e),32);const t=Dh(e,0),r=Dh(e,2),n=Dh(e,4),s=Dh(e,6),i=Dh(e,8),o=Dh(e,10),a=Dh(e,12),c=Dh(e,14);this.r[0]=8191&t,this.r[1]=8191&(t>>>13|r<<3),this.r[2]=7939&(r>>>10|n<<6),this.r[3]=8191&(n>>>7|s<<9),this.r[4]=255&(s>>>4|i<<12),this.r[5]=i>>>1&8190,this.r[6]=8191&(i>>>14|o<<2),this.r[7]=8065&(o>>>11|a<<5),this.r[8]=8191&(a>>>8|c<<8),this.r[9]=c>>>5&127;for(let t=0;t<8;t++)this.pad[t]=Dh(e,16+2*t)}process(e,t,r=!1){const n=r?0:2048,{h:s,r:i}=this,o=i[0],a=i[1],c=i[2],l=i[3],u=i[4],h=i[5],d=i[6],p=i[7],f=i[8],g=i[9],m=Dh(e,t+0),y=Dh(e,t+2),b=Dh(e,t+4),w=Dh(e,t+6),v=Dh(e,t+8),E=Dh(e,t+10),S=Dh(e,t+12),A=Dh(e,t+14);let I=s[0]+(8191&m),_=s[1]+(8191&(m>>>13|y<<3)),C=s[2]+(8191&(y>>>10|b<<6)),x=s[3]+(8191&(b>>>7|w<<9)),k=s[4]+(8191&(w>>>4|v<<12)),T=s[5]+(v>>>1&8191),P=s[6]+(8191&(v>>>14|E<<2)),R=s[7]+(8191&(E>>>11|S<<5)),L=s[8]+(8191&(S>>>8|A<<8)),D=s[9]+(A>>>5|n),M=0,N=M+I*o+_*(5*g)+C*(5*f)+x*(5*p)+k*(5*d);M=N>>>13,N&=8191,N+=T*(5*h)+P*(5*u)+R*(5*l)+L*(5*c)+D*(5*a),M+=N>>>13,N&=8191;let O=M+I*a+_*o+C*(5*g)+x*(5*f)+k*(5*p);M=O>>>13,O&=8191,O+=T*(5*d)+P*(5*h)+R*(5*u)+L*(5*l)+D*(5*c),M+=O>>>13,O&=8191;let U=M+I*c+_*a+C*o+x*(5*g)+k*(5*f);M=U>>>13,U&=8191,U+=T*(5*p)+P*(5*d)+R*(5*h)+L*(5*u)+D*(5*l),M+=U>>>13,U&=8191;let F=M+I*l+_*c+C*a+x*o+k*(5*g);M=F>>>13,F&=8191,F+=T*(5*f)+P*(5*p)+R*(5*d)+L*(5*h)+D*(5*u),M+=F>>>13,F&=8191;let B=M+I*u+_*l+C*c+x*a+k*o;M=B>>>13,B&=8191,B+=T*(5*g)+P*(5*f)+R*(5*p)+L*(5*d)+D*(5*h),M+=B>>>13,B&=8191;let q=M+I*h+_*u+C*l+x*c+k*a;M=q>>>13,q&=8191,q+=T*o+P*(5*g)+R*(5*f)+L*(5*p)+D*(5*d),M+=q>>>13,q&=8191;let $=M+I*d+_*h+C*u+x*l+k*c;M=$>>>13,$&=8191,$+=T*a+P*o+R*(5*g)+L*(5*f)+D*(5*p),M+=$>>>13,$&=8191;let z=M+I*p+_*d+C*h+x*u+k*l;M=z>>>13,z&=8191,z+=T*c+P*a+R*o+L*(5*g)+D*(5*f),M+=z>>>13,z&=8191;let j=M+I*f+_*p+C*d+x*h+k*u;M=j>>>13,j&=8191,j+=T*l+P*c+R*a+L*o+D*(5*g),M+=j>>>13,j&=8191;let V=M+I*g+_*f+C*p+x*d+k*h;M=V>>>13,V&=8191,V+=T*u+P*l+R*c+L*a+D*o,M+=V>>>13,V&=8191,M=(M<<2)+M|0,M=M+N|0,N=8191&M,M>>>=13,O+=M,s[0]=N,s[1]=O,s[2]=U,s[3]=F,s[4]=B,s[5]=q,s[6]=$,s[7]=z,s[8]=j,s[9]=V}finalize(){const{h:e,pad:t}=this,r=new Uint16Array(10);let n=e[1]>>>13;e[1]&=8191;for(let t=2;t<10;t++)e[t]+=n,n=e[t]>>>13,e[t]&=8191;e[0]+=5*n,n=e[0]>>>13,e[0]&=8191,e[1]+=n,n=e[1]>>>13,e[1]&=8191,e[2]+=n,r[0]=e[0]+5,n=r[0]>>>13,r[0]&=8191;for(let t=1;t<10;t++)r[t]=e[t]+n,n=r[t]>>>13,r[t]&=8191;r[9]-=8192;let s=(1^n)-1;for(let e=0;e<10;e++)r[e]&=s;s=~s;for(let t=0;t<10;t++)e[t]=e[t]&s|r[t];e[0]=65535&(e[0]|e[1]<<13),e[1]=65535&(e[1]>>>3|e[2]<<10),e[2]=65535&(e[2]>>>6|e[3]<<7),e[3]=65535&(e[3]>>>9|e[4]<<4),e[4]=65535&(e[4]>>>12|e[5]<<1|e[6]<<14),e[5]=65535&(e[6]>>>2|e[7]<<11),e[6]=65535&(e[7]>>>5|e[8]<<8),e[7]=65535&(e[8]>>>8|e[9]<<5);let i=e[0]+t[0];e[0]=65535&i;for(let r=1;r<8;r++)i=(e[r]+t[r]|0)+(i>>>16)|0,e[r]=65535&i;gh(r)}update(e){ph(this),dh(e=yh(e));const{buffer:t,blockLen:r}=this,n=e.length;for(let s=0;s<n;){const i=Math.min(r-this.pos,n-s);if(i!==r)t.set(e.subarray(s,s+i),this.pos),this.pos+=i,s+=i,this.pos===r&&(this.process(t,0,!1),this.pos=0);else for(;r<=n-s;s+=r)this.process(e,s)}return this}destroy(){gh(this.h,this.r,this.buffer,this.pad)}digestInto(e){ph(this),function(e,t){dh(e);const r=t.outputLen;if(e.length<r)throw Error("digestInto() expects output buffer of length at least "+r)}(e,this),this.finished=!0;const{buffer:t,h:r}=this;let{pos:n}=this;if(n){for(t[n++]=1;n<16;n++)t[n]=0;this.process(t,0,!0)}this.finalize();let s=0;for(let t=0;t<8;t++)e[s++]=r[t]>>>0,e[s++]=r[t]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}}const Nh=function(e){const t=(t,r)=>e(r).update(yh(t)).digest(),r=e(new Uint8Array(32));return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=t=>e(t),t}((e=>new Mh(e)));function Oh(e,t,r,n,s,i=20){let o=e[0],a=e[1],c=e[2],l=e[3],u=t[0],h=t[1],d=t[2],p=t[3],f=t[4],g=t[5],m=t[6],y=t[7],b=s,w=r[0],v=r[1],E=r[2],S=o,A=a,I=c,_=l,C=u,x=h,k=d,T=p,P=f,R=g,L=m,D=y,M=b,N=w,O=v,U=E;for(let e=0;e<i;e+=2)S=S+C|0,M=kh(M^S,16),P=P+M|0,C=kh(C^P,12),S=S+C|0,M=kh(M^S,8),P=P+M|0,C=kh(C^P,7),A=A+x|0,N=kh(N^A,16),R=R+N|0,x=kh(x^R,12),A=A+x|0,N=kh(N^A,8),R=R+N|0,x=kh(x^R,7),I=I+k|0,O=kh(O^I,16),L=L+O|0,k=kh(k^L,12),I=I+k|0,O=kh(O^I,8),L=L+O|0,k=kh(k^L,7),_=_+T|0,U=kh(U^_,16),D=D+U|0,T=kh(T^D,12),_=_+T|0,U=kh(U^_,8),D=D+U|0,T=kh(T^D,7),S=S+x|0,U=kh(U^S,16),L=L+U|0,x=kh(x^L,12),S=S+x|0,U=kh(U^S,8),L=L+U|0,x=kh(x^L,7),A=A+k|0,M=kh(M^A,16),D=D+M|0,k=kh(k^D,12),A=A+k|0,M=kh(M^A,8),D=D+M|0,k=kh(k^D,7),I=I+T|0,N=kh(N^I,16),P=P+N|0,T=kh(T^P,12),I=I+T|0,N=kh(N^I,8),P=P+N|0,T=kh(T^P,7),_=_+C|0,O=kh(O^_,16),R=R+O|0,C=kh(C^R,12),_=_+C|0,O=kh(O^_,8),R=R+O|0,C=kh(C^R,7);let F=0;n[F++]=o+S|0,n[F++]=a+A|0,n[F++]=c+I|0,n[F++]=l+_|0,n[F++]=u+C|0,n[F++]=h+x|0,n[F++]=d+k|0,n[F++]=p+T|0,n[F++]=f+P|0,n[F++]=g+R|0,n[F++]=m+L|0,n[F++]=y+D|0,n[F++]=b+M|0,n[F++]=w+N|0,n[F++]=v+O|0,n[F++]=E+U|0}const Uh=Lh(Oh,{counterRight:!1,counterLength:4,allowShortKeys:!1}),Fh=new Uint8Array(16),Bh=(e,t)=>{e.update(t);const r=t.length%16;r&&e.update(Fh.subarray(r))},qh=new Uint8Array(32);function $h(e,t,r,n,s){const i=e(t,r,qh),o=Nh.create(i);s&&Bh(o,s),Bh(o,n);const a=Eh(n.length,s?s.length:0,!0);o.update(a);const c=o.digest();return gh(i,a),c}const zh=bh({blockSize:64,nonceLength:12,tagLength:16},(jh=Uh,(e,t,r)=>{const n=16;return{encrypt(s,i){const o=s.length;(i=wh(o+n,i,!1)).set(s);const a=i.subarray(0,-16);jh(e,t,a,a,1);const c=$h(jh,e,t,a,r);return i.set(c,o),gh(c),i},decrypt(s,i){i=wh(s.length-n,i,!1);const o=s.subarray(0,-16),a=s.subarray(-16),c=$h(jh,e,t,o,r);if(!((e,t)=>{if(e.length!==t.length)return!1;let r=0;for(let n=0;n<e.length;n++)r|=e[n]^t[n];return 0===r})(a,c))throw Error("invalid tag");return i.set(s.subarray(0,-16)),jh(e,t,i,i,1),gh(c),i}}}));var jh;const Vh=Uint8Array.from([0]),Kh=Uint8Array.of();const Hh={hashSHA256:e=>on(e.subarray()),getHKDF(e,t){const r=function(e,t,r){return ar(e),void 0===r&&(r=new Uint8Array(e.outputLen)),vc(e,Ar(r),Ar(t))}(on,t,e),n=function(e,t,r,n=32){ar(e),ir(n);const s=e.outputLen;if(n>255*s)throw Error("Length should be <= 255*HashLen");const i=Math.ceil(n/s);void 0===r&&(r=Kh);const o=new Uint8Array(i*s),a=vc.create(e,t),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let e=0;e<i;e++)Vh[0]=e+1,c.update(0===e?Kh:l).update(r).update(Vh).digestInto(l),o.set(l,s*e),a._cloneInto(c);return a.destroy(),c.destroy(),lr(l,Vh),o.slice(0,n)}(on,r,void 0,96),s=n;return[s.subarray(0,32),s.subarray(32,64),s.subarray(64,96)]},generateX25519KeyPair(){const e=Ya.utils.randomPrivateKey();return{publicKey:Ya.getPublicKey(e),privateKey:e}},generateX25519KeyPairFromSeed:e=>({publicKey:Ya.getPublicKey(e),privateKey:e}),generateX25519SharedKey:(e,t)=>Ya.getSharedSecret(e.subarray(),t.subarray()),chaCha20Poly1305Encrypt:(e,t,r,n)=>zh(n,t,r).encrypt(e.subarray()),chaCha20Poly1305Decrypt:(e,t,r,n,s)=>zh(n,t,r).decrypt(e.subarray(),s)},Gh=Hh;const Wh=e=>{const r=t(2);return r[0]=e>>8,r[1]=e,r};Wh.bytes=2;const Xh=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");if(e instanceof Uint8Array){let t=0;return t+=e[0]<<8,t+=e[1],t}return e.getUint16(0)};function Zh(e,t){t.enabled&&ch&&(e?(t("LOCAL_STATIC_PUBLIC_KEY "+an(e.publicKey,"hex")),t("LOCAL_STATIC_PRIVATE_KEY "+an(e.privateKey,"hex"))):t("Missing local static keys."))}function Yh(e,t){t.enabled&&ch&&(e?(t("LOCAL_PUBLIC_EPHEMERAL_KEY "+an(e.publicKey,"hex")),t("LOCAL_PRIVATE_EPHEMERAL_KEY "+an(e.privateKey,"hex"))):t("Missing local ephemeral keys."))}function Qh(e,t){t.enabled&&ch&&t(e?"REMOTE_EPHEMERAL_PUBLIC_KEY "+an(e.subarray(),"hex"):"Missing remote ephemeral keys.")}function Jh(e,t,r){r.enabled&&ch&&(r(`CIPHER_STATE_1 ${e.n.getUint64()} ${e.k&&an(e.k,"hex")}`),r(`CIPHER_STATE_2 ${t.n.getUint64()} ${t.k&&an(t.k,"hex")}`))}Xh.bytes=2;class ed extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=ed.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}class td{n;bytes;view;constructor(t=0){this.n=t,this.bytes=e(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,t,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw Error("Cipherstate has reached maximum n, a new handshake must be performed")}}const rd=e(0);class nd{k;n;crypto;constructor(e,t,r=0){this.crypto=e,this.k=t,this.n=new td(r)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const r=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),r}decryptWithAd(e,t,r){if(!this.hasKey())return t;this.n.assertValue();const n=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,r);return this.n.increment(),n}}class sd{cs;ck;h;crypto;constructor(t,r){this.crypto=t;const n=tt(r,"utf-8");this.h=function(t,r){if(r.length<=32){const t=e(32);return t.set(r),t}return t.hash(r)}(t,n),this.ck=this.h,this.cs=new nd(t)}mixKey(e){const[t,r]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new nd(this.crypto,r)}mixHash(e){this.h=this.crypto.hash(new Ks(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,rd);return[new nd(this.crypto,e),new nd(this.crypto,t)]}}class id{ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:r,prologue:n,initiator:s,s:i,e:o,rs:a,re:c}=e;this.crypto=t,this.ss=new sd(t,r),this.ss.mixHash(n),this.initiator=s,this.s=i,this.e=o,this.rs=a,this.re=c}writeE(){if(this.e)throw Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw Error("ephemeral keypair is not set");if(!this.re)throw Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw Error("ephemeral keypair is not set");if(!this.rs)throw Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw Error("static keypair is not set");if(!this.re)throw Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw Error("static keypair is not set");if(!this.re)throw Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw Error("ephemeral keypair is not set");if(!this.rs)throw Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw Error("remote static public key is already set");const r=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+r)throw Error("message is not long enough");const n=e.sublist(t,t+r);return this.rs=this.ss.decryptAndHash(n),r}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class od extends id{writeMessageA(e){return new Ks(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const r=this.writeS();return this.writeES(),new Ks(t,r,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new Ks(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(e){throw new ed("handshake stage 0 validation fail: "+e.message)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(e){throw new ed("handshake stage 1 validation fail: "+e.message)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(e){throw new ed("handshake stage 2 validation fail: "+e.message)}}}var ad,cd;async function ld(e,t,r){const n=await e.sign(hd(t));return cd.encode({identityKey:Gc(e.publicKey),identitySig:n,extensions:r})}async function ud(e,t,r){try{const n=cd.decode(e),s=Hc(n.identityKey);if(!1===r?.equals(s))throw Error(`Payload identity key ${s} does not match expected remote identity key ${r}`);if(!t)throw Error("Remote static does not exist");const i=hd(t);if(!await s.verify(i,n.identitySig))throw Error("Invalid payload signature");return n}catch(e){throw new Dn(e.message)}}function hd(e){const t=tt("noise-libp2p-static-key:");return e instanceof Uint8Array?qs([t,e],t.length+e.length):(e.prepend(t),e)}async function dd(e,t){const{log:r,connection:n,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=e,u=await ld(i,a.publicKey,l),h=new od({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});Zh(h.s,r),r.trace("Stage 0 - Initiator starting to send first message."),await n.write(h.writeMessageA(rd),t),r.trace("Stage 0 - Initiator finished sending first message."),Yh(h.e,r),r.trace("Stage 1 - Initiator waiting to receive first message from responder...");const d=h.readMessageB(await n.read(t));var p,f;r.trace("Stage 1 - Initiator received the message."),Qh(h.re,r),p=h.rs,(f=r).enabled&&ch&&f(p?"REMOTE_STATIC_PUBLIC_KEY "+an(p.subarray(),"hex"):"Missing remote static public key."),r.trace("Initiator going to check remote's signature...");const g=await ud(d,h.rs,c);r.trace("All good with the signature!"),r.trace("Stage 2 - Initiator sending third handshake message."),await n.write(h.writeMessageC(u),t),r.trace("Stage 2 - Initiator sent message with signed payload.");const[m,y]=h.ss.split();return Jh(m,y,r),{payload:g,encrypt(e){return m.encryptWithAd(rd,e)},decrypt(e,t){return y.decryptWithAd(rd,e,t)}}}(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes)for(const r of e.webtransportCerthashes)t.uint32(10),t.bytes(r);if(null!=e.streamMuxers)for(const r of e.streamMuxers)t.uint32(18),t.string(r);!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={webtransportCerthashes:[],streamMuxers:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:if(null!=r.limits?.webtransportCerthashes&&n.webtransportCerthashes.length===r.limits.webtransportCerthashes)throw new Jt('Decode error - map field "webtransportCerthashes" had too many elements');n.webtransportCerthashes.push(e.bytes());break;case 2:if(null!=r.limits?.streamMuxers&&n.streamMuxers.length===r.limits.streamMuxers)throw new Jt('Decode error - map field "streamMuxers" had too many elements');n.streamMuxers.push(e.string());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(ad||(ad={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.identityKey&&e.identityKey.byteLength>0&&(t.uint32(10),t.bytes(e.identityKey)),null!=e.identitySig&&e.identitySig.byteLength>0&&(t.uint32(18),t.bytes(e.identitySig)),null!=e.extensions&&(t.uint32(34),ad.codec().encode(e.extensions,t)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r,n={})=>{const s={identityKey:e(0),identitySig:e(0)},i=null==r?t.len:t.pos+r;for(;t.pos<i;){const e=t.uint32();switch(e>>>3){case 1:s.identityKey=t.bytes();break;case 2:s.identitySig=t.bytes();break;case 4:s.extensions=ad.codec().decode(t,t.uint32(),{limits:n.limits?.extensions});break;default:t.skipType(7&e)}}return s}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(cd||(cd={}));class pd{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(t,r={}){const{staticNoiseKey:n,extensions:s,crypto:i,prologueBytes:o}=r,{metrics:a}=t;this.components=t;const c=i??Gh;this.crypto=function(e){return{generateKeypair:e.generateX25519KeyPair,dh:(t,r)=>e.generateX25519SharedKey(t.privateKey,r).subarray(0,32),encrypt:e.chaCha20Poly1305Encrypt,decrypt:e.chaCha20Poly1305Decrypt,hash:e.hashSHA256,hkdf:e.getHKDF}}(c),this.extensions={webtransportCerthashes:[],...s},this.metrics=a?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(a):void 0,this.staticKey=n?c.generateX25519KeyPairFromSeed(n):c.generateX25519KeyPair(),this.prologue=o??e(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[os]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){const r=ih(e,{lengthEncoder:Wh,lengthDecoder:Xh,maxDataLength:ah}),n=await this.performHandshakeInitiator(r,this.components.privateKey,t?.remotePeer?.publicKey,t),s=await this.createSecureConnection(r,n);e.source=s.source,e.sink=s.sink;const i=Hc(n.payload.identityKey);return{conn:e,remoteExtensions:n.payload.extensions,remotePeer:tl(i),streamMuxer:!0===t?.skipStreamMuxerNegotiation?void 0:this.getStreamMuxer(n.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(null==e||0===e.length)return;const t=this.components.upgrader.getStreamMuxers();if(null!=t)for(const r of e){const e=t.get(r);if(null!=e)return e}if(e.length)throw new Mn("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){const r=ih(e,{lengthEncoder:Wh,lengthDecoder:Xh,maxDataLength:ah}),n=await this.performHandshakeResponder(r,this.components.privateKey,t?.remotePeer?.publicKey,t),s=await this.createSecureConnection(r,n);e.source=s.source,e.sink=s.sink;const i=Hc(n.payload.identityKey);return{conn:e,remoteExtensions:n.payload.extensions,remotePeer:tl(i),streamMuxer:!0===t?.skipStreamMuxerNegotiation?void 0:this.getStreamMuxer(n.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,r,n){let s;const i=!0===n?.skipStreamMuxerNegotiation?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{s=await dd({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:i,webtransportCerthashes:[],...this.extensions}},n),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){throw this.metrics?.xxHandshakeErrors.increment(),e}return s}async performHandshakeResponder(e,t,r,n){let s;const i=!0===n?.skipStreamMuxerNegotiation?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{s=await async function(e,t){const{log:r,connection:n,crypto:s,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=e,u=await ld(i,a.publicKey,l),h=new od({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});Zh(h.s,r),r.trace("Stage 0 - Responder waiting to receive first message."),h.readMessageA(await n.read(t)),r.trace("Stage 0 - Responder received first message."),Qh(h.re,r),r.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(h.writeMessageB(u),t),r.trace("Stage 1 - Responder sent the second handshake message with signed payload."),Yh(h.e,r),r.trace("Stage 2 - Responder waiting for third handshake message...");const d=h.readMessageC(await n.read(t));r.trace("Stage 2 - Responder received the message, finished handshake.");const p=await ud(d,h.rs,c),[f,g]=h.ss.split();return Jh(f,g,r),{payload:p,encrypt:e=>g.encryptWithAd(rd,e),decrypt:(e,t)=>f.decryptWithAd(rd,e,t)}}({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:i,webtransportCerthashes:[],...this.extensions}},n),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){throw this.metrics?.xxHandshakeErrors.increment(),e}return s}async createSecureConnection(e,t){const[r,n]=function(){const e=oh(),t=oh();return[{source:e.source,sink:t.sink},{source:t.source,sink:e.sink}]}(),s=e.unwrap();return await pi(r,function(e,t){return async function*(r){for await(const n of r)for(let r=0;r<n.length;r+=65519){let s,i=r+65519;i>n.length&&(i=n.length),s=n instanceof Uint8Array?e.encrypt(n.subarray(r,i)):e.encrypt(n.sublist(r,i)),t?.encryptedPackets.increment(),yield new Ks(Wh(s.byteLength),s)}}}(t,this.metrics),s,(e=>Ju(e,{lengthDecoder:Xh})),function(e,t){return async function*(r){for await(const n of r)for(let r=0;r<n.length;r+=ah){let s=r+ah;if(s>n.length&&(s=n.length),s-16<r)throw Error("Invalid chunk");const i=n.sublist(r,s),o=n.subarray(r,s-16);try{const r=e.decrypt(i,o);t?.decryptedPackets.increment(),yield r}catch(e){throw t?.decryptErrors.increment(),e}}}}(t,this.metrics),r),n}}function fd(e={}){return t=>new pd(t,e)}const gd=Hd("dns4"),md=Hd("dns6"),yd=Hd("dnsaddr"),bd=Kd(Hd("dns"),yd,gd,md),wd=Kd(Hd("ip4"),Hd("ip6")),vd=Kd(Vd(wd,Hd("tcp")),Vd(bd,Hd("tcp"))),Ed=Vd(wd,Hd("udp")),Sd=Vd(Ed,Hd("utp")),Ad=Vd(Ed,Hd("quic")),Id=Vd(Ed,Hd("quic-v1")),_d=Kd(Vd(vd,Hd("ws")),Vd(bd,Hd("ws"))),Cd=Kd(Vd(_d,Hd("p2p")),_d),xd=Kd(Vd(vd,Hd("wss")),Vd(bd,Hd("wss")),Vd(vd,Hd("tls"),Hd("ws")),Vd(bd,Hd("tls"),Hd("ws"))),kd=Kd(Vd(xd,Hd("p2p")),xd),Td=Kd(Vd(vd,Hd("http")),Vd(wd,Hd("http")),Vd(bd,Hd("http"))),Pd=Kd(Vd(vd,Hd("https")),Vd(wd,Hd("https")),Vd(bd,Hd("https"))),Rd=Vd(Ed,Hd("webrtc-direct"),Hd("certhash")),Ld=Kd(Vd(Rd,Hd("p2p")),Rd),Dd=Vd(Id,Hd("webtransport"),Hd("certhash"),Hd("certhash")),Md=Kd(Vd(Dd,Hd("p2p")),Dd),Nd=Kd(Vd(Cd,Hd("p2p-webrtc-star"),Hd("p2p")),Vd(kd,Hd("p2p-webrtc-star"),Hd("p2p")),Vd(Cd,Hd("p2p-webrtc-star")),Vd(kd,Hd("p2p-webrtc-star")));Kd(Vd(Cd,Hd("p2p-websocket-star"),Hd("p2p")),Vd(kd,Hd("p2p-websocket-star"),Hd("p2p")),Vd(Cd,Hd("p2p-websocket-star")),Vd(kd,Hd("p2p-websocket-star")));const Od=Kd(Vd(Td,Hd("p2p-webrtc-direct"),Hd("p2p")),Vd(Pd,Hd("p2p-webrtc-direct"),Hd("p2p")),Vd(Td,Hd("p2p-webrtc-direct")),Vd(Pd,Hd("p2p-webrtc-direct"))),Ud=Kd(_d,xd,Td,Pd,Nd,Od,vd,Sd,Ad,bd,Ld,Md);Kd(Vd(Ud,Hd("p2p-stardust"),Hd("p2p")),Vd(Ud,Hd("p2p-stardust")));const Fd=Kd(Vd(Ud,Hd("p2p")),Nd,Od,Ld,Md,Hd("p2p")),Bd=Kd(Vd(Fd,Hd("p2p-circuit"),Fd),Vd(Fd,Hd("p2p-circuit")),Vd(Hd("p2p-circuit"),Fd),Vd(Ud,Hd("p2p-circuit")),Vd(Hd("p2p-circuit"),Ud),Hd("p2p-circuit")),qd=()=>Kd(Vd(Bd,qd),Bd),$d=qd(),zd=Kd(Vd($d,Fd,$d),Vd(Fd,$d),Vd($d,Fd),$d,Fd);function jd(e){return function(t){let r;try{r=Hl(t)}catch(e){return!1}const n=e(r.protoNames());return null!==n&&(!0===n||!1===n?n:0===n.length)}}function Vd(...e){function t(t){if(t.length<e.length)return null;let r=t;return e.some((e=>(r="function"==typeof e?e().partialMatch(t):e.partialMatch(t),Array.isArray(r)&&(t=r),null===r))),r}return{toString(){return"{ "+e.join(" ")+" }"},input:e,matches:jd(t),partialMatch:t}}function Kd(...e){function t(t){let r=null;return e.some((e=>{const n="function"==typeof e?e().partialMatch(t):e.partialMatch(t);return null!=n&&(r=n,!0)})),r}return{toString(){return"{ "+e.join(" ")+" }"},input:e,matches:jd(t),partialMatch:t}}function Hd(e){const t=e;return{toString(){return t},matches(e){let r;try{r=Hl(e)}catch(e){return!1}const n=r.protoNames();return 1===n.length&&n[0]===t},partialMatch(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}Kd(Vd($d,Hd("webrtc"),Hd("p2p")),Vd($d,Hd("webrtc")),Vd(Ud,Hd("webrtc"),Hd("p2p")),Vd(Ud,Hd("webrtc")),Hd("webrtc"));class Gd extends ss{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(null==t.list||0===t.list.length)throw Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??1e3,this.list=[];for(const e of t.list){if(!zd.matches(e)){this.log.error("Invalid multiaddr");continue}const t=Hl(e),r=t.getPeerId();if(null==r){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const n={id:el(r),multiaddrs:[t]};this.list.push(n)}this._init=t}[_n]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[os]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout((()=>{this._discoverBootstrapPeers().catch((e=>{this.log.error(e)}))}),this.timeout))}async _discoverBootstrapPeers(){if(null!=this.timer)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??"bootstrap"]:{value:this._init.tagValue??50,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),null==this.timer)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch((t=>{this.log.error("could not dial bootstrap peer %p",e.id,t)}))}}stop(){null!=this.timer&&clearTimeout(this.timer),this.timer=void 0}}var Wd;(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.publicKey&&e.publicKey.byteLength>0&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.payloadType&&e.payloadType.byteLength>0&&(t.uint32(18),t.bytes(e.payloadType)),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(26),t.bytes(e.payload)),null!=e.signature&&e.signature.byteLength>0&&(t.uint32(42),t.bytes(e.signature)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r)=>{const n={publicKey:e(0),payloadType:e(0),payload:e(0),signature:e(0)},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const e=t.uint32();switch(e>>>3){case 1:n.publicKey=t.bytes();break;case 2:n.payloadType=t.bytes();break;case 3:n.payload=t.bytes();break;case 5:n.signature=t.bytes();break;default:t.skipType(7&e)}}return n}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(Wd||(Wd={}));class Xd extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class Zd{static createFromProtobuf=e=>{const t=Wd.decode(e),r=Hc(t.publicKey);return new Zd({publicKey:r,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,r)=>{if(null==t)throw Error("Missing private key");const n=e.domain,s=e.codec,i=e.marshal(),o=Yd(n,s,i),a=await t.sign(o.subarray(),r);return new Zd({publicKey:t.publicKey,payloadType:s,payload:i,signature:a})};static openAndCertify=async(e,t,r)=>{const n=Zd.createFromProtobuf(e);if(!await n.validate(t,r))throw new Xd("Envelope signature is not valid for the given domain");return n};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:r,payload:n,signature:s}=e;this.publicKey=t,this.payloadType=r,this.payload=n,this.signature=s}marshal(){return null==this.marshaled&&(this.marshaled=Wd.encode({publicKey:Gc(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return null!=e&&$s(this.marshal(),e.marshal())}async validate(e,t){const r=Yd(e,this.payloadType,this.payload);return this.publicKey.verify(r.subarray(),this.signature,t)}}const Yd=(e,t,r)=>{const n=tt(e),s=h(n.byteLength),i=h(t.length),o=h(r.length);return new Ks(s,n,i,t,o,r)};const Qd=Uint8Array.from([3,1]);var Jd;(t=>{let r;(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r)=>{const n={multiaddr:e(0)},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const e=t.uint32();if(e>>>3==1)n.multiaddr=t.bytes();else t.skipType(7&e)}return n}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(t.AddressInfo||(t.AddressInfo={})),t.codec=()=>(null==r&&(r=Qt(((e,r,n={})=>{if(!1!==n.lengthDelimited&&r.fork(),null!=e.peerId&&e.peerId.byteLength>0&&(r.uint32(10),r.bytes(e.peerId)),null!=e.seq&&0n!==e.seq&&(r.uint32(16),r.uint64(e.seq)),null!=e.addresses)for(const n of e.addresses)r.uint32(26),t.AddressInfo.codec().encode(n,r);!1!==n.lengthDelimited&&r.ldelim()}),((r,n,s={})=>{const i={peerId:e(0),seq:0n,addresses:[]},o=null==n?r.len:r.pos+n;for(;r.pos<o;){const e=r.uint32();switch(e>>>3){case 1:i.peerId=r.bytes();break;case 2:i.seq=r.uint64();break;case 3:if(null!=s.limits?.addresses&&i.addresses.length===s.limits.addresses)throw new Jt('Decode error - map field "addresses" had too many elements');i.addresses.push(t.AddressInfo.codec().decode(r,r.uint32(),{limits:s.limits?.addresses$}));break;default:r.skipType(7&e)}}return i}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(Jd||(Jd={}));class ep{static createFromProtobuf=e=>{const t=Jd.decode(e),r=rl(Oe(t.peerId)),n=(t.addresses??[]).map((e=>Hl(e.multiaddr))),s=t.seq;return new ep({peerId:r,multiaddrs:n,seqNumber:s})};static DOMAIN="libp2p-peer-record";static CODEC=Qd;peerId;multiaddrs;seqNumber;domain=ep.DOMAIN;codec=ep.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:r,seqNumber:n}=e;this.peerId=t,this.multiaddrs=r??[],this.seqNumber=n??BigInt(Date.now())}marshal(){return null==this.marshaled&&(this.marshaled=Jd.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map((e=>({multiaddr:e.bytes})))})),this.marshaled}equals(e){return e instanceof ep&&(!!this.peerId.equals(e.peerId)&&(this.seqNumber===e.seqNumber&&!!function(e,t){const r=(e,t)=>e.toString().localeCompare(t.toString());return e.length===t.length&&(t.sort(r),e.sort(r).every(((e,r)=>t[r].equals(e))))}(this.multiaddrs,e.multiaddrs)))}}function tp(e,t){let r;const n=()=>{clearTimeout(r),r=setTimeout((()=>{r=void 0,e()}),t)};return n.start=()=>{},n.stop=()=>{clearTimeout(r)},n}function rp(e){if(null!=e[Symbol.asyncIterator])return(async()=>{for await(const t of e);})();for(const t of e);}const np=globalThis.CustomEvent??Event;function sp(e,t){const r=ih(e,t),n={async read(e,t){const n=await r.read(t);return e.decode(n)},async write(e,t,n){await r.write(t.encode(e),n)},async writeV(e,t,n){await r.writeV(e.map((e=>t.encode(e))),n)},pb(e){return{async read(t){return n.read(e,t)},async write(t,r){return n.write(t,e,r)},async writeV(t,r){return n.writeV(t,e,r)},unwrap(){return n}}},unwrap(){return r.unwrap()}};return n}var ip;(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{if(!1!==r.lengthDelimited&&t.fork(),null!=e.protocolVersion&&(t.uint32(42),t.string(e.protocolVersion)),null!=e.agentVersion&&(t.uint32(50),t.string(e.agentVersion)),null!=e.publicKey&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.listenAddrs)for(const r of e.listenAddrs)t.uint32(18),t.bytes(r);if(null!=e.observedAddr&&(t.uint32(34),t.bytes(e.observedAddr)),null!=e.protocols)for(const r of e.protocols)t.uint32(26),t.string(r);null!=e.signedPeerRecord&&(t.uint32(66),t.bytes(e.signedPeerRecord)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={listenAddrs:[],protocols:[]},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 5:n.protocolVersion=e.string();break;case 6:n.agentVersion=e.string();break;case 1:n.publicKey=e.bytes();break;case 2:if(null!=r.limits?.listenAddrs&&n.listenAddrs.length===r.limits.listenAddrs)throw new Jt('Decode error - map field "listenAddrs" had too many elements');n.listenAddrs.push(e.bytes());break;case 4:n.observedAddr=e.bytes();break;case 3:if(null!=r.limits?.protocols&&n.protocols.length===r.limits.protocols)throw new Jt('Decode error - map field "protocols" had too many elements');n.protocols.push(e.string());break;case 8:n.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(ip||(ip={}));const op={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:8192,runOnConnectionOpen:!0,runOnLimitedConnection:!0};class ap{host;protocol;started;timeout;peerId;privateKey;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnLimitedConnection;log;constructor(e,t){var r,n;this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??op.timeout,this.maxInboundStreams=t.maxInboundStreams??op.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??op.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??op.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??op.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??op.runOnLimitedConnection,this.host={protocolVersion:(t.protocolPrefix??op.protocolPrefix)+"/0.1.0",agentVersion:(r=e.nodeInfo,n=t.agentVersion,null!=n?n:r.userAgent)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:tt(this.host.agentVersion),ProtocolVersion:tt(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,(e=>{this.handleProtocol(e).catch((e=>{this.log.error(e)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}var cp,lp={};var up=(cp||(cp=1,function(){var e,t,r,n,s,i,o,a;a=e=>[(e&255<<24)>>>24,(e&255<<16)>>>16,(65280&e)>>>8,255&e].join("."),o=e=>{var r,n,s,i,o,a;for(r=[],s=i=0;i<=3&&0!==e.length;s=++i){if(s>0){if("."!==e[0])throw Error("Invalid IP");e=e.substring(1)}o=(a=t(e))[0],n=a[1],e=e.substring(n),r.push(o)}if(0!==e.length)throw Error("Invalid IP");switch(r.length){case 1:if(r[0]>4294967295)throw Error("Invalid IP");return r[0]>>>0;case 2:if(r[0]>255||r[1]>16777215)throw Error("Invalid IP");return(r[0]<<24|r[1])>>>0;case 3:if(r[0]>255||r[1]>255||r[2]>65535)throw Error("Invalid IP");return(r[0]<<24|r[1]<<16|r[2])>>>0;case 4:if(r[0]>255||r[1]>255||r[2]>255||r[3]>255)throw Error("Invalid IP");return(r[0]<<24|r[1]<<16|r[2]<<8|r[3])>>>0;default:throw Error("Invalid IP")}},n=(r=e=>e.charCodeAt(0))("0"),i=r("a"),s=r("A"),t=e=>{var t,o,a,c,l;for(c=0,t=10,o="9",a=0,e.length>1&&"0"===e[a]&&("x"===e[a+1]||"X"===e[a+1]?(a+=2,t=16):"0"<=e[a+1]&&e[a+1]<="9"&&(a++,t=8,o="7")),l=a;a<e.length;){if("0"<=e[a]&&e[a]<=o)c=c*t+(r(e[a])-n)>>>0;else{if(16!==t)break;if("a"<=e[a]&&e[a]<="f")c=c*t+(10+r(e[a])-i)>>>0;else{if(!("A"<=e[a]&&e[a]<="F"))break;c=c*t+(10+r(e[a])-s)>>>0}}if(c>4294967295)throw Error("too large");a++}if(a===l)throw Error("empty octet");return[c,a]},e=function(){function e(e,t){var r,n,s;if("string"!=typeof e)throw Error("Missing `net' parameter");if(t||(s=e.split("/",2),e=s[0],t=s[1]),t||(t=32),"string"==typeof t&&t.indexOf(".")>-1){try{this.maskLong=o(t)}catch(e){throw Error("Invalid mask: "+t)}for(r=n=32;n>=0;r=--n)if(this.maskLong===4294967295<<32-r>>>0){this.bitmask=r;break}}else{if(!t&&0!==t)throw Error("Invalid mask: empty");this.bitmask=parseInt(t,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0)}try{this.netLong=(o(e)&this.maskLong)>>>0}catch(t){throw Error("Invalid net address: "+e)}if(!(this.bitmask<=32))throw Error("Invalid mask for ip4: "+t);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return e.prototype.contains=function(t){return"string"==typeof t&&(t.indexOf("/")>0||4!==t.split(".").length)&&(t=new e(t)),t instanceof e?this.contains(t.base)&&this.contains(t.broadcast||t.last):(o(t)&this.maskLong)>>>0==(this.netLong&this.maskLong)>>>0},e.prototype.next=function(t){return null==t&&(t=1),new e(a(this.netLong+this.size*t),this.mask)},e.prototype.forEach=function(e){var t,r,n;for(n=o(this.first),r=o(this.last),t=0;n<=r;)e(a(n),n,t),t++,n++},e.prototype.toString=function(){return this.base+"/"+this.bitmask},e}(),lp.ip2long=o,lp.long2ip=a,lp.Netmask=e}()),lp);const hp=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"].map((e=>new up.Netmask(e)));function dp(e){for(const t of hp)if(t.contains(e))return!0;return!1}function pp(e){return dl(e)?dp(e):/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(e)?function(e){const t=e.split(":");if(t.length<2)return!1;const r=t[t.length-1].padStart(4,"0"),n=t[t.length-2].padStart(4,"0");return dp(`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}`)}(e):function(e){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)}(e)?function(e){const t=e.split(":");return dp(t[t.length-1])}(e):pl(e)?function(e){return/^::$/.test(e)||/^::1$/.test(e)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(e)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(e)||/^ff([0-9a-fA-F]{2,2}):/i.test(e)}(e):void 0}function fp(e){try{for(const{code:t}of e.getComponents())if(t!==gl)return 4===t||t===fl}catch{}return!1}function gp(e){try{if(!fp(e))return!1;const[[,t]]=e.stringTuples();return null!=t&&(pp(t)??!1)}catch{}return!0}const mp=e=>({match(t){return!(t.length<1)&&(!!e(t[0])&&t.slice(1))},pattern:"fn"}),yp=e=>({match(t){return mp((t=>t===e)).match(t)},pattern:e}),bp=()=>({match(e){return mp((e=>"string"==typeof e)).match(e)},pattern:"{string}"}),wp=()=>({match(e){return mp((e=>!isNaN(parseInt(e)))).match(e)},pattern:"{number}"}),vp=()=>({match(e){if(e.length<2)return!1;if("p2p"!==e[0]&&"ipfs"!==e[0])return!1;if(!e[1].startsWith("Q")&&!e[1].startsWith("1"))return!1;try{he.decode("z"+e[1])}catch(e){return!1}return e.slice(2)},pattern:"/p2p/{peerid}"}),Ep=()=>({match(e){if(e.length<2)return!1;if("certhash"!==e[0])return!1;try{me.decode(e[1])}catch{return!1}return e.slice(2)},pattern:"/certhash/{certhash}"}),Sp=e=>({match(t){const r=e.match(t);return!1===r?t:r},pattern:`optional(${e.pattern})`}),Ap=(...e)=>({match(t){let r;for(const n of e){const e=n.match(t);!1!==e&&((null==r||e.length<r.length)&&(r=e))}return null!=r&&r},pattern:`or(${e.map((e=>e.pattern)).join(", ")})`}),Ip=(...e)=>({match(t){for(const r of e){const e=r.match(t);if(!1===e)return!1;t=e}return t},pattern:`and(${e.map((e=>e.pattern)).join(", ")})`});function _p(...e){function t(t){let r=(e=>e.toString().split("/").slice(1))(t);for(const t of e){const e=t.match(r);if(!1===e)return!1;r=e}return r}return{matchers:e,matches(e){return!1!==t(e)},exactMatch(e){const r=t(e);return!1!==r&&0===r.length}}}const Cp=_p(vp()),xp=Ip(yp("dns4"),bp()),kp=Ip(yp("dns6"),bp()),Tp=Ip(yp("dnsaddr"),bp()),Pp=Ip(yp("dns"),bp());_p(xp,Sp(vp())),_p(kp,Sp(vp())),_p(Tp,Sp(vp())),_p(Ap(Pp,Tp,xp,kp),Sp(vp()));const Rp=Ip(yp("ip4"),mp(dl)),Lp=Ip(yp("ip6"),mp(pl)),Dp=Ap(Rp,Lp),Mp=Ap(Dp,Pp,xp,kp,Tp),Np=_p(Ap(Dp,Ip(Ap(Pp,Tp,xp,kp),Sp(vp())))),Op=_p(Rp),Up=_p(Lp);_p(Dp);const Fp=Ip(Mp,yp("tcp"),wp()),Bp=Ip(Mp,yp("udp"),wp()),qp=_p(Ip(Fp,Sp(vp())));_p(Bp);const $p=Ip(Bp,yp("quic"),Sp(vp())),zp=Ip(Bp,yp("quic-v1"),Sp(vp())),jp=Ap($p,zp);_p($p);const Vp=_p(zp),Kp=Ap(Mp,Fp,Bp,$p,zp),Hp=Ap(Ip(Kp,yp("ws"),Sp(vp()))),Gp=_p(Hp),Wp=Ap(Ip(Kp,yp("wss"),Sp(vp())),Ip(Kp,yp("tls"),Sp(Ip(yp("sni"),bp())),yp("ws"),Sp(vp()))),Xp=_p(Wp),Zp=Ip(Bp,yp("webrtc-direct"),Sp(Ep()),Sp(Ep()),Sp(vp())),Yp=_p(Zp),Qp=Ip(zp,yp("webtransport"),Sp(Ep()),Sp(Ep()),Sp(vp())),Jp=_p(Qp),ef=Ap(Hp,Wp,Ip(Fp,Sp(vp())),Ip(jp,Sp(vp())),Ip(Mp,Sp(vp())),Zp,Qp,vp());_p(ef);const tf=_p(Ip(ef,yp("p2p-circuit"),vp())),rf=_p(Ap(Ip(ef,yp("p2p-circuit"),yp("webrtc"),Sp(vp())),Ip(ef,yp("webrtc"),Sp(vp())),Ip(yp("webrtc"),Sp(vp()))));_p(Ap(Ip(Mp,yp("tcp"),wp(),yp("http"),Sp(vp())),Ip(Mp,yp("http"),Sp(vp()))));_p(Ap(Ip(Mp,yp("tcp"),Ap(Ip(yp("443"),yp("http")),Ip(wp(),yp("https")),Ip(wp(),yp("tls"),yp("http"))),Sp(vp())),Ip(Mp,yp("tls"),yp("http"),Sp(vp())),Ip(Mp,yp("https"),Sp(vp()))));_p(Ap(Ip(yp("memory"),bp(),Sp(vp()))));class nf extends ap{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??op.protocolPrefix}/id/1.0.0`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??op.runOnConnectionOpen)&&e.events.addEventListener("connection:open",(e=>{const t=e.detail;this.identify(t).catch((e=>{e.name!==Wn.name&&this.log.error("error during identify trigged by connection:open",e)}))}))}[os]=["@libp2p/identify"];async _identify(e,t={}){let r;if(null==t.signal){const e=AbortSignal.timeout(this.timeout);t={...t,signal:e}}try{r=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const n=sp(r,{maxDataLength:this.maxMessageSize}).pb(ip),s=await n.read(t);return await r.close(t),s}catch(e){throw r?.abort(e),e}}async identify(e,t={}){const r=await this._identify(e,t),{publicKey:n,protocols:s,observedAddr:i}=r;if(null==n)throw new Xn("public key was missing from identify message");const o=nl(Hc(n).toCID());if(!e.remotePeer.equals(o))throw new Xn("identified peer does not match the expected peer");if(this.peerId.equals(o))throw new Xn("identified peer is our own peer id?");return this.maybeAddObservedAddress(i),this.log("identify completed for peer %p and protocols %o",o,s),async function(e,t,r,n,s){if(r("received identify from %p",n.remotePeer),null==s)throw new Xn("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map((e=>({isCertified:!1,multiaddr:Hl(e)})))),s.protocols.length>0&&(i.protocols=s.protocols),null!=s.publicKey){const e=Hc(s.publicKey);if(!tl(e).equals(n.remotePeer))throw new Xn("public key did not match remote PeerId");i.publicKey=e}let o;if(null!=s.signedPeerRecord){r.trace("received signedPeerRecord from %p",n.remotePeer);let t=s.signedPeerRecord;const a=await Zd.openAndCertify(t,ep.DOMAIN);let c=ep.createFromProtobuf(a.payload);const l=nl(a.publicKey.toCID());if(!c.peerId.equals(l))throw new Xn("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(c.peerId))throw new Xn("signing key does not match remote PeerId");let u;try{u=await e.get(c.peerId)}catch(e){if("NotFoundError"!==e.name)throw e}if(null!=u&&(i.metadata=u.metadata,null!=u.peerRecordEnvelope)){const e=Zd.createFromProtobuf(u.peerRecordEnvelope),n=ep.createFromProtobuf(e.payload);n.seqNumber>=c.seqNumber&&(r("sequence number was lower or equal to existing sequence number - stored: %d received: %d",n.seqNumber,c.seqNumber),c=n,t=u.peerRecordEnvelope)}i.peerRecordEnvelope=t,i.addresses=c.multiaddrs.map((e=>({isCertified:!0,multiaddr:e}))),o={seq:c.seqNumber,addresses:c.multiaddrs}}else r("%p did not send a signed peer record",n.remotePeer);if(r.trace("patching %p with",n.remotePeer,i),await e.patch(n.remotePeer,i),null!=s.agentVersion||null!=s.protocolVersion){const t={};null!=s.agentVersion&&(t.AgentVersion=tt(s.agentVersion)),null!=s.protocolVersion&&(t.ProtocolVersion=tt(s.protocolVersion)),r.trace("merging %p metadata",n.remotePeer,t),await e.merge(n.remotePeer,{metadata:t})}const a={peerId:n.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map((e=>Hl(e))),observedAddr:null==s.observedAddr?void 0:Hl(s.observedAddr),protocols:s.protocols,signedPeerRecord:o,connection:n};return t.safeDispatchEvent("peer:identify",{detail:a}),a}(this.peerStore,this.events,this.log,e,r)}maybeAddObservedAddress(e){const t=function(e){if(null!=e&&e.length>0)try{return Hl(e)}catch{}}(e);if(null==t)return;if(this.log.trace("our observed address was %a",t),gp(t))return void this.log.trace("our observed address was private");const r=t.getComponents();r[0].code!==fl&&(r[0].code!==gl||r[1].code!==fl)||function(e){try{for(const{code:r,value:n}of e.getComponents())if(null!=n&&r===fl)return t=n,new $l("2000::/3").contains(t)}catch{}var t;return!1}(t)?qp.exactMatch(t)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(t)):this.log.trace("our observed address was IPv6 but not a global unicast address")}async handleProtocol(e){const{connection:t,stream:r}=e,n=AbortSignal.timeout(this.timeout);try{const e=await this.peerStore.get(this.peerId),s=this.addressManager.getAddresses().map((e=>e.decapsulateCode(Gl("p2p").code)));let i=e.peerRecordEnvelope;if(s.length>0&&null==i){const e=new ep({peerId:this.peerId,multiaddrs:s});i=(await Zd.seal(e,this.privateKey)).marshal().subarray()}let o=t.remoteAddr.bytes;Np.matches(t.remoteAddr)||(o=void 0);const a=sp(r).pb(ip);await a.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:Gc(this.privateKey.publicKey),listenAddrs:s.map((e=>e.bytes)),signedPeerRecord:i,observedAddr:o,protocols:e.protocols},{signal:n}),await r.close({signal:n})}catch(e){this.log.error("could not respond to identify request",e),r.abort(e)}}}function sf(e={}){return t=>new nf(t,e)}function of(e,t){const r=function(e){if(null!=e){if("function"==typeof e[Symbol.iterator])return e[Symbol.iterator]();if("function"==typeof e[Symbol.asyncIterator])return e[Symbol.asyncIterator]();if("function"==typeof e.next)return e}throw Error("argument is not an iterator or iterable")}(e).return?.();var n;null!=(n=r)&&"function"==typeof n.then&&"function"==typeof n.catch&&"function"==typeof n.finally&&r.catch((e=>{t.error("could not cause iterator to return",e)}))}const af=()=>{const e=Error("Delay aborted");return e.name="AbortError",e},cf=new WeakMap;const lf=function({clearTimeout:e,setTimeout:t}={}){return(r,{value:n,signal:s}={})=>{if(s?.aborted)return Promise.reject(af());let i,o,a;const c=e??clearTimeout,l=()=>{c(i),a(af())},u=new Promise(((e,c)=>{o=()=>{s&&s.removeEventListener("abort",l),e(n)},a=c,i=(t??setTimeout)(o,r)}));return s&&s.addEventListener("abort",l,{once:!0}),cf.set(u,(()=>{c(i),i=null,o()})),u}}();class uf extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}let hf=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};class df{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??1e3*this.duration/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new pf}async consume(e,t=1,r={}){const n=this.getKey(e),s=this._getKeySecDuration(r);let i=this.memoryStorage.incrby(n,t,s);if(i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.consumedPoints>this.points)throw this.blockDuration>0&&i.consumedPoints<=this.points+t&&(i=this.memoryStorage.set(n,i.consumedPoints,this.blockDuration)),new uf("Rate limit exceeded",i);if(this.execEvenly&&i.msBeforeNext>0&&!i.isFirstInDuration){let e=Math.ceil(i.msBeforeNext/(i.remainingPoints+2));e<this.execEvenlyMinDelayMs&&(e=i.consumedPoints*this.execEvenlyMinDelayMs),await lf(e)}return i}penalty(e,t=1,r={}){const n=this.getKey(e),s=this._getKeySecDuration(r),i=this.memoryStorage.incrby(n,t,s);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}reward(e,t=1,r={}){const n=this.getKey(e),s=this._getKeySecDuration(r),i=this.memoryStorage.incrby(n,-t,s);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}block(e,t){const r=1e3*t,n=this.points+1;return this.memoryStorage.set(this.getKey(e),n,t),{remainingPoints:0,msBeforeNext:0===r?-1:r,consumedPoints:n,isFirstInDuration:!1}}set(e,t,r=0){const n=1e3*(r>=0?r:this.duration);return this.memoryStorage.set(this.getKey(e),t,r),{remainingPoints:0,msBeforeNext:0===n?-1:n,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return null!=t&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return null!=e?.customDuration&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class pf{storage;constructor(){this.storage=new Map}incrby(e,t,r){const n=this.storage.get(e);if(null!=n){const s=null!=n.expiresAt?n.expiresAt.getTime()-(new Date).getTime():-1;return null==n.expiresAt||s>0?(n.value+=t,{remainingPoints:0,msBeforeNext:s,consumedPoints:n.value,isFirstInDuration:!1}):this.set(e,t,r)}return this.set(e,t,r)}set(e,t,r){const n=1e3*r,s=this.storage.get(e);null!=s&&clearTimeout(s.timeoutId);const i={value:t,expiresAt:n>0?new Date(Date.now()+n):void 0};return this.storage.set(e,i),n>0&&(i.timeoutId=setTimeout((()=>{this.storage.delete(e)}),n),null!=i.timeoutId.unref&&i.timeoutId.unref()),{remainingPoints:0,msBeforeNext:0===n?-1:n,consumedPoints:i.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(null!=t){return{remainingPoints:0,msBeforeNext:null!=t.expiresAt?t.expiresAt.getTime()-(new Date).getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}}delete(e){const t=this.storage.get(e);return null!=t&&(null!=t.timeoutId&&clearTimeout(t.timeoutId),this.storage.delete(e),!0)}}var ff;(e=>{e[e.NEW_STREAM=0]="NEW_STREAM",e[e.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",e[e.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",e[e.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",e[e.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",e[e.RESET_RECEIVER=5]="RESET_RECEIVER",e[e.RESET_INITIATOR=6]="RESET_INITIATOR"})(ff||(ff={}));const gf=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),mf=Object.freeze({NEW_STREAM:ff.NEW_STREAM,MESSAGE:ff.MESSAGE_INITIATOR,CLOSE:ff.CLOSE_INITIATOR,RESET:ff.RESET_INITIATOR}),yf=Object.freeze({MESSAGE:ff.MESSAGE_RECEIVER,CLOSE:ff.CLOSE_RECEIVER,RESET:ff.RESET_RECEIVER}),bf=1<<20;class wf{_buffer;_headerInfo;_maxMessageSize;_maxUnprocessedMessageQueueSize;constructor(e=bf,t=4194304){this._buffer=new Ks,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(null==e||0===e.length)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new Xn("Unprocessed message queue size too large!");const t=[];for(;0!==this._buffer.length;){if(null==this._headerInfo)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(e){if("InvalidMessageError"===e.name)throw e;break}const{id:e,type:r,length:n,offset:s}=this._headerInfo;if(this._buffer.length-s<n)break;const i={id:e,type:r};r!==ff.NEW_STREAM&&r!==ff.MESSAGE_INITIATOR&&r!==ff.MESSAGE_RECEIVER||(i.data=this._buffer.sublist(s,s+n)),t.push(i),this._buffer.consume(s+n),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:r}=Sf(e),{value:n,offset:s}=Sf(e,r),i=7&t;if(null==gf[i])throw Error("Invalid type received: "+i);if(n>this._maxMessageSize)throw new Xn("Message size too large");return{id:t>>3,type:i,offset:r+s,length:n}}}const vf=128,Ef=127;function Sf(e,t=0){let r,n=0,s=0,i=t;const o=e.length;do{if(i>=o||s>49)throw t=0,new RangeError("Could not decode varint");r=e.get(i++),n+=s<28?(r&Ef)<<s:(r&Ef)*Math.pow(2,s),s+=7}while(r>=vf);return{value:n,offset:t=i-t}}const Af=10240;const If=new class{_pool;_poolOffset;constructor(){this._pool=t(Af),this._poolOffset=0}write(e,r){const n=this._pool;let s=this._poolOffset;h(e.id<<3|e.type,n,s),s+=c(e.id<<3|e.type),e.type!==ff.NEW_STREAM&&e.type!==ff.MESSAGE_INITIATOR&&e.type!==ff.MESSAGE_RECEIVER||null==e.data?(h(0,n,s),s+=c(0)):(h(e.data.length,n,s),s+=c(e.data.length));const i=n.subarray(this._poolOffset,s);Af-s<100?(this._pool=t(Af),this._poolOffset=0):this._poolOffset=s,r.append(i),e.type!==ff.NEW_STREAM&&e.type!==ff.MESSAGE_INITIATOR&&e.type!==ff.MESSAGE_RECEIVER||null==e.data||r.append(e.data)}};class _f extends Error{constructor(e="Stream input buffer error"){super(e),this.name="StreamInputBufferError"}}function Cf(e){return null!=e&&("function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally)}class xf{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=ri(),this.closed=ri(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??5e3,this.onEnd=e.onEnd,this.onCloseRead=e.onCloseRead,this.onCloseWrite=e.onCloseWrite,this.onReset=e.onReset,this.onAbort=e.onAbort,this.source=this.streamSource=oi({onEnd:e=>{null!=e?this.log.trace("source ended with error",e):this.log.trace("source ended"),this.onSourceEnd(e)}}),this.sink=this.sink.bind(this)}async sink(e){if("ready"!==this.writeStatus)throw new zn(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if("outbound"===this.direction){const e=this.sendNewStream(t);Cf(e)&&await e}const r=()=>{of(e,this.log)};try{this.sinkController.signal.addEventListener("abort",r),this.log.trace("sink reading from source");for await(let r of e){r=r instanceof Uint8Array?new Ks(r):r;const e=this.sendData(r,t);Cf(e)&&(this.sendingData=ri(),await e,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",r)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),"writing"===this.writeStatus&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(e){throw this.log.trace("sink ended with error, calling abort with error",e),this.abort(e),e}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){null==this.timeline.closeRead&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",null!=e&&null==this.endErr&&(this.endErr=e),this.onCloseRead?.(),null!=this.timeline.closeWrite?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),"aborted"!==this.status&&"reset"!==this.status&&(this.status="closed"),null!=this.onEnd&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){null==this.timeline.closeWrite&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",null!=e&&null==this.endErr&&(this.endErr=e),this.onCloseWrite?.(),null!=this.timeline.closeRead?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),"aborted"!==this.status&&"reset"!==this.status&&(this.status="closed"),null!=this.onEnd&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){"open"===this.status&&(this.log.trace("closing gracefully"),this.status="closing",await ci(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if("closing"===this.readStatus||"closed"===this.readStatus)return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing","reset"!==this.status&&"aborted"!==this.status&&null==this.timeline.closeRead&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),"ready"===t&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){"closing"!==this.writeStatus&&"closed"!==this.writeStatus&&(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),"ready"===this.writeStatus&&(this.log.trace("sink was never sunk, sink an empty array"),await ci(this.sink([]),e.signal)),"writing"===this.writeStatus&&(null!=this.sendingData&&await ci(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await ci(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if("closed"===this.status||"aborted"===this.status||"reset"===this.status)return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();Cf(t)&&t.catch((e=>{this.log.error("error sending reset message",e)})),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if("closed"===this.status||"aborted"===this.status||"reset"===this.status)return;const e=new $n("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){"writing"===this.writeStatus&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){"closing"!==this.readStatus&&"closed"!==this.readStatus&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){"closing"!==this.readStatus&&"closed"!==this.readStatus?(this.log.trace("remote close write"),this._closeSource()):this.log("received remote close write but local source is already closed")}remoteCloseRead(){"closing"!==this.writeStatus&&"closed"!==this.writeStatus?(this.log.trace("remote close read"),this._closeSink()):this.log("received remote close read but local sink is already closed")}destroy(){"closed"!==this.status&&"aborted"!==this.status&&"reset"!==this.status?(this.log.trace("stream destroyed"),this._closeSinkAndSource()):this.log("received destroy but we are already closed")}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}class kf extends xf{name;streamId;send;types;maxDataSize;constructor(e){super(e),this.types="outbound"===e.direction?mf:yf,this.send=e.send,this.name=e.name,this.streamId=e.streamId,this.maxDataSize=e.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:mf.NEW_STREAM,data:new Ks(tt(this.name))})}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:e.sublist(0,t)}),e.consume(t)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function Tf(e){const t={...e,type:`${gf[e.type]} (${e.type})`};return e.type===ff.NEW_STREAM&&(t.data=an(e.data instanceof Uint8Array?e.data:e.data.subarray())),e.type!==ff.MESSAGE_INITIATOR&&e.type!==ff.MESSAGE_RECEIVER||(t.data=an(e.data instanceof Uint8Array?e.data:e.data.subarray(),"base16")),t}class Pf{protocol="/mplex/6.7.0";sink;source;log;_streamId;_streams;_init;_source;closeController;rateLimiter;closeTimeout;logger;constructor(e,t){t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??500,this.sink=this._createSink(),this._source=oi({objectMode:!0,onEnd:()=>{for(const e of this._streams.initiators.values())e.destroy();for(const e of this._streams.receivers.values())e.destroy()}}),this.source=pi(this._source,(e=>async function*(e){for await(const t of e){const e=new Ks;If.write(t,e),yield e}}(e))),this.closeController=new AbortController,this.rateLimiter=new df({points:t.disconnectThreshold??5,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new qn("Muxer already closed");const t=this._streamId++;e=null==e?t.toString():e.toString();const r=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:r})}async close(e){if(this.closeController.signal.aborted)return;const t=e?.signal??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map((async e=>e.close({signal:t})))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(e){this.abort(e)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach((t=>{t.abort(e)})),this.closeController.abort(e))}_newReceiverStream(e){const{id:t,name:r}=e,n=this._streams.receivers;return this._newStream({id:t,name:r,type:"receiver",registry:n})}_newStream(e){const{id:t,name:r,type:n,registry:s}=e;if(this.log("new %s stream %s",n,t),"initiator"===n&&this._streams.initiators.size===(this._init.maxOutboundStreams??1024))throw new rs("Too many outbound streams open");if(s.has(t))throw Error(`${n} stream ${t} already exists!`);const i=function(e){const{id:t,name:r,send:n,onEnd:s,type:i="initiator",maxMsgSize:o=bf}=e;return new kf({id:"initiator"===i?"i"+t:"r"+t,streamId:t,name:""+(r??t),direction:"initiator"===i?"outbound":"inbound",maxDataSize:o,onEnd:s,send:n,log:e.logger.forComponent(`libp2p:mplex:stream:${i}:${t}`)})}({id:t,name:r,send:async e=>{this.log.enabled&&this.log.trace("%s stream %s send",n,t,Tf(e)),this._source.push(e)},type:n,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",n,t,i.protocol),s.delete(t),null!=this._init.onStreamEnd&&this._init.onStreamEnd(i)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return s.set(t,i),i}_createSink(){return async e=>{const t=()=>{of(e,this.log)};this.closeController.signal.addEventListener("abort",t);try{const t=new wf(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const r of e)for(const e of t.write(r))await this._handleIncoming(e);this._source.end()}catch(e){this.log("error in sink",e),this._source.end(e)}finally{this.closeController.signal.removeEventListener("abort",t)}}}async _handleIncoming(e){const{id:t,type:r}=e;if(this.log.enabled&&this.log.trace("incoming message",Tf(e)),e.type===ff.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??1024)){this.log("too many inbound streams open"),this._source.push({id:t,type:ff.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{return this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),void this.abort(Error("Too many open streams"))}return}const r=this._newReceiverStream({id:t,name:an(e.data instanceof Uint8Array?e.data:e.data.subarray())});return void(null!=this._init.onIncomingStream&&this._init.onIncomingStream(r))}const n=(1&~r?this._streams.receivers:this._streams.initiators).get(t);if(null==n){this.log("missing stream %s for message type %s",t,gf[r]);try{await this.rateLimiter.consume("missing-stream",1)}catch{return this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),void this.abort(Error("Too many messages for missing streams"))}return}const s=this._init.maxStreamBufferSize??4194304;try{switch(r){case ff.MESSAGE_INITIATOR:case ff.MESSAGE_RECEIVER:if(n.sourceReadableLength()>s)throw this._source.push({id:e.id,type:r===ff.MESSAGE_INITIATOR?ff.RESET_RECEIVER:ff.RESET_INITIATOR}),new _f("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers");n.sourcePush(e.data);break;case ff.CLOSE_INITIATOR:case ff.CLOSE_RECEIVER:n.remoteCloseWrite();break;case ff.RESET_INITIATOR:case ff.RESET_RECEIVER:n.reset();break;default:this.log("unknown message type %s",r)}}catch(e){this.log.error("error while processing message",e),n.abort(e)}}}class Rf{protocol="/mplex/6.7.0";_init;components;constructor(e,t={}){this.components=e,this._init=t}[Symbol.toStringTag]="@libp2p/mplex";[os]=["@libp2p/stream-multiplexing"];createStreamMuxer(e={}){return new Pf(this.components,{...e,...this._init})}}function Lf(e={}){return t=>new Rf(t,e)}class Df{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??"ipfs"}/ping/1.0.0`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[os]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,r=Date.now(),n=th(t);let s=!1;Promise.resolve().then((async()=>{for(;;){const e=AbortSignal.timeout(this.timeout);e.addEventListener("abort",(()=>{t?.abort(new Yn("ping timeout"))}));const r=await n.read({bytes:32,signal:e});await n.write(r,{signal:e}),s=!0}})).catch((r=>{s&&"UnexpectedEOFError"===r.name&&"ready"!==t.readStatus||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,r),t?.abort(r))})).finally((()=>{const n=Date.now()-r;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,n);const s=AbortSignal.timeout(this.timeout);t.close({signal:s}).catch((r=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,r),t?.abort(r)}))}))}async ping(e,t={}){this.log("pinging %p",e);const r=Date.now(),n=gc(32),s=await this.components.connectionManager.openConnection(e,t);let i;if(null==t.signal){const e=AbortSignal.timeout(this.timeout);t={...t,signal:e}}try{i=await s.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const e=th(i),[,o]=await Promise.all([e.write(n,t),e.read({...t,bytes:32})]),a=Date.now()-r;if(!$s(n,o.subarray()))throw new Zn(`Received wrong ping ack after ${a}ms`);return this.log("ping %p complete in %dms",s.remotePeer,a),a}catch(e){throw this.log.error("error while pinging %p",s.remotePeer,e),i?.abort(e),e}finally{null!=i&&await i.close(t)}}}function Mf(e={}){return t=>new Df(t,e)}const Nf=[6,53,56,54,55];function Of(e){return Ff("sni",e)?.value}function Uf(e){const t=Ff("tcp",e)?.value;return null==t?"":":"+t}function Ff(e,t){return t.find((t=>t.name===e))}function Bf(e){return e.some((({code:e})=>448===e))}function qf(e,t){const r=$f[e.name];if(null==r)throw Error("Can't interpret protocol "+e.name);const n=r(e,t);return e.code===fl?`[${n}]`:n}const $f={ip4(e){return e.value},ip6(e,t){return 0===t.length?e.value:`[${e.value}]`},tcp(e,t){const r=t.pop();if(null==r)throw Error("Unexpected end of multiaddr");return`tcp://${qf(r,t)}:${e.value}`},udp(e,t){const r=t.pop();if(null==r)throw Error("Unexpected end of multiaddr");return`udp://${qf(r,t)}:${e.value}`},dnsaddr(e){return e.value},dns4(e){return e.value},dns6(e){return e.value},dns(e){return e.value},ipfs(e,t){const r=t.pop();if(null==r)throw Error("Unexpected end of multiaddr");return""+qf(r,t)},p2p(e,t){const r=t.pop();if(null==r)throw Error("Unexpected end of multiaddr");return""+qf(r,t)},http(e,t){const r=Bf(t),n=Of(t),s=Uf(t);if(r&&null!=n)return`https://${n}${s}`;const i=r?"https://":"http://",o=t.pop();if(null==o)throw Error("Unexpected end of multiaddr");let a=qf(o,t);return a=a?.replace("tcp://",""),`${i}${a}`},"http-path"(e,t){const r=t.pop();if(null==r)throw Error("Unexpected end of multiaddr");return`${qf(r,t)}${decodeURIComponent(e.value??"")}`},tls(e,t){const r=t.pop();if(null==r)throw Error("Unexpected end of multiaddr");return qf(r,t)},sni(e,t){const r=t.pop();if(null==r)throw Error("Unexpected end of multiaddr");return qf(r,t)},https(e,t){const r=t.pop();if(null==r)throw Error("Unexpected end of multiaddr");let n=qf(r,t);return n=n?.replace("tcp://",""),"https://"+n},ws(e,t){const r=Bf(t),n=Of(t),s=Uf(t);if(r&&null!=n)return`wss://${n}${s}`;const i=r?"wss://":"ws://",o=t.pop();if(null==o)throw Error("Unexpected end of multiaddr");let a=qf(o,t);return a=a?.replace("tcp://",""),`${i}${a}`},wss(e,t){const r=t.pop();if(null==r)throw Error("Unexpected end of multiaddr");let n=qf(r,t);return n=n?.replace("tcp://",""),"wss://"+n}};var zf,jf,Vf=async e=>{if(e.readyState>=2)throw Error("socket closed");1!==e.readyState&&await new Promise(((t,r)=>{function n(){e.removeEventListener("open",s),e.removeEventListener("error",i)}function s(){n(),t()}function i(t){n(),r(t.error??Error("connect ECONNREFUSED "+e.url))}e.addEventListener("open",s),e.addEventListener("error",i)}))},Kf=(e,t)=>{(t=t??{}).closeOnEnd=!1!==t.closeOnEnd;return async r=>{for await(const t of r){try{await Vf(e)}catch(e){if("socket closed"===e.message)break;throw e}if(e.readyState===e.CLOSING||e.readyState===e.CLOSED)break;e.send(t)}null!=t.closeOnEnd&&e.readyState<=1&&await new Promise(((t,r)=>{e.addEventListener("close",(e=>{if(e.wasClean||1006===e.code)t();else{const t=Object.assign(Error("ws error"),{event:e});r(t)}})),setTimeout((()=>{e.close()}))}))}},Hf={},Gf={};var Wf=function(){if(jf)return Hf;jf=1,Object.defineProperty(Hf,"__esModule",{value:!0});const e=function(){if(zf)return Gf;zf=1,Object.defineProperty(Gf,"__esModule",{value:!0});class e{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const e=this.pullQueue.shift();e&&e.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),void 0!==this.highWaterMark&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch((()=>{})),this.pushQueue.push(t)}}remove(){Promise.resolve().then((()=>{this.removeCallback&&this.removeCallback()}))}[Symbol.asyncIterator](){return{next:()=>{const e=this.pushQueue.shift();return e?(void 0!==this.lowWaterMark&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),e):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise(((e,t)=>{this.pullQueue.push({resolve:e,reject:t})}))},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class t{constructor(t,{highWaterMark:r=100,lowWaterMark:n=1}={}){const s=new e;s.highWaterMark=r,s.lowWaterMark=n,s.removeCallback=t({push:e=>s.push(e),stop:()=>s.stop(),fail:e=>s.fail(e),on(e,t){s.eventHandlers[e]=t}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}}return Gf.EventIterator=t,Gf.default=t,Gf}();return Hf.EventIterator=e.EventIterator,Hf.subscribe=function(t,r,n){return new e.EventIterator((({push:e})=>(this.addEventListener(t,e,r),()=>this.removeEventListener(t,e,r))),n)},Hf.default=e.EventIterator,Hf}();function Xf(e){return e instanceof ArrayBuffer||"ArrayBuffer"===e?.constructor?.name&&"number"==typeof e?.byteLength}var Zf=(e,t)=>{t=t??{};const r=(e=>{e.binaryType="arraybuffer";const t=async()=>{await new Promise(((t,r)=>{if(s)return void t();if(null!=n)return void r(n);const i=t=>{e.removeEventListener("open",o),e.removeEventListener("error",a),t()},o=()=>{i(t)},a=t=>{i((()=>{r(t.error??Error("connect ECONNREFUSED "+e.url))}))};e.addEventListener("open",o),e.addEventListener("error",a)}))},r=async function*(){const r=new Wf.EventIterator((({push:t,stop:r,fail:n})=>{const s=e=>{let r=null;"string"==typeof e.data&&(r=tt(e.data)),Xf(e.data)&&(r=new Uint8Array(e.data)),e.data instanceof Uint8Array&&(r=e.data),null!=r&&t(r)},i=e=>{n(e.error??Error("Socket error"))};return e.addEventListener("message",s),e.addEventListener("error",i),e.addEventListener("close",r),()=>{e.removeEventListener("message",s),e.removeEventListener("error",i),e.removeEventListener("close",r)}}),{highWaterMark:1/0});await t();for await(const e of r)yield Xf(e)?new Uint8Array(e):e}();let n,s=1===e.readyState;return e.addEventListener("open",(()=>{s=!0,n=null})),e.addEventListener("close",(()=>{s=!1,n=null})),e.addEventListener("error",(t=>{s||(n=t.error??Error("connect ECONNREFUSED "+e.url))})),Object.assign(r,{connected:t})})(e);let n=t.remoteAddress,s=t.remotePort;if(null!=e.url)try{const t=new URL(e.url);n=t.hostname,s=parseInt(t.port,10)}catch{}if(null==n||null==s)throw Error("Remote connection did not have address and/or port");return{sink:Kf(e,t),source:r,async connected(){await r.connected()},async close(){e.readyState!==e.CONNECTING&&e.readyState!==e.OPEN||await new Promise((t=>{e.addEventListener("close",(()=>{t()})),e.close()}))},destroy(){null!=e.terminate?e.terminate():e.close()},remoteAddress:n,remotePort:s,socket:e}},Yf=WebSocket;const Qf={"http:":"ws:","https:":"wss:"};function Jf(e,t){t=t??{};const r=((e,t)=>{if(e.startsWith("//")&&(e=`${t?.protocol??"ws:"}${e}`),e.startsWith("/")&&null!=t){const r=t.protocol??"ws:",n=t.host,s=null!=t.port&&!0!==n?.endsWith(":"+t.port)?":"+t.port:"";e=`${r}//${n}${s}${e}`}const r=new URL(e);for(const[e,t]of Object.entries(Qf))r.protocol===e&&(r.protocol=t);return r})(e,"undefined"==typeof window?void 0:window.location),n=new Yf(r.toString(),t.websocket);return Zf(n,t)}class eg extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}function tg(e){return e.filter((e=>Xp.exactMatch(e)||Gp.exactMatch(e)))}function rg(e){return e.filter((e=>Xp.exactMatch(e)))}class ng{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Pn]=!0;[Symbol.toStringTag]="@libp2p/websockets";[os]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const r=function(e,t,r){const n=r.logger.forComponent("libp2p:websockets:maconn"),s=r.metrics,i=r.metricPrefix??"",o={log:n,async sink(t){try{await e.sink(async function*(){for await(const e of t)e instanceof Uint8Array?yield e:yield e.subarray()}())}catch(e){"aborted"!==e.type&&n.error(e)}},source:e.source,remoteAddr:t,timeline:{open:Date.now()},async close(t={}){const r=Date.now();if(null==t.signal){const e=AbortSignal.timeout(500);t={...t,signal:e}}const s=()=>{const{host:e,port:t}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",e,t,Date.now()-r),this.abort(new Ln("Socket close timeout"))};t.signal?.addEventListener("abort",s);try{await e.close()}catch(e){n.error("error closing WebSocket gracefully",e),this.abort(e)}finally{t.signal?.removeEventListener("abort",s),o.timeline.close=Date.now()}},abort(t){const{host:r,port:a}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",r,a,t),e.destroy(),o.timeline.close=Date.now(),s?.increment({[i+"error"]:!0})}};return e.socket.addEventListener("close",(()=>{s?.increment({[i+"close"]:!0}),null==o.timeline.close&&(o.timeline.close=Date.now())}),{once:!0}),o}(await this._connect(e,t),e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",r.remoteAddr);const n=await t.upgrader.upgradeOutbound(r,t);return this.log("outbound connection %s upgraded",r.remoteAddr),n}async _connect(e,t){t?.signal?.throwIfAborted();const r=e.toOptions();this.log("dialing %s:%s",r.host,r.port);const n=ri(),s=Jf(function(e){const t=Hl(e).getComponents(),r=t.pop();if(null==r)throw Error("Unexpected end of multiaddr");const n=$f[r.name];if(null==n)throw Error("No interpreter found for "+r.name);let s=n(r,t)??"";return Nf.includes(r.code)&&(s=s.replace(/^.*:\/\//,""),s="443"===r.value?"https://"+s:"http://"+s),(s.startsWith("http://")||s.startsWith("https://")||s.startsWith("ws://")||s.startsWith("wss://"))&&(s=new URL(s).toString(),s.endsWith("/")&&(s=s.substring(0,s.length-1))),s}(e),this.init);s.socket.addEventListener("error",(()=>{const t=new Bn("Could not connect to "+e.toString());this.log.error("connection error:",t),this.metrics?.dialerEvents.increment({error:!0}),n.reject(t)}));try{t.onProgress?.(new eg("websockets:open-connection")),await ci(Promise.race([s.connected(),n.promise]),t.signal)}catch(e){throw t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),s.close().catch((e=>{this.log.error("error closing raw socket",e)})),e}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),s}createListener(e){return function(){throw Error("WebSocket Servers can not be created in the browser!")}((this.logger,this.components.events,this.components.metrics),this.init)}listenFilter(e){return e=Array.isArray(e)?e:[e],null!=this.init?.filter?this.init?.filter(e):tg(e)}dialFilter(e){return this.listenFilter(e)}}function sg(e={}){return t=>new ng(t,e)}function ig(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)}const{hasOwnProperty:og}=Object.prototype,{propertyIsEnumerable:ag}=Object,cg=(e,t,r)=>{Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!0,configurable:!0})},lg={concatArrays:!1,ignoreUndefined:!1},ug=e=>{const t=[];for(const r in e)og.call(e,r)&&t.push(r);if(Object.getOwnPropertySymbols){const r=Object.getOwnPropertySymbols(e);for(const n of r)ag.call(e,n)&&t.push(n)}return t};function hg(e){return Array.isArray(e)?function(e){const t=e.slice(0,0);return ug(e).forEach((r=>{cg(t,r,hg(e[r]))})),t}(e):ig(e)?function(e){const t=null===Object.getPrototypeOf(e)?Object.create(null):{};return ug(e).forEach((r=>{cg(t,r,hg(e[r]))})),t}(e):e}const dg=(e,t,r,n)=>(r.forEach((r=>{void 0===t[r]&&n.ignoreUndefined||(r in e&&e[r]!==Object.getPrototypeOf(e)?cg(e,r,fg(e[r],t[r],n)):cg(e,r,hg(t[r])))})),e),pg=(e,t,r)=>{let n=e.slice(0,0),s=0;return[e,t].forEach((t=>{const i=[];for(let r=0;r<t.length;r++)og.call(t,r)&&(i.push(r+""),cg(n,s++,t===e?t[r]:hg(t[r])));n=dg(n,t,ug(t).filter((e=>!i.includes(e))),r)})),n};function fg(e,t,r){return r.concatArrays&&Array.isArray(e)&&Array.isArray(t)?pg(e,t,r):ig(t)&&ig(e)?dg(e,t,ug(t),r):hg(t)}function gg(...e){const t=fg(hg(lg),undefined!==this&&this||{},lg);let r={_:{}};for(const n of e)if(void 0!==n){if(!ig(n))throw new TypeError("`"+n+"` is not an Option Object");r=fg(r,{_:n},t)}return r._}var mg,yg={exports:{}};var bg=(mg||(mg=1,function(e){var t={}.hasOwnProperty,r="~";function n(){}function s(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function i(e,t,n,i,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var a=new s(n,i||e,o),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function a(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),a.prototype.eventNames=function(){var e,n,s=[];if(0===this._eventsCount)return s;for(n in e=this._events)t.call(e,n)&&s.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},a.prototype.listeners=function(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,i=n.length,o=Array(i);s<i;s++)o[s]=n[s].fn;return o},a.prototype.listenerCount=function(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},a.prototype.emit=function(e,t,n,s,i,o){var a=r?r+e:e;if(!this._events[a])return!1;var c,l,u=this._events[a],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,s),!0;case 5:return u.fn.call(u.context,t,n,s,i),!0;case 6:return u.fn.call(u.context,t,n,s,i,o),!0}for(l=1,c=Array(h-1);l<h;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var d,p=u.length;for(l=0;l<p;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),h){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,n);break;case 4:u[l].fn.call(u[l].context,t,n,s);break;default:if(!c)for(d=1,c=Array(h-1);d<h;d++)c[d-1]=arguments[d];u[l].fn.apply(u[l].context,c)}}return!0},a.prototype.on=function(e,t,r){return i(this,e,t,r,!1)},a.prototype.once=function(e,t,r){return i(this,e,t,r,!0)},a.prototype.removeListener=function(e,t,n,s){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return o(this,i),this;var a=this._events[i];if(a.fn)a.fn!==t||s&&!a.once||n&&a.context!==n||o(this,i);else{for(var c=0,l=[],u=a.length;c<u;c++)(a[c].fn!==t||s&&!a[c].once||n&&a[c].context!==n)&&l.push(a[c]);l.length?this._events[i]=1===l.length?l[0]:l:o(this,i)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&o(this,t)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,e.exports=a}(yg)),yg.exports),wg=ls(bg);class vg extends Error{constructor(e){super(e),this.name="TimeoutError"}}let Eg=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const Sg=e=>void 0===globalThis.DOMException?new Eg(e):new DOMException(e),Ag=e=>{const t=void 0===e.reason?Sg("This operation was aborted."):e.reason;return t instanceof Error?t:Sg(t)};let Ig=class{#s=[];enqueue(e,t){const r={priority:(t={priority:0,...t}).priority,id:t.id,run:e};if(0===this.size||this.#s[this.size-1].priority>=t.priority)return void this.#s.push(r);const n=function(e,t,r){let n=0,s=e.length;for(;s>0;){const i=Math.trunc(s/2);let o=n+i;r(e[o],t)<=0?(n=++o,s-=i+1):s=i}return n}(this.#s,r,((e,t)=>t.priority-e.priority));this.#s.splice(n,0,r)}setPriority(e,t){const r=this.#s.findIndex((t=>t.id===e));if(-1===r)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[n]=this.#s.splice(r,1);this.enqueue(n.run,{priority:t,id:e})}dequeue(){const e=this.#s.shift();return e?.run}filter(e){return this.#s.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this.#s.length}};class _g extends wg{#i;#o;#a=0;#c;#l;#u=0;#h;#d;#s;#p;#f=0;#g;#m;#y;#b=1n;timeout;constructor(e){if(super(),!("number"==typeof(e={carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:Ig,...e}).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#i=e.carryoverConcurrencyCount,this.#o=e.intervalCap===1/0||0===e.interval,this.#c=e.intervalCap,this.#l=e.interval,this.#s=new e.queueClass,this.#p=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#y=!0===e.throwOnTimeout,this.#m=!1===e.autoStart}get#w(){return this.#o||this.#a<this.#c}get#v(){return this.#f<this.#g}#E(){this.#f--,this.#S(),this.emit("next")}#A(){this.#I(),this.#_(),this.#d=void 0}get#C(){const e=Date.now();if(void 0===this.#h){const t=this.#u-e;if(!(t<0))return void 0===this.#d&&(this.#d=setTimeout((()=>{this.#A()}),t)),!0;this.#a=this.#i?this.#f:0}return!1}#S(){if(0===this.#s.size)return this.#h&&clearInterval(this.#h),this.#h=void 0,this.emit("empty"),0===this.#f&&this.emit("idle"),!1;if(!this.#m){const e=!this.#C;if(this.#w&&this.#v){const t=this.#s.dequeue();return!!t&&(this.emit("active"),t(),e&&this.#_(),!0)}}return!1}#_(){this.#o||void 0!==this.#h||(this.#h=setInterval((()=>{this.#I()}),this.#l),this.#u=Date.now()+this.#l)}#I(){0===this.#a&&0===this.#f&&this.#h&&(clearInterval(this.#h),this.#h=void 0),this.#a=this.#i?this.#f:0,this.#x()}#x(){for(;this.#S(););}get concurrency(){return this.#g}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#g=e,this.#x()}async#k(e){return new Promise(((t,r)=>{e.addEventListener("abort",(()=>{r(e.reason)}),{once:!0})}))}setPriority(e,t){this.#s.setPriority(e,t)}async add(e,t={}){return t.id??=""+this.#b++,t={timeout:this.timeout,throwOnTimeout:this.#y,...t},new Promise(((r,n)=>{this.#s.enqueue((async()=>{this.#f++,this.#a++;try{t.signal?.throwIfAborted();let n=e({signal:t.signal});t.timeout&&(n=function(e,t){const{milliseconds:r,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=t;let o,a;const c=new Promise(((c,l)=>{if("number"!=typeof r||1!==Math.sign(r))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${r}\``);if(t.signal){const{signal:e}=t;e.aborted&&l(Ag(e)),a=()=>{l(Ag(e))},e.addEventListener("abort",a,{once:!0})}if(r===1/0)return void e.then(c,l);const u=new vg;o=i.setTimeout.call(void 0,(()=>{if(n)try{c(n())}catch(e){l(e)}else"function"==typeof e.cancel&&e.cancel(),!1===s?c():s instanceof Error?l(s):(u.message=s??`Promise timed out after ${r} milliseconds`,l(u))}),r),(async()=>{try{c(await e)}catch(e){l(e)}})()})).finally((()=>{c.clear(),a&&t.signal&&t.signal.removeEventListener("abort",a)}));return c.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},c}(Promise.resolve(n),{milliseconds:t.timeout})),t.signal&&(n=Promise.race([n,this.#k(t.signal)]));const s=await n;r(s),this.emit("completed",s)}catch(e){if(e instanceof vg&&!t.throwOnTimeout)return void r();n(e),this.emit("error",e)}finally{this.#E()}}),t),this.emit("add"),this.#S()}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this.#m?(this.#m=!1,this.#x(),this):this}pause(){this.#m=!0}clear(){this.#s=new this.#p}async onEmpty(){0!==this.#s.size&&await this.#T("empty")}async onSizeLessThan(e){this.#s.size<e||await this.#T("next",(()=>this.#s.size<e))}async onIdle(){0===this.#f&&0===this.#s.size||await this.#T("idle")}async#T(e,t){return new Promise((r=>{const n=()=>{t&&!t()||(this.off(e,n),r())};this.on(e,n)}))}get size(){return this.#s.size}sizeBy(e){return this.#s.filter(e).length}get pending(){return this.#f}get isPaused(){return this.#m}}function Cg(e){const t=[Ng.A];return null==e?t:Array.isArray(e)?0===e.length?t:e:[e]}function xg(e){return{Status:e.Status??0,TC:e.TC??e.flag_tc??!1,RD:e.RD??e.flag_rd??!1,RA:e.RA??e.flag_ra??!1,AD:e.AD??e.flag_ad??!1,CD:e.CD??e.flag_cd??!1,Question:(e.Question??e.questions??[]).map((e=>({name:e.name,type:Ng[e.type]}))),Answer:(e.Answer??e.answers??[]).map((e=>({name:e.name,type:Ng[e.type],TTL:e.TTL??e.ttl??60,data:e.data instanceof Uint8Array?an(e.data):e.data})))}}function kg(e,t={}){const r=new _g({concurrency:t.queryConcurrency??4});return async(t,n={})=>{const s=new URLSearchParams;s.set("name",t),Cg(n.types).forEach((e=>{s.append("type",Ng[e])})),n.onProgress?.(new eg("dns:query",{detail:t}));const i=await r.add((async()=>{const t=await fetch(`${e}?${s}`,{headers:{accept:"application/dns-json"},signal:n?.signal});if(200!==t.status)throw Error(`Unexpected HTTP status: ${t.status} - ${t.statusText}`);const r=xg(await t.json());return n.onProgress?.(new eg("dns:response",{detail:r})),r}),{signal:n.signal});if(null==i)throw Error("No DNS response received");return i}}var Tg,Pg;var Rg=(Pg||(Pg=1,Tg=e=>{if(!e)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,r=Object.create(null),n=Object.create(null);function s(s,i){r[s]=i,++t>=e&&(t=0,n=r,r=Object.create(null))}return{has:e=>void 0!==r[e]||void 0!==n[e],remove(e){void 0!==r[e]&&(r[e]=void 0),void 0!==n[e]&&(n[e]=void 0)},get(e){var t=r[e];return void 0!==t?t:void 0!==(t=n[e])?(s(e,t),t):void 0},set(e,t){void 0!==r[e]?r[e]=t:s(e,t)},clear(){r=Object.create(null),n=Object.create(null)}}}),Tg),Lg=ls(Rg);class Dg{lru;constructor(e){this.lru=Lg(e)}get(e,t){let r=!0;const n=[];for(const s of t){const t=this.getAnswers(e,s);if(0===t.length){r=!1;break}n.push(...t)}if(r)return xg({answers:n})}getAnswers(e,t){const r=`${e.toLowerCase()}-${t}`,n=this.lru.get(r);if(null!=n){const e=n.filter((e=>e.expires>Date.now())).map((({expires:e,value:t})=>({...t,TTL:Math.round((e-Date.now())/1e3),type:Ng[t.type]})));return 0===e.length&&this.lru.remove(r),e}return[]}add(e,t){const r=`${e.toLowerCase()}-${t.type}`,n=this.lru.get(r)??[];n.push({expires:Date.now()+1e3*(t.TTL??60),value:t}),this.lru.set(r,n)}remove(e,t){const r=`${e.toLowerCase()}-${t}`;this.lru.remove(r)}clear(){this.lru.clear()}}class Mg{resolvers;cache;constructor(e){var t;this.resolvers={},this.cache=(t=e.cacheSize??1e3,new Dg(t)),Object.entries(e.resolvers??{}).forEach((([e,t])=>{Array.isArray(t)||(t=[t]),e.endsWith(".")||(e+="."),this.resolvers[e]=t})),null==this.resolvers["."]&&(this.resolvers["."]=[kg("https://cloudflare-dns.com/dns-query"),kg("https://dns.google/resolve")])}async query(e,t={}){const r=Cg(t.types),n=!1!==t.cached?this.cache.get(e,r):void 0;if(null!=n)return t.onProgress?.(new eg("dns:cache",{detail:n})),n;const s=e.split(".").pop()+".",i=(this.resolvers[s]??this.resolvers["."]).sort((()=>Math.random()>.5?-1:1)),o=[];for(const n of i){if(!0===t.signal?.aborted)break;try{const s=await n(e,{...t,types:r});for(const t of s.Answer)this.cache.add(e,t);return s}catch(e){o.push(e),t.onProgress?.(new eg("dns:error",{detail:e}))}}if(1===o.length)throw o[0];throw new AggregateError(o,`DNS lookup of ${e} ${r} failed`)}}var Ng;(e=>{e[e.A=1]="A",e[e.CNAME=5]="CNAME",e[e.TXT=16]="TXT",e[e.AAAA=28]="AAAA"})(Ng||(Ng={}));const Og=-1,Ug={},Fg={};[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Og,"ip6zone"],[43,8,"ipcidr"],[53,Og,"dns",!0],[54,Og,"dns4",!0],[55,Og,"dns6",!0],[56,Og,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Og,"unix",!1,!0],[421,Og,"ipfs"],[421,Og,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Og,"garlic64"],[448,0,"tls"],[449,Og,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Og,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,Og,"http-path"],[777,Og,"memory"]].forEach((e=>{const t=function(e,t,r,n,s){return{code:e,size:t,name:r,resolvable:!!n,path:!!s}}(...e);Fg[t.code]=t,Ug[t.name]=t}));const{code:Bg}=function(e){if(null!=Ug[e])return Ug[e];throw Error("no protocol with name: "+e)}("dnsaddr");class qg extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}const $g=async function(e,t={}){const r=t.maxRecursiveDepth??32;if(0===r)throw new qg("Max recursive depth reached");const[,n]=e.stringTuples().find((([e])=>e===Bg))??[],s=t?.dns??function(e={}){return new Mg(e)}(),i=await s.query("_dnsaddr."+n,{signal:t?.signal,types:[Ng.TXT]}),o=e.getPeerId(),a=[];for(const e of i.Answer){const n=e.data.replace(/["']/g,"").trim().split("=")[1];if(null==n)continue;if(null!=o&&!n.includes(o))continue;const s=Hl(n);if(n.startsWith("/dnsaddr")){const e=await s.resolve({...t,maxRecursiveDepth:r-1});a.push(...e.map((e=>e.toString())))}else a.push(s.toString())}return a},zg={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter(e){return e}},connectionManager:{resolvers:{dnsaddr:$g}},transportManager:{faultTolerance:Rn.FATAL_ALL}};async function jg(e){const t=gg(zg,e);if(null===t.connectionProtector&&null!=globalThis.process?.env?.LIBP2P_FORCE_PNET)throw new Nn("Private network is enforced, but no protector was provided");return t}const Vg=1e3,Kg=60*Vg,Hg=60*Kg,Gg=24*Hg,Wg=7*Gg,Xg=365.25*Gg;function Zg(e,t){try{if("string"==typeof e&&e.length>0)return function(e){if((e+="").length>100)throw Error("Value exceeds the maximum length of 100 characters.");const t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return NaN;const r=parseFloat(t[1]),n=(t[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return r*Xg;case"weeks":case"week":case"w":return r*Wg;case"days":case"day":case"d":return r*Gg;case"hours":case"hour":case"hrs":case"hr":case"h":return r*Hg;case"minutes":case"minute":case"mins":case"min":case"m":return r*Kg;case"seconds":case"second":case"secs":case"sec":case"s":return r*Vg;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:throw Error(`The unit ${n} was matched, but no matching case exists.`)}}(e);if("number"==typeof e&&isFinite(e))return t?.long?function(e){const t=Math.abs(e);if(t>=Gg)return Yg(e,t,Gg,"day");if(t>=Hg)return Yg(e,t,Hg,"hour");if(t>=Kg)return Yg(e,t,Kg,"minute");if(t>=Vg)return Yg(e,t,Vg,"second");return e+" ms"}(e):function(e){const t=Math.abs(e);if(t>=Gg)return Math.round(e/Gg)+"d";if(t>=Hg)return Math.round(e/Hg)+"h";if(t>=Kg)return Math.round(e/Kg)+"m";if(t>=Vg)return Math.round(e/Vg)+"s";return e+"ms"}(e);throw Error("Value is not a string or number.")}catch(t){const r=function(e){return"object"==typeof e&&null!==e&&"message"in e}(t)?`${t.message}. value=${JSON.stringify(e)}`:"An unknown error has occured.";throw Error(r)}}function Yg(e,t,r,n){const s=t>=1.5*r;return`${Math.round(e/r)} ${n}${s?"s":""}`}const Qg=function(){try{return localStorage}catch(e){}}();const Jg=console.debug??console.log??(()=>{});var em=function(e){function t(e){let n,s,i,o=null;function a(...e){if(!a.enabled)return;const r=a,s=Number(new Date),i=s-(n||s);r.diff=i,r.prev=n,r.curr=s,n=s,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((n,s)=>{if("%%"===n)return"%";o++;const i=t.formatters[s];if("function"==typeof i){const t=e[o];n=i.call(r,t),e.splice(o,1),o--}return n})),t.formatArgs.call(r,e);(r.log||t.log).apply(r,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=r,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get(){return null!==o?o:(s!==t.namespaces&&(s=t.namespaces,i=t.enabled(e)),i)},set(e){o=e}}),"function"==typeof t.init&&t.init(a),a}function r(e,r){const n=t(this.namespace+(void 0===r?":":r)+e);return n.log=this.log,n}function n(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack??e.message;return e},t.disable=function(){const e=[...t.names.map(n),...t.skips.map(n).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let r;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),s=n.length;for(r=0;r<s;r++)n[r]&&("-"===(e=n[r].replace(/\*/g,".*?"))[0]?t.skips.push(RegExp("^"+e.substr(1)+"$")):t.names.push(RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let r,n;for(r=0,n=t.skips.length;r<n;r++)if(t.skips[r].test(e))return!1;for(r=0,n=t.names.length;r<n;r++)if(t.names[r].test(e))return!0;return!1},t.humanize=Zg,t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((r=>{t[r]=e[r]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.setupFormatters(t.formatters),t.enable(t.load()),t}({formatArgs(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+Zg(this.diff),!this.useColors)return;const t="color: "+this.color;e.splice(1,0,t,"color: inherit");let r=0,n=0;e[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(r++,"%c"===e&&(n=r))})),e.splice(n,0,t)},save(e){try{e?Qg?.setItem("debug",e):Qg?.removeItem("debug")}catch(e){}},load(){let e;try{e=Qg?.getItem("debug")}catch(e){}return!e&&void 0!==globalThis.process&&"env"in globalThis.process&&(e=globalThis.process.env.DEBUG),e},useColors(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||null==navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement?.style?.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&null!=navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/))},setupFormatters(e){e.j=e=>{try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},colors:["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],storage:Qg,log:Jg});function tm(){return{forComponent:e=>rm(e)}}function rm(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}(e+":trace");return em.enabled(e+":trace")&&null!=em.names.map((e=>e.toString())).find((e=>e.includes(":trace")))&&(t=em(e+":trace")),Object.assign(em(e),{error:em(e+":error"),trace:t,newScope(t){return rm(`${e}:${t}`)}})}function nm(e){if(null!=e&&0!==(e=e.trim()).length)return e}function sm(e,t){const r={[Symbol.iterator](){return r},next(){const r=e.next(),n=r.value;if(!0===r.done||null==n){return{done:!0,value:void 0}}return{done:!1,value:t(n)}}};return r}function im(e){return rl(Oe(he.decode("z"+e)))}em.formatters.b=e=>null==e?"undefined":he.baseEncode(e),em.formatters.t=e=>null==e?"undefined":Q.baseEncode(e),em.formatters.m=e=>null==e?"undefined":fe.baseEncode(e),em.formatters.p=e=>null==e?"undefined":e.toString(),em.formatters.c=e=>null==e?"undefined":e.toString(),em.formatters.k=e=>null==e?"undefined":e.toString(),em.formatters.a=e=>null==e?"undefined":e.toString(),em.formatters.e=e=>null==e?"undefined":nm(e.stack)??nm(e.message)??e.toString();class om{map;constructor(e){if(this.map=new Map,null!=e)for(const[t,r]of e.entries())this.map.set(t.toString(),{key:t,value:r})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return sm(this.map.entries(),(e=>[e[1].key,e[1].value]))}forEach(e){this.map.forEach((t=>{e(t.value,t.key,this)}))}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return sm(this.map.values(),(e=>e.key))}values(){return sm(this.map.values(),(e=>e.value))}get size(){return this.map.size}}class am{set;constructor(e){if(this.set=new Set,null!=e)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return sm(this.set.entries(),(e=>{const t=im(e[0]);return[t,t]}))}forEach(e){this.set.forEach((t=>{const r=im(t);e(r,r,this)}))}has(e){return this.set.has(e.toString())}values(){return sm(this.set.values(),(e=>im(e)))}intersection(e){const t=new am;for(const r of e)this.has(r)&&t.add(r);return t}difference(e){const t=new am;for(const r of this)e.has(r)||t.add(r);return t}union(e){const t=new am;for(const r of e)t.add(r);for(const e of this)t.add(e);return t}}const cm={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},lm={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},um=new globalThis.TextEncoder;function hm(e,{size:t=32,utf8Buffer:r}={}){if(!cm[t])throw Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if("string"==typeof e){if(r)return function(e,t,r){if(0===r.length)throw Error("The `utf8Buffer` option must have a length greater than zero");const n=cm[t];let s=lm[t],i=e;for(;i.length>0;){const e=um.encodeInto(i,r);i=i.slice(e.read);for(let i=0;i<e.written;i++)s^=BigInt(r[i]),s=BigInt.asUintN(t,s*n)}return s}(e,t,r);e=um.encode(e)}return function(e,t){const r=cm[t];let n=lm[t];for(let s=0;s<e.length;s++)n^=BigInt(e[s]),n=BigInt.asUintN(t,n*r);return n}(e,t)}const dm={hash(e){return Number(hm(e,{size:32}))},hashV(e,t){return function(e){let t=e.toString(16);t.length%2==1&&(t="0"+t);return tt(t,"base16")}(dm.hash(e,t))}};class pm{fp;h;seed;constructor(t,r,n,s=2){if(s>64)throw new TypeError("Invalid Fingerprint Size");const i=r.hashV(t,n),o=e(s);for(let e=0;e<o.length;e++)o[e]=i[e];0===o.length&&(o[0]=7),this.fp=o,this.h=r,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array&&$s(this.fp,e.fp)}}function fm(e,t){return Math.floor(Math.random()*(t-e))+e}class gm{contents;constructor(e){this.contents=Array(e).fill(null)}has(e){if(!(e instanceof pm))throw new TypeError("Invalid Fingerprint");return this.contents.some((t=>e.equals(t)))}add(e){if(!(e instanceof pm))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(null==this.contents[t])return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof pm))throw new TypeError("Invalid Fingerprint");const t=fm(0,this.contents.length-1),r=this.contents[t];return this.contents[t]=e,r}remove(e){if(!(e instanceof pm))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex((t=>e.equals(t)));return t>-1&&(this.contents[t]=null,!0)}}class mm{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??dm,this.seed=e.seed??fm(0,1024)}add(e){"string"==typeof e&&(e=tt(e));const t=new pm(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,n=(r^t.hash())%this.filterSize;if(null==this.buckets[r]&&(this.buckets[r]=new gm(this.bucketSize)),null==this.buckets[n]&&(this.buckets[n]=new gm(this.bucketSize)),this.buckets[r].add(t)||this.buckets[n].add(t))return this.count++,!0;const s=[r,n];let i=s[fm(0,s.length-1)];null==this.buckets[i]&&(this.buckets[i]=new gm(this.bucketSize));for(let e=0;e<500;e++){const e=this.buckets[i].swap(t);if(null!=e&&(i=(i^e.hash())%this.filterSize,null==this.buckets[i]&&(this.buckets[i]=new gm(this.bucketSize)),this.buckets[i].add(e)))return this.count++,!0}return!1}has(e){"string"==typeof e&&(e=tt(e));const t=new pm(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,n=this.buckets[r]?.has(t)??!1;if(n)return n;const s=(r^t.hash())%this.filterSize;return this.buckets[s]?.has(t)??!1}remove(e){"string"==typeof e&&(e=tt(e));const t=new pm(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,n=this.buckets[r]?.remove(t)??!1;if(n)return this.count--,n;const s=(r^t.hash())%this.filterSize,i=this.buckets[s]?.remove(t)??!1;return i&&this.count--,i}get reliable(){return Math.floor(this.count/this.filterSize*100)<=90}}const ym={1:.5,2:.84,4:.95,8:.98};function bm(e,t=.001){const r=function(e=.001){return e>.002?2:e>1e-5?4:8}(t);return{filterSize:Math.round(e/ym[r]),bucketSize:r,fingerprintSize:Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*r)),64)}}class wm{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??dm,this.seed=e.seed??fm(0,1024),this.filterSeries=[new mm({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if("string"==typeof e&&(e=tt(e)),this.has(e))return!0;let t=this.filterSeries.find((e=>e.reliable));if(null==t){const e=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new mm({filterSize:e,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){"string"==typeof e&&(e=tt(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){"string"==typeof e&&(e=tt(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce(((e,t)=>e+t.count),0)}}function vm(e,t=.001){return new wm({...bm(e,t)})}class Em extends om{metric;constructor(e){super();const{name:t,metrics:r}=e;this.metric=r.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}let Sm=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};async function Am(e,t,r,n){const s=new Sm(n?.errorMessage);null!=n?.errorCode&&(s.code=n.errorCode);const i=n?.errorEvent??"error";return!0===r?.aborted?Promise.reject(s):new Promise(((o,a)=>{function c(){_m(r,"abort",h),_m(e,t,l),_m(e,i,u)}const l=e=>{try{if(!1===n?.filter?.(e))return}catch(e){return c(),void a(e)}c(),o(e)},u=e=>{c(),a(e instanceof Error?e:e.detail??n?.error??Error(`The "${n?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},h=()=>{c(),a(s)};Im(r,"abort",h),Im(e,t,l),Im(e,i,u)}))}function Im(e,t,r){null!=e&&(Cm(e)?e.addEventListener(t,r):e.addListener(t,r))}function _m(e,t,r){null!=e&&(Cm(e)?e.removeEventListener(t,r):e.removeListener(t,r))}function Cm(e){return"function"==typeof e.addEventListener&&"function"==typeof e.removeEventListener}class xm extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}let km=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Sm)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};let Tm=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=`${parseInt(1e9*Math.random()+"",10).toString()}${Date.now()}`,this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce(((e,t)=>e&&!0===t.signal?.aborted),!0)&&(this.controller.abort(new Sm),this.cleanup())}async join(e={}){const t=new km(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await ci(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach((t=>{t.deferred.resolve(e)})),this.status="complete"}catch(e){this.recipients.forEach((t=>{t.deferred.reject(e)})),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach((e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)}))}};function Pm(e,t){let r;const n=()=>{clearTimeout(r),r=setTimeout((()=>{r=void 0,e()}),t)};return n.start=()=>{},n.stop=()=>{clearTimeout(r)},n}let Rm=class extends ss{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??1/0,this.maxSize=e.maxSize??1/0,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=Pm(this.emitEmpty.bind(this),1),this.emitIdle=Pm(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){0===this.size&&this.safeDispatchEvent("empty")}emitIdle(){0===this.running&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(0===this.size)return this.emitEmpty(),0===this.running&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if("queued"===t.status){e=t;break}return null!=e&&(this.safeDispatchEvent("active"),this.pending++,e.run().finally((()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()})),!0)}return!1}enqueue(e){this.queue.push(e),null!=this.sort&&this.queue.sort(this.sort)}start(){!1===this.autoStart&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new xm;const r=new Tm(e,t);return this.enqueue(r),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),r.join(t).then((e=>(this.safeDispatchEvent("success",{detail:{job:r,result:e}}),e))).catch((e=>{if("queued"===r.status)for(let e=0;e<this.queue.length;e++)if(this.queue[e]===r){this.queue.splice(e,1);break}throw this.safeDispatchEvent("failure",{detail:{job:r,error:e}}),e}))}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach((e=>{e.abort(new Sm)})),this.clear()}async onEmpty(e){0!==this.size&&await Am(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Am(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){0===this.pending&&0===this.size||await Am(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=oi({objectMode:!0}),r=e=>{null!=e?this.abort():this.clear(),t.end(e)},n=e=>{null!=e.detail&&t.push(e.detail.result)},s=e=>{r(e.detail.error)},i=()=>{r()},o=()=>{r(new Sm("Queue aborted"))};this.addEventListener("success",n),this.addEventListener("failure",s),this.addEventListener("idle",i),e?.signal?.addEventListener("abort",o);try{yield*t}finally{this.removeEventListener("success",n),this.removeEventListener("failure",s),this.removeEventListener("idle",i),e?.signal?.removeEventListener("abort",o),r()}}};const Lm="lock:worker:request-read",Dm="lock:worker:abort-read-request",Mm="lock:worker:release-read",Nm="lock:master:grant-read",Om="lock:master:error-read",Um="lock:worker:request-write",Fm="lock:worker:abort-write-request",Bm="lock:worker:release-write",qm="lock:master:grant-write",$m="lock:master:error-write",zm="lock:worker:finalize",jm="mortice",Vm={singleProcess:!1},Km=(e,t,r,n,s,i,o,a,c)=>l=>{if(null==l.data)return;const u={type:l.data.type,name:l.data.name,identifier:l.data.identifier};u.type===s&&e.safeDispatchEvent(r,{detail:{name:u.name,identifier:u.identifier,async handler(){t.postMessage({type:c,name:u.name,identifier:u.identifier}),await new Promise((e=>{const r=n=>{if(null==n?.data)return;const s=n.data.type,i=(n.data.name,n.data.identifier);s===a&&i===u.identifier&&(t.removeEventListener("message",r),e())};t.addEventListener("message",r)}))},onError(e){t.postMessage({type:o,name:u.name,identifier:u.identifier,error:{message:e.message,name:e.name,stack:e.stack}})}}}),u.type===i&&e.safeDispatchEvent(n,{detail:{name:u.name,identifier:u.identifier}}),u.type===zm&&e.safeDispatchEvent("finalizeRequest",{detail:{name:u.name}})};class Hm{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(jm)}readLock(e){return this.sendRequest(Lm,Dm,Nm,Om,Mm,e)}writeLock(e){return this.sendRequest(Um,Fm,qm,$m,Bm,e)}finalize(){this.channel.postMessage({type:zm,name:this.name}),this.channel.close()}async sendRequest(e,t,r,n,s,i){i?.signal?.throwIfAborted();const o=((e=10)=>Math.random().toString().substring(2,e+2))();return this.channel.postMessage({type:e,identifier:o,name:this.name}),new Promise(((e,a)=>{const c=()=>{this.channel.postMessage({type:t,identifier:o,name:this.name})};i?.signal?.addEventListener("abort",c,{once:!0});const l=t=>{if(t.data?.identifier===o&&(t.data?.type===r&&(this.channel.removeEventListener("message",l),i?.signal?.removeEventListener("abort",c),e((()=>{this.channel.postMessage({type:s,identifier:o,name:this.name})}))),t.data.type===n)){this.channel.removeEventListener("message",l),i?.signal?.removeEventListener("abort",c);const e=Error();null!=t.data.error&&(e.message=t.data.error.message,e.name=t.data.error.name,e.stack=t.data.error.stack),a(e)}};this.channel.addEventListener("message",l)}))}}const Gm=new Map;let Wm;function Xm(e){return"function"==typeof e?.readLock&&"function"==typeof e?.writeLock}function Zm(e){if(null==Wm&&(Wm=(e=>{if(e=Object.assign({},Vm,e),!!globalThis.document||e.singleProcess){const e=new BroadcastChannel(jm),t=new ss;return e.addEventListener("message",Km(t,e,"requestReadLock","abortReadLockRequest",Lm,Dm,Om,Mm,Nm)),e.addEventListener("message",Km(t,e,"requestWriteLock","abortWriteLockRequest",Um,Fm,$m,Bm,qm)),t}return new Hm(e.name)})(e),!Xm(Wm))){const e=Wm;e.addEventListener("requestReadLock",(t=>{const r=t.detail.name,n=t.detail.identifier,s=Gm.get(r);if(null==s)return;const i=new AbortController,o=e=>{e.detail.name===r&&e.detail.identifier===n&&i.abort()};e.addEventListener("abortReadLockRequest",o),s.readLock({signal:i.signal}).then((async e=>{await t.detail.handler().finally((()=>{e()}))})).catch((e=>{t.detail.onError(e)})).finally((()=>{e.removeEventListener("abortReadLockRequest",o)}))})),e.addEventListener("requestWriteLock",(t=>{const r=t.detail.name,n=t.detail.identifier,s=Gm.get(r);if(null==s)return;const i=new AbortController,o=e=>{e.detail.name===r&&e.detail.identifier===n&&i.abort()};e.addEventListener("abortWriteLockRequest",o),s.writeLock({signal:i.signal}).then((async e=>{await t.detail.handler().finally((()=>{e()}))})).catch((e=>{t.detail.onError(e)})).finally((()=>{e.removeEventListener("abortWriteLockRequest",o)}))})),e.addEventListener("finalizeRequest",(e=>{const t=e.detail.name,r=Gm.get(t);null!=r&&r.finalize()}))}return Wm}async function Ym(e,t){let r,n;const s=new Promise(((e,t)=>{r=e,n=t})),i=()=>{n(new Sm)};return t?.signal?.addEventListener("abort",i,{once:!0}),e.add((async()=>{await new Promise((e=>{r((()=>{t?.signal?.removeEventListener("abort",i),e()}))}))}),{signal:t?.signal}).catch((e=>{n(e)})),s}const Qm={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function Jm(e){const t=Object.assign({},Qm,e);return((e,t)=>{let r=Gm.get(e);if(null!=r)return r;const n=Zm(t);if(Xm(n))return r=n,Gm.set(e,r),r;const s=new Rm({concurrency:1});let i;return r={async readLock(e){if(null!=i)return Ym(i,e);i=new Rm({concurrency:t.concurrency,autoStart:!1});const r=i,n=Ym(i,e);return s.add((async()=>{r.start(),await r.onIdle().then((()=>{i===r&&(i=null)}))})),n},async writeLock(e){return i=null,Ym(s,e)},finalize(){Gm.delete(e)},queue:s},Gm.set(e,r),!0===t.autoFinalize&&s.addEventListener("idle",(()=>{r.finalize()}),{once:!0}),r})(t.name,t)}var ey,ty,ry;function ny(e,t){if(null!=e.publicKey||null==t.publicKey)return e;let r;"RSA"===e.type&&(r=e.toMultihash());return tl(Hc(t.publicKey,r))}function sy(e,t,r){const n=new Map,s=BigInt(Date.now());for(const[e,r]of t.tags.entries())null!=r.expiry&&r.expiry<s||n.set(e,r);return{...t,id:ny(e,t),addresses:t.addresses.filter((({observed:e})=>null!=e&&e>Date.now()-r)).map((({multiaddr:e,isCertified:t})=>({multiaddr:Hl(e),isCertified:t??!1}))),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:n}}function iy(e,t){return u=e.addresses,h=t.addresses,ay(u,h,((e,t)=>e.isCertified===t.isCertified&&!!$s(e.multiaddr,t.multiaddr)))&&(c=e.protocols,l=t.protocols,ay(c,l,((e,t)=>e===t)))&&(o=e.publicKey,a=t.publicKey,oy(o,a))&&(s=e.peerRecordEnvelope,i=t.peerRecordEnvelope,oy(s,i))&&(r=e.metadata,n=t.metadata,cy(r,n,((e,t)=>$s(e,t))))&&function(e,t){return cy(e,t,((e,t)=>e.value===t.value&&e.expiry===t.expiry))}(e.tags,t.tags);var r,n,s,i,o,a,c,l,u,h}function oy(e,t){return null==e&&null==t||null!=e&&null!=t&&$s(e,t)}function ay(e,t,r){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!r(e[n],t[n]))return!1;return!0}function cy(e,t,r){if(e.size!==t.size)return!1;for(const[n,s]of e.entries()){const e=t.get(n);if(null==e)return!1;if(!r(s,e))return!1}return!0}(t=>{let r;(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r)=>{const n={key:"",value:e(0)},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const e=t.uint32();switch(e>>>3){case 1:n.key=t.string();break;case 2:n.value=t.bytes();break;default:t.skipType(7&e)}}return n}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(t.Peer$metadataEntry||(t.Peer$metadataEntry={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&(t.uint32(18),ry.codec().encode(e.value,t)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t,r={})=>{const n={key:""},s=null==t?e.len:e.pos+t;for(;e.pos<s;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.string();break;case 2:n.value=ry.codec().decode(e,e.uint32(),{limits:r.limits?.value});break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(t.Peer$tagsEntry||(t.Peer$tagsEntry={})),t.codec=()=>(null==r&&(r=Qt(((e,r,n={})=>{if(!1!==n.lengthDelimited&&r.fork(),null!=e.addresses)for(const t of e.addresses)r.uint32(10),ty.codec().encode(t,r);if(null!=e.protocols)for(const t of e.protocols)r.uint32(18),r.string(t);if(null!=e.publicKey&&(r.uint32(34),r.bytes(e.publicKey)),null!=e.peerRecordEnvelope&&(r.uint32(42),r.bytes(e.peerRecordEnvelope)),null!=e.metadata&&0!==e.metadata.size)for(const[n,s]of e.metadata.entries())r.uint32(50),t.Peer$metadataEntry.codec().encode({key:n,value:s},r);if(null!=e.tags&&0!==e.tags.size)for(const[n,s]of e.tags.entries())r.uint32(58),t.Peer$tagsEntry.codec().encode({key:n,value:s},r);null!=e.updated&&(r.uint32(64),r.uint64Number(e.updated)),!1!==n.lengthDelimited&&r.ldelim()}),((e,r,n={})=>{const s={addresses:[],protocols:[],metadata:new Map,tags:new Map},i=null==r?e.len:e.pos+r;for(;e.pos<i;){const r=e.uint32();switch(r>>>3){case 1:if(null!=n.limits?.addresses&&s.addresses.length===n.limits.addresses)throw new Jt('Decode error - map field "addresses" had too many elements');s.addresses.push(ty.codec().decode(e,e.uint32(),{limits:n.limits?.addresses$}));break;case 2:if(null!=n.limits?.protocols&&s.protocols.length===n.limits.protocols)throw new Jt('Decode error - map field "protocols" had too many elements');s.protocols.push(e.string());break;case 4:s.publicKey=e.bytes();break;case 5:s.peerRecordEnvelope=e.bytes();break;case 6:{if(null!=n.limits?.metadata&&s.metadata.size===n.limits.metadata)throw new er('Decode error - map field "metadata" had too many elements');const r=t.Peer$metadataEntry.codec().decode(e,e.uint32());s.metadata.set(r.key,r.value);break}case 7:{if(null!=n.limits?.tags&&s.tags.size===n.limits.tags)throw new er('Decode error - map field "tags" had too many elements');const r=t.Peer$tagsEntry.codec().decode(e,e.uint32(),{limits:{value:n.limits?.tags$value}});s.tags.set(r.key,r.value);break}case 8:s.updated=e.uint64Number();break;default:e.skipType(7&r)}}return s}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(ey||(ey={})),(t=>{let r;t.codec=()=>(null==r&&(r=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),null!=e.isCertified&&(t.uint32(16),t.bool(e.isCertified)),null!=e.observed&&(t.uint32(24),t.uint64Number(e.observed)),!1!==r.lengthDelimited&&t.ldelim()}),((t,r)=>{const n={multiaddr:e(0)},s=null==r?t.len:t.pos+r;for(;t.pos<s;){const e=t.uint32();switch(e>>>3){case 1:n.multiaddr=t.bytes();break;case 2:n.isCertified=t.bool();break;case 3:n.observed=t.uint64Number();break;default:t.skipType(7&e)}}return n}))),r),t.encode=e=>gt(e,t.codec()),t.decode=(e,r)=>k(e,t.codec(),r)})(ty||(ty={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.value&&0!==e.value&&(t.uint32(8),t.uint32(e.value)),null!=e.expiry&&(t.uint32(16),t.uint64(e.expiry)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={value:0},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.value=e.uint32();break;case 2:r.expiry=e.uint64();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(ry||(ry={}));const ly="/",uy=(new TextEncoder).encode(ly),hy=uy[0];class dy{_buf;constructor(e,t){if("string"==typeof e)this._buf=tt(e);else{if(!(e instanceof Uint8Array))throw Error("Invalid key, should be String of Uint8Array");this._buf=e}if(null==t&&(t=!0),t&&this.clean(),0===this._buf.byteLength||this._buf[0]!==hy)throw Error("Invalid key")}toString(e="utf8"){return an(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new dy(e.join(ly))}static random(){return new dy(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||"string"==typeof e?new dy(e):"function"==typeof e.uint8Array?new dy(e.uint8Array()):null}clean(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=uy),this._buf[0]!==hy){const e=new Uint8Array(this._buf.byteLength+1);e.fill(hy,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===hy;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),r=e.list();for(let e=0;e<t.length;e++){if(r.length<e+1)return!1;const n=t[e],s=r[e];if(n<s)return!0;if(n>s)return!1}return t.length<r.length}reverse(){return dy.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(ly).slice(1)}type(){return function(e){const t=e.split(":");if(t.length<2)return"";return t.slice(0,-1).join(":")}(this.baseNamespace())}name(){return function(e){const t=e.split(":");return t[t.length-1]}(this.baseNamespace())}instance(e){return new dy(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(ly)||(e+=ly),e+=this.type(),new dy(e)}parent(){const e=this.list();return 1===e.length?new dy(ly):new dy(e.slice(0,-1).join(ly))}child(e){return this.toString()===ly?e:e.toString()===ly?this:new dy(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}isTopLevel(){return 1===this.list().length}concat(...e){return dy.withNamespaces([...this.namespaces(),...(t=e.map((e=>e.namespaces())),[].concat(...t))]);var t}}const py="/peers/";function fy(e){if(!xn(e)||null==e.type)throw new Nn("Invalid PeerId");const t=e.toCID().toString();return new dy(`${py}${t}`)}async function gy(e,t,r,n,s){const i=new Map;for(const n of r){if(null==n)continue;if(n.multiaddr instanceof Uint8Array&&(n.multiaddr=Hl(n.multiaddr)),!Kl(n.multiaddr))throw new Nn("Multiaddr was invalid");if(!await t(e,n.multiaddr,s))continue;const r=n.isCertified??!1,o=n.multiaddr.toString(),a=i.get(o);null!=a?n.isCertified=a.isCertified||r:i.set(o,{multiaddr:n.multiaddr,isCertified:r})}return[...i.values()].sort(((e,t)=>e.multiaddr.toString().localeCompare(t.multiaddr.toString()))).map((({isCertified:t,multiaddr:r})=>{const n=r.getPeerId();return e.equals(n)&&(r=r.decapsulate(Hl("/p2p/"+e))),{isCertified:t,multiaddr:r.bytes}}))}async function my(e,t,r,n){if(null==t)throw new Nn("Invalid PeerData");if(null!=t.publicKey&&null!=e.publicKey&&!t.publicKey.equals(e.publicKey))throw new Nn("publicKey bytes do not match peer id publicKey bytes");const s=n.existingPeer?.peer;if(null!=s&&!e.equals(s.id))throw new Nn("peer id did not match existing peer id");let i,o=s?.addresses??[],a=new Set(s?.protocols??[]),c=s?.metadata??new Map,l=s?.tags??new Map,u=s?.peerRecordEnvelope;if("patch"===r){if(null==t.multiaddrs&&null==t.addresses||(o=[],null!=t.multiaddrs&&o.push(...t.multiaddrs.map((e=>({isCertified:!1,multiaddr:e})))),null!=t.addresses&&o.push(...t.addresses)),null!=t.protocols&&(a=new Set(t.protocols)),null!=t.metadata){c=yy(t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata),{validate:by})}if(null!=t.tags){l=yy(t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),{validate:wy,map:vy})}null!=t.peerRecordEnvelope&&(u=t.peerRecordEnvelope)}if("merge"===r){if(null!=t.multiaddrs&&o.push(...t.multiaddrs.map((e=>({isCertified:!1,multiaddr:e})))),null!=t.addresses&&o.push(...t.addresses),null!=t.protocols&&(a=new Set([...a,...t.protocols])),null!=t.metadata){const e=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(const[t,r]of e)null==r?c.delete(t):c.set(t,r);c=yy([...c.entries()],{validate:by})}if(null!=t.tags){const e=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),r=new Map(l);for(const[t,n]of e)null==n?r.delete(t):r.set(t,n);l=yy([...r.entries()],{validate:wy,map:vy})}null!=t.peerRecordEnvelope&&(u=t.peerRecordEnvelope)}null!=s?.id.publicKey?i=Gc(s.id.publicKey):null!=t.publicKey?i=Gc(t.publicKey):null!=e.publicKey&&(i=Gc(e.publicKey));const h={addresses:await gy(e,n.addressFilter??(async()=>!0),o,n.existingPeer?.peerPB.addresses,n),protocols:[...a.values()].sort(((e,t)=>e.localeCompare(t))),metadata:c,tags:l,publicKey:i,peerRecordEnvelope:u};return h.addresses.forEach((e=>{e.observed=n.existingPeer?.peerPB.addresses?.find((e=>$s(e.multiaddr,e.multiaddr)))?.observed??Date.now()})),"RSA"!==e.type&&delete h.publicKey,h}function yy(e,t){const r=new Map;for(const[r,n]of e)null!=n&&t.validate(r,n);for(const[n,s]of e.sort((([e],[t])=>e.localeCompare(t))))null!=s&&r.set(n,t.map?.(n,s)??s);return r}function by(e,t){if("string"!=typeof e)throw new Nn("Metadata key must be a string");if(!(t instanceof Uint8Array))throw new Nn("Metadata value must be a Uint8Array")}function wy(e,t){if("string"!=typeof e)throw new Nn("Tag name must be a string");if(null!=t.value){if(parseInt(""+t.value,10)!==t.value)throw new Nn("Tag value must be an integer");if(t.value<0||t.value>100)throw new Nn("Tag value must be between 0-100")}if(null!=t.ttl){if(parseInt(""+t.ttl,10)!==t.ttl)throw new Nn("Tag ttl must be an integer");if(t.ttl<0)throw new Nn("Tag ttl must be between greater than 0")}}function vy(e,t){let r;null!=t.expiry&&(r=t.expiry),null!=t.ttl&&(r=BigInt(Date.now()+Number(t.ttl)));const n={value:t.value??0};return null!=r&&(n.expiry=r),n}function Ey(e){const t=e.toString().split("/")[2];return nl(Ke.parse(t,Q))}function Sy(e,t,r){return function(e,t,r){return sy(e,ey.decode(t),r)}(Ey(e),t,r)}class Ay{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=function(e){const{name:t,metrics:r}=e;let n;return n=null!=r?new Em({name:t,metrics:r}):new om,n}({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??36e5,this.maxPeerAge=t.maxPeerAge??216e5}getLock(e){let t=this.locks.get(e);return null==t&&(t={refs:0,lock:Jm({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,0===t.refs&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const r=this.getLock(e);try{const n=await r.lock.readLock(t);return()=>{n(),this.maybeRemoveLock(e,r)}}catch(t){throw this.maybeRemoveLock(e,r),t}}async getWriteLock(e,t){const r=this.getLock(e);try{const n=await r.lock.writeLock(t);return()=>{n(),this.maybeRemoveLock(e,r)}}catch(t){throw this.maybeRemoveLock(e,r),t}}async has(e,t){try{return await this.load(e,t),!0}catch(e){if("NotFoundError"!==e.name)throw e}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(fy(e),t)}async load(e,t){const r=fy(e),n=await this.datastore.get(r,t),s=ey.decode(n);if(this.#P(e,s))throw await this.datastore.delete(r,t),new jn;return sy(e,s,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,r){const n=await this.#R(e,r),s=await my(e,t,"patch",{...r,addressFilter:this.addressFilter});return this.#L(e,s,n)}async patch(e,t,r){const n=await this.#R(e,r),s=await my(e,t,"patch",{...r,addressFilter:this.addressFilter,existingPeer:n});return this.#L(e,s,n)}async merge(e,t,r){const n=await this.#R(e,r),s=await my(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:n});return this.#L(e,s,n)}async*all(e){for await(const{key:t,value:r}of this.datastore.query(function(e,t){return{prefix:py,filters:(e.filters??[]).map((e=>({key:r,value:n})=>e(Sy(r,n,t)))),orders:(e.orders??[]).map((e=>(r,n)=>e(Sy(r.key,r.value,t),Sy(n.key,n.value,t))))}}(e??{},this.maxAddressAge),e)){const n=Ey(t);if(n.equals(this.peerId))continue;const s=ey.decode(r);this.#P(n,s)?await this.datastore.delete(t,e):yield sy(n,s,this.peerId.equals(n)?1/0:this.maxAddressAge)}}async#R(e,t){try{const r=fy(e),n=await this.datastore.get(r,t),s=ey.decode(n);if(this.#P(e,s))throw await this.datastore.delete(r,t),new jn;return{peerPB:s,peer:sy(e,s,this.maxAddressAge)}}catch(e){"NotFoundError"!==e.name&&this.log.error("invalid peer data found in peer store - %e",e)}}async#L(e,t,r,n){t.updated=Date.now();const s=ey.encode(t);return await this.datastore.put(fy(e),s,n),{peer:sy(e,t,this.maxAddressAge),previous:r?.peer,updated:null==r||!iy(t,r.peerPB)}}#P(e,t){if(null==t.updated)return!0;if(this.peerId.equals(e))return!1;const r=t.updated<Date.now()-this.maxPeerAge,n=Date.now()-this.maxAddressAge,s=t.addresses.filter((e=>null!=e.observed&&e.observed>n));return r&&0===s.length}}class Iy{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new Ay(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const r of this.store.all(t))e(r)}async all(e){return Bs(this.store.all(e))}async delete(e,t){const r=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{r()}}async has(e,t){const r=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),r?.()}}async get(e,t){const r=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{r?.()}}async getInfo(e,t){const r=await this.get(e,t);return{id:r.id,multiaddrs:r.addresses.map((({multiaddr:e})=>e))}}async save(e,t,r){const n=await this.store.getWriteLock(e,r);try{const n=await this.store.save(e,t,r);return this.#D(e,n),n.peer}finally{n?.()}}async patch(e,t,r){const n=await this.store.getWriteLock(e,r);try{const n=await this.store.patch(e,t,r);return this.#D(e,n),n.peer}finally{n?.()}}async merge(e,t,r){const n=await this.store.getWriteLock(e,r);try{const n=await this.store.merge(e,t,r);return this.#D(e,n),n.peer}finally{n?.()}}async consumePeerRecord(e,t,r){const n=xn(t)?t:xn(t?.expectedPeer)?t.expectedPeer:void 0,s=xn(t)||void 0===t?r:t,i=await Zd.openAndCertify(e,ep.DOMAIN,s),o=nl(i.publicKey.toCID());if(!1===n?.equals(o))return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",n,o),!1;const a=ep.createFromProtobuf(i.payload);let c;try{c=await this.get(o,s)}catch(e){if("NotFoundError"!==e.name)throw e}if(null!=c?.peerRecordEnvelope){const e=Zd.createFromProtobuf(c.peerRecordEnvelope),t=ep.createFromProtobuf(e.payload);if(t.seqNumber>=a.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",t.seqNumber,a.seqNumber),!1}return await this.patch(a.peerId,{peerRecordEnvelope:e,addresses:a.multiaddrs.map((e=>({isCertified:!0,multiaddr:e})))},s),!0}#D(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}class _y extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=_y.name;code=_y.code;constructor(e="Not Found"){super(e)}}function Cy(e,t){let r=0;if(null!=e[Symbol.asyncIterator])return async function*(){for await(const n of e)await t(n,r++)&&(yield n)}();const n=function(e){const[t,r]=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>t.next(),push(e){n.push(e)},next:()=>n.length>0?{done:!1,value:n.shift()}:t.next(),[r](){return this}}}(e),{value:s,done:i}=n.next();if(!0===i)return function*(){}();const o=t(s,r++);if("function"==typeof o.then)return async function*(){await o&&(yield s);for await(const e of n)await t(e,r++)&&(yield e)}();const a=t;return function*(){!0===o&&(yield s);for(const e of n)a(e,r++)&&(yield e)}()}function xy(e,t){return null!=e[Symbol.asyncIterator]?async function*(){const r=await Bs(e);yield*r.sort(t)}():function*(){const r=Bs(e);yield*r.sort(t)}()}function ky(e,t){return null!=e[Symbol.asyncIterator]?async function*(){let r=0;if(!(t<1))for await(const n of e)if(yield n,r++,r===t)return}():function*(){let r=0;if(!(t<1))for(const n of e)if(yield n,r++,r===t)return}()}class Ty{put(e,t,r){return Promise.reject(Error(".put is not implemented"))}get(e,t){return Promise.reject(Error(".get is not implemented"))}has(e,t){return Promise.reject(Error(".has is not implemented"))}delete(e,t){return Promise.reject(Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:r,value:n}of e)await this.put(r,n,t),yield r}async*getMany(e,t={}){for await(const r of e)yield{key:r,value:await this.get(r,t)}}async*deleteMany(e,t={}){for await(const r of e)await this.delete(r,t),yield r}batch(){let e=[],t=[];return{put(t,r){e.push({key:t,value:r})},delete(e){t.push(e)},commit:async r=>{await rp(this.putMany(e,r)),e=[],await rp(this.deleteMany(t,r)),t=[]}}}async*_all(e,t){throw Error("._all is not implemented")}async*_allKeys(e,t){throw Error("._allKeys is not implemented")}query(e,t){let r=this._all(e,t);if(null!=e.prefix){const t=e.prefix;r=Cy(r,(e=>e.key.toString().startsWith(t)))}if(Array.isArray(e.filters)&&(r=e.filters.reduce(((e,t)=>Cy(e,t)),r)),Array.isArray(e.orders)&&(r=e.orders.reduce(((e,t)=>xy(e,t)),r)),null!=e.offset){let t=0;const n=e.offset;r=Cy(r,(()=>t++>=n))}return null!=e.limit&&(r=ky(r,e.limit)),r}queryKeys(e,t){let r=this._allKeys(e,t);if(null!=e.prefix){const t=e.prefix;r=Cy(r,(e=>e.toString().startsWith(t)))}if(Array.isArray(e.filters)&&(r=e.filters.reduce(((e,t)=>Cy(e,t)),r)),Array.isArray(e.orders)&&(r=e.orders.reduce(((e,t)=>xy(e,t)),r)),null!=e.offset){const t=e.offset;let n=0;r=Cy(r,(()=>n++>=t))}return null!=e.limit&&(r=ky(r,e.limit)),r}}class Py extends Ty{data;constructor(){super(),this.data=new Map}put(e,t){return this.data.set(e.toString(),t),e}get(e){const t=this.data.get(e.toString());if(null==t)throw new _y;return t}has(e){return this.data.has(e.toString())}delete(e){this.data.delete(e.toString())}*_all(){for(const[e,t]of this.data.entries())yield{key:new dy(e),value:t}}*_allKeys(){for(const e of this.data.keys())yield new dy(e)}}class Ry extends Map{metric;constructor(e){super();const{name:t,metrics:r}=e;this.metric=r.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Ly(e){const{name:t,metrics:r}=e;let n;return n=null!=r?new Ry({name:t,metrics:r}):new Map,n}const Dy=864e13;class My{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=Ly({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=this.findHost(e);for(const e of this.mappings.values())if(e.domain===t)return!0;return!1}add(e,t){t.forEach((t=>{this.log("add DNS mapping %s to %s",t,e);const r=!0===pp(t);this.mappings.set(t,{domain:e,verified:r,expires:r?Dy-Date.now():0,lastVerified:r?Dy-Date.now():void 0})}))}remove(e){const t=this.findHost(e);let r=!1;for(const[e,n]of this.mappings.entries())n.domain===t&&(this.log("removing %s to %s DNS mapping %e",e,n.domain,Error("where")),this.mappings.delete(e),r=r||n.verified);return r}getAll(e){const t=[];for(let r=0;r<e.length;r++){const n=e[r].multiaddr.stringTuples(),s=n[0][1];if(null!=s)for(const[i,o]of this.mappings.entries()){if(s!==i)continue;this.maybeAddSNITuple(n,o.domain)&&(e.splice(r,1),r--,t.push({multiaddr:Hl("/"+n.map((e=>[Gl(e[0]).name,e[1]].join("/"))).join("/")),verified:o.verified,type:"dns-mapping",expires:o.expires,lastVerified:o.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let r=0;r<e.length;r++)if(448===e[r][0]&&449!==e[r+1]?.[0])return e.splice(r+1,0,[449,t]),!0;return!1}confirm(e,t){const r=this.findHost(e);let n=!1;for(const[e,s]of this.mappings.entries())s.domain===r&&(this.log("marking %s to %s DNS mapping as verified",e,s.domain),n=s.verified,s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now());return n}unconfirm(e,t){const r=this.findHost(e);let n=!1;for(const[e,s]of this.mappings.entries())s.domain===r&&(this.log("removing verification of %s to %s DNS mapping",e,s.domain),n=n||s.verified,s.verified=!1,s.expires=Date.now()+t);return n}findHost(e){for(const t of e.stringTuples()){if(449===t[0])return t[1];if(53===t[0]||54===t[0]||55===t[0]||56===t[0])return t[1]}}}class Ny{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=Ly({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=e.stringTuples();for(const e of this.mappings.values())for(const r of e)if(r.externalIp===t[0][1])return!0;return!1}add(e,t,r,n=t,s="tcp"){const i=`${e}-${t}-${s}`,o=this.mappings.get(i)??[],a={internalIp:e,internalPort:t,externalIp:r,externalPort:n,externalFamily:dl(r)?4:6,protocol:s,verified:!1,expires:0};o.push(a),this.mappings.set(i,o)}remove(e){const t=e.stringTuples(),r=t[0][1]??"",n=6===t[1][0]?"tcp":"udp",s=parseInt(t[1][1]??"0");let i=!1;for(const[e,t]of this.mappings.entries()){for(let e=0;e<t.length;e++){const o=t[e];o.externalIp===r&&o.externalPort===s&&o.protocol===n&&(this.log("removing %s:%s to %s:%s %s IP mapping",o.externalIp,o.externalPort,r,s,n),i=i||o.verified,t.splice(e,1),e--)}0===t.length&&this.mappings.delete(e)}return i}getAll(e){const t=[];for(const{multiaddr:r}of e){const e=r.stringTuples();let n;if(4!==e[0][0]&&41!==e[0][0]||6!==e[1][0]?4!==e[0][0]&&41!==e[0][0]||273!==e[1][0]||(n=`${e[0][1]}-${e[1][1]}-udp`):n=`${e[0][1]}-${e[1][1]}-tcp`,null==n)continue;const s=this.mappings.get(n);if(null!=s)for(const r of s)e[0][0]=4===r.externalFamily?4:41,e[0][1]=r.externalIp,e[1][1]=""+r.externalPort,t.push({multiaddr:Hl("/"+e.map((e=>[Gl(e[0]).name,e[1]].join("/"))).join("/")),verified:r.verified,type:"ip-mapping",expires:r.expires,lastVerified:r.lastVerified})}return t}confirm(e,t){const r=e.stringTuples()[0][1];let n=!1;for(const e of this.mappings.values())for(const s of e)s.externalIp===r&&(this.log("marking %s to %s IP mapping as verified",s.internalIp,s.externalIp),n=s.verified,s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now());return n}unconfirm(e,t){const r=e.stringTuples(),n=r[0][1]??"",s=6===r[1][0]?"tcp":"udp",i=parseInt(r[1][1]??"0");let o=!1;for(const e of this.mappings.values())for(let r=0;r<e.length;r++){const a=e[r];a.externalIp===n&&a.externalPort===i&&a.protocol===s&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",a.externalIp,a.externalPort,n,i,s),o=o||a.verified,a.verified=!1,a.expires=Date.now()+t)}return o}}const Oy=10;class Uy{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=Ly({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??Oy}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(gp(e)||function(e){try{for(const{code:t,value:r}of e.getComponents())if(t!==gl&&null!=r){if(4===t)return r.startsWith("169.254.");if(t===fl)return r.toLowerCase().startsWith("fe80")}}catch{}return!1}(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map((([e,t])=>({multiaddr:Hl(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified})))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const r=e.toString(),n=this.addresses.get(r)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},s=n.verified;return n.verified=!0,n.expires=Date.now()+t,n.lastVerified=Date.now(),this.log("marking observed address %a as verified",r),this.addresses.set(r,n),s}}const Fy=[4,fl,53,54,55,56];function By(e){try{for(const{code:t}of e.getComponents())if(t!==gl)return Fy.includes(t)}catch{}return!1}const qy=10;class $y{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=Ly({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??qy}get(e,t){if(gp(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const r=this.toKey(e);let n=this.addresses.get(r);return null==n&&(n={verified:!By(e),expires:0},this.addresses.set(r,n)),{multiaddr:e,verified:n.verified,type:"transport",expires:n.expires,lastVerified:n.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),r=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),r}confirm(e,t){const r=this.toKey(e),n=this.addresses.get(r)??{verified:!1,expires:0,lastVerified:0},s=n.verified;return n.verified=!0,n.expires=Date.now()+t,n.lastVerified=Date.now(),this.addresses.set(r,n),s}unconfirm(e,t){const r=this.toKey(e),n=this.addresses.get(r)??{verified:!1,expires:0},s=n.verified;return n.verified=!1,n.expires=Date.now()+t,this.addresses.set(r,n),s}toKey(e){if(By(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const zy={addressVerificationTTL:6e5,addressVerificationRetry:3e5},jy=e=>e;function Vy(e,t){const r=e.getPeerId();if(null!=r){el(r).equals(t)&&(e=e.decapsulate(Hl("/p2p/"+t.toString())))}return e}class Ky{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:r=[],announce:n=[],appendAnnounce:s=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=r.map((e=>e.toString())),this.announce=new Set(n.map((e=>e.toString()))),this.appendAnnounce=new Set(s.map((e=>e.toString()))),this.observed=new Uy(e,t),this.dnsMappings=new My(e,t),this.ipMappings=new Ny(e,t),this.transportAddresses=new $y(e,t),this.announceFilter=t.announceFilter??jy,this.observedAddressFilter=vm(1024),this.addressVerificationTTL=t.addressVerificationTTL??zy.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??zy.addressVerificationRetry,this._updatePeerStoreAddresses=tp(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",(()=>{this._updatePeerStoreAddresses()})),e.events.addEventListener("transport:close",(()=>{this._updatePeerStoreAddresses()}))}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map((e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate("/p2p/"+this.components.peerId.toString()):e));this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch((e=>{this.log.error("error updating addresses",e)}))}getListenAddrs(){return Array.from(this.listen).map((e=>Hl(e)))}getAnnounceAddrs(){return Array.from(this.announce).map((e=>Hl(e)))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map((e=>Hl(e)))}getObservedAddrs(){return this.observed.getAll().map((e=>e.multiaddr))}addObservedAddr(e){const t=e.stringTuples(),r=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(r)||(this.observedAddressFilter.add(r),e=Vy(e,this.components.peerId),this.ipMappings.has(e)||this.dnsMappings.has(e)||this.observed.add(e))}confirmObservedAddr(e,t){e=Vy(e,this.components.peerId);let r=!0;if("transport"===t?.type||this.transportAddresses.has(e)){!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1)}if("dns-mapping"===t?.type||this.dnsMappings.has(e)){!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1)}if("ip-mapping"===t?.type||this.ipMappings.has(e)){!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1)}if("observed"===t?.type||this.observed.has(e))if(this.maybeUpgradeToIPMapping(e))this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),r=!1;else{!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1)}r||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=Vy(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter((t=>{if(!t.verified)return!1;const r=t.multiaddr.toString();return!e.has(r)&&(e.add(r),!0)})).map((e=>e.multiaddr));return this.announceFilter(t.map((e=>{const t=Hl(e),r=t.getComponents().pop();return r?.value===this.components.peerId.toString()?t:t.encapsulate("/p2p/"+this.components.peerId.toString())})))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach((t=>{t.updateAnnounceAddrs(e)})),e.map((e=>({multiaddr:e,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})));let t=[];t=t.concat(this.components.transportManager.getAddrs().map((e=>this.transportAddresses.get(e,this.addressVerificationTTL))));const r=this.getAppendAnnounceAddrs();return r.length>0&&(this.components.transportManager.getListeners().forEach((e=>{e.updateAnnounceAddrs(r)})),t=t.concat(r.map((e=>({multiaddr:e,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}))))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(Hl("/dns/"+e))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,r,n=t,s="tcp"){this.ipMappings.add(e,t,r,n,s),this.observed.removePrefixed(`/ip${dl(r)?4:6}/${r}/${s}/${n}`)}removePublicAddressMapping(e,t,r,n=t,s="tcp"){this.ipMappings.remove(Hl(`/ip${dl(r)?4:6}/${r}/${s}/${n}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(6===t.family||"127.0.0.1"===t.host||!0===pp(t.host))return!1;const r=this.components.transportManager.getListeners(),n=[e=>Gp.exactMatch(e)||Xp.exactMatch(e),e=>qp.exactMatch(e),e=>Vp.exactMatch(e)];for(const s of n){if(!s(e))continue;const n=r.filter((e=>e.getAddrs().filter((e=>4===e.toOptions().family&&s(e))).length>0));if(1!==n.length)continue;const i=n[0].getAddrs().filter((e=>"127.0.0.1"!==e.toOptions().host)).pop();if(null==i)continue;const o=i.toOptions();return this.observed.remove(e),this.ipMappings.add(o.host,o.port,t.host,t.port,t.transport),!0}return!1}}var Hy;(e=>{e.NOT_STARTED_YET="The libp2p node is not started yet",e.NOT_FOUND="Not found"})(Hy||(Hy={}));class Gy extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class Wy extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class Xy extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class Zy extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class Yy extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class Qy extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class Jy extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class eb extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class tb extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class rb extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class nb extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class sb extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class ib extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class ob extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class ab extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class cb extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class lb{components={};_started=!1;constructor(e={}){this.components={};for(const[t,r]of Object.entries(e))this.components[t]=r;null==this.components.logger&&(this.components.logger=tm())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter((e=>is(e))).map((async t=>{await(t[e]?.())})))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const ub=["metrics","connectionProtector","dns"],hb=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function db(e){return Array.isArray(e?.[os])?e[os]:[]}function pb(e){return Array.isArray(e?.[as])?e[as]:[]}function fb(e){return e?.[Symbol.toStringTag]??e?.toString()??"unknown"}function gb(e={}){return{async denyDialPeer(){return!1},async denyDialMultiaddr(e){if(Gp.matches(e))return!1;const t=e.stringTuples();return(4===t[0][0]||41===t[0][0])&&!!pp(""+t[0][1])},async denyInboundConnection(){return!1},async denyOutboundConnection(){return!1},async denyInboundEncryptedConnection(){return!1},async denyOutboundEncryptedConnection(){return!1},async denyInboundUpgradedConnection(){return!1},async denyOutboundUpgradedConnection(){return!1},async filterMultiaddrForPeer(){return!0},...e}}function mb(e){if(xn(e))return{peerId:e,multiaddrs:[]};let t,r=Array.isArray(e)?e:[e];if(r.length>0){const e=r[0].getPeerId();t=null==e?void 0:el(e),r.forEach((e=>{if(!Kl(e))throw new Kn("Invalid multiaddr");const r=e.getPeerId();if(null==r){if(null!=t)throw new Nn("Multiaddrs must all have the same peer id or have no peer id")}else{const e=el(r);if(!0!==t?.equals(e))throw new Nn("Multiaddrs must all have the same peer id or have no peer id")}}))}return r=r.filter((e=>!Cp.exactMatch(e))),{peerId:t,multiaddrs:r}}const yb=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];function bb(e){try{let t;if(t="string"==typeof e?Hl(e):e,!t.protoNames().includes("ipcidr")){const e=t.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";t=t.encapsulate(e)}return function(e){let t,r;if(e.getComponents().forEach((e=>{"ip4"!==e.name&&"ip6"!==e.name||(r=e.value),"ipcidr"===e.name&&(t=e.value)})),null==t||null==r)throw Error("Invalid multiaddr");return new $l(r,t)}(t)}catch(t){throw Error("Can't convert to IpNet, Invalid multiaddr format: "+e)}}class wb{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map((e=>bb(e))),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch((e=>{this.log.error("error while pruning connections %e",e)}))}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,r=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,r),t<=r)return;const n=new om;for(const t of e){const e=t.remotePeer;if(!n.has(e)){n.set(e,0);try{const t=await this.peerStore.get(e);n.set(e,[...t.tags.values()].reduce(((e,t)=>e+t.value),0))}catch(e){"NotFoundError"!==e.name&&this.log.error("error loading peer tags",e)}}}const s=this.sortConnections(e,n),i=Math.max(t-r,0),o=[];for(const e of s){this.log("too many connections open - closing a connection to %p",e.remotePeer);if(this.allow.some((t=>t.contains(e.remoteAddr.nodeAddress().address)))||o.push(e),o.length===i)break}await Promise.all(o.map((async e=>{await async function(e,t){const r=e?.streams?.map((e=>e.protocol))??[],n=t?.closableProtocols??yb;if(!(r.filter((e=>null!=e&&!n.includes(e))).length>0))try{await(e?.close(t))}catch(t){e?.abort(t)}}(e,{signal:AbortSignal.timeout(1e3)})}))),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(e,t){return e.sort(((e,t)=>{const r=e.timeline.open,n=t.timeline.open;return r<n?1:r>n?-1:0})).sort(((e,t)=>"outbound"===e.direction&&"inbound"===t.direction?1:"inbound"===e.direction&&"outbound"===t.direction?-1:0)).sort(((e,t)=>e.streams.length>t.streams.length?1:e.streams.length<t.streams.length?-1:0)).sort(((e,r)=>{const n=t.get(e.remotePeer)??0,s=t.get(r.remotePeer)??0;return n>s?1:n<s?-1:0}))}}const vb="last-dial-failure",Eb="last-dial-success";class Sb{deferred;signal;constructor(e){this.signal=e,this.deferred=ri(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Ln)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}class Ab{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=`${parseInt(1e9*Math.random()+"",10).toString()}${Date.now()}`,this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce(((e,t)=>e&&!0===t.signal?.aborted),!0)&&(this.controller.abort(new Ln),this.cleanup())}async join(e={}){const t=new Sb(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await ci(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach((t=>{t.deferred.resolve(e)})),this.status="complete"}catch(e){this.recipients.forEach((t=>{t.deferred.reject(e)})),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach((e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)}))}}class Ib extends ss{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??1/0,this.maxSize=e.maxSize??1/0,this.pending=0,null!=e.metricName&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=tp(this.emitEmpty.bind(this),1),this.emitIdle=tp(this.emitIdle.bind(this),1)}emitEmpty(){0===this.size&&this.safeDispatchEvent("empty")}emitIdle(){0===this.running&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(0===this.size)return this.emitEmpty(),0===this.running&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if("queued"===t.status){e=t;break}return null!=e&&(this.safeDispatchEvent("active"),this.pending++,e.run().finally((()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")})),!0)}return!1}enqueue(e){this.queue.push(e),null!=this.sort&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new hf;const r=new Ab(e,t);return this.enqueue(r),this.safeDispatchEvent("add"),this.tryToStartAnother(),r.join(t).then((e=>(this.safeDispatchEvent("completed",{detail:e}),this.safeDispatchEvent("success",{detail:{job:r,result:e}}),e))).catch((e=>{if("queued"===r.status)for(let e=0;e<this.queue.length;e++)if(this.queue[e]===r){this.queue.splice(e,1);break}throw this.safeDispatchEvent("failure",{detail:{job:r,error:e}}),e}))}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach((e=>{e.abort(new Ln)})),this.clear()}async onEmpty(e){0!==this.size&&await Am(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Am(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){0===this.pending&&0===this.size||await Am(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=oi({objectMode:!0}),r=e=>{null!=e?this.abort():this.clear(),t.end(e)},n=e=>{null!=e.detail&&t.push(e.detail)},s=e=>{r(e.detail.error)},i=()=>{r()},o=()=>{r(new Ln("Queue aborted"))};this.addEventListener("completed",n),this.addEventListener("failure",s),this.addEventListener("idle",i),e?.signal?.addEventListener("abort",o);try{yield*t}finally{this.removeEventListener("completed",n),this.removeEventListener("failure",s),this.removeEventListener("idle",i),e?.signal?.removeEventListener("abort",o),r()}}}class _b extends Ib{constructor(e={}){super({...e,sort(e,t){return e.options.priority>t.options.priority?-1:e.options.priority<t.options.priority?1:0}})}}function Cb(e){const t=new globalThis.AbortController;function r(){t.abort();for(const t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",r)}for(const t of e){if(!0===t?.aborted){r();break}null!=t?.addEventListener&&t.addEventListener("abort",r)}const n=t.signal;return n.clear=function(){for(const t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",r)},n}function xb(e){if(!fp(e))return!1;const{address:t}=e.nodeAddress();return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r=t)||/^::1$/.test(r);var r}function kb(e,t){const r=qp.exactMatch(e.multiaddr),n=qp.exactMatch(t.multiaddr);if(r&&!n)return-1;if(!r&&n)return 1;const s=Xp.exactMatch(e.multiaddr),i=Xp.exactMatch(t.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const o=Gp.exactMatch(e.multiaddr),a=Gp.exactMatch(t.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=rf.exactMatch(e.multiaddr),l=rf.exactMatch(t.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;const u=Yp.exactMatch(e.multiaddr),h=Yp.exactMatch(t.multiaddr);if(u&&!h)return-1;if(!u&&h)return 1;const d=Jp.exactMatch(e.multiaddr),p=Jp.exactMatch(t.multiaddr);return d&&!p?-1:!d&&p?1:0}function Tb(e,t){const r=xb(e.multiaddr),n=xb(t.multiaddr);return r&&!n?1:!r&&n?-1:0}function Pb(e,t){const r=gp(e.multiaddr),n=gp(t.multiaddr);return r&&!n?1:!r&&n?-1:0}function Rb(e,t){return e.isCertified&&!t.isCertified?-1:!e.isCertified&&t.isCertified?1:0}function Lb(e,t){const r=tf.exactMatch(e.multiaddr),n=tf.exactMatch(t.multiaddr);return r&&!n?1:!r&&n?-1:0}const Db=50,Mb=500,Nb=25,Ob=1e4;class Ub{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Nb,this.maxDialQueueLength=t.maxDialQueueLength??Mb,this.dialTimeout=t.dialTimeout??Ob,this.connections=t.connections??new om,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(const[e,r]of Object.entries(t.resolvers??{}))Vl.set(e,r);this.queue=new _b({concurrency:t.maxParallelDials??Db,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",(e=>{e.detail?.name!==Ln.name&&this.log.error("error in dial queue - %e",e.detail)}))}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:r,multiaddrs:n}=mb(e),s=Array.from(this.connections.values()).flat().find((e=>!0!==t.force&&(!!e.remotePeer.equals(r)||n.find((t=>t.equals(e.remoteAddr))))));if("open"===s?.status)return this.log("already connected to %a",s.remoteAddr),t.onProgress?.(new eg("dial-queue:already-connected")),s;const i=this.queue.queue.find((e=>{if(!0===r?.equals(e.options.peerId))return!0;const t=e.options.multiaddrs;if(null==t)return!1;for(const e of n)if(t.has(e.toString()))return!0;return!1}));if(null!=i){this.log("joining existing dial target for %p",r);for(const e of n)i.options.multiaddrs.add(e.toString());return t.onProgress?.(new eg("dial-queue:already-in-dial-queue")),i.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new Jn("Dial queue is full");return this.log("creating dial target for %p",r,n.map((e=>e.toString()))),t.onProgress?.(new eg("dial-queue:add-to-dial-queue")),this.queue.add((async e=>{e.onProgress?.(new eg("dial-queue:start-dial"));const t=Cb([this.shutDownController.signal,e.signal]);try{return await this.dialPeer(e,t)}finally{t.clear()}}),{peerId:r,priority:t.priority??ew,multiaddrs:new Set(n.map((e=>e.toString()))),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const r=e.peerId,n=e.multiaddrs,s=new Set;let i=0===e.multiaddrs.size,o=0,a=0;const c=[];for(this.log("starting dial to %p",r);i||n.size>0;){a++,i=!1;const l=[],u=new Set(e.multiaddrs);n.clear(),this.log("calculating addrs to dial %p from %s",r,[...u]);const h=await this.calculateMultiaddrs(r,u,{...e,signal:t});for(const e of h)s.has(e.multiaddr.toString())?this.log.trace("skipping previously failed multiaddr %a while dialing %p",e.multiaddr,r):l.push(e);this.log("%s dial to %p with %s",1===a?"starting":"continuing",r,l.map((e=>e.multiaddr.toString()))),e?.onProgress?.(new eg("dial-queue:calculated-addresses",l));for(const n of l){if(o===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",o,e.peerId),new Jn("Peer had more than maxPeerAddrsToDial");o++;try{const s=await this.components.transportManager.dial(n.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",n.multiaddr);try{await this.components.peerStore.merge(s.remotePeer,{multiaddrs:[s.remoteAddr],metadata:{[Eb]:tt(Date.now().toString())}})}catch(e){this.log.error("could not update last dial failure key for %p",r,e)}return s}catch(e){if(this.log.error("dial failed to %a",n.multiaddr,e),s.add(n.multiaddr.toString()),null!=r)try{await this.components.peerStore.merge(r,{metadata:{[vb]:tt(Date.now().toString())}})}catch(e){this.log.error("could not update last dial failure key for %p",r,e)}if(t.aborted)throw new Yn(e.message);c.push(e)}}}if(1===c.length)throw c[0];throw new AggregateError(c,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,r={}){const n=[...t].map((e=>({multiaddr:Hl(e),isCertified:!1})));if(null!=e){if(this.components.peerId.equals(e))throw new Jn("Tried to dial self");if(!0===await(this.components.connectionGater.denyDialPeer?.(e)))throw new eb("The dial request is blocked by gater.allowDialPeer");if(0===n.length){this.log("loading multiaddrs for %p",e);try{const t=await this.components.peerStore.get(e);n.push(...t.addresses),this.log("loaded multiaddrs for %p",e,n.map((({multiaddr:e})=>e.toString())))}catch(e){if("NotFoundError"!==e.name)throw e}}if(0===n.length){this.log("looking up multiaddrs for %p in the peer routing",e);try{const t=await this.components.peerRouting.findPeer(e,r);this.log("found multiaddrs for %p in the peer routing",e,n.map((({multiaddr:e})=>e.toString()))),n.push(...t.multiaddrs.map((e=>({multiaddr:e,isCertified:!1}))))}catch(t){"NoPeerRoutersError"===t.name?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,t)}}}let s=(await Promise.all(n.map((async e=>{const t=await async function(e,t){let r=!1;for(const t of Vl.keys())if(r=e.protoNames().includes(t),r)break;if(!r)return[e];const n=await e.resolve(t);return t.log("resolved %s to",e,n.map((e=>e.toString()))),n}(e.multiaddr,{dns:this.components.dns,...r,log:this.log});return 1===t.length&&t[0].equals(e.multiaddr)?e:t.map((e=>({multiaddr:e,isCertified:!1})))})))).flat();if(null!=e){const t="/p2p/"+e.toString();s=s.map((e=>{const r=e.multiaddr.getComponents().pop();return"p2p"!==r?.name?{multiaddr:e.multiaddr.encapsulate(t),isCertified:e.isCertified}:e}))}const i=s.filter((t=>{if(null==this.components.transportManager.dialTransportForMultiaddr(t.multiaddr))return!1;const r=t.multiaddr.getPeerId();return null==e||null==r||e.equals(r)})),o=new Map;for(const e of i){const t=e.multiaddr.toString(),r=o.get(t);null==r?o.set(t,e):r.isCertified=r.isCertified||e.isCertified||!1}const a=[...o.values()];if(0===a.length)throw new nb("The dial request has no valid addresses");const c=[];for(const e of a)null!=this.components.connectionGater.denyDialMultiaddr&&await this.components.connectionGater.denyDialMultiaddr(e.multiaddr)||c.push(e);const l=null==this.addressSorter?c.sort(kb).sort(Rb).sort(Lb).sort(Pb).sort(Tb):c.sort(this.addressSorter);if(0===l.length)throw new eb("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",s.map((({multiaddr:e})=>e.toString()))),this.log.trace("addresses for %p after filtering",e??"unknown peer",l.map((({multiaddr:e})=>e.toString()))),l}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const r=await this.calculateMultiaddrs(void 0,new Set(e.map((e=>e.toString()))),t);return!1!==t.runOnLimitedConnection||null!=r.find((e=>!tf.matches(e.multiaddr)))}catch(e){this.log.trace("error calculating if multiaddr(s) were dialable",e)}return!1}}class Fb extends Ib{has(e){return null!=this.find(e)}find(e){return this.queue.find((t=>e.equals(t.options.peerId)))}}var Bb,qb,$b,zb,jb,Vb={};function Kb(){return $b||($b=1,e=Vb,t=function(){if(qb)return Bb;function e(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return qb=1,Bb=e,e.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},e.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},e.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1)}var n=this;return this._timer=setTimeout((()=>{n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout((()=>{n._operationTimeoutCb(n._attempts)}),n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)}),r),this._options.unref&&this._timer.unref(),!0},e.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout((()=>{r._operationTimeoutCb()}),r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},e.prototype.try=function(e){this.attempt(e)},e.prototype.start=function(e){this.attempt(e)},e.prototype.start=e.prototype.try,e.prototype.errors=function(){return this._errors},e.prototype.attempts=function(){return this._attempts},e.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,n=0;n<this._errors.length;n++){var s=this._errors[n],i=s.message,o=(e[i]||0)+1;e[i]=o,o>=r&&(t=s,r=o)}return t},Bb}(),e.operation=r=>{var n=e.timeouts(r);return new t(n,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})},e.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw Error("minTimeout is greater than maxTimeout");for(var n=[],s=0;s<t.retries;s++)n.push(this.createTimeout(s,t));return e&&e.forever&&!n.length&&n.push(this.createTimeout(s,t)),n.sort(((e,t)=>e-t)),n},e.createTimeout=(e,t)=>{var r=t.randomize?Math.random()+1:1,n=Math.round(r*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return n=Math.min(n,t.maxTimeout)},e.wrap=function(t,r,n){if(r instanceof Array&&(n=r,r=null),!n)for(var s in n=[],t)"function"==typeof t[s]&&n.push(s);for(var i=0;i<n.length;i++){var o=n[i],a=t[o];t[o]=function(n){var s=e.operation(r),i=[].slice.call(arguments,1),o=i.pop();i.push((function(e){s.retry(e)||(e&&(arguments[0]=s.mainError()),o.apply(this,arguments))})),s.attempt((()=>{n.apply(t,i)}))}.bind(t,a),t[o].options=r}}),Vb;var e,t}var Hb=ls(jb?zb:(jb=1,zb=Kb()));const Gb={}.toString,Wb=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function Xb(e){var t;return!(!e||(t=e,"[object Error]"!==Gb.call(t))||"TypeError"!==e.name||"string"!=typeof e.message)&&("Load failed"===e.message?void 0===e.stack:Wb.has(e.message))}class Zb extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const Yb=(e,t,r)=>{const n=r.retries-(t-1);return e.attemptNumber=t,e.retriesLeft=n,e};class Qb{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Fb({concurrency:t.maxParallelReconnects??5,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",(e=>{this.maybeReconnect(e.detail).catch((t=>{this.log.error("failed to maybe reconnect to %p - %e",e.detail,t)}))}))}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);Jb(t)&&(this.queue.has(e)||this.queue.add((async t=>{await async function(e,t){return new Promise(((r,n)=>{t={...t},t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.retries??=10;const s=Hb.operation(t),i=()=>{s.stop(),n(t.signal?.reason)};t.signal&&!t.signal.aborted&&t.signal.addEventListener("abort",i,{once:!0});const o=()=>{t.signal?.removeEventListener("abort",i),s.stop()};s.attempt((async i=>{try{const t=await e(i);o(),r(t)}catch(e){try{if(!(e instanceof Error))throw new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`);if(e instanceof Zb)throw e.originalError;if(e instanceof TypeError&&!Xb(e))throw e;if(Yb(e,i,t),await t.shouldRetry(e)||(s.stop(),n(e)),await t.onFailedAttempt(e),!s.retry(e))throw s.mainError()}catch(e){Yb(e,i,t),o(),n(e)}}}))}))}((async r=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:t?.signal})}catch(t){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,r,this.retries,t),t}}),{signal:t?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})}),{peerId:e}).catch((async r=>{this.log.error("failed to reconnect to %p - %e",e,r);const n={};[...t.tags.keys()].forEach((e=>{e.startsWith(Tn)&&(n[e]=void 0)})),await this.peerStore.merge(e,{tags:n}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})})).catch((async t=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,t)})))}start(){this.started=!0}async afterStart(){Promise.resolve().then((async()=>{const e=await this.peerStore.all({filters:[e=>Jb(e)]});await Promise.all(e.map((async e=>{await this.connectionManager.openConnection(e.id).catch((e=>{this.log.error(e)}))})))})).catch((e=>{this.log.error(e)}))}stop(){this.started=!1,this.queue.abort()}}function Jb(e){for(const t of e.tags.keys())if(t.startsWith(Tn))return!0;return!1}const ew=50,tw=100,rw=5,nw=10;class sw{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??tw,this.maxConnections<1)throw new Nn("Connection Manager maxConnections must be greater than 0");this.connections=new om,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map((e=>bb(e))),this.deny=(t.deny??[]).map((e=>bb(e))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??nw,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new df({points:t.inboundConnectionThreshold??rw,duration:1}),this.connectionPruner=new wb({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map((e=>Hl(e)))}),this.dialQueue=new Ub(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??50,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??1e4,resolvers:t.resolvers??{dnsaddr:$g},connections:this.connections}),this.reconnectQueue=new Qb({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const r of t)e[r.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const r of t)for(const t of r.streams){const r=`${t.direction} ${t.protocol??"unnegotiated"}`;e[r]=(e[r]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const r of t){const t={};for(const e of r.streams){const r=`${e.direction} ${e.protocol??"unnegotiated"}`;t[r]=(t[r]??0)+1}for(const[r,n]of Object.entries(t))e[r]=e[r]??[],e[r].push(n)}const t={};for(let[r,n]of Object.entries(e)){n=n.sort(((e,t)=>e-t));const e=Math.floor(.9*n.length);t[r]=n[e]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await async function(...e){const t=[];for(const r of e)is(r)&&t.push(r);await Promise.all(t.map((async e=>{null!=e.beforeStart&&await e.beforeStart()}))),await Promise.all(t.map((async e=>{await e.start()}))),await Promise.all(t.map((async e=>{null!=e.afterStart&&await e.afterStart()})))}(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await async function(...e){const t=[];for(const r of e)is(r)&&t.push(r);await Promise.all(t.map((async e=>{null!=e.beforeStop&&await e.beforeStop()}))),await Promise.all(t.map((async e=>{await e.stop()}))),await Promise.all(t.map((async e=>{null!=e.afterStop&&await e.afterStop()})))}(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const r of t)e.push((async()=>{try{await r.close()}catch(e){this.log.error(e)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new Nn("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch((e=>{this.log.error(e)}))}async _onConnect(e){const{detail:t}=e;if(!this.started)return void await t.close();if("open"!==t.status)return;const r=t.remotePeer,n=!this.connections.has(r),s=this.connections.get(r)??[];s.push(t),this.connections.set(r,s),null!=r.publicKey&&"RSA"===r.type&&await this.peerStore.patch(r,{publicKey:r.publicKey}),n&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,r=t.remotePeer,n=(this.connections.get(r)??[]).filter((e=>e.id!==t.id));this.connections.set(r,n),0===n.length&&(this.log("onDisconnect remove all connections for peer %p",r),this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(null!=e)return this.connections.get(e)??[];let t=[];for(const e of this.connections.values())t=t.concat(e);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new Qn("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:r}=mb(e);if(this.peerId.equals(r))throw new Vn("Can not dial self");if(null!=r&&!0!==t.force){this.log("dial %p",r);const e=this.getConnections(r).find((e=>null==e.limits));if(null!=e)return this.log("had an existing non-limited connection to %p",r),t.onProgress?.(new eg("dial-queue:already-connected")),e}const n=await this.dialQueue.dial(e,{...t,priority:t.priority??ew});if("open"!==n.status)throw new Fn("Remote closed connection during opening");let s=this.connections.get(n.remotePeer);null==s&&(s=[],this.connections.set(n.remotePeer,s));let i=!1;for(const e of s)if(e.id===n.id&&(i=!0),!0!==t.force&&e.id!==n.id&&e.remoteAddr.equals(n.remoteAddr))return n.abort(new Kn("Duplicate multiaddr connection")),e;return i||s.push(n),n}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const r=this.connections.get(e)??[];await Promise.all(r.map((async e=>{try{await e.close(t)}catch(t){e.abort(t)}})))}async acceptIncomingConnection(e){if(this.deny.some((t=>t.contains(e.remoteAddr.nodeAddress().address))))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some((t=>t.contains(e.remoteAddr.nodeAddress().address))))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const t=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(t,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,t),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map((t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map((e=>Hl(e)))})))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class iw{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(null!=this.previousTime){const r=this.alpha(t,this.previousTime),n=e-this.movingAverage,s=r*n;this.movingAverage=r*e+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+n*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*n}else this.movingAverage=e;this.previousTime=t}}class ow{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??5e3;this.success=new iw(t),this.failure=new iw(t),this.next=new iw(t),this.failureMultiplier=e.failureMultiplier??2,this.timeoutMultiplier=e.timeoutMultiplier??1.2,this.minTimeout=e.minTimeout??5e3,this.maxTimeout=e.maxTimeout??6e4,null!=e.metricName&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const r=AbortSignal.timeout(t),n=Cb([e.signal,r]);return n.start=Date.now(),n.timeout=t,n}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class aw{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??"ipfs"}/ping/1.0.0`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??1e4,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??true,this.timeout=new ow({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[os]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval((()=>{this.components.connectionManager.getConnections().forEach((e=>{Promise.resolve().then((async()=>{let t=Date.now();try{const r=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),n=th(await e.newStream(this.protocol,{signal:r,runOnLimitedConnection:!0}));t=Date.now(),await Promise.all([n.write(gc(32),{signal:r}),n.read({bytes:32,signal:r})]),e.rtt=Date.now()-t,await n.unwrap().close({signal:r})}catch(r){if("UnsupportedProtocolError"!==r.name)throw r;e.rtt=(Date.now()-t)/2}})).catch((t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")}))}))}),this.pingIntervalMs)}stop(){this.abortController?.abort(),null!=this.heartbeatInterval&&clearInterval(this.heartbeatInterval)}}class cw{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs([e],t){return{...t,cid:e.toString()}},getAttributesFromYieldedValue(e,t){return{...t,providers:[...Array.isArray(t.providers)?t.providers:[],e.id.toString()]}}})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs([e],t){return{...t,cid:e.toString()}}})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs([e],t){return{...t,cid:e.toString()}}})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs([e]){return{key:an(e,"base36")}}})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs([e]){return{key:an(e,"base36")}}})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(0===this.routers.length)throw new Xy("No content routers available");const r=this,n=new am;for await(const s of di(...r.routers.filter((e=>e.findProviders instanceof Function)).map((r=>r.findProviders(e,t)))))null!=s&&(s.multiaddrs.length>0&&await this.components.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),n.has(s.id)||(n.add(s.id),yield s))}async provide(e,t={}){if(0===this.routers.length)throw new Xy("No content routers available");await Promise.all(this.routers.filter((e=>e.provide instanceof Function)).map((async r=>{await r.provide(e,t)})))}async cancelReprovide(e,t={}){if(0===this.routers.length)throw new Xy("No content routers available");await Promise.all(this.routers.filter((e=>e.cancelReprovide instanceof Function)).map((async r=>{await r.cancelReprovide(e,t)})))}async put(e,t,r){if(!this.isStarted())throw new Qn;await Promise.all(this.routers.filter((e=>e.put instanceof Function)).map((async n=>{await n.put(e,t,r)})))}async get(e,t){if(!this.isStarted())throw new Qn;return Promise.any(this.routers.filter((e=>e.get instanceof Function)).map((async r=>r.get(e,t))))}}class lw{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs([e],t){return{...t,peer:e.toString()}}})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs([e],t){return{...t,key:an(e,"base36")}},getAttributesFromYieldedValue(e,t){return{...t,peers:[...Array.isArray(t.peers)?t.peers:[],e.id.toString()]}}})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(0===this.routers.length)throw new Zy("No peer routers available");if(e.toString()===this.peerId.toString())throw new Yy("Should not try to find self");const r=this,n=di(...this.routers.filter((e=>e.findPeer instanceof Function)).map((n=>async function*(){try{yield await n.findPeer(e,t)}catch(e){r.log.error(e)}}())));for await(const e of n)if(null!=e)return e.multiaddrs.length>0&&await this.peerStore.merge(e.id,{multiaddrs:e.multiaddrs},t),e;throw new jn}async*getClosestPeers(e,t={}){if(0===this.routers.length)throw new Zy("No peer routers available");const r=this,n=vm(1024);for await(const s of async function*(e,t={}){let r=t.concurrency??1/0;r<1&&(r=1/0);const n=t.ordered??!1,s=new EventTarget,i=[];let o,a=ri(),c=ri(),l=!1,u=!1;function h(){return n?i[0]?.done:!!i.find((e=>e.done))}function*d(){for(;i.length>0&&i[0].done;){const e=i[0];if(i.shift(),!e.ok)throw u=!0,a.resolve(),e.err;yield e.value,a.resolve()}}function*p(){for(;h();)for(let e=0;e<i.length;e++)if(i[e].done){const t=i[e];if(i.splice(e,1),e--,!t.ok)throw u=!0,a.resolve(),t.err;yield t.value,a.resolve()}}for(s.addEventListener("task-complete",(()=>{c.resolve()})),Promise.resolve().then((async()=>{try{for await(const t of e){if(i.length===r&&(a=ri(),await a.promise),u)break;const e={done:!1};i.push(e),t().then((t=>{e.done=!0,e.ok=!0,e.value=t,s.dispatchEvent(new np("task-complete"))}),(t=>{e.done=!0,e.err=t,s.dispatchEvent(new np("task-complete"))}))}l=!0,s.dispatchEvent(new np("task-complete"))}catch(e){o=e,s.dispatchEvent(new np("task-complete"))}}));;){if(h()||(c=ri(),await c.promise),null!=o)throw o;if(n?yield*d():yield*p(),null!=o)throw o;if(l&&0===i.length)break}}(async function*(){const n=di(...r.routers.filter((e=>e.getClosestPeers instanceof Function)).map((r=>r.getClosestPeers(e,t))));for await(let e of n)yield async()=>{if(0===e.multiaddrs.length)try{e=await r.findPeer(e.id,{...t,useCache:!1})}catch(e){return void r.log.error("could not find peer multiaddrs",e)}return e}}()))null!=s&&(s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs},t),n.has(s.id.toMultihash().bytes)||(n.add(s.id.toMultihash().bytes),yield s))}}class uw extends ss{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=Cb([this.shutdownController.signal,e?.signal]);try{for(;;){this.needNext?.resolve(),this.needNext=ri();const e=await Am(this,"walk:peer",t,{errorEvent:"walk:error"});yield e.detail}}finally{t.clear(),this.walkers--,0===this.walkers&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=Cb([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let r=0;Promise.resolve().then((async()=>{for(this.log("start walk");this.walkers>0;)try{const t=gc(32);let n=Date.now();for await(const s of this.peerRouting.getClosestPeers(t,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",s.id,Date.now()-n,this.walkers),r++,this.safeDispatchEvent("walk:peer",{detail:s}),1===this.walkers&&null!=this.needNext&&(this.log("wait for need next"),await ci(this.needNext.promise,e)),n=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",t,this.walkers,r)}catch(e){this.log.error("random walk errored",e),this.safeDispatchEvent("walk:error",{detail:e})}this.log("no walkers left, ended walk")})).catch((e=>{this.log.error("random walk errored",e)})).finally((()=>{this.log("finished walk, found %d peers after %dms",r,Date.now()-t),this.walking=!1}))}}class hw{log;topologies;handlers;components;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const e={};for(const[t,r]of this.topologies)e[t]=r.size;return e}}),this.handlers=Ly({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(null==t)throw new Qy("No handler registered for protocol "+e);return t}getTopologies(e){const t=this.topologies.get(e);return null==t?[]:[...t.values()]}async handle(e,t,r){if(this.handlers.has(e)&&!0!==r?.force)throw new Jy("Handler already registered for protocol "+e);const n=gg.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},r);this.handlers.set(e,{handler:t,options:n}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},r)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach((e=>{this.handlers.delete(e)})),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(null==t)throw new Nn("invalid topology");const r=`${(1e9*Math.random()).toString(36)}${Date.now()}`;let n=this.topologies.get(e);return null==n&&(n=new Map,this.topologies.set(e,n)),n.set(r,t),r}unregister(e){for(const[t,r]of this.topologies.entries())r.has(e)&&(r.delete(e),0===r.size&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail,r={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,r).then((e=>{for(const r of e.protocols){const e=this.topologies.get(r);if(null!=e)for(const r of e.values())!1!==r.filter?.has(t)&&(r.filter?.remove(t),r.onDisconnect?.(t))}})).catch((e=>{"NotFoundError"!==e.name&&this.log.error("could not inform topologies of disconnecting peer %p",t,e)}))}_onPeerUpdate(e){const{peer:t,previous:r}=e.detail,n=(r?.protocols??[]).filter((e=>!t.protocols.includes(e)));for(const e of n){const r=this.topologies.get(e);if(null!=r)for(const e of r.values())!1!==e.filter?.has(t.id)&&(e.filter?.remove(t.id),e.onDisconnect?.(t.id))}}_onPeerIdentify(e){const t=e.detail.protocols,r=e.detail.connection,n=e.detail.peerId;for(const e of t){const t=this.topologies.get(e);if(null!=t)for(const e of t.values())null!=r.limits&&!0!==e.notifyOnLimitedConnection||!0!==e.filter?.has(n)&&(e.filter?.add(n),e.onConnect?.(n,r))}}}class dw{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=Ly({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=Ly({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Rn.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(null==t)throw new Nn("Transport must have a valid tag");if(this.transports.has(t))throw new Nn("There is already a transport with the tag "+t);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,r]of this.listeners)for(this.log("closing listeners for %s",t);r.length>0;){const t=r.pop();null!=t&&e.push(t.close())}await Promise.all(e),this.log("all listeners closed");for(const e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(e,t){const r=this.dialTransportForMultiaddr(e);if(null==r)throw new cb("No transport available for address "+(e+""));return t?.onProgress?.(new eg("transport-manager:selected-transport",r[Symbol.toStringTag])),r.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const r of t)e=[...e,...r.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values()){if(t.dialFilter([e]).length>0)return t}}listenTransportForMultiaddr(e){for(const t of this.transports.values()){if(t.listenFilter([e]).length>0)return t}}async listen(e){if(!this.isStarted())throw new Qn("Not started");if(null==e||0===e.length)return void this.log("no addresses were provided for listening, this node is dial only");const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach((e=>{t.errors.set(e.toString(),new tb)}));const r=[];for(const[n,s]of this.transports.entries()){const i=s.listenFilter(e);for(const e of i){this.log("creating listener for %s on %a",n,e);const i=s.createListener({upgrader:this.components.upgrader});let o=this.listeners.get(n)??[];null==o&&(o=[],this.listeners.set(n,o)),o.push(i),i.addEventListener("listening",(()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:i})})),i.addEventListener("close",(()=>{const e=o.findIndex((e=>e===i));o.splice(e,1),this.components.events.safeDispatchEvent("transport:close",{detail:i})})),Op.matches(e)?t.ipv4.attempts++:Up.matches(e)&&t.ipv6.attempts++,r.push(i.listen(e).then((()=>{t.errors.delete(e.toString()),Op.matches(e)&&t.ipv4.success++,Up.matches(e)&&t.ipv6.success++}),(r=>{throw this.log.error("transport %s could not listen on address %a - %e",n,e,r),t.errors.set(e.toString(),r),r})))}}const n=await Promise.allSettled(r);if(!(n.length>0&&n.every((e=>"fulfilled"===e.status))))if(this.ipv6Unsupported(t))this.log("all IPv4 addresses succeed but all IPv6 failed");else{if(this.faultTolerance!==Rn.NO_FATAL)throw new rb("Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set `transportManager.faultTolerance` to NO_FATAL:\n"+[...t.errors.entries()].map((([e,t])=>`\n  ${e}: ${(""+(t.stack??t)).split("\n").join("\n  ")}\n`)).join(""));this.log("failed to listen on any address but fault tolerance allows this")}}ipv6Unsupported(e){if(0===e.ipv4.attempts||0===e.ipv6.attempts)return!1;const t=e.ipv4.attempts===e.ipv4.success,r=0===e.ipv6.success;return t&&r}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const r=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const e=t.pop();null!=e&&r.push(e.close())}await Promise.all(r),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const pw="/multistream/1.0.0",fw=1024,gw=tt("\n");async function mw(e,t,r){await e.write(t,r)}async function yw(e,t){const r=await async function(e,t){const r=await e.read(t);if(0===r.byteLength||r.get(r.byteLength-1)!==gw[0])throw t.log.error("Invalid mss message - missing newline",r),new Xn("Missing newline");return r.sublist(0,-1)}(e,t);return an(r.subarray())}async function bw(e,t,r){if(1===(t=Array.isArray(t)?[...t]:[t]).length&&!1===r.negotiateFully)return function(e,t,r){const n=e.sink.bind(e),s=e.source;let i=!1,o=!1;const a=ri();let c=!1,l=!1;const u=ri();let d=!1,p=!1;const f=ri(),g=ih({sink:n,source:s},{...r,maxDataLength:fw});async function m(){if(o)return r.log.trace("optimistic: already negotiating %s stream",t),void await a.promise;o=!0;try{c||(r.log.trace("optimistic: doing send protocol for %s stream",t),await y()),d||(r.log.trace("optimistic: doing read protocol for %s stream",t),await b())}finally{o=!1,i=!0,a.resolve()}}async function y(){if(l)await u.promise;else{l=!0;try{r.log.trace('optimistic: write ["%s", "%s", data] in source',pw,t),await g.writeV([tt(pw+"\n"),tt(t+"\n")]),r.log.trace('optimistic: wrote ["%s", "%s", data] in source',pw,t)}finally{c=!0,l=!1,u.resolve()}}}async function b(){if(p)await f.promise;else{p=!0;try{r.log.trace("optimistic: reading multistream select header");let e=await yw(g,r);if(r.log.trace('optimistic: read multistream select header "%s"',e),e===pw&&(e=await yw(g,r)),r.log.trace('optimistic: read protocol "%s", expecting "%s"',e,t),e!==t)throw new Wn("protocol selection failed")}finally{d=!0,p=!1,f.resolve()}}}if(e.sink=async e=>{const{sink:n}=g.unwrap();await n(async function*(){let n=!1;for await(const s of e){if(l&&await u.promise,c)yield s;else{l=!0,r.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',pw,t,s.byteLength);const e=t+"\n";yield new Ks(Uint8Array.from([19]),tt(pw+"\n"),h(e.length),tt(e),s).subarray(),r.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',pw,t,s.byteLength),c=!0,l=!1,u.resolve(),m().catch((e=>{r.log.error("could not finish optimistic protocol negotiation of %s",t,e)}))}n=!0}n||await m()}())},e.source=async function*(){await m(),r.log.trace('optimistic: reading data from "%s" stream',t),yield*g.unwrap().source}(),null!=e.closeRead){const t=e.closeRead.bind(e);e.closeRead=async e=>{i||await m().catch((e=>{r.log.error("could not negotiate protocol before close read",e)})),await t(e)}}if(null!=e.closeWrite){const t=e.closeWrite.bind(e);e.closeWrite=async e=>{i||await m().catch((e=>{r.log.error("could not negotiate protocol before close write",e)})),await t(e)}}if(null!=e.close){const t=e.close.bind(e);e.close=async e=>{const r=[];l&&r.push(u.promise),p&&r.push(f.promise),r.length>0?await ci(Promise.all(r),e?.signal):(i=!0,o=!1,a.resolve()),await t(e)}}return{stream:e,protocol:t}}(e,t[0],r);const n=ih(e,{...r,maxDataLength:fw}),s=t.shift();if(null==s)throw Error("At least one protocol must be specified");r.log.trace('select: write ["%s", "%s"]',pw,s);const i=tt(pw+"\n"),o=tt(s+"\n");await async function(e,t,r){await e.writeV(t,r)}(n,[i,o],r),r.log.trace("select: reading multistream-select header");let a=await yw(n,r);if(r.log.trace('select: read "%s"',a),a===pw&&(r.log.trace("select: reading protocol response"),a=await yw(n,r),r.log.trace('select: read "%s"',a)),a===s)return{stream:n.unwrap(),protocol:s};for(const e of t){r.log.trace('select: write "%s"',e),await mw(n,tt(e+"\n"),r),r.log.trace("select: reading protocol response");const t=await yw(n,r);if(r.log.trace('select: read "%s" for "%s"',t,e),t===e)return{stream:n.unwrap(),protocol:e}}throw new Wn("protocol selection failed")}async function ww(e,t,r){t=Array.isArray(t)?t:[t],r.log.trace("handle: available protocols %s",t);const n=ih(e,{...r,maxDataLength:fw,maxLengthLength:2});for(;;){r.log.trace("handle: reading incoming string");const e=await yw(n,r);if(r.log.trace('handle: read "%s"',e),e!==pw){if(t.includes(e))return r.log.trace('handle: respond with "%s" for "%s"',e,e),await mw(n,tt(e+"\n"),r),r.log.trace('handle: responded with "%s" for "%s"',e,e),{stream:n.unwrap(),protocol:e};if("ls"!==e)r.log.trace('handle: respond with "na" for "%s"',e),await mw(n,tt("na\n"),r),r.log('handle: responded with "na" for "%s"',e);else{const s=new Ks(...t.map((e=>Zu.single(tt(e+"\n")))),tt("\n"));r.log.trace('handle: respond with "%s" for %s',t,e),await mw(n,s,r),r.log.trace('handle: responded with "%s" for %s',t,e)}}else r.log.trace('handle: respond with "%s" for "%s"',pw,e),await mw(n,tt(pw+"\n"),r),r.log.trace('handle: responded with "%s" for "%s"',pw,e)}}class vw{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){const{remoteAddr:t,remotePeer:r,newStream:n,close:s,abort:i,getStreams:o}=e;this.id=`${parseInt(1e9*Math.random()+"").toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=r,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),null==this.remoteAddr.getPeerId()&&(this.remoteAddr=this.remoteAddr.encapsulate("/p2p/"+this.remotePeer)),this._newStream=n,this._close=s,this._abort=i,this._getStreams=o,this.tags=[]}[Symbol.toStringTag]="Connection";[An]=!0;get streams(){return this._getStreams()}async newStream(e,t){if("closing"===this.status)throw new Un("the connection is being closed");if("closed"===this.status)throw new Fn("the connection is closed");if(Array.isArray(e)||(e=[e]),null!=this.limits&&!0!==t?.runOnLimitedConnection)throw new es("Cannot open protocol stream on limited connection");const r=await this._newStream(e,t);return r.direction="outbound",r}async close(e={}){if("closed"!==this.status&&"closing"!==this.status){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",null==e.signal){const t=AbortSignal.timeout(500);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(e){"closed"!==this.status&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}}function Ew(e,t,r){let n=0;return r.streams.forEach((r=>{r.direction===t&&r.protocol===e&&n++})),n}class Sw{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=Ly({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach((e=>{this.connectionEncrypters.set(e.protocol,e)})),this.streamMuxers=Ly({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach((e=>{this.streamMuxers.set(e.protocol,e)})),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??1e4,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??1e4,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const r=this.components.connectionGater[e];if(null==r)return;if(!0===await r.apply(this.components.connectionGater,t))throw new sb("The multiaddr connection is blocked by gater."+e)}createInboundAbortSignal(e){return Cb([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let r=!1;const n=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),r=await ci(this.components.connectionManager.acceptIncomingConnection(e),n),!r)throw new ib("Connection denied");await ci(this.shouldBlockConnection("denyInboundConnection",e),n),await this._performUpgrade(e,"inbound",{...t,signal:n})}catch(e){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[e.name??"Error"]:!0}),e}finally{n.clear(),r&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const r=e.remoteAddr.getPeerId();let n;null!=r&&(n=el(r),await ci(this.shouldBlockConnection("denyOutboundConnection",n,e),t.signal));let s="outbound";return!1===t.initiator&&(s="inbound"),await this._performUpgrade(e,s,t)}catch(e){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[e.name??"Error"]:!0}),e}}async _performUpgrade(e,t,r){let n,s,i,o,a;this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let c=e;if(!0!==r?.skipProtection){const n=this.components.connectionProtector;null!=n&&(e.log("protecting the %s connection",t),c=await n.protect(e,r))}try{if(n=c,!0!==r?.skipEncryption){r?.onProgress?.(new eg(`upgrader:encrypt-${t}-connection`)),({conn:n,remotePeer:s,protocol:a,streamMuxer:o}=await("inbound"===t?this._encryptInbound(c,r):this._encryptOutbound(c,r)));const e={...c,...n};await this.shouldBlockConnection("inbound"===t?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",s,e)}else{const r=e.remoteAddr.getPeerId();if(null==r)throw new Kn(t+" connection that skipped encryption must have a peer id");const n=el(r);a="native",s=n}if(s.equals(this.components.peerId)){const t=new Vn("Can not dial self");throw e.abort(t),t}if(i=n,null!=r?.muxerFactory)o=r.muxerFactory;else if(null==o&&this.streamMuxers.size>0){r?.onProgress?.(new eg(`upgrader:multiplex-${t}-connection`));const e=await("inbound"===t?this._multiplexInbound({...c,...n},this.streamMuxers,r):this._multiplexOutbound({...c,...n},this.streamMuxers,r));o=e.muxerFactory,i=e.stream}}catch(r){throw e.log.error("failed to upgrade inbound connection %s %a - %e","inbound"===t?"from":"to",e.remoteAddr,r),r}return await this.shouldBlockConnection("inbound"===t?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",s,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:a,direction:t,maConn:e,upgradedConn:i,muxerFactory:o,remotePeer:s,limits:r?.limits})}_createConnection(e){const{cryptoProtocol:t,direction:r,maConn:n,upgradedConn:s,remotePeer:i,muxerFactory:o,limits:a}=e;let c,l,u;null!=o&&(c=o.createStreamMuxer({direction:r,onIncomingStream:e=>{if(null==u)return;const t=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then((async()=>{const r=this.components.registrar.getProtocols(),{stream:n,protocol:s}=await ww(e,r,{signal:t,log:e.log,yieldBytes:!1});if(null==u)return;u.log("incoming stream opened on %s",s);const o=function(e,t){try{const{options:r}=t.getHandler(e);return r.maxInboundStreams}catch(e){if("UnhandledProtocolError"!==e.name)throw e}return 32}(s,this.components.registrar);if(Ew(s,"inbound",u)===o){const t=new ts(`Too many inbound protocol streams for protocol "${s}" - limit ${o}`);throw e.abort(t),t}e.source=n.source,e.sink=n.sink,e.protocol=s,null!=n.closeWrite&&(e.closeWrite=n.closeWrite),null!=n.closeRead&&(e.closeRead=n.closeRead),null!=n.close&&(e.close=n.close),await this.components.peerStore.merge(i,{protocols:[s]},{signal:t}),this.components.metrics?.trackProtocolStream(e,u),this._onStream({connection:u,stream:e,protocol:s})})).catch((async r=>{u.log.error("error handling incoming stream id %s - %e",e.id,r),null==e.timeline.close&&await e.close({signal:t}).catch((t=>e.abort(t)))}))}}),l=async(t,n={})=>{if(null==c)throw new ob("Connection is not multiplexed");u.log.trace("starting new stream for protocols %s",t);const s=await c.newStream();u.log.trace("started new stream %s for protocols %s",s.id,t);try{if(null==n.signal){s.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",t);const e=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);n={...n,signal:e}}s.log.trace("selecting protocol from protocols %s",t);const{stream:e,protocol:r}=await bw(s,t,{...n,log:s.log,yieldBytes:!0});s.log.trace("selected protocol %s",r);const o=function(e,t,r={}){try{const{options:r}=t.getHandler(e);if(null!=r.maxOutboundStreams)return r.maxOutboundStreams}catch(e){if("UnhandledProtocolError"!==e.name)throw e}return r.maxOutboundStreams??64}(r,this.components.registrar,n),a=Ew(r,"outbound",u);if(a>=o){const e=new rs(`Too many outbound protocol streams for protocol "${r}" - ${a}/${o}`);throw s.abort(e),e}return await this.components.peerStore.merge(i,{protocols:[r]}),s.source=e.source,s.sink=e.sink,s.protocol=r,null!=e.closeWrite&&(s.closeWrite=e.closeWrite),null!=e.closeRead&&(s.closeRead=e.closeRead),null!=e.close&&(s.close=e.close),this.components.metrics?.trackProtocolStream(s,u),s}catch(n){throw u.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e","inbound"===r?"from":"to",e.maConn.remoteAddr,t,n),null==s.timeline.close&&s.abort(n),n}},Promise.all([c.sink(s.source),s.sink(c.source)]).catch((e=>{u.log.error("error piping data through muxer - %e",e)})));const h=n.timeline;n.timeline=new Proxy(h,{set:(...e)=>("close"===e[1]&&null!=e[2]&&null==h.close&&(async()=>{try{"open"===u.status&&await u.close()}catch(e){u.log.error("error closing connection after timeline close %e",e)}finally{this.events.safeDispatchEvent("connection:close",{detail:u})}})().catch((e=>{u.log.error("error thrown while dispatching connection:close event %e",e)})),Reflect.set(...e))}),n.timeline.upgraded=Date.now();var d;return d={remoteAddr:n.remoteAddr,remotePeer:i,status:"open",direction:r,timeline:n.timeline,multiplexer:c?.protocol,encryption:t,limits:a,logger:this.components.logger,newStream:l??(()=>{throw new ob("Connection is not multiplexed")}),getStreams:()=>c?.streams??[],async close(e){await(c?.close(e)),await n.close(e)},abort(e){n.abort(e),c?.abort(e)}},u=new vw(d),this.events.safeDispatchEvent("connection:open",{detail:u}),u.__maConnTimeline=h,u}_onStream(e){const{connection:t,stream:r,protocol:n}=e,{handler:s,options:i}=this.components.registrar.getHandler(n);if(null!=t.limits&&!0!==i.runOnLimitedConnection)throw new es("Cannot open protocol stream on limited connection");s({connection:t,stream:r})}async _encryptInbound(e,t){const r=Array.from(this.connectionEncrypters.keys());try{const{stream:n,protocol:s}=await ww(e,r,{...t,log:e.log}),i=this.connectionEncrypters.get(s);if(null==i)throw new ab("no crypto module found for "+s);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,s),{...await i.secureInbound(n,t),protocol:s}}catch(t){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,t),new ab(t.message)}}async _encryptOutbound(e,t){const r=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",r);const{stream:n,protocol:s}=await bw(e,r,{...t,log:e.log,yieldBytes:!0}),i=this.connectionEncrypters.get(s);if(null==i)throw new ab("no crypto module found for "+s);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,s),{...await i.secureOutbound(n,t),protocol:s}}catch(t){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,t),new ab(t.message)}}async _multiplexOutbound(e,t,r){const n=Array.from(t.keys());e.log("outbound selecting muxer %s",n);try{e.log.trace("selecting stream muxer from %s",n);const{stream:s,protocol:i}=await bw(e,n,{...r,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",i);return{stream:s,muxerFactory:t.get(i)}}catch(t){throw e.log.error("error multiplexing outbound connection",t),new ob(t+"")}}async _multiplexInbound(e,t,r){const n=Array.from(t.keys());e.log("inbound handling muxers %s",n);try{const{stream:s,protocol:i}=await ww(e,n,{...r,log:e.log});return{stream:s,muxerFactory:t.get(i)}}catch(t){throw e.log.error("error multiplexing inbound connection",t),new ob(t+"")}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const Aw="2.8.11",Iw="js-libp2p";function _w(e,t){return`${e??Iw}/${t??Aw} browser/${globalThis.navigator.userAgent}`}class Cw extends ss{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new ss,r=t.dispatchEvent.bind(t);t.dispatchEvent=e=>{const t=r(e),n=this.dispatchEvent(new CustomEvent(e.type,{detail:e.detail}));return t||n},this.peerId=e.peerId,this.logger=e.logger??tm(),this.log=this.logger.forComponent("libp2p"),this.services={};const n=e.nodeInfo?.name??Iw,s=e.nodeInfo?.version??Aw,i=this.components=function(e={}){const t=new lb(e);return new Proxy(t,{get(e,r,n){if("string"==typeof r&&!hb.includes(r)){const e=t.components[r];if(null==e&&!ub.includes(r))throw new Gy(r+" not set");return e}return Reflect.get(e,r,n)},set(e,r,n){return"string"==typeof r?t.components[r]=n:Reflect.set(e,r,n),!0}})}({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:n,version:s,userAgent:e.nodeInfo?.userAgent??_w(n,s)},logger:this.logger,events:t,datastore:e.datastore??new Py,connectionGater:gb(e.connectionGater),dns:e.dns});null!=e.metrics&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",function(e,t={}){return new Iy(e,t)}(i,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),i.events.addEventListener("peer:update",(e=>{if(null==e.detail.previous){const t={id:e.detail.peer.id,multiaddrs:e.detail.peer.addresses.map((e=>e.multiaddr))};i.events.safeDispatchEvent("peer:discovery",{detail:t})}})),null!=e.connectionProtector&&this.configureComponent("connectionProtector",e.connectionProtector(i)),this.components.upgrader=new Sw(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map(((e,t)=>this.configureComponent("connection-encryption-"+t,e(this.components)))),streamMuxers:(e.streamMuxers??[]).map(((e,t)=>this.configureComponent("stream-muxers-"+t,e(this.components)))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new dw(this.components,e.transportManager)),this.configureComponent("connectionManager",new sw(this.components,e.connectionManager)),!1!==e.connectionMonitor?.enabled&&this.configureComponent("connectionMonitor",new aw(this.components,e.connectionMonitor)),this.configureComponent("registrar",new hw(this.components)),this.configureComponent("addressManager",new Ky(this.components,e.addresses));const o=(e.peerRouters??[]).map(((e,t)=>this.configureComponent("peer-router-"+t,e(this.components))));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new lw(this.components,{routers:o}));const a=(e.contentRouters??[]).map(((e,t)=>this.configureComponent("content-router-"+t,e(this.components))));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new cw(this.components,{routers:a})),this.configureComponent("randomWalk",new uw(this.components)),(e.peerDiscovery??[]).forEach(((e,t)=>{this.configureComponent("peer-discovery-"+t,e(this.components)).addEventListener("peer",(e=>{this.#M(e)}))})),e.transports?.forEach(((e,t)=>{this.components.transportManager.add(this.configureComponent("transport-"+t,e(this.components)))})),null!=e.services)for(const t of Object.keys(e.services)){const r=(0,e.services[t])(this.components);null!=r?(this.services[t]=r,this.configureComponent(t,r),null!=r[In]&&(this.log("registering service %s for content routing",t),a.push(r[In])),null!=r[kn]&&(this.log("registering service %s for peer routing",t),o.push(r[kn])),null!=r[_n]&&(this.log("registering service %s for peer discovery",t),r[_n].addEventListener?.("peer",(e=>{this.#M(e)})))):this.log.error("service factory %s returned null or undefined instance",t)}!function(e){const t={};for(const r of Object.values(e.components))for(const e of db(r))t[e]=!0;for(const r of Object.values(e.components))for(const e of pb(r))if(!0!==t[e])throw new Wy(`Service "${fb(r)}" required capability "${e}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}(i)}configureComponent(e,t){return null==t&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if("stopped"===this.status){this.status="starting",this.log("libp2p is starting");try{await(this.components.beforeStart?.()),await this.components.start(),await(this.components.afterStart?.()),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){"started"===this.status&&(this.log("libp2p is stopping"),this.status="stopping",await(this.components.beforeStop?.()),await this.components.stop(),await(this.components.afterStop?.()),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new am;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,r={}){if(null==t)throw new Nn("no protocols were provided to open a stream");if(0===(t=Array.isArray(t)?t:[t]).length)throw new Nn("no protocols were provided to open a stream");return(await this.dial(e,r)).newStream(t,r)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Kl(e)&&(e=el(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),null!=e.publicKey)return e.publicKey;try{const r=await this.peerStore.get(e,t);if(null!=r.id.publicKey)return r.id.publicKey}catch(e){if("NotFoundError"!==e.name)throw e}const r=qs([tt("/pk/"),e.toMultihash().bytes]),n=Hc(await this.contentRouting.get(r,t));return await this.peerStore.patch(e,{publicKey:n},t),n}async handle(e,t,r){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.handle(e,t,r)})))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.unhandle(e,t)})))}async register(e,t,r){return this.components.registrar.register(e,t,r)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#M(e){const{detail:t}=e;t.id.toString()!==this.peerId.toString()?this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch((e=>{this.log.error(e)})):this.log.error("peer discovery mechanism discovered self")}}function xw(){try{return!1}catch(e){return!1}}const kw="enrtree://AIRVQ5DDA4FFWLRBCHJWUWOO6X6S4ZTZ5B667LQ6AJU6PEYDLRD5O@sandbox.waku.nodes.status.im",Tw="enrtree://AOGYWMBYOUIMOENHXCHILPKY3ZRFEULMFI4DOM442QSZ73TT2A7VI@test.waku.nodes.status.im",Pw=Ns.BOOTSTRAP,Rw="Invalid record id";var Lw=Object.freeze({__proto__:null,default:{}});const Dw=BigInt(0),Mw=BigInt(1),Nw=BigInt(2),Ow=BigInt(3),Uw=BigInt(8),Fw=Object.freeze({a:Dw,b:BigInt(7),P:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:Mw,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee")}),Bw=(e,t)=>(e+t/Nw)/t,qw={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar(e){const{n:t}=Fw,r=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-Mw*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),i=r,o=BigInt("0x100000000000000000000000000000000"),a=Bw(i*e,t),c=Bw(-n*e,t);let l=mv(e-a*r-c*s,t),u=mv(-a*n-c*i,t);const h=l>o,d=u>o;if(h&&(l=t-l),d&&(u=t-u),l>o||u>o)throw Error("splitScalarEndo: Endomorphism failed, k="+e);return{k1neg:h,k1:l,k2neg:d,k2:u}}},$w=32,zw=32;function jw(e){const{a:t,b:r}=Fw,n=mv(e*e),s=mv(n*e);return mv(s+t*e+r)}const Vw=Fw.a===Dw;class Kw extends Error{constructor(e){super(e)}}function Hw(e){if(!(e instanceof Gw))throw new TypeError("JacobianPoint expected")}class Gw{constructor(e,t,r){this.x=e,this.y=t,this.z=r}static fromAffine(e){if(!(e instanceof Zw))throw new TypeError("JacobianPoint#fromAffine: expected Point");return e.equals(Zw.ZERO)?Gw.ZERO:new Gw(e.x,e.y,Mw)}static toAffineBatch(e){const t=function(e,t=Fw.P){const r=Array(e.length),n=bv(e.reduce(((e,n,s)=>n===Dw?e:(r[s]=e,mv(e*n,t))),Mw),t);return e.reduceRight(((e,n,s)=>n===Dw?e:(r[s]=mv(e*r[s],t),mv(e*n,t))),n),r}(e.map((e=>e.z)));return e.map(((e,r)=>e.toAffine(t[r])))}static normalizeZ(e){return Gw.toAffineBatch(e).map(Gw.fromAffine)}equals(e){Hw(e);const{x:t,y:r,z:n}=this,{x:s,y:i,z:o}=e,a=mv(n*n),c=mv(o*o),l=mv(t*c),u=mv(s*a),h=mv(mv(r*o)*c),d=mv(mv(i*n)*a);return l===u&&h===d}negate(){return new Gw(this.x,mv(-this.y),this.z)}double(){const{x:e,y:t,z:r}=this,n=mv(e*e),s=mv(t*t),i=mv(s*s),o=e+s,a=mv(Nw*(mv(o*o)-n-i)),c=mv(Ow*n),l=mv(c*c),u=mv(l-Nw*a),h=mv(c*(a-u)-Uw*i),d=mv(Nw*t*r);return new Gw(u,h,d)}add(e){Hw(e);const{x:t,y:r,z:n}=this,{x:s,y:i,z:o}=e;if(s===Dw||i===Dw)return this;if(t===Dw||r===Dw)return e;const a=mv(n*n),c=mv(o*o),l=mv(t*c),u=mv(s*a),h=mv(mv(r*o)*c),d=mv(mv(i*n)*a),p=mv(u-l),f=mv(d-h);if(p===Dw)return f===Dw?this.double():Gw.ZERO;const g=mv(p*p),m=mv(p*g),y=mv(l*g),b=mv(f*f-m-Nw*y),w=mv(f*(y-b)-h*m),v=mv(n*o*p);return new Gw(b,w,v)}subtract(e){return this.add(e.negate())}multiplyUnsafe(e){const t=Gw.ZERO;if("bigint"==typeof e&&e===Dw)return t;let r=gv(e);if(r===Mw)return this;if(!Vw){let e=t,n=this;for(;r>Dw;)r&Mw&&(e=e.add(n)),n=n.double(),r>>=Mw;return e}let{k1neg:n,k1:s,k2neg:i,k2:o}=qw.splitScalar(r),a=t,c=t,l=this;for(;s>Dw||o>Dw;)s&Mw&&(a=a.add(l)),o&Mw&&(c=c.add(l)),l=l.double(),s>>=Mw,o>>=Mw;return n&&(a=a.negate()),i&&(c=c.negate()),c=new Gw(mv(c.x*qw.beta),c.y,c.z),a.add(c)}precomputeWindow(e){const t=Vw?128/e+1:256/e+1,r=[];let n=this,s=n;for(let i=0;i<t;i++){s=n,r.push(s);for(let t=1;t<2**(e-1);t++)s=s.add(n),r.push(s);n=s.double()}return r}wNAF(e,t){!t&&this.equals(Gw.BASE)&&(t=Zw.BASE);const r=t&&t._WINDOW_SIZE||1;if(256%r)throw Error("Point#wNAF: Invalid precomputation window, must be power of 2");let n=t&&Xw.get(t);n||(n=this.precomputeWindow(r),t&&1!==r&&(n=Gw.normalizeZ(n),Xw.set(t,n)));let s=Gw.ZERO,i=Gw.BASE;const o=1+(Vw?128/r:256/r),a=2**(r-1),c=BigInt(2**r-1),l=2**r,u=BigInt(r);for(let t=0;t<o;t++){const r=t*a;let o=Number(e&c);e>>=u,o>a&&(o-=l,e+=Mw);const h=r,d=r+Math.abs(o)-1,p=t%2!=0,f=o<0;0===o?i=i.add(Ww(p,n[h])):s=s.add(Ww(f,n[d]))}return{p:s,f:i}}multiply(e,t){let r,n,s=gv(e);if(Vw){const{k1neg:e,k1:i,k2neg:o,k2:a}=qw.splitScalar(s);let{p:c,f:l}=this.wNAF(i,t),{p:u,f:h}=this.wNAF(a,t);c=Ww(e,c),u=Ww(o,u),u=new Gw(mv(u.x*qw.beta),u.y,u.z),r=c.add(u),n=l.add(h)}else{const{p:e,f:i}=this.wNAF(s,t);r=e,n=i}return Gw.normalizeZ([r,n])[0]}toAffine(e){const{x:t,y:r,z:n}=this,s=this.equals(Gw.ZERO);null==e&&(e=s?Uw:bv(n));const i=e,o=mv(i*i),a=mv(o*i),c=mv(t*o),l=mv(r*a),u=mv(n*i);if(s)return Zw.ZERO;if(u!==Mw)throw Error("invZ was invalid");return new Zw(c,l)}}function Ww(e,t){const r=t.negate();return e?r:t}Gw.BASE=new Gw(Fw.Gx,Fw.Gy,Mw),Gw.ZERO=new Gw(Dw,Mw,Dw);const Xw=new WeakMap;class Zw{constructor(e,t){this.x=e,this.y=t}_setWindowSize(e){this._WINDOW_SIZE=e,Xw.delete(this)}hasEvenY(){return this.y%Nw===Dw}static fromCompressedHex(e){const t=32===e.length,r=pv(t?e:e.subarray(1));if(!Iv(r))throw Error("Point is not on curve");let n=function(e){const{P:t}=Fw,r=BigInt(6),n=BigInt(11),s=BigInt(22),i=BigInt(23),o=BigInt(44),a=BigInt(88),c=e*e*e%t,l=c*c*e%t,u=yv(l,Ow)*l%t,h=yv(u,Ow)*l%t,d=yv(h,Nw)*c%t,p=yv(d,n)*d%t,f=yv(p,s)*p%t,g=yv(f,o)*f%t,m=yv(g,a)*g%t,y=yv(m,o)*f%t,b=yv(y,Ow)*l%t,w=yv(b,i)*p%t,v=yv(w,r)*c%t,E=yv(v,Nw);if(E*E%t!==e)throw Error("Cannot find square root");return E}(jw(r));const s=(n&Mw)===Mw;if(t)s&&(n=mv(-n));else{!(1&~e[0])!==s&&(n=mv(-n))}const i=new Zw(r,n);return i.assertValidity(),i}static fromUncompressedHex(e){const t=pv(e.subarray(1,33)),r=pv(e.subarray(33,65)),n=new Zw(t,r);return n.assertValidity(),n}static fromHex(e){const t=fv(e),r=t.length,n=t[0];if(r===$w)return this.fromCompressedHex(t);if(33===r&&(2===n||3===n))return this.fromCompressedHex(t);if(65===r&&4===n)return this.fromUncompressedHex(t);throw Error("Point.fromHex: received invalid point. Expected 32-33 compressed bytes or 65 uncompressed bytes, not "+r)}static fromPrivateKey(e){return Zw.BASE.multiply(Cv(e))}static fromSignature(e,t,r){const{r:n,s}=xv(t);if(![0,1,2,3].includes(r))throw Error("Cannot recover: invalid recovery bit");const i=wv(fv(e)),{n:o}=Fw,a=2===r||3===r?n+o:n,c=bv(a,o),l=mv(-i*c,o),u=mv(s*c,o),h=1&r?"03":"02",d=Zw.fromHex(h+lv(a)),p=Zw.BASE.multiplyAndAddUnsafe(d,l,u);if(!p)throw Error("Cannot recover signature: point at infinify");return p.assertValidity(),p}toRawBytes(e=!1){return av(this.toHex(e))}toHex(e=!1){const t=lv(this.x);if(e){return`${this.hasEvenY()?"02":"03"}${t}`}return`04${t}${lv(this.y)}`}toHexX(){return this.toHex(!0).slice(2)}toRawX(){return this.toRawBytes(!0).slice(1)}assertValidity(){const e="Point is not on elliptic curve",{x:t,y:r}=this;if(!Iv(t)||!Iv(r))throw Error(e);const n=mv(r*r);if(mv(n-jw(t))!==Dw)throw Error(e)}equals(e){return this.x===e.x&&this.y===e.y}negate(){return new Zw(this.x,mv(-this.y))}double(){return Gw.fromAffine(this).double().toAffine()}add(e){return Gw.fromAffine(this).add(Gw.fromAffine(e)).toAffine()}subtract(e){return this.add(e.negate())}multiply(e){return Gw.fromAffine(this).multiply(e,this).toAffine()}multiplyAndAddUnsafe(e,t,r){const n=Gw.fromAffine(this),s=t===Dw||t===Mw||this!==Zw.BASE?n.multiplyUnsafe(t):n.multiply(t),i=Gw.fromAffine(e).multiplyUnsafe(r),o=s.add(i);return o.equals(Gw.ZERO)?void 0:o.toAffine()}}function Yw(e){return Number.parseInt(e[0],16)>=8?"00"+e:e}function Qw(e){if(e.length<2||2!==e[0])throw Error("Invalid signature integer tag: "+sv(e));const t=e[1],r=e.subarray(2,t+2);if(!t||r.length!==t)throw Error("Invalid signature integer: wrong length");if(0===r[0]&&r[1]<=127)throw Error("Invalid signature integer: trailing length");return{data:pv(r),left:e.subarray(t+2)}}Zw.BASE=new Zw(Fw.Gx,Fw.Gy),Zw.ZERO=new Zw(Dw,Dw);class Jw{constructor(e,t){this.r=e,this.s=t,this.assertValidity()}static fromCompact(e){const t=ev(e),r="Signature.fromCompact";if("string"!=typeof e&&!t)throw new TypeError(r+": Expected string or Uint8Array");const n=t?sv(e):e;if(128!==n.length)throw Error(r+": Expected 64-byte hex");return new Jw(dv(n.slice(0,64)),dv(n.slice(64,128)))}static fromDER(e){const t=ev(e);if("string"!=typeof e&&!t)throw new TypeError("Signature.fromDER: Expected string or Uint8Array");const{r,s:n}=function(e){if(e.length<2||48!=e[0])throw Error("Invalid signature tag: "+sv(e));if(e[1]!==e.length-2)throw Error("Invalid signature: incorrect length");const{data:t,left:r}=Qw(e.subarray(2)),{data:n,left:s}=Qw(r);if(s.length)throw Error("Invalid signature: left bytes after parsing: "+sv(s));return{r:t,s:n}}(t?e:av(e));return new Jw(r,n)}static fromHex(e){return this.fromDER(e)}assertValidity(){const{r:e,s:t}=this;if(!Av(e))throw Error("Invalid Signature: r must be 0 < r < n");if(!Av(t))throw Error("Invalid Signature: s must be 0 < s < n")}hasHighS(){const e=Fw.n>>Mw;return this.s>e}normalizeS(){return this.hasHighS()?new Jw(this.r,mv(-this.s,Fw.n)):this}toDERRawBytes(){return av(this.toDERHex())}toDERHex(){const e=Yw(hv(this.s)),t=Yw(hv(this.r)),r=e.length/2,n=t.length/2,s=hv(r),i=hv(n);return`30${hv(n+r+4)}02${i}${t}02${s}${e}`}toRawBytes(){return this.toDERRawBytes()}toHex(){return this.toDERHex()}toCompactRawBytes(){return av(this.toCompactHex())}toCompactHex(){return lv(this.r)+lv(this.s)}}function ev(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&"Uint8Array"===e.constructor.name}function tv(e){if(!ev(e))throw Error("Uint8Array expected")}function rv(...e){if(e.every(tv),1===e.length)return e[0];const t=e.reduce(((e,t)=>e+t.length),0),r=new Uint8Array(t);for(let t=0,n=0;t<e.length;t++){const s=e[t];r.set(s,n),n+=s.length}return r}const nv=Array.from({length:256},((e,t)=>t.toString(16).padStart(2,"0")));function sv(e){tv(e);let t="";for(let r=0;r<e.length;r++)t+=nv[e[r]];return t}const iv={_0:48,_9:57,A:65,F:70,a:97,f:102};function ov(e){return e>=iv._0&&e<=iv._9?e-iv._0:e>=iv.A&&e<=iv.F?e-(iv.A-10):e>=iv.a&&e<=iv.f?e-(iv.a-10):void 0}function av(e){if("string"!=typeof e)throw Error("hex string expected, got "+typeof e);const t=e.length,r=t/2;if(t%2)throw Error("hex string expected, got unpadded hex of length "+t);const n=new Uint8Array(r);for(let t=0,s=0;t<r;t++,s+=2){const r=ov(e.charCodeAt(s)),i=ov(e.charCodeAt(s+1));if(void 0===r||void 0===i){const t=e[s]+e[s+1];throw Error('hex string expected, got non-hex character "'+t+'" at index '+s)}n[t]=16*r+i}return n}const cv=BigInt("0x10000000000000000000000000000000000000000000000000000000000000000");function lv(e){if("bigint"!=typeof e)throw Error("Expected bigint");if(!(Dw<=e&&e<cv))throw Error("Expected number 0 <= n < 2^256");return e.toString(16).padStart(64,"0")}function uv(e){const t=av(lv(e));if(32!==t.length)throw Error("Error: expected 32 bytes");return t}function hv(e){const t=e.toString(16);return 1&t.length?"0"+t:t}function dv(e){if("string"!=typeof e)throw new TypeError("hexToNumber: expected string, got "+typeof e);return BigInt("0x"+e)}function pv(e){return dv(sv(e))}function fv(e){return ev(e)?Uint8Array.from(e):av(e)}function gv(e){if("number"==typeof e&&Number.isSafeInteger(e)&&e>0)return BigInt(e);if("bigint"==typeof e&&Av(e))return e;throw new TypeError("Expected valid private scalar: 0 < scalar < curve.n")}function mv(e,t=Fw.P){const r=e%t;return r>=Dw?r:t+r}function yv(e,t){const{P:r}=Fw;let n=e;for(;t-- >Dw;)n*=n,n%=r;return n}function bv(e,t=Fw.P){if(e===Dw||t<=Dw)throw Error(`invert: expected positive integers, got n=${e} mod=${t}`);let r=mv(e,t),n=t,s=Dw,i=Mw;for(;r!==Dw;){const e=n%r,t=s-i*(n/r);n=r,r=e,s=i,i=t}if(n!==Mw)throw Error("invert: does not exist");return mv(s,t)}function wv(e,t=!1){const r=function(e){const t=8*e.length-256,r=pv(e);return t>0?r>>BigInt(t):r}(e);if(t)return r;const{n}=Fw;return r>=n?r-n:r}let vv,Ev;class Sv{constructor(e,t){if(this.hashLen=e,this.qByteLen=t,"number"!=typeof e||e<2)throw Error("hashLen must be a number");if("number"!=typeof t||t<2)throw Error("qByteLen must be a number");this.v=new Uint8Array(e).fill(1),this.k=new Uint8Array(e).fill(0),this.counter=0}hmac(...e){return Ov.hmacSha256(this.k,...e)}hmacSync(...e){return Ev(this.k,...e)}checkSync(){if("function"!=typeof Ev)throw new Kw("hmacSha256Sync needs to be set")}incr(){if(this.counter>=1e3)throw Error("Tried 1,000 k values for sign(), all were invalid");this.counter+=1}async reseed(e=new Uint8Array){this.k=await this.hmac(this.v,Uint8Array.from([0]),e),this.v=await this.hmac(this.v),0!==e.length&&(this.k=await this.hmac(this.v,Uint8Array.from([1]),e),this.v=await this.hmac(this.v))}reseedSync(e=new Uint8Array){this.checkSync(),this.k=this.hmacSync(this.v,Uint8Array.from([0]),e),this.v=this.hmacSync(this.v),0!==e.length&&(this.k=this.hmacSync(this.v,Uint8Array.from([1]),e),this.v=this.hmacSync(this.v))}async generate(){this.incr();let e=0;const t=[];for(;e<this.qByteLen;){this.v=await this.hmac(this.v);const r=this.v.slice();t.push(r),e+=this.v.length}return rv(...t)}generateSync(){this.checkSync(),this.incr();let e=0;const t=[];for(;e<this.qByteLen;){this.v=this.hmacSync(this.v);const r=this.v.slice();t.push(r),e+=this.v.length}return rv(...t)}}function Av(e){return Dw<e&&e<Fw.n}function Iv(e){return Dw<e&&e<Fw.P}function _v(e,t,r,n=!0){const{n:s}=Fw,i=wv(e,!0);if(!Av(i))return;const o=bv(i,s),a=Zw.BASE.multiply(i),c=mv(a.x,s);if(c===Dw)return;const l=mv(o*mv(t+r*c,s),s);if(l===Dw)return;let u=new Jw(c,l),h=(a.x===u.r?0:2)|Number(a.y&Mw);return n&&u.hasHighS()&&(u=u.normalizeS(),h^=1),{sig:u,recovery:h}}function Cv(e){let t;if("bigint"==typeof e)t=e;else if("number"==typeof e&&Number.isSafeInteger(e)&&e>0)t=BigInt(e);else if("string"==typeof e){if(64!==e.length)throw Error("Expected 32 bytes of private key");t=dv(e)}else{if(!ev(e))throw new TypeError("Expected valid private key");if(e.length!==zw)throw Error("Expected 32 bytes of private key");t=pv(e)}if(!Av(t))throw Error("Expected private key: 0 < key < n");return t}function xv(e){if(e instanceof Jw)return e.assertValidity(),e;try{return Jw.fromDER(e)}catch(t){return Jw.fromCompact(e)}}function kv(e){return pv(e.length>$w?e.slice(0,$w):e)}function Tv(e){const t=kv(e),r=mv(t,Fw.n);return Pv(r<Dw?t:r)}function Pv(e){return uv(e)}async function Rv(e,t,r={}){const{seed:n,m:s,d:i}=function(e,t,r){if(null==e)throw Error(`sign: expected valid message hash, not "${e}"`);const n=fv(e),s=Cv(t),i=[Pv(s),Tv(n)];if(null!=r){!0===r&&(r=Ov.randomBytes($w));const e=fv(r);if(e.length!==$w)throw Error("sign: Expected 32 bytes of extra data");i.push(e)}return{seed:rv(...i),m:kv(n),d:s}}(e,t,r.extraEntropy),o=new Sv(32,zw);let a;for(await o.reseed(n);!(a=_v(await o.generate(),s,i,r.canonical));)await o.reseed();return function(e,t){const{sig:r,recovery:n}=e,{der:s,recovered:i}=Object.assign({canonical:!0,der:!0},t),o=s?r.toDERRawBytes():r.toCompactRawBytes();return i?[o,n]:o}(a,r)}const Lv={strict:!0};function Dv(e,t,r,n=Lv){let s;try{s=xv(e),t=fv(t)}catch(e){return!1}const{r:i,s:o}=s;if(n.strict&&s.hasHighS())return!1;const a=wv(t);let c;try{c=function(e){return e instanceof Zw?(e.assertValidity(),e):Zw.fromHex(e)}(r)}catch(e){return!1}const{n:l}=Fw,u=bv(o,l),h=mv(a*u,l),d=mv(i*u,l),p=Zw.BASE.multiplyAndAddUnsafe(c,h,d);if(!p)return!1;return mv(p.x,l)===i}Zw.BASE._setWindowSize(8);const Mv={node:Lw,web:"object"==typeof self&&"crypto"in self?self.crypto:void 0},Nv={},Ov={bytesToHex:sv,hexToBytes:av,concatBytes:rv,mod:mv,invert:bv,isValidPrivateKey(e){try{return Cv(e),!0}catch(e){return!1}},_bigintTo32Bytes:uv,_normalizePrivateKey:Cv,hashToPrivateKey(e){if((e=fv(e)).length<40||e.length>1024)throw Error("Expected valid bytes of private key as per FIPS 186");return uv(mv(pv(e),Fw.n-Mw)+Mw)},randomBytes(e=32){if(Mv.web)return Mv.web.getRandomValues(new Uint8Array(e));if(Mv.node){const{randomBytes:t}=Mv.node;return Uint8Array.from(t(e))}throw Error("The environment doesn't have randomBytes function")},randomPrivateKey(){return Ov.hashToPrivateKey(Ov.randomBytes(40))},precompute(e=8,t=Zw.BASE){const r=t===Zw.BASE?t:new Zw(t.x,t.y);return r._setWindowSize(e),r.multiply(Ow),r},async sha256(...e){if(Mv.web){const t=await Mv.web.subtle.digest("SHA-256",rv(...e));return new Uint8Array(t)}if(Mv.node){const{createHash:t}=Mv.node,r=t("sha256");return e.forEach((e=>r.update(e))),Uint8Array.from(r.digest())}throw Error("The environment doesn't have sha256 function")},async hmacSha256(e,...t){if(Mv.web){const r=await Mv.web.subtle.importKey("raw",e,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),n=rv(...t),s=await Mv.web.subtle.sign("HMAC",r,n);return new Uint8Array(s)}if(Mv.node){const{createHmac:r}=Mv.node,n=r("sha256",e);return t.forEach((e=>n.update(e))),Uint8Array.from(n.digest())}throw Error("The environment doesn't have hmac-sha256 function")},sha256Sync:void 0,hmacSha256Sync:void 0,async taggedHash(e,...t){let r=Nv[e];if(void 0===r){const t=await Ov.sha256(Uint8Array.from(e,(e=>e.charCodeAt(0))));r=rv(t,t),Nv[e]=r}return Ov.sha256(r,...t)},taggedHashSync(e,...t){if("function"!=typeof vv)throw new Kw("sha256Sync is undefined, you need to set it");let r=Nv[e];if(void 0===r){const t=vv(Uint8Array.from(e,(e=>e.charCodeAt(0))));r=rv(t,t),Nv[e]=r}return vv(r,...t)},_JacobianPoint:Gw};Object.defineProperties(Ov,{sha256Sync:{configurable:!1,get:()=>vv,set(e){vv||(vv=e)}},hmacSha256Sync:{configurable:!1,get:()=>Ev,set(e){Ev||(Ev=e)}}});var Uv,Fv={exports:{}};var Bv,qv=(Uv||(Uv=1,Bv=Fv,function(){var e="input is invalid type",t="object"==typeof window,r=t?window:{};r.JS_SHA3_NO_WINDOW&&(t=!1);var n=!t&&"object"==typeof self;!r.JS_SHA3_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node?r=cs:n&&(r=self);for(var s=!r.JS_SHA3_NO_COMMON_JS&&Bv.exports,i=!r.JS_SHA3_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,o="0123456789abcdef".split(""),a=[4,1024,262144,67108864],c=[0,8,16,24],l=[1,0,32898,0,32906,2147483648,2147516416,2147483648,32907,0,2147483649,0,2147516545,2147483648,32777,2147483648,138,0,136,0,2147516425,0,2147483658,0,2147516555,0,139,2147483648,32905,2147483648,32771,2147483648,32770,2147483648,128,2147483648,32778,0,2147483658,2147483648,2147516545,2147483648,32896,2147483648,2147483649,0,2147516424,2147483648],u=[224,256,384,512],h=[128,256],d=["hex","buffer","arrayBuffer","array","digest"],p={128:168,256:136},f=r.JS_SHA3_NO_NODE_JS||!Array.isArray?e=>"[object Array]"==={}.toString.call(e):Array.isArray,g=!i||!r.JS_SHA3_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView?ArrayBuffer.isView:e=>"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer,m=t=>{var r=typeof t;if("string"===r)return[t,!0];if("object"!==r||null===t)throw Error(e);if(i&&t.constructor===ArrayBuffer)return[new Uint8Array(t),!1];if(!f(t)&&!g(t))throw Error(e);return[t,!1]},y=e=>0===m(e)[0].length,b=e=>{for(var t=[],r=0;r<e.length;++r)t[r]=e[r];return t},w=(e,t,r)=>n=>new M(e,t,e).update(n)[r](),v=(e,t,r)=>(n,s)=>new M(e,t,s).update(n)[r](),E=(e,t,r)=>(t,n,s,i)=>C["cshake"+e].update(t,n,s,i)[r](),S=(e,t,r)=>(t,n,s,i)=>C["kmac"+e].update(t,n,s,i)[r](),A=(e,t,r,n)=>{for(var s=0;s<d.length;++s){var i=d[s];e[i]=t(r,n,i)}return e},I=(e,t)=>{var r=w(e,t,"hex");return r.create=()=>new M(e,t,e),r.update=e=>r.create().update(e),A(r,w,e,t)},_=[{name:"keccak",padding:[1,256,65536,16777216],bits:u,createMethod:I},{name:"sha3",padding:[6,1536,393216,100663296],bits:u,createMethod:I},{name:"shake",padding:[31,7936,2031616,520093696],bits:h,createMethod(e,t){var r=v(e,t,"hex");return r.create=r=>new M(e,t,r),r.update=(e,t)=>r.create(t).update(e),A(r,v,e,t)}},{name:"cshake",padding:a,bits:h,createMethod(e,t){var r=p[e],n=E(e,0,"hex");return n.create=(n,s,i)=>y(s)&&y(i)?C["shake"+e].create(n):new M(e,t,n).bytepad([s,i],r),n.update=(e,t,r,s)=>n.create(t,r,s).update(e),A(n,E,e,t)}},{name:"kmac",padding:a,bits:h,createMethod(e,t){var r=p[e],n=S(e,0,"hex");return n.create=(n,s,i)=>new N(e,t,s).bytepad(["KMAC",i],r).bytepad([n],r),n.update=(e,t,r,s)=>n.create(e,r,s).update(t),A(n,S,e,t)}}],C={},x=[],k=0;k<_.length;++k)for(var T=_[k],P=T.bits,R=0;R<P.length;++R){var L=T.name+"_"+P[R];if(x.push(L),C[L]=T.createMethod(P[R],T.padding),"sha3"!==T.name){var D=T.name+P[R];x.push(D),C[D]=C[L]}}function M(e,t,r){this.blocks=[],this.s=[],this.padding=t,this.outputBits=r,this.reset=!0,this.finalized=!1,this.block=0,this.start=0,this.blockCount=1600-(e<<1)>>5,this.byteCount=this.blockCount<<2,this.outputBlocks=r>>5,this.extraBytes=(31&r)>>3;for(var n=0;n<50;++n)this.s[n]=0}function N(e,t,r){M.call(this,e,t,r)}M.prototype.update=function(e){if(this.finalized)throw Error("finalize already called");var t=m(e);e=t[0];for(var r,n,s=t[1],i=this.blocks,o=this.byteCount,a=e.length,l=this.blockCount,u=0,h=this.s;u<a;){if(this.reset)for(this.reset=!1,i[0]=this.block,r=1;r<l+1;++r)i[r]=0;if(s)for(r=this.start;u<a&&r<o;++u)(n=e.charCodeAt(u))<128?i[r>>2]|=n<<c[3&r++]:n<2048?(i[r>>2]|=(192|n>>6)<<c[3&r++],i[r>>2]|=(128|63&n)<<c[3&r++]):n<55296||n>=57344?(i[r>>2]|=(224|n>>12)<<c[3&r++],i[r>>2]|=(128|n>>6&63)<<c[3&r++],i[r>>2]|=(128|63&n)<<c[3&r++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++u)),i[r>>2]|=(240|n>>18)<<c[3&r++],i[r>>2]|=(128|n>>12&63)<<c[3&r++],i[r>>2]|=(128|n>>6&63)<<c[3&r++],i[r>>2]|=(128|63&n)<<c[3&r++]);else for(r=this.start;u<a&&r<o;++u)i[r>>2]|=e[u]<<c[3&r++];if(this.lastByteIndex=r,r>=o){for(this.start=r-o,this.block=i[l],r=0;r<l;++r)h[r]^=i[r];O(h),this.reset=!0}else this.start=r}return this},M.prototype.encode=function(e,t){var r=255&e,n=1,s=[r];for(r=255&(e>>=8);r>0;)s.unshift(r),r=255&(e>>=8),++n;return t?s.push(n):s.unshift(n),this.update(s),s.length},M.prototype.encodeString=function(e){var t=m(e);e=t[0];var r=t[1],n=0,s=e.length;if(r)for(var i=0;i<e.length;++i){var o=e.charCodeAt(i);o<128?n+=1:o<2048?n+=2:o<55296||o>=57344?n+=3:(o=65536+((1023&o)<<10|1023&e.charCodeAt(++i)),n+=4)}else n=s;return n+=this.encode(8*n),this.update(e),n},M.prototype.bytepad=function(e,t){for(var r=this.encode(t),n=0;n<e.length;++n)r+=this.encodeString(e[n]);var s=(t-r%t)%t,i=[];return i.length=s,this.update(i),this},M.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex,r=this.blockCount,n=this.s;if(e[t>>2]|=this.padding[3&t],this.lastByteIndex===this.byteCount)for(e[0]=e[r],t=1;t<r+1;++t)e[t]=0;for(e[r-1]|=2147483648,t=0;t<r;++t)n[t]^=e[t];O(n)}},M.prototype.toString=M.prototype.hex=function(){this.finalize();for(var e,t=this.blockCount,r=this.s,n=this.outputBlocks,s=this.extraBytes,i=0,a=0,c="";a<n;){for(i=0;i<t&&a<n;++i,++a)e=r[i],c+=o[e>>4&15]+o[15&e]+o[e>>12&15]+o[e>>8&15]+o[e>>20&15]+o[e>>16&15]+o[e>>28&15]+o[e>>24&15];a%t==0&&(r=b(r),O(r),i=0)}return s&&(e=r[i],c+=o[e>>4&15]+o[15&e],s>1&&(c+=o[e>>12&15]+o[e>>8&15]),s>2&&(c+=o[e>>20&15]+o[e>>16&15])),c},M.prototype.arrayBuffer=function(){this.finalize();var e,t=this.blockCount,r=this.s,n=this.outputBlocks,s=this.extraBytes,i=0,o=0,a=this.outputBits>>3;e=s?new ArrayBuffer(n+1<<2):new ArrayBuffer(a);for(var c=new Uint32Array(e);o<n;){for(i=0;i<t&&o<n;++i,++o)c[o]=r[i];o%t==0&&(r=b(r),O(r))}return s&&(c[o]=r[i],e=e.slice(0,a)),e},M.prototype.buffer=M.prototype.arrayBuffer,M.prototype.digest=M.prototype.array=function(){this.finalize();for(var e,t,r=this.blockCount,n=this.s,s=this.outputBlocks,i=this.extraBytes,o=0,a=0,c=[];a<s;){for(o=0;o<r&&a<s;++o,++a)e=a<<2,t=n[o],c[e]=255&t,c[e+1]=t>>8&255,c[e+2]=t>>16&255,c[e+3]=t>>24&255;a%r==0&&(n=b(n),O(n))}return i&&(e=a<<2,t=n[o],c[e]=255&t,i>1&&(c[e+1]=t>>8&255),i>2&&(c[e+2]=t>>16&255)),c},N.prototype=new M,N.prototype.finalize=function(){return this.encode(this.outputBits,!0),M.prototype.finalize.call(this)};var O=e=>{var t,r,n,s,i,o,a,c,u,h,d,p,f,g,m,y,b,w,v,E,S,A,I,_,C,x,k,T,P,R,L,D,M,N,O,U,F,B,q,$,z,j,V,K,H,G,W,X,Z,Y,Q,J,ee,te,re,ne,se,ie,oe,ae,ce,le,ue;for(n=0;n<48;n+=2)s=e[0]^e[10]^e[20]^e[30]^e[40],i=e[1]^e[11]^e[21]^e[31]^e[41],o=e[2]^e[12]^e[22]^e[32]^e[42],a=e[3]^e[13]^e[23]^e[33]^e[43],c=e[4]^e[14]^e[24]^e[34]^e[44],u=e[5]^e[15]^e[25]^e[35]^e[45],h=e[6]^e[16]^e[26]^e[36]^e[46],d=e[7]^e[17]^e[27]^e[37]^e[47],t=(p=e[8]^e[18]^e[28]^e[38]^e[48])^(o<<1|a>>>31),r=(f=e[9]^e[19]^e[29]^e[39]^e[49])^(a<<1|o>>>31),e[0]^=t,e[1]^=r,e[10]^=t,e[11]^=r,e[20]^=t,e[21]^=r,e[30]^=t,e[31]^=r,e[40]^=t,e[41]^=r,t=s^(c<<1|u>>>31),r=i^(u<<1|c>>>31),e[2]^=t,e[3]^=r,e[12]^=t,e[13]^=r,e[22]^=t,e[23]^=r,e[32]^=t,e[33]^=r,e[42]^=t,e[43]^=r,t=o^(h<<1|d>>>31),r=a^(d<<1|h>>>31),e[4]^=t,e[5]^=r,e[14]^=t,e[15]^=r,e[24]^=t,e[25]^=r,e[34]^=t,e[35]^=r,e[44]^=t,e[45]^=r,t=c^(p<<1|f>>>31),r=u^(f<<1|p>>>31),e[6]^=t,e[7]^=r,e[16]^=t,e[17]^=r,e[26]^=t,e[27]^=r,e[36]^=t,e[37]^=r,e[46]^=t,e[47]^=r,t=h^(s<<1|i>>>31),r=d^(i<<1|s>>>31),e[8]^=t,e[9]^=r,e[18]^=t,e[19]^=r,e[28]^=t,e[29]^=r,e[38]^=t,e[39]^=r,e[48]^=t,e[49]^=r,g=e[0],m=e[1],G=e[11]<<4|e[10]>>>28,W=e[10]<<4|e[11]>>>28,T=e[20]<<3|e[21]>>>29,P=e[21]<<3|e[20]>>>29,ae=e[31]<<9|e[30]>>>23,ce=e[30]<<9|e[31]>>>23,j=e[40]<<18|e[41]>>>14,V=e[41]<<18|e[40]>>>14,N=e[2]<<1|e[3]>>>31,O=e[3]<<1|e[2]>>>31,y=e[13]<<12|e[12]>>>20,b=e[12]<<12|e[13]>>>20,X=e[22]<<10|e[23]>>>22,Z=e[23]<<10|e[22]>>>22,R=e[33]<<13|e[32]>>>19,L=e[32]<<13|e[33]>>>19,le=e[42]<<2|e[43]>>>30,ue=e[43]<<2|e[42]>>>30,te=e[5]<<30|e[4]>>>2,re=e[4]<<30|e[5]>>>2,U=e[14]<<6|e[15]>>>26,F=e[15]<<6|e[14]>>>26,w=e[25]<<11|e[24]>>>21,v=e[24]<<11|e[25]>>>21,Y=e[34]<<15|e[35]>>>17,Q=e[35]<<15|e[34]>>>17,D=e[45]<<29|e[44]>>>3,M=e[44]<<29|e[45]>>>3,_=e[6]<<28|e[7]>>>4,C=e[7]<<28|e[6]>>>4,ne=e[17]<<23|e[16]>>>9,se=e[16]<<23|e[17]>>>9,B=e[26]<<25|e[27]>>>7,q=e[27]<<25|e[26]>>>7,E=e[36]<<21|e[37]>>>11,S=e[37]<<21|e[36]>>>11,J=e[47]<<24|e[46]>>>8,ee=e[46]<<24|e[47]>>>8,K=e[8]<<27|e[9]>>>5,H=e[9]<<27|e[8]>>>5,x=e[18]<<20|e[19]>>>12,k=e[19]<<20|e[18]>>>12,ie=e[29]<<7|e[28]>>>25,oe=e[28]<<7|e[29]>>>25,$=e[38]<<8|e[39]>>>24,z=e[39]<<8|e[38]>>>24,A=e[48]<<14|e[49]>>>18,I=e[49]<<14|e[48]>>>18,e[0]=g^~y&w,e[1]=m^~b&v,e[10]=_^~x&T,e[11]=C^~k&P,e[20]=N^~U&B,e[21]=O^~F&q,e[30]=K^~G&X,e[31]=H^~W&Z,e[40]=te^~ne&ie,e[41]=re^~se&oe,e[2]=y^~w&E,e[3]=b^~v&S,e[12]=x^~T&R,e[13]=k^~P&L,e[22]=U^~B&$,e[23]=F^~q&z,e[32]=G^~X&Y,e[33]=W^~Z&Q,e[42]=ne^~ie&ae,e[43]=se^~oe&ce,e[4]=w^~E&A,e[5]=v^~S&I,e[14]=T^~R&D,e[15]=P^~L&M,e[24]=B^~$&j,e[25]=q^~z&V,e[34]=X^~Y&J,e[35]=Z^~Q&ee,e[44]=ie^~ae&le,e[45]=oe^~ce&ue,e[6]=E^~A&g,e[7]=S^~I&m,e[16]=R^~D&_,e[17]=L^~M&C,e[26]=$^~j&N,e[27]=z^~V&O,e[36]=Y^~J&K,e[37]=Q^~ee&H,e[46]=ae^~le&te,e[47]=ce^~ue&re,e[8]=A^~g&y,e[9]=I^~m&b,e[18]=D^~_&x,e[19]=M^~C&k,e[28]=j^~N&U,e[29]=V^~O&F,e[38]=J^~K&G,e[39]=ee^~H&W,e[48]=le^~te&ne,e[49]=ue^~re&se,e[0]^=l[n],e[1]^=l[n+1]};if(s)Bv.exports=C;else for(k=0;k<x.length;++k)r[x[k]]=C[x[k]]}()),Fv.exports),$v=ls(qv);function zv(e){return new Uint8Array($v.keccak256.arrayBuffer(e))}function jv(e,t,r){try{return Dv(Jw.fromCompact(e.slice(0,64)),t,r)}catch{return!1}}function Vv(e,t){switch(t){case"udp":return Vv(e,"udp4")||Vv(e,"udp6");case"tcp":return Vv(e,"tcp4")||Vv(e,"tcp6")}const r=t.endsWith("6"),n=e.get(r?"ip6":"ip");if(!n)return;const s=t.slice(0,3);let i;switch(s){case"udp":i=r?e.get("udp6"):e.get("udp");break;case"tcp":i=r?e.get("tcp6"):e.get("tcp");break;default:return}return i?function(e,t,r,n){let s=Hl("/"+e+"/"+zl(e,r));return s=s.encapsulate(Hl("/"+t+"/"+zl(t,n))),s}(r?"ip6":"ip4",s,n,i):void 0}const Kv=parseInt("11111",2),Hv=parseInt("10000000",2),Gv=parseInt("01111111",2),Wv={0:Yv,1:Yv,2(e,t){const r=Zv(e,t),n=t.offset,s=t.offset+r,i=[];for(let t=n;t<s;t++)t===n&&0===e[t]||i.push(e[t]);return t.offset+=r,Uint8Array.from(i)},3(e,t){const r=Zv(e,t),n=e[t.offset];t.offset++;const s=e.subarray(t.offset,t.offset+r-1);if(t.offset+=r,0!==n)throw Error("Unused bits in bit string is unimplemented");return s},4(e,t){const r=Zv(e,t),n=e.subarray(t.offset,t.offset+r);return t.offset+=r,n},5(e,t){return t.offset++,null},6(e,t){const r=Zv(e,t),n=t.offset+r,s=e[t.offset];t.offset++;let i=0,o=0;s<40?(i=0,o=s):s<80?(i=1,o=s-40):(i=2,o=s-80);let a=`${i}.${o}`,c=[];for(;t.offset<n;){const r=e[t.offset];if(t.offset++,c.push(127&r),r<128){c.reverse();let e=0;for(let t=0;t<c.length;t++)e+=c[t]<<7*t;a+="."+e,c=[]}}return a},16:Yv,22:Yv,48:Yv};function Xv(e,t={offset:0}){const r=e[t.offset]&Kv;if(t.offset++,null!=Wv[r])return Wv[r](e,t);throw Error("No decoder for tag "+r)}function Zv(e,t){let r=0;if((e[t.offset]&Hv)===Hv){const n=e[t.offset]&Gv;let s="0x";t.offset++;for(let r=0;r<n;r++,t.offset++)s+=e[t.offset].toString(16).padStart(2,"0");r=parseInt(s,16)}else r=e[t.offset],t.offset++;return r}function Yv(e,t){Zv(e,t);const r=[];for(;!(t.offset>=e.byteLength);){const n=Xv(e,t);if(null===n)break;r.push(n)}return r}function Qv(e){if(e.byteLength<128)return Uint8Array.from([e.byteLength]);const t=function(e){let t=e.toString(16);t.length%2==1&&(t="0"+t);const r=new Ks;for(let e=0;e<t.length;e+=2)r.append(Uint8Array.from([parseInt(`${t[e]}${t[e+1]}`,16)]));return r}(e.byteLength);return new Ks(Uint8Array.from([t.byteLength|Hv]),t)}function Jv(e){const t=new Ks;return!(128&~e.subarray()[0])&&t.append(Uint8Array.from([0])),t.append(e),new Ks(Uint8Array.from([2]),Qv(t),t)}function eE(e){const t=Uint8Array.from([0]),r=new Ks(t,e);return new Ks(Uint8Array.from([3]),Qv(r),r)}function tE(e,t=48){const r=new Ks;for(const t of e)r.append(t);return new Ks(Uint8Array.from([t]),Qv(r),r)}const rE=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),nE=Uint8Array.from([6,5,43,129,4,0,34]),sE=Uint8Array.from([6,5,43,129,4,0,35]),iE={ext:!0,kty:"EC",crv:"P-256"},oE={ext:!0,kty:"EC",crv:"P-384"},aE={ext:!0,kty:"EC",crv:"P-521"};function cE(e){if("P-256"===e)return rE;if("P-384"===e)return nE;if("P-521"===e)return sE;throw new Nn("Invalid curve "+e)}class lE{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){var e;return null==this._raw&&(this._raw=(e=this.jwk,tE([Jv(Uint8Array.from([1])),tE([cE(e.crv)],160),tE([eE(new Ks(Uint8Array.from([4]),tt(e.x??"","base64url"),tt(e.y??"","base64url")))],161)]).subarray())),this._raw}toMultihash(){return Be.digest(kE(this))}toCID(){return Ke.createV1(114,this.toMultihash())}toString(){return he.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&$s(this.raw,e.raw)}async verify(e,t,r){return async function(e,t,r,n){const s=await crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:e.crv??"P-256"},!1,["verify"]);n?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,t,r.subarray());return n?.signal?.throwIfAborted(),i}(this.jwk,t,e,r)}}class uE extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class hE extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}var dE={get(e=globalThis){const t=e.crypto;if(null==t?.subtle)throw new hE("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return t}};let pE;const fE=(async()=>{try{return await dE.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();async function gE(e,t,r){return null==pE&&(pE=await fE),pE?async function(e,t,r){if(e.buffer instanceof ArrayBuffer){const n=await dE.get().subtle.importKey("raw",e.buffer,{name:"Ed25519"},!1,["verify"]);return await dE.get().subtle.verify({name:"Ed25519"},n,t,r instanceof Uint8Array?r:r.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}(e,t,r):function(e,t,r){return Za.verify(t,r instanceof Uint8Array?r:r.subarray(),e)}(e,t,r)}function mE(e){return null!=e&&("function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally)}class yE{type="Ed25519";raw;constructor(e){this.raw=bE(e,32)}toMultihash(){return Be.digest(kE(this))}toCID(){return Ke.createV1(114,this.toMultihash())}toString(){return he.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&$s(this.raw,e.raw)}verify(e,t,r){r?.signal?.throwIfAborted();const n=gE(this.raw,t,e);return mE(n)?n.then((e=>(r?.signal?.throwIfAborted(),e))):n}}function bE(e,t){if((e=Uint8Array.from(e??[])).length!==t)throw new Nn(`Key must be a Uint8Array of length ${t}, got ${e.length}`);return e}var wE,vE,EE,SE;(e=>{e.RSA="RSA",e.Ed25519="Ed25519",e.secp256k1="secp256k1",e.ECDSA="ECDSA"})(wE||(wE={})),(e=>{e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.secp256k1=2]="secp256k1",e[e.ECDSA=3]="ECDSA"})(vE||(vE={})),(e=>{e.codec=()=>Yt(vE)})(wE||(wE={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),wE.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.Type=wE.codec().decode(e);break;case 2:r.Data=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(EE||(EE={})),(e=>{let t;e.codec=()=>(null==t&&(t=Qt(((e,t,r={})=>{!1!==r.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),wE.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==r.lengthDelimited&&t.ldelim()}),((e,t)=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.Type=wE.codec().decode(e);break;case 2:r.Data=e.bytes();break;default:e.skipType(7&t)}}return r}))),t),e.encode=t=>gt(t,e.codec()),e.decode=(t,r)=>k(t,e.codec(),r)})(SE||(SE={}));class AE{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return null==this._raw&&(this._raw=function(e){if(null==e.n||null==e.e)throw new Nn("JWK was missing components");return tE([IE,eE(tE([Jv(tt(e.n,"base64url")),Jv(tt(e.e,"base64url"))]))]).subarray()}(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return Ke.createV1(114,this._multihash)}toString(){return he.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&$s(this.raw,e.raw)}verify(e,t,r){return async function(e,t,r,n){const s=await dE.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);n?.signal?.throwIfAborted();const i=await dE.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,t,r instanceof Uint8Array?r:r.subarray());return n?.signal?.throwIfAborted(),i}(this.jwk,t,e,r)}}const IE=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function _E(e,t,r){const n=function(e){const t=Xv(e[1],{offset:0});return{kty:"RSA",n:an(t[0],"base64url"),e:an(t[1],"base64url")}}(e);if(null==r){r=Ne(18,on(EE.encode({Type:wE.RSA,Data:t})))}return new AE(n,r)}class CE{type="secp256k1";raw;_key;constructor(e){this._key=function(e){try{return zc.ProjectivePoint.fromHex(e),e}catch(e){throw new On(e+"")}}(e),this.raw=function(e){const t=zc.ProjectivePoint.fromHex(e).toRawBytes(!0);return t}(this._key)}toMultihash(){return Be.digest(kE(this))}toCID(){return Ke.createV1(114,this.toMultihash())}toString(){return he.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&$s(this.raw,e.raw)}verify(e,t,r){return function(e,t,r,n){const s=$e.digest(r instanceof Uint8Array?r:r.subarray());if(mE(s))return s.then((({digest:r})=>(n?.signal?.throwIfAborted(),zc.verify(t,r,e)))).catch((e=>{if("AbortError"===e.name)throw e;throw new uE(e+"")}));try{return n?.signal?.throwIfAborted(),zc.verify(t,s.digest,e)}catch(e){throw new uE(e+"")}}(this._key,t,e,r)}}function xE(e){if(32===e.byteLength)return t=bE(t=e,32),new yE(t);if(33===e.byteLength)return function(e){return new CE(e)}(e);var t;const r=Xv(e),n=r[1]?.[0];if("1.2.840.10045.3.1.7"===n||"1.3.132.0.34"===n||"1.3.132.0.35"===n)return function(e){const t=e[1][1][0];let r,n;if(65===t.byteLength)return r=an(t.subarray(1,33),"base64url"),n=an(t.subarray(33),"base64url"),new lE({...iE,key_ops:["verify"],x:r,y:n});if(97===t.byteLength)return r=an(t.subarray(1,49),"base64url"),n=an(t.subarray(49),"base64url"),new lE({...oE,key_ops:["verify"],x:r,y:n});if(133===t.byteLength)return r=an(t.subarray(1,67),"base64url"),n=an(t.subarray(67),"base64url"),new lE({...aE,key_ops:["verify"],x:r,y:n});throw new Nn(`coordinates were wrong length, got ${t.byteLength}, expected 65, 97 or 133`)}(r);if("1.2.840.113549.1.1.1"===r[0]?.[0])return _E(r,e);throw new Nn("Could not extract public key from raw bytes")}function kE(e){return EE.encode({Type:wE[e.type],Data:e.raw})}const TE=Symbol.for("nodejs.util.inspect.custom");class PE{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Cn]=!0;toString(){return null==this.string&&(this.string=he.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ke.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return $s(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return $s(this.multihash.bytes,e.toMultihash().bytes);throw Error("not valid Id")}[TE](){return`PeerId(${this.toString()})`}}class RE extends PE{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class LE extends PE{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class DE extends PE{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}function ME(e){const t=xE(e);if("secp256k1"!==t.type)throw Error("Keypair type not implemented");return function(e){if("Ed25519"===e.type)return new LE({multihash:e.toCID().multihash,publicKey:e});if("secp256k1"===e.type)return new DE({multihash:e.toCID().multihash,publicKey:e});if("RSA"===e.type)return new RE({multihash:e.toCID().multihash,publicKey:e});throw new ns}(t)}function NE(e){const t=e.reduce(((e,t)=>e+2+t.bytes.length),0),r=new Uint8Array(t),n=new DataView(r.buffer);let s=0;return e.forEach((e=>{if(e.getPeerId())throw Error("`multiaddr` field MUST not contain peer id");n.setUint16(s,e.bytes.length),s+=2,r.set(e.bytes,s),s+=e.bytes.length})),r}function OE(e){let t=0;return e.lightPush&&(t+=1),t<<=1,e.filter&&(t+=1),t<<=1,e.store&&(t+=1),t<<=1,e.relay&&(t+=1),t}class UE extends Map{seq;signature;constructor(e={},t=BigInt(1),r){super(Object.entries(e)),this.seq=t,this.signature=r}set(e,t){return this.signature=void 0,this.seq++,super.set(e,t)}get id(){const e=this.get("id");if(!e)throw Error("id not found.");return hn(e)}get publicKey(){if("v4"===this.id)return this.get("secp256k1");throw Error(Rw)}get rs(){const e=this.get("rs");if(e)return En(e)}get rsv(){const e=this.get("rsv");if(e)return En(e)}get ip(){return FE(this,"ip","ip4")}set ip(e){qE(this,"ip","ip4",e)}get tcp(){return BE(this,"tcp","tcp")}set tcp(e){$E(this,"tcp","tcp",e)}get udp(){return BE(this,"udp","udp")}set udp(e){$E(this,"udp","udp",e)}get ip6(){return FE(this,"ip6","ip6")}set ip6(e){qE(this,"ip6","ip6",e)}get tcp6(){return BE(this,"tcp6","tcp")}set tcp6(e){$E(this,"tcp6","tcp",e)}get udp6(){return BE(this,"udp6","udp")}set udp6(e){$E(this,"udp6","udp",e)}get multiaddrs(){const e=this.get("multiaddrs");if(e)return function(e){const t=[];let r=0;for(;r<e.length;){const n=new DataView(e.buffer,r,2).getUint16(0);r+=2;const s=e.slice(r,r+n);r+=n,t.push(Hl(s))}return t}(e)}set multiaddrs(e){zE(this,"multiaddrs",e,NE)}get waku2(){const e=this.get("waku2");if(e)return function(e){const t={relay:!1,store:!1,filter:!1,lightPush:!1};return e%2&&(t.relay=!0),(e>>=1)%2&&(t.store=!0),(e>>=1)%2&&(t.filter=!0),(e>>=1)%2&&(t.lightPush=!0),t}(e[0])}set waku2(e){zE(this,"waku2",e,(e=>new Uint8Array([OE(e)])))}}function FE(e,t,r){const n=e.get(t);if(n)return zl(r,n)}function BE(e,t,r){const n=e.get(t);if(n)return Number(zl(r,n))}function qE(e,t,r,n){zE(e,t,n,jl.bind({},r))}function $E(e,t,r,n){qE(e,t,r,n?.toString(10))}function zE(e,t,r,n){void 0!==r?e.set(t,n(r)):e.delete(t)}const jE=new vs("enr");var VE,KE;(e=>{e.TCP="tcp",e.UDP="udp"})(VE||(VE={})),(e=>{e.TCP4="tcp4",e.UDP4="udp4",e.TCP6="tcp6",e.UDP6="udp6"})(KE||(KE={}));class HE extends UE{static RECORD_PREFIX="enr:";peerId;static create(e={},t=BigInt(1),r){const n=new HE(e,t,r);try{const e=n.publicKey;e&&(n.peerId=ME(e))}catch(e){jE.error("Could not calculate peer id for ENR",e)}return n}get nodeId(){if("v4"===this.id)return this.publicKey?function(e){const t=Zw.fromHex(e).toRawBytes(!1);return un(zv(t.slice(1)))}(this.publicKey):void 0;throw Error(Rw)}getLocationMultiaddr=Vv.bind({},this);get shardInfo(){return this.rs&&this.rsv&&jE.warn("ENR contains both `rs` and `rsv` fields."),this.rs||this.rsv}setLocationMultiaddr(e){const t=e.protoNames();if(2!==t.length&&"udp"!==t[1]&&"tcp"!==t[1])throw Error("Invalid multiaddr");const r=e.tuples();if(!r[0][1]||!r[1][1])throw Error("Invalid multiaddr");4===r[0][0]?(this.set("ip",r[0][1]),this.set(t[1],r[1][1])):(this.set("ip6",r[0][1]),this.set(t[1]+"6",r[1][1]))}getAllLocationMultiaddrs(){const e=[];for(const t of Object.values(KE)){const r=this.getLocationMultiaddr(t);r&&e.push(r)}const t=this.multiaddrs??[];return e.concat(t).map((e=>this.peerId?e.encapsulate("/p2p/"+this.peerId.toString()):e))}get peerInfo(){const e=this.peerId;if(e)return{id:e,multiaddrs:this.getAllLocationMultiaddrs()}}getFullMultiaddr(e){if(this.peerId){const t=this.getLocationMultiaddr(e);if(t)return t.encapsulate("/p2p/"+this.peerId.toString())}}getFullMultiaddrs(){if(this.peerId&&this.multiaddrs){const e=this.peerId;return this.multiaddrs.map((t=>t.encapsulate("/p2p/"+e.toString())))}return[]}verify(e,t){if(!this.get("id")||"v4"!==this.id)throw Error(Rw);if(!this.publicKey)throw Error("Failed to verify ENR: No public key");return jv(t,zv(e),this.publicKey)}async sign(e,t){if("v4"!==this.id)throw Error(Rw);return this.signature=await async function(e,t){return Rv(zv(t),e,{der:!1})}(t,e),this.signature}}let GE=!1,WE=!1;const XE={debug:1,default:2,info:2,warning:3,error:4,off:5};let ZE=XE.default,YE=null;const QE=function(){try{const e=[];if(["NFD","NFC","NFKD","NFKC"].forEach((t=>{try{if("test"!=="test".normalize(t))throw Error("bad normalize")}catch(r){e.push(t)}})),e.length)throw Error("missing "+e.join(", "));0}catch(e){return e.message}return null}();var JE,eS;(e=>{e.DEBUG="DEBUG",e.INFO="INFO",e.WARNING="WARNING",e.ERROR="ERROR",e.OFF="OFF"})(JE||(JE={})),(e=>{e.UNKNOWN_ERROR="UNKNOWN_ERROR",e.NOT_IMPLEMENTED="NOT_IMPLEMENTED",e.UNSUPPORTED_OPERATION="UNSUPPORTED_OPERATION",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.TIMEOUT="TIMEOUT",e.BUFFER_OVERRUN="BUFFER_OVERRUN",e.NUMERIC_FAULT="NUMERIC_FAULT",e.MISSING_NEW="MISSING_NEW",e.INVALID_ARGUMENT="INVALID_ARGUMENT",e.MISSING_ARGUMENT="MISSING_ARGUMENT",e.UNEXPECTED_ARGUMENT="UNEXPECTED_ARGUMENT",e.CALL_EXCEPTION="CALL_EXCEPTION",e.INSUFFICIENT_FUNDS="INSUFFICIENT_FUNDS",e.NONCE_EXPIRED="NONCE_EXPIRED",e.REPLACEMENT_UNDERPRICED="REPLACEMENT_UNDERPRICED",e.UNPREDICTABLE_GAS_LIMIT="UNPREDICTABLE_GAS_LIMIT",e.TRANSACTION_REPLACED="TRANSACTION_REPLACED",e.ACTION_REJECTED="ACTION_REJECTED"})(eS||(eS={}));const tS="0123456789abcdef";class rS{constructor(e){Object.defineProperty(this,"version",{enumerable:!0,value:e,writable:!1})}_log(e,t){const r=e.toLowerCase();null==XE[r]&&this.throwArgumentError("invalid log level name","logLevel",e)}debug(...e){this._log(rS.levels.DEBUG,e)}info(...e){this._log(rS.levels.INFO,e)}warn(...e){this._log(rS.levels.WARNING,e)}makeError(e,t,r){if(WE)return this.makeError("censored error",t,{});t||(t=rS.errors.UNKNOWN_ERROR),r||(r={});const n=[];Object.keys(r).forEach((e=>{const t=r[e];try{if(t instanceof Uint8Array){let r="";for(let e=0;e<t.length;e++)r+=tS[t[e]>>4],r+=tS[15&t[e]];n.push(e+"=Uint8Array(0x"+r+")")}else n.push(e+"="+JSON.stringify(t))}catch(t){n.push(e+"="+JSON.stringify(r[e].toString()))}})),n.push("code="+t),n.push("version="+this.version);const s=e;let i="";switch(t){case eS.NUMERIC_FAULT:{i="NUMERIC_FAULT";const t=e;switch(t){case"overflow":case"underflow":case"division-by-zero":i+="-"+t;break;case"negative-power":case"negative-width":i+="-unsupported";break;case"unbound-bitwise-result":i+="-unbound-result"}break}case eS.CALL_EXCEPTION:case eS.INSUFFICIENT_FUNDS:case eS.MISSING_NEW:case eS.NONCE_EXPIRED:case eS.REPLACEMENT_UNDERPRICED:case eS.TRANSACTION_REPLACED:case eS.UNPREDICTABLE_GAS_LIMIT:i=t}i&&(e+=" [ See: https://links.ethers.org/v5-errors-"+i+" ]"),n.length&&(e+=" ("+n.join(", ")+")");const o=Error(e);return o.reason=s,o.code=t,Object.keys(r).forEach((e=>{o[e]=r[e]})),o}throwError(e,t,r){throw this.makeError(e,t,r)}throwArgumentError(e,t,r){return this.throwError(e,rS.errors.INVALID_ARGUMENT,{argument:t,value:r})}assert(e,t,r,n){e||this.throwError(t,r,n)}assertArgument(e,t,r,n){e||this.throwArgumentError(t,r,n)}checkNormalize(e){QE&&this.throwError("platform missing String.prototype.normalize",rS.errors.UNSUPPORTED_OPERATION,{operation:"String.prototype.normalize",form:QE})}checkSafeUint53(e,t){"number"==typeof e&&(null==t&&(t="value not safe"),(e<0||e>=9007199254740991)&&this.throwError(t,rS.errors.NUMERIC_FAULT,{operation:"checkSafeInteger",fault:"out-of-safe-range",value:e}),e%1&&this.throwError(t,rS.errors.NUMERIC_FAULT,{operation:"checkSafeInteger",fault:"non-integer",value:e}))}checkArgumentCount(e,t,r){r=r?": "+r:"",e<t&&this.throwError("missing argument"+r,rS.errors.MISSING_ARGUMENT,{count:e,expectedCount:t}),e>t&&this.throwError("too many arguments"+r,rS.errors.UNEXPECTED_ARGUMENT,{count:e,expectedCount:t})}checkNew(e,t){e!==Object&&null!=e||this.throwError("missing new",rS.errors.MISSING_NEW,{name:t.name})}checkAbstract(e,t){e===t?this.throwError("cannot instantiate abstract class "+JSON.stringify(t.name)+" directly; use a sub-class",rS.errors.UNSUPPORTED_OPERATION,{name:e.name,operation:"new"}):e!==Object&&null!=e||this.throwError("missing new",rS.errors.MISSING_NEW,{name:t.name})}static globalLogger(){return YE||(YE=new rS("logger/5.8.0")),YE}static setCensorship(e,t){if(!e&&t&&this.globalLogger().throwError("cannot permanently disable censorship",rS.errors.UNSUPPORTED_OPERATION,{operation:"setCensorship"}),GE){if(!e)return;this.globalLogger().throwError("error censorship permanent",rS.errors.UNSUPPORTED_OPERATION,{operation:"setCensorship"})}WE=!!e,GE=!!t}static setLogLevel(e){const t=XE[e.toLowerCase()];null!=t?ZE=t:rS.globalLogger().warn("invalid log level - "+e)}static from(e){return new rS(e)}}rS.errors=eS,rS.levels=JE;const nS=new rS("bytes/5.8.0");function sS(e){return!!e.toHexString}function iS(e){return e.slice||(e.slice=function(){const t=[].slice.call(arguments);return iS(new Uint8Array([].slice.apply(e,t)))}),e}function oS(e){return"number"==typeof e&&e==e&&e%1==0}function aS(e){if(null==e)return!1;if(e.constructor===Uint8Array)return!0;if("string"==typeof e)return!1;if(!oS(e.length)||e.length<0)return!1;for(let t=0;t<e.length;t++){const r=e[t];if(!oS(r)||r<0||r>=256)return!1}return!0}function cS(e,t){if(t||(t={}),"number"==typeof e){nS.checkSafeUint53(e,"invalid arrayify value");const t=[];for(;e;)t.unshift(255&e),e=parseInt(e/256+"");return 0===t.length&&t.push(0),iS(new Uint8Array(t))}if(t.allowMissingPrefix&&"string"==typeof e&&"0x"!==e.substring(0,2)&&(e="0x"+e),sS(e)&&(e=e.toHexString()),lS(e)){let r=e.substring(2);r.length%2&&("left"===t.hexPad?r="0"+r:"right"===t.hexPad?r+="0":nS.throwArgumentError("hex data is odd-length","value",e));const n=[];for(let e=0;e<r.length;e+=2)n.push(parseInt(r.substring(e,e+2),16));return iS(new Uint8Array(n))}return aS(e)?iS(new Uint8Array(e)):nS.throwArgumentError("invalid arrayify value","value",e)}function lS(e){return!("string"!=typeof e||!e.match(/^0x[0-9A-Fa-f]*$/))}const uS="0123456789abcdef";function hS(e,t){if(t||(t={}),"number"==typeof e){nS.checkSafeUint53(e,"invalid hexlify value");let t="";for(;e;)t=uS[15&e]+t,e=Math.floor(e/16);return t.length?(t.length%2&&(t="0"+t),"0x"+t):"0x00"}if("bigint"==typeof e)return(e=e.toString(16)).length%2?"0x0"+e:"0x"+e;if(t.allowMissingPrefix&&"string"==typeof e&&"0x"!==e.substring(0,2)&&(e="0x"+e),sS(e))return e.toHexString();if(lS(e))return e.length%2&&("left"===t.hexPad?e="0x0"+e.substring(2):"right"===t.hexPad?e+="0":nS.throwArgumentError("hex data is odd-length","value",e)),e.toLowerCase();if(aS(e)){let t="0x";for(let r=0;r<e.length;r++){let n=e[r];t+=uS[(240&n)>>4]+uS[15&n]}return t}return nS.throwArgumentError("invalid hexlify value","value",e)}const dS=new rS("rlp/5.8.0");function pS(e){const t=[];for(;e;)t.unshift(255&e),e>>=8;return t}function fS(e,t,r){let n=0;for(let s=0;s<r;s++)n=256*n+e[t+s];return n}function gS(e){if(Array.isArray(e)){let t=[];if(e.forEach((e=>{t=t.concat(gS(e))})),t.length<=55)return t.unshift(192+t.length),t;const r=pS(t.length);return r.unshift(247+r.length),r.concat(t)}var t;lS(t=e)&&!(t.length%2)||aS(t)||dS.throwArgumentError("RLP object must be BytesLike","object",e);const r=[].slice.call(cS(e));if(1===r.length&&r[0]<=127)return r;if(r.length<=55)return r.unshift(128+r.length),r;const n=pS(r.length);return n.unshift(183+n.length),n.concat(r)}function mS(e,t,r,n){const s=[];for(;r<t+1+n;){const i=yS(e,r);s.push(i.result),(r+=i.consumed)>t+1+n&&dS.throwError("child data too short",rS.errors.BUFFER_OVERRUN,{})}return{consumed:1+n,result:s}}function yS(e,t){if(0===e.length&&dS.throwError("data too short",rS.errors.BUFFER_OVERRUN,{}),e[t]>=248){const r=e[t]-247;t+1+r>e.length&&dS.throwError("data short segment too short",rS.errors.BUFFER_OVERRUN,{});const n=fS(e,t+1,r);return t+1+r+n>e.length&&dS.throwError("data long segment too short",rS.errors.BUFFER_OVERRUN,{}),mS(e,t,t+1+r,r+n)}if(e[t]>=192){const r=e[t]-192;return t+1+r>e.length&&dS.throwError("data array too short",rS.errors.BUFFER_OVERRUN,{}),mS(e,t,t+1,r)}if(e[t]>=184){const r=e[t]-183;t+1+r>e.length&&dS.throwError("data array too short",rS.errors.BUFFER_OVERRUN,{});const n=fS(e,t+1,r);t+1+r+n>e.length&&dS.throwError("data array too short",rS.errors.BUFFER_OVERRUN,{});return{consumed:1+r+n,result:hS(e.slice(t+1+r,t+1+r+n))}}if(e[t]>=128){const r=e[t]-128;t+1+r>e.length&&dS.throwError("data too short",rS.errors.BUFFER_OVERRUN,{});return{consumed:1+r,result:hS(e.slice(t+1,t+1+r))}}return{consumed:1,result:hS(e[t])}}const bS=new vs("enr:decoder");class wS{static fromString(e){if(!e.startsWith(HE.RECORD_PREFIX))throw Error(`"string encoded ENR must start with '${HE.RECORD_PREFIX}'`);return wS.fromRLP(tt(e.slice(4),"base64url"))}static fromRLP(e){return async function(e){const{signature:t,seq:r,kvs:n}=function(e){if(!Array.isArray(e))throw Error("Decoded ENR must be an array");if(e.length%2!=0)throw Error("Decoded ENR must have an even number of elements");const[t,r,...n]=e;if(!t||Array.isArray(t))throw Error("Decoded ENR invalid signature: must be a byte array");if(!r||Array.isArray(r))throw Error("Decoded ENR invalid sequence number: must be a byte array");return{signature:t,seq:r,kvs:n}}(e),s={};for(let e=0;e<n.length;e+=2)try{s[hn(n[e])]=n[e+1]}catch(t){bS.error("Failed to decode ENR key to UTF-8, skipping it",n[e],t)}const i=function(e){return e.length?BigInt("0x"+un(e)):BigInt(0)}(r),o=HE.create(s,i,t);return function(e,t,r,n){const s=cn((i=[e,...t],hS(gS(i))));var i;if(!r.verify(s,n))throw Error("Unable to verify ENR signature")}(r,n,o,t),o}(function(e){const t=cS(e),r=yS(t,0);return r.consumed!==t.length&&dS.throwArgumentError("invalid rlp data","data",e),r.result}(e).map(cn))}}class vS extends Map{#N=0;#O=new Map;#U=new Map;#F;#B;#q;constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if("number"==typeof e.maxAge&&0===e.maxAge)throw new TypeError("`maxAge` must be a number greater than 0");this.#F=e.maxSize,this.#B=e.maxAge||1/0,this.#q=e.onEviction}get __oldCache(){return this.#U}#$(e){if("function"==typeof this.#q)for(const[t,r]of e)this.#q(t,r.value)}#z(e,t){return"number"==typeof t.expiry&&t.expiry<=Date.now()&&("function"==typeof this.#q&&this.#q(e,t.value),this.delete(e))}#j(e,t){if(!1===this.#z(e,t))return t.value}#V(e,t){return t.expiry?this.#j(e,t):t.value}#K(e,t){const r=t.get(e);return this.#V(e,r)}#H(e,t){this.#O.set(e,t),this.#N++,this.#N>=this.#F&&(this.#N=0,this.#$(this.#U),this.#U=this.#O,this.#O=new Map)}#G(e,t){this.#U.delete(e),this.#H(e,t)}*#W(){for(const e of this.#U){const[t,r]=e;if(!this.#O.has(t)){!1===this.#z(t,r)&&(yield e)}}for(const e of this.#O){const[t,r]=e;!1===this.#z(t,r)&&(yield e)}}get(e){if(this.#O.has(e)){const t=this.#O.get(e);return this.#V(e,t)}if(this.#U.has(e)){const t=this.#U.get(e);if(!1===this.#z(e,t))return this.#G(e,t),t.value}}set(e,t,{maxAge:r=this.#B}={}){const n="number"==typeof r&&r!==1/0?Date.now()+r:void 0;return this.#O.has(e)?this.#O.set(e,{value:t,expiry:n}):this.#H(e,{value:t,expiry:n}),this}has(e){return this.#O.has(e)?!this.#z(e,this.#O.get(e)):!!this.#U.has(e)&&!this.#z(e,this.#U.get(e))}peek(e){return this.#O.has(e)?this.#K(e,this.#O):this.#U.has(e)?this.#K(e,this.#U):void 0}expiresIn(e){const t=this.#O.get(e)??this.#U.get(e);if(t)return t.expiry?t.expiry-Date.now():1/0}delete(e){const t=this.#O.delete(e);return t&&this.#N--,this.#U.delete(e)||t}clear(){this.#O.clear(),this.#U.clear(),this.#N=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this.#W()],r=t.length-e;r<0?(this.#O=new Map(t),this.#U=new Map,this.#N=t.length):(r>0&&this.#$(t.slice(0,r)),this.#U=new Map(t.slice(r)),this.#O=new Map,this.#N=0),this.#F=e}evict(e=1){const t=Number(e);if(!t||t<=0)return;const r=[...this.#W()],n=Math.trunc(Math.min(t,Math.max(r.length-1,0)));n<=0||(this.#$(r.slice(0,n)),this.#U=new Map(r.slice(n)),this.#O=new Map,this.#N=0)}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.#O){const[t,r]=e;!1===this.#z(t,r)&&(yield[t,r.value])}for(const e of this.#U){const[t,r]=e;if(!this.#O.has(t)){!1===this.#z(t,r)&&(yield[t,r.value])}}}*entriesDescending(){let e=[...this.#O];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;!1===this.#z(n,s)&&(yield[n,s.value])}e=[...this.#U];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;if(!this.#O.has(n)){!1===this.#z(n,s)&&(yield[n,s.value])}}}*entriesAscending(){for(const[e,t]of this.#W())yield[e,t.value]}get size(){if(!this.#N)return this.#U.size;let e=0;for(const t of this.#U.keys())this.#O.has(t)||e++;return Math.min(this.#N+e,this.#F)}get maxSize(){return this.#F}get maxAge(){return this.#B}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,n]of this.entriesAscending())e.call(t,n,r,this)}get[Symbol.toStringTag](){return"QuickLRU"}toString(){return`QuickLRU(${this.size}/${this.maxSize})`}[Symbol.for("nodejs.util.inspect.custom")](){return this.toString()}}function ES(e,t,r){return`${e}?name=${t}&type=${r}`}async function SS(e,t){const r=await fetch(e,{headers:new Headers({accept:"application/dns-json"}),signal:t});return await r.json()}function AS(e,t){return`${t}_${e}`}const IS=Object.assign(em("dns-over-http-resolver"),{error:em("dns-over-http-resolver:error")});class _S{_cache;_TXTcache;_servers;_request;_abortControllers;constructor(e={}){this._cache=new vS({maxSize:e?.maxCache??100}),this._TXTcache=new vS({maxSize:e?.maxCache??100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=e.request??SS,this._abortControllers=[]}cancel(){this._abortControllers.forEach((e=>{e.abort()}))}getServers(){return this._servers}_getShuffledServers(){const e=[...this._servers];for(let t=e.length-1;t>0;t--){const r=Math.floor(Math.random()*t),n=e[t];e[t]=e[r],e[r]=n}return e}setServers(e){this._servers=e}async resolve(e,t="A"){switch(t){case"A":return this.resolve4(e);case"AAAA":return this.resolve6(e);case"TXT":return this.resolveTxt(e);default:throw Error(t+" is not supported")}}async resolve4(e){const t="A",r=this._cache.get(AS(e,t));if(null!=r)return r;let n=!1;for(const r of this._getShuffledServers()){const s=new AbortController;this._abortControllers.push(s);try{const n=await this._request(ES(r,e,t),s.signal),i=n.Answer.map((e=>e.data)),o=Math.min(...n.Answer.map((e=>e.TTL)));return this._cache.set(AS(e,t),i,{maxAge:o}),i}catch(i){s.signal.aborted&&(n=!0),IS.error(`${r} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter((e=>e!==s))}}if(n)throw Object.assign(Error("queryA ECANCELLED"),{code:"ECANCELLED"});throw Error(`Could not resolve ${e} record ${t}`)}async resolve6(e){const t="AAAA",r=this._cache.get(AS(e,t));if(null!=r)return r;let n=!1;for(const r of this._getShuffledServers()){const s=new AbortController;this._abortControllers.push(s);try{const n=await this._request(ES(r,e,t),s.signal),i=n.Answer.map((e=>e.data)),o=Math.min(...n.Answer.map((e=>e.TTL)));return this._cache.set(AS(e,t),i,{maxAge:o}),i}catch(i){s.signal.aborted&&(n=!0),IS.error(`${r} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter((e=>e!==s))}}if(n)throw Object.assign(Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"});throw Error(`Could not resolve ${e} record ${t}`)}async resolveTxt(e){const t="TXT",r=this._TXTcache.get(AS(e,t));if(null!=r)return r;let n=!1;for(const r of this._getShuffledServers()){const s=new AbortController;this._abortControllers.push(s);try{const n=await this._request(ES(r,e,t),s.signal),i=n.Answer.map((e=>[e.data.replace(/['"]+/g,"")])),o=Math.min(...n.Answer.map((e=>e.TTL)));return this._TXTcache.set(AS(e,t),i,{maxAge:o}),i}catch(i){s.signal.aborted&&(n=!0),IS.error(`${r} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter((e=>e!==s))}}if(n)throw Object.assign(Error("queryTxt ECANCELLED"),{code:"ECANCELLED"});throw Error(`Could not resolve ${e} record ${t}`)}clearCache(){this._cache.clear(),this._TXTcache.clear()}}const CS=new vs("dns-over-https");class xS{resolver;static async create(){return new xS}constructor(e=new _S){this.resolver=e}async resolveTXT(e){let t;try{t=await this.resolver.resolveTxt(e)}catch(e){throw CS.error("query failed: ",e),Error("DNS query failed")}if(!t)throw Error("Could not resolve "+e);const r=[];return t.forEach((e=>{"string"==typeof e?r.push(e):Array.isArray(e)?e.forEach((e=>{"string"==typeof e?r.push(e):r.push(hn(e))})):r.push(hn(e))})),r}}var kS,TS={exports:{}};var PS=(kS||(kS=1,(e=>{(()=>{var t="object"==typeof window?window:{};!t.HI_BASE32_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node&&(t=cs);var r=!t.HI_BASE32_NO_COMMON_JS&&e.exports,n="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567".split(""),s={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,2:26,3:27,4:28,5:29,6:30,7:31},i=[0,0,0,0,0,0,0,0],o=(e,t)=>{t.length>10&&(t="..."+t.substr(-10));var r=Error("Decoded data is not valid UTF-8. Maybe try base32.decode.asBytes()? Partial data after reading "+e+" bytes: "+t+" <-");throw r.position=e,r},a=e=>{if(""===e)return[];if(!/^[A-Z2-7=]+$/.test(e))throw Error("Invalid base32 characters");for(var t,r,n,i,o,a,c,l,u=[],h=0,d=(e=e.replace(/=/g,"")).length,p=0,f=d>>3<<3;p<f;)t=s[e.charAt(p++)],r=s[e.charAt(p++)],n=s[e.charAt(p++)],i=s[e.charAt(p++)],o=s[e.charAt(p++)],a=s[e.charAt(p++)],c=s[e.charAt(p++)],l=s[e.charAt(p++)],u[h++]=255&(t<<3|r>>>2),u[h++]=255&(r<<6|n<<1|i>>>4),u[h++]=255&(i<<4|o>>>1),u[h++]=255&(o<<7|a<<2|c>>>3),u[h++]=255&(c<<5|l);var g=d-f;return 2===g?(t=s[e.charAt(p++)],r=s[e.charAt(p++)],u[h++]=255&(t<<3|r>>>2)):4===g?(t=s[e.charAt(p++)],r=s[e.charAt(p++)],n=s[e.charAt(p++)],i=s[e.charAt(p++)],u[h++]=255&(t<<3|r>>>2),u[h++]=255&(r<<6|n<<1|i>>>4)):5===g?(t=s[e.charAt(p++)],r=s[e.charAt(p++)],n=s[e.charAt(p++)],i=s[e.charAt(p++)],o=s[e.charAt(p++)],u[h++]=255&(t<<3|r>>>2),u[h++]=255&(r<<6|n<<1|i>>>4),u[h++]=255&(i<<4|o>>>1)):7===g&&(t=s[e.charAt(p++)],r=s[e.charAt(p++)],n=s[e.charAt(p++)],i=s[e.charAt(p++)],o=s[e.charAt(p++)],a=s[e.charAt(p++)],c=s[e.charAt(p++)],u[h++]=255&(t<<3|r>>>2),u[h++]=255&(r<<6|n<<1|i>>>4),u[h++]=255&(i<<4|o>>>1),u[h++]=255&(o<<7|a<<2|c>>>3)),u},c=(e,t)=>{if(!t)return(e=>{for(var t,r,n="",s=e.length,i=0,a=0;i<s;)if((t=e[i++])<=127)n+=String.fromCharCode(t);else{t>191&&t<=223?(r=31&t,a=1):t<=239?(r=15&t,a=2):t<=247?(r=7&t,a=3):o(i,n);for(var c=0;c<a;++c)((t=e[i++])<128||t>191)&&o(i,n),r<<=6,r+=63&t;r>=55296&&r<=57343&&o(i,n),r>1114111&&o(i,n),r<=65535?n+=String.fromCharCode(r):(n+=String.fromCharCode(55296+((r-=65536)>>10)),n+=String.fromCharCode(56320+(1023&r)))}return n})(a(e));if(""===e)return"";if(!/^[A-Z2-7=]+$/.test(e))throw Error("Invalid base32 characters");var r,n,i,c,l,u,h,d,p="",f=e.indexOf("=");-1===f&&(f=e.length);for(var g=0,m=f>>3<<3;g<m;)r=s[e.charAt(g++)],n=s[e.charAt(g++)],i=s[e.charAt(g++)],c=s[e.charAt(g++)],l=s[e.charAt(g++)],u=s[e.charAt(g++)],h=s[e.charAt(g++)],d=s[e.charAt(g++)],p+=String.fromCharCode(255&(r<<3|n>>>2))+String.fromCharCode(255&(n<<6|i<<1|c>>>4))+String.fromCharCode(255&(c<<4|l>>>1))+String.fromCharCode(255&(l<<7|u<<2|h>>>3))+String.fromCharCode(255&(h<<5|d));var y=f-m;return 2===y?(r=s[e.charAt(g++)],n=s[e.charAt(g++)],p+=String.fromCharCode(255&(r<<3|n>>>2))):4===y?(r=s[e.charAt(g++)],n=s[e.charAt(g++)],i=s[e.charAt(g++)],c=s[e.charAt(g++)],p+=String.fromCharCode(255&(r<<3|n>>>2))+String.fromCharCode(255&(n<<6|i<<1|c>>>4))):5===y?(r=s[e.charAt(g++)],n=s[e.charAt(g++)],i=s[e.charAt(g++)],c=s[e.charAt(g++)],l=s[e.charAt(g++)],p+=String.fromCharCode(255&(r<<3|n>>>2))+String.fromCharCode(255&(n<<6|i<<1|c>>>4))+String.fromCharCode(255&(c<<4|l>>>1))):7===y&&(r=s[e.charAt(g++)],n=s[e.charAt(g++)],i=s[e.charAt(g++)],c=s[e.charAt(g++)],l=s[e.charAt(g++)],u=s[e.charAt(g++)],h=s[e.charAt(g++)],p+=String.fromCharCode(255&(r<<3|n>>>2))+String.fromCharCode(255&(n<<6|i<<1|c>>>4))+String.fromCharCode(255&(c<<4|l>>>1))+String.fromCharCode(255&(l<<7|u<<2|h>>>3))),p},l={encode(e,t){var r="string"!=typeof e;return r&&e.constructor===ArrayBuffer&&(e=new Uint8Array(e)),r?(e=>{for(var t,r,s,i,o,a="",c=e.length,l=0,u=5*parseInt(c/5);l<u;)t=e[l++],r=e[l++],s=e[l++],i=e[l++],o=e[l++],a+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[31&(r<<4|s>>>4)]+n[31&(s<<1|i>>>7)]+n[i>>>2&31]+n[31&(i<<3|o>>>5)]+n[31&o];var h=c-u;return 1===h?(t=e[l],a+=n[t>>>3]+n[t<<2&31]+"======"):2===h?(t=e[l++],r=e[l],a+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[r<<4&31]+"===="):3===h?(t=e[l++],r=e[l++],s=e[l],a+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[31&(r<<4|s>>>4)]+n[s<<1&31]+"==="):4===h&&(t=e[l++],r=e[l++],s=e[l++],i=e[l],a+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[31&(r<<4|s>>>4)]+n[31&(s<<1|i>>>7)]+n[i>>>2&31]+n[i<<3&31]+"="),a})(e):t?(e=>{for(var t,r,s,i,o,a="",c=e.length,l=0,u=5*parseInt(c/5);l<u;)t=e.charCodeAt(l++),r=e.charCodeAt(l++),s=e.charCodeAt(l++),i=e.charCodeAt(l++),o=e.charCodeAt(l++),a+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[31&(r<<4|s>>>4)]+n[31&(s<<1|i>>>7)]+n[i>>>2&31]+n[31&(i<<3|o>>>5)]+n[31&o];var h=c-u;return 1===h?(t=e.charCodeAt(l),a+=n[t>>>3]+n[t<<2&31]+"======"):2===h?(t=e.charCodeAt(l++),r=e.charCodeAt(l),a+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[r<<4&31]+"===="):3===h?(t=e.charCodeAt(l++),r=e.charCodeAt(l++),s=e.charCodeAt(l),a+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[31&(r<<4|s>>>4)]+n[s<<1&31]+"==="):4===h&&(t=e.charCodeAt(l++),r=e.charCodeAt(l++),s=e.charCodeAt(l++),i=e.charCodeAt(l),a+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[31&(r<<4|s>>>4)]+n[31&(s<<1|i>>>7)]+n[i>>>2&31]+n[i<<3&31]+"="),a})(e):(e=>{var t,r,s,o,a,c,l,u=!1,h="",d=0,p=0,f=e.length;if(""===e)return h;do{for(i[0]=i[5],i[1]=i[6],i[2]=i[7],l=p;d<f&&l<5;++d)(c=e.charCodeAt(d))<128?i[l++]=c:c<2048?(i[l++]=192|c>>6,i[l++]=128|63&c):c<55296||c>=57344?(i[l++]=224|c>>12,i[l++]=128|c>>6&63,i[l++]=128|63&c):(c=65536+((1023&c)<<10|1023&e.charCodeAt(++d)),i[l++]=240|c>>18,i[l++]=128|c>>12&63,i[l++]=128|c>>6&63,i[l++]=128|63&c);p=l-5,d===f&&++d,d>f&&l<6&&(u=!0),t=i[0],l>4?(r=i[1],s=i[2],o=i[3],a=i[4],h+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[31&(r<<4|s>>>4)]+n[31&(s<<1|o>>>7)]+n[o>>>2&31]+n[31&(o<<3|a>>>5)]+n[31&a]):1===l?h+=n[t>>>3]+n[t<<2&31]+"======":2===l?(r=i[1],h+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[r<<4&31]+"===="):3===l?(r=i[1],s=i[2],h+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[31&(r<<4|s>>>4)]+n[s<<1&31]+"==="):(r=i[1],s=i[2],o=i[3],h+=n[t>>>3]+n[31&(t<<2|r>>>6)]+n[r>>>1&31]+n[31&(r<<4|s>>>4)]+n[31&(s<<1|o>>>7)]+n[o>>>2&31]+n[o<<3&31]+"=")}while(!u);return h})(e)},decode:c};c.asBytes=a,r?e.exports=l:t.base32=l})()})(TS)),TS.exports),RS=ls(PS);class LS{static RECORD_PREFIX=HE.RECORD_PREFIX;static TREE_PREFIX="enrtree:";static BRANCH_PREFIX="enrtree-branch:";static ROOT_PREFIX="enrtree-root:";static parseAndVerifyRoot(e,t){if(!e.startsWith(this.ROOT_PREFIX))throw Error(`ENRTree root entry must start with '${this.ROOT_PREFIX}'`);const r=LS.parseRootValues(e),n=RS.decode.asBytes(t),s=e.split(" sig")[0],i=dn(s);if(!jv(tt(r.signature,"base64url").slice(0,64),zv(i),new Uint8Array(n)))throw Error("Unable to verify ENRTree root signature");return r.eRoot}static parseRootValues(e){const t=e.match(/^enrtree-root:v1 e=([^ ]+) l=([^ ]+) seq=(\d+) sig=([^ ]+)$/);if(!Array.isArray(t))throw Error("Could not parse ENRTree root entry");t.shift();const[r,n,s,i]=t;if(!r)throw Error("Could not parse 'e' value from ENRTree root entry");if(!n)throw Error("Could not parse 'l' value from ENRTree root entry");if(!s)throw Error("Could not parse 'seq' value from ENRTree root entry");if(!i)throw Error("Could not parse 'sig' value from ENRTree root entry");return{eRoot:r,lRoot:n,seq:Number(s),signature:i}}static parseTree(e){if(!e.startsWith(this.TREE_PREFIX))throw Error(`ENRTree tree entry must start with '${this.TREE_PREFIX}'`);const t=e.match(/^enrtree:\/\/([^@]+)@(.+)$/);if(!Array.isArray(t))throw Error("Could not parse ENRTree tree entry");t.shift();const[r,n]=t;if(!r)throw Error("Could not parse public key from ENRTree tree entry");if(!n)throw Error("Could not parse domain from ENRTree tree entry");return{publicKey:r,domain:n}}static parseBranch(e){if(!e.startsWith(this.BRANCH_PREFIX))throw Error(`ENRTree branch entry must start with '${this.BRANCH_PREFIX}'`);return e.split(this.BRANCH_PREFIX)[1].split(",")}}const DS=new vs("discovery:fetch_nodes");async function*MS(e,t=10,r=3){const n=new Set;let s=0,i=0;for(;s<t&&i<r;){s++;const t=await e();t&&t.nodeId?n.has(t.nodeId)||(n.add(t.nodeId),t.waku2&&(yield t),DS.info(`got new peer candidate from DNS address=${t.nodeId}@${t.ip}`)):i++}}const NS=new vs("discovery:dns");class OS{dns;_DNSTreeCache;static async dnsOverHttp(e){return e||(e=await xS.create()),new OS(e)}constructor(e){this._DNSTreeCache={},this.dns=e}async*getNextPeer(e){for(const t of function(e){if(e.length<=1)return e;for(let t=0;t<e.length;t++){const r=Math.floor(Math.random()*Math.floor(e.length)),n=e[t];e[t]=e[r],e[r]=n}return e}(e)){const{publicKey:e,domain:r}=LS.parseTree(t),n={domain:r,publicKey:e,visits:{}};for await(const e of MS((()=>this._search(r,n))))yield e}}async _search(e,t){try{const r=await this._getTXTRecord(e,t);let n,s;t.visits[e]=!0;const i=function(e){return e.startsWith(LS.ROOT_PREFIX)?LS.ROOT_PREFIX:e.startsWith(LS.BRANCH_PREFIX)?LS.BRANCH_PREFIX:e.startsWith(LS.RECORD_PREFIX)?LS.RECORD_PREFIX:""}(r);try{switch(i){case LS.ROOT_PREFIX:return n=LS.parseAndVerifyRoot(r,t.publicKey),await this._search(n,t);case LS.BRANCH_PREFIX:return s=LS.parseBranch(r),n=function(e,t){const r={};for(const[n,s]of e.entries())t.visits[s]&&(r[n]=!0);if(Object.keys(r).length===e.length)throw Error("Unresolvable circular path detected");let n;do{n=Math.floor(Math.random()*e.length)}while(r[n]);return e[n]}(s,t),await this._search(n,t);case LS.RECORD_PREFIX:return wS.fromString(r);default:return null}}catch(t){return NS.error(`Failed to search DNS tree ${i} at subdomain ${e}: ${t}`),null}}catch(t){return NS.error(`Failed to retrieve TXT record at subdomain ${e}: ${t}`),null}}async _getTXTRecord(e,t){if(this._DNSTreeCache[e])return this._DNSTreeCache[e];const r=e!==t.domain?`${e}.${t.domain}`:t.domain,n=await this.dns.resolveTXT(r);if(!n.length)throw Error("Received empty result array while fetching TXT record");if(!n[0].length)throw Error("Received empty TXT record");const s=n.join("");return this._DNSTreeCache[e]=s,s}}const US=new vs("peer-discovery-dns");class FS extends ss{nextPeer;_started;_components;_options;constructor(e,t){super(),this._started=!1,this._components=e,this._options=t;const{enrUrls:r}=t;US.info("Use following EIP-1459 ENR Tree URLs: ",r)}async start(){US.info("Starting peer discovery via dns"),this._started=!0,await this.findPeers()}async findPeers(){if(!this.nextPeer){let{enrUrls:e}=this._options;Array.isArray(e)||(e=[e]);const t=await OS.dnsOverHttp();this.nextPeer=t.getNextPeer.bind(t,e)}for await(const e of this.nextPeer()){if(!this._started)return;const{peerInfo:t,shardInfo:r}=e;if(!t)continue;const n={[Pw]:{value:this._options.tagValue??50,ttl:this._options.tagTTL??1e8}};let s=!1;if(await this._components.peerStore.has(t.id)){(await this._components.peerStore.get(t.id)).tags.has(Pw)||(s=!0,await this._components.peerStore.merge(t.id,{tags:n}))}else s=!0,await this._components.peerStore.save(t.id,{tags:n,...r&&{metadata:{shardInfo:Sn(r)}}});s&&this.dispatchEvent(new CustomEvent("peer",{detail:t}))}}stop(){this._started=!1}get[_n](){return!0}get[Symbol.toStringTag](){return"@waku/bootstrap"}}const BS=Ns.PEER_EXCHANGE,qS="/vac/waku/peer-exchange/2.0.0-alpha1";class $S{proto;constructor(e){this.proto=e}static createRequest(e){const{numPeers:t}=e;return new $S({query:{numPeers:t},response:void 0})}encode(){return Kt.encode(this.proto)}static decode(e){const t=Kt.decode(e);return new $S(t)}get query(){return this.proto.query}get response(){return this.proto.response}}const zS=new vs("peer-exchange");class jS{components;streamManager;constructor(e){this.components=e,this.streamManager=new Ei(qS,e)}async query(e){const{numPeers:t,peerId:r}=e,n=$S.createRequest({numPeers:BigInt(t)});if(!await this.components.peerStore.has(r))return{peerInfos:null,error:Ds.NO_PEER_AVAILABLE};const s=await this.streamManager.getStream(r);if(!s)return zS.error("Failed to get a stream for remote peer:"+r?.toString?.()),{peerInfos:null,error:Ds.NO_STREAM_AVAILABLE};const i=await pi([n.encode()],Zu,s,Ju,(async e=>await Bs(e)));try{const e=new Ks;i.forEach((t=>{e.append(t)}));const{response:t}=$S.decode(e);if(!t)return zS.error("PeerExchangeRPC message did not contains a `response` field"),{peerInfos:null,error:Ds.EMPTY_PAYLOAD};return{peerInfos:await Promise.all(t.peerInfos.map((e=>e.enr)).filter(tr).map((async e=>({ENR:await wS.fromRLP(e)})))),error:null}}catch(e){return zS.error("Failed to decode push reply",e),{peerInfos:null,error:Ds.DECODE_FAILED}}}}const VS=new vs("peer-exchange-discovery");class KS extends ss{components;peerExchange;options;isStarted=!1;queryingPeers=new Set;peerExpirationRecords=new Map;continuousDiscoveryInterval=null;constructor(e,t={}){super(),this.components=e,this.peerExchange=new jS(e),this.options={...t,TTL:t.TTL??3e4},this.handleDiscoveredPeer=this.handleDiscoveredPeer.bind(this)}start(){this.isStarted||(VS.info("Starting peer exchange node discovery, discovering peers"),this.isStarted=!0,this.components.events.addEventListener("peer:identify",this.handleDiscoveredPeer),this.continuousDiscoveryInterval=setInterval((()=>{this.handlePeriodicDiscovery()}),this.options.TTL))}stop(){this.isStarted&&(VS.info("Stopping peer exchange node discovery"),this.isStarted=!1,this.queryingPeers.clear(),this.peerExpirationRecords.clear(),this.continuousDiscoveryInterval&&clearInterval(this.continuousDiscoveryInterval),this.components.events.removeEventListener("peer:identify",this.handleDiscoveredPeer))}get[_n](){return!0}get[Symbol.toStringTag](){return"@waku/peer-exchange"}async handleDiscoveredPeer(e){this.runQuery(e.detail.peerId,e.detail.protocols)}async handlePeriodicDiscovery(){const e=this.components.connectionManager.getConnections();await Promise.all(e.map((async e=>{try{const t=e.remotePeer.toString();if(!(!this.peerExpirationRecords.has(t)||this.peerExpirationRecords.get(t)<=Date.now()))return null;const r=await this.components.peerStore.get(e.remotePeer);return this.runQuery(e.remotePeer,r.protocols)}catch(e){return VS.warn("Error getting peer info",e),null}})))}async runQuery(e,t){if(t.includes(qS)&&!this.queryingPeers.has(e.toString())){try{this.queryingPeers.add(e.toString()),await this.query(e)}catch(e){VS.error("Error querying peer",e)}this.peerExpirationRecords.set(e.toString(),Date.now()+this.options.TTL),this.queryingPeers.delete(e.toString())}else VS.info(`Skipping peer ${e} as it is already querying or does not support peer exchange`)}async query(e){const t=e.toString();VS.info("Querying peer exchange for "+t);const{error:r,peerInfos:n}=await this.peerExchange.query({numPeers:60,peerId:e});if(r)VS.error(`Peer exchange query to ${t} failed`,r);else for(const{ENR:e}of n){if(!e){VS.warn(`No ENR in peerInfo object from ${t}, skipping`);continue}const{peerInfo:r,shardInfo:n}=e;if(!r){VS.warn(`No peerInfo in ENR from ${t}, skipping`);continue}const s=!await this.hasShardInfo(r.id)&&n?{metadata:{shardInfo:Sn(n)}}:void 0;await this.components.peerStore.merge(r.id,{tags:{[BS]:{value:50}},...s,...r.multiaddrs&&{multiaddrs:r.multiaddrs}}),VS.info("Discovered peer: "+r.id.toString()),this.dispatchEvent(new CustomEvent("peer",{detail:{id:r.id,multiaddrs:r.multiaddrs}}))}}async hasShardInfo(e){try{const t=await this.components.peerStore.get(e);return!!t&&t.metadata.has("shardInfo")}catch(t){VS.warn("Error getting shard info for "+e.toString(),t)}return!1}}const HS=Ns.PEER_CACHE,GS=e=>!!e&&"object"==typeof e&&"id"in e&&"string"==typeof e.id&&"multiaddrs"in e&&Array.isArray(e.multiaddrs);class WS{get(){return[]}set(e){}remove(){}}class XS{get(){try{const e=localStorage.getItem("waku:peers");return(e?JSON.parse(e):[]).filter(GS)}catch(e){return[]}}set(e){try{localStorage.setItem("waku:peers",JSON.stringify(e))}catch(e){}}remove(){try{localStorage.removeItem("waku:peers")}catch(e){}}}const ZS=new vs("peer-cache");class YS extends ss{components;isStarted=!1;cache;constructor(e,t){super(),this.components=e,this.cache=t?.cache??(()=>{try{if("undefined"!=typeof localStorage)return new XS}catch(e){}return new WS})()}get[Symbol.toStringTag](){return"@waku/"+HS}async start(){this.isStarted||(ZS.info("Starting Peer Cache Discovery"),this.components.events.addEventListener("peer:identify",this.handleDiscoveredPeer),await this.discoverPeers(),this.isStarted=!0)}stop(){this.isStarted&&(ZS.info("Stopping Peer Cache Discovery"),this.components.events.removeEventListener("peer:identify",this.handleDiscoveredPeer),this.isStarted=!1)}handleDiscoveredPeer=e=>{const{peerId:t,listenAddrs:r}=e.detail,n=r.map((e=>e.toString())),s=t.toString(),i=this.readPeerInfoFromCache(),o=i.findIndex((e=>e.id===s));-1!==o?i[o].multiaddrs=n:i.push({id:s,multiaddrs:n}),this.writePeerInfoToCache(i)};async discoverPeers(){const e=this.readPeerInfoFromCache();for(const t of e){const e=el(t.id),r=t.multiaddrs.map((e=>Hl(e)));await this.components.peerStore.has(e)||(await this.components.peerStore.save(e,{multiaddrs:r,tags:{[HS]:{value:50}}}),this.dispatchEvent(new CustomEvent("peer",{detail:{id:e,multiaddrs:r}})))}}readPeerInfoFromCache(){try{return this.cache.get()}catch(e){return ZS.error("Error parsing peers from cache:",e),[]}}writePeerInfoToCache(e){try{this.cache.set(e)}catch(e){ZS.error("Error saving peers to cache:",e)}}}function QS(e,t){const r=[kw,Tw],n=[];var s;return e?.dns&&n.push((s=r,e=>new FS(e,{enrUrls:s}))),(e?.peerCache||t)&&n.push(function(e={}){return t=>new YS(t,e)}({cache:t})),e?.peerExchange&&n.push(function(e={}){return t=>new KS(t,e)}()),n}const JS=new vs("sdk:create");async function eA(e,t,r){!t?.hideWebSocketInfo&&xw();return async function(e={}){e.privateKey??=await Kc();const t=new Cw({...await jg(e),peerId:(r=e.privateKey,tl(r.publicKey))});var r;return!1!==e.start&&await t.start(),t}({transports:[sg({filter:!1===t?.filterMultiaddrs||xw()?tg:rg})],streamMuxers:[Lf()],connectionEncrypters:[fd()],...t,services:{identify:sf({agentVersion:r??"js-waku"}),ping:Mf({maxInboundStreams:t?.pingMaxInboundStreams??10}),metadata:du(e),...t?.services}})}async function tA(e){const t=(e.networkConfig??Us).clusterId??1;JS.info("Creating Waku node with cluster id: ",t);const r=e?.libp2p??{},n=r.peerDiscovery??[];e?.defaultBootstrap?n.push(...QS({dns:!0,peerExchange:!0,peerCache:!0,...e.discovery},e.peerCache)):n.push(...QS(e.discovery,e.peerCache));const s=[...e.bootstrapPeers||[],...e.store?.peers||[]];var i;return s.length&&n.push((i={list:s},e=>new Gd(e,i))),r.peerDiscovery=n,eA(t,r,e?.userAgent)}var rA=0,nA={size:0,kind:17,base:null,node:null,finalizer:null},sA={size:0,kind:17,base:null,node:null,finalizer:null},iA={size:0,kind:17,base:null,node:null,finalizer:null},oA={size:0,kind:17,base:null,node:null,finalizer:null},aA={size:0,kind:17,base:null,node:null,finalizer:null},cA={size:0,kind:22,base:null,node:null,finalizer:null},lA={size:0,kind:28,base:null,node:null,finalizer:null},uA={size:0,kind:22,base:null,node:null,finalizer:null},hA={size:0,kind:17,base:null,node:null,finalizer:null},dA={size:0,kind:17,base:null,node:null,finalizer:null},pA={size:0,kind:17,base:null,node:null,finalizer:null},fA={size:0,kind:17,base:null,node:null,finalizer:null};fA.node={kind:2,len:0,offset:0,typ:null,name:null,sons:[]};pA.node={kind:2,len:0,offset:0,typ:null,name:null,sons:[]};dA.node={kind:2,len:0,offset:0,typ:null,name:null,sons:[]},uA.base=hA,cA.base=hA;var gA={kind:2,len:5,offset:0,typ:null,name:null,sons:[{kind:1,offset:"parent",len:0,typ:uA,name:"parent",sons:null},{kind:1,offset:"name",len:0,typ:{size:0,kind:29,base:null,node:null,finalizer:null},name:"name",sons:null},{kind:1,offset:"message",len:0,typ:lA,name:"msg",sons:null},{kind:1,offset:"trace",len:0,typ:lA,name:"trace",sons:null},{kind:1,offset:"up",len:0,typ:cA,name:"up",sons:null}]};hA.node=gA;aA.node={kind:2,len:0,offset:0,typ:null,name:null,sons:[]},hA.base=aA,dA.base=hA,pA.base=dA,fA.base=pA;oA.node={kind:2,len:0,offset:0,typ:null,name:null,sons:[]},oA.base=pA;iA.node={kind:2,len:0,offset:0,typ:null,name:null,sons:[]},iA.base=dA;sA.node={kind:2,len:0,offset:0,typ:null,name:null,sons:[]},sA.base=dA;function mA(e,t){throw e.name=t,0==rA&&function(e){var t=[[]];0!=e.message.length?(t[0].push.call(t[0],69,114,114,111,114,58,32,117,110,104,97,110,100,108,101,100,32,101,120,99,101,112,116,105,111,110,58,32),t[0].push.apply(t[0],e.message)):t[0].push.call(t[0],69,114,114,111,114,58,32,117,110,104,97,110,100,108,101,100,32,101,120,99,101,112,116,105,111,110);t[0].push.call(t[0],32,91),function(e,t,r){null===e[t]&&(e[t]=[]);var n=e[t].length;e[t].length+=r.length;for(var s=0;s<r.length;++s)e[t][n+s]=r.charCodeAt(s)}(t,0,e.name),t[0].push.call(t[0],93,10);var r=function(e){var t=DA(e.length),r=0,n=0;for(;r<e.length;){var s=e[r];if(s<128)t[n]=String.fromCharCode(s),r+=1;else{var i=DA(0);e:for(;;){var o=s.toString(16);if(1==(null==o?0:o.length)?i.push("%0"):i.push("%"),i.push(o),r+=1,e.length<=r||e[r]<128)break e;s=e[r]}++rA;try{t[n]=decodeURIComponent(i.join("")),--rA}catch(e){--rA,t[n]=i.join("")}}n+=1}if(t.length<n)for(var a=t.length;a<n;++a)t.push(null);else t.length=n;return t.join("")}(t[0]);throw void 0!==Error?Error(r):r}(e),e}function yA(e,t){return 0==t&&MA(),-1==t&&2147483647==e&&NA(),Math.trunc(e%t)}function bA(e){return e<0?-1*e:e}function wA(e,t){var r=e*t;return OA(r),r}function vA(e,t){var r=e-t;return OA(r),r}function EA(e,t){var r=e+t;return OA(r),r}function SA(e,t,r){var n=0;return t<=e&&e<=r?n=e:mA({message:[118,97,108,117,101,32,111,117,116,32,111,102,32,114,97,110,103,101],parent:null,m_type:iA,name:null,trace:[],up:null},"RangeDefect"),n}nA.node={kind:2,len:0,offset:0,typ:null,name:null,sons:[]},nA.base=dA;var AA,IA,_A,CA,xA,kA,TA,PA=function(){for(var e={},t=0;t<arguments.length;++t){var r=arguments[t];if("object"==typeof r)for(var n=r[0];n<=r[1];++n)e[n]=!0;else e[r]=!0}return e}(17,16,4,18,27,19,23,22,21);function RA(e,t,r){var n=null;switch(r.kind){case 21:case 22:case 23:case 5:n=function(e){var t=!1;t=!(null!=PA[e.base.kind]);return t}(r)?[t[0],t[1]]:t;break;case 19:if(null==e)e={};else for(var s in e)delete e[s];for(var s in t)e[s]=t[s];n=e;break;case 18:case 17:qA(n=null!=r.base?RA(e,t,r.base):17==r.kind?null==e?{m_type:r}:e:null==e?{}:e,t,r.node);break;case 4:case 16:if(ArrayBuffer.isView(t))null==e||e.length!=t.length?e=new t.constructor(t):e.set(t,0),n=e;else if(null===t)n=null;else{null!=e&&e.length==t.length||(e=Array(t.length)),n=e;for(var i=0;i<t.length;++i)n[i]=RA(n[i],t[i],r.base)}break;case 24:case 27:if(null===t)n=null;else{null!=e&&e.length==t.length||(e=Array(t.length)),n=e;for(i=0;i<t.length;++i)n[i]=RA(n[i],t[i],r.base)}break;case 28:null!==t&&(n=t.slice(0));break;default:n=t}return n}function LA(e,t,r){var n=0;return t<=e&&e<=r?n=e:function(e,t,r){var n;n=r<t?[105,110,100,101,120,32,111,117,116,32,111,102,32,98,111,117,110,100,115,44,32,116,104,101,32,99,111,110,116,97,105,110,101,114,32,105,115,32,101,109,112,116,121]:[105,110,100,101,120,32].concat(BA(e),[32,110,111,116,32,105,110,32],BA(t),[32,46,46,32],BA(r));mA({message:RA(null,n,lA),parent:null,m_type:sA,name:null,trace:[],up:null},"IndexDefect")}(e,t,r),n}function DA(e){var t=[];t=Array(e);for(var r=0;r<e;++r)t[r]=null;return t}function MA(){mA({message:[100,105,118,105,115,105,111,110,32,98,121,32,122,101,114,111],parent:null,m_type:fA,name:null,trace:[],up:null},"DivByZeroDefect")}function NA(){mA({message:[111,118,101,114,45,32,111,114,32,117,110,100,101,114,102,108,111,119],parent:null,m_type:oA,name:null,trace:[],up:null},"OverflowDefect")}function OA(e){(e>2147483647||e<-2147483648)&&NA()}function UA(e,t,r){!function(e,t,r,n,s){var i,o=e[t].length;if(e[t].length<(i=SA(EA(o,s),0,2147483647)))for(var a=e[t].length;a<i;++a)e[t].push(0);else e[t].length=i;var c=0,l=0;for(;l<s;)c=l,e[t][LA(EA(o,c),0,e[t].length-1)]=r.charCodeAt(LA(EA(n,c),0,r.length-1)),l=EA(l,1)}(e,t,r,0,null==r?0:r.length)}function FA(e,t,r){!function(e,t,r){UA(e,t,r+"")}(e,t,r)}function BA(e){var t=[[]];return FA(t,0,e),t[0]}function qA(e,t,r){switch(r.kind){case 0:break;case 1:e[r.offset]=RA(e[r.offset],t[r.offset],r.typ);break;case 2:for(var n=0;n<r.sons.length;n++)qA(e,t,r.sons[n]);break;case 3:e[r.offset]=RA(e[r.offset],t[r.offset],r.typ);for(n=0;n<r.sons.length;++n)qA(e,t,r.sons[n][1])}}function $A(e,t){var r=65535,n=(e&r)>>>0,s=(t&r)>>>0;return(n*s>>>0)+((((e>>>16&r)>>>0)*s>>>0)+(n*((t>>>16&r)>>>0)>>>0)>>>0<<16>>>0)>>>0}function zA(e,t){return(e<<t>>>0|e>>>vA(32,t))>>>0}function jA(e){var t=e.length,r=(a=t,0==(c=4)&&MA(),-1==c&&2147483647==a&&NA(),Math.trunc(a/c)),n=0,s=0;e:for(;s<wA(r,4);){var i=0,o=4;t:for(;0<o;)o=vA(o,1),i=(i<<8>>>0|Number(BigInt.asUintN(32,BigInt(e[LA(EA(s,o),0,e.length-1)]))))>>>0;s=EA(s,4),i=zA(i=$A(i,3432918353),15),n=3864292196+(5*(n=zA(n=(n^(i=$A(i,461845907)))>>>0,13))>>>0)>>>0}var a,c,l=0,u=yA(t,4);e:for(;0<u;)u=vA(u,1),l=(l<<8>>>0|Number(BigInt.asUintN(32,BigInt(e[LA(EA(s,u),0,e.length-1)]))))>>>0;return l=$A(l,3432918353),l=$A(l=zA(l,15),461845907),n=$A(n=((n=((n=(n^l)>>>0)^Number(BigInt.asUintN(32,BigInt(t))))>>>0)^n>>>16)>>>0,2246822507),n=((n=$A(n=(n^n>>>13)>>>0,3266489909))^n>>>16)>>>0,Number(BigInt.asIntN(32,BigInt(n)))}function VA(e){return jA(e.slice(0,e.length-1+1))}function KA(e){mA({message:RA(null,e,lA),m_type:nA,parent:null,name:null,trace:[],up:null},"AssertionDefect")}0!=(IA=0,_A=1,CA=yA(bA(VA(AA=[100,117,109,109,121])),_A),xA=yA(bA(VA(AA.concat([32,98]))),_A),yA(bA(EA(CA,wA(IA,xA))),_A))&&KA([110,105,109,95,104,97,115,104,46,110,105,109,40,50,54,44,32,51,41,32,96,104,97,115,104,78,40,34,100,117,109,109,121,34,44,32,48,44,32,49,41,32,61,61,32,48,96,32]),(e=>{e.Send="send",e.Receive="receive",e.SendEphemeral="sendEphemeral"})(kA||(kA={})),(e=>{e.OutMessageSent="sds:out:message-sent",e.InMessageDelivered="sds:in:message-delivered",e.InMessageReceived="sds:in:message-received",e.OutMessageAcknowledged="sds:out:message-acknowledged",e.OutMessagePossiblyAcknowledged="sds:out:message-possibly-acknowledged",e.InMessageMissing="sds:in:message-missing",e.OutSyncSent="sds:out:sync-sent",e.InSyncReceived="sds:in:sync-received",e.InMessageLost="sds:in:message-irretrievably-lost",e.ErrorTask="sds:error-task"})(TA||(TA={}));var HA,GA,WA={exports:{}};HA||(HA=1,function(e,t){!function(){var r,n="Expected a function",s="__lodash_hash_undefined__",i="__lodash_placeholder__",o=32,a=128,c=256,l=1/0,u=9007199254740991,h=NaN,d=4294967295,p=[["ary",a],["bind",1],["bindKey",2],["curry",8],["curryRight",16],["flip",512],["partial",o],["partialRight",64],["rearg",c]],f="[object Arguments]",g="[object Array]",m="[object Boolean]",y="[object Date]",b="[object Error]",w="[object Function]",v="[object GeneratorFunction]",E="[object Map]",S="[object Number]",A="[object Object]",I="[object Promise]",_="[object RegExp]",C="[object Set]",x="[object String]",k="[object Symbol]",T="[object WeakMap]",P="[object ArrayBuffer]",R="[object DataView]",L="[object Float32Array]",D="[object Float64Array]",M="[object Int8Array]",N="[object Int16Array]",O="[object Int32Array]",U="[object Uint8Array]",F="[object Uint8ClampedArray]",B="[object Uint16Array]",q="[object Uint32Array]",$=/\b__p \+= '';/g,z=/\b(__p \+=) '' \+/g,j=/(__e\(.*?\)|\b__t\)) \+\n'';/g,V=/&(?:amp|lt|gt|quot|#39);/g,K=/[&<>"']/g,H=RegExp(V.source),G=RegExp(K.source),W=/<%-([\s\S]+?)%>/g,X=/<%([\s\S]+?)%>/g,Z=/<%=([\s\S]+?)%>/g,Y=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Q=/^\w*$/,J=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ee=/[\\^$.*+?()[\]{}|]/g,te=RegExp(ee.source),re=/^\s+/,ne=/\s/,se=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,ie=/\{\n\/\* \[wrapped with (.+)\] \*/,oe=/,? & /,ae=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,ce=/[()=,{}\[\]\/\s]/,le=/\\(\\)?/g,ue=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,he=/\w*$/,de=/^[-+]0x[0-9a-f]+$/i,pe=/^0b[01]+$/i,fe=/^\[object .+?Constructor\]$/,ge=/^0o[0-7]+$/i,me=/^(?:0|[1-9]\d*)$/,ye=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,be=/($^)/,we=/['\n\r\u2028\u2029\\]/g,ve="\\ud800-\\udfff",Ee="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff",Se="\\u2700-\\u27bf",Ae="a-z\\xdf-\\xf6\\xf8-\\xff",Ie="A-Z\\xc0-\\xd6\\xd8-\\xde",_e="\\ufe0e\\ufe0f",Ce="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",xe="['â€™]",ke="["+ve+"]",Te="["+Ce+"]",Pe="["+Ee+"]",Re="\\d+",Le="["+Se+"]",De="["+Ae+"]",Me="[^"+ve+Ce+Re+Se+Ae+Ie+"]",Ne="\\ud83c[\\udffb-\\udfff]",Oe="[^"+ve+"]",Ue="(?:\\ud83c[\\udde6-\\uddff]){2}",Fe="[\\ud800-\\udbff][\\udc00-\\udfff]",Be="["+Ie+"]",qe="\\u200d",$e="(?:"+De+"|"+Me+")",ze="(?:"+Be+"|"+Me+")",je="(?:['â€™](?:d|ll|m|re|s|t|ve))?",Ve="(?:['â€™](?:D|LL|M|RE|S|T|VE))?",Ke="(?:"+Pe+"|"+Ne+")?",He="["+_e+"]?",Ge=He+Ke+"(?:"+qe+"(?:"+[Oe,Ue,Fe].join("|")+")"+He+Ke+")*",We="(?:"+[Le,Ue,Fe].join("|")+")"+Ge,Xe="(?:"+[Oe+Pe+"?",Pe,Ue,Fe,ke].join("|")+")",Ze=RegExp(xe,"g"),Ye=RegExp(Pe,"g"),Qe=RegExp(Ne+"(?="+Ne+")|"+Xe+Ge,"g"),Je=RegExp([Be+"?"+De+"+"+je+"(?="+[Te,Be,"$"].join("|")+")",ze+"+"+Ve+"(?="+[Te,Be+$e,"$"].join("|")+")",Be+"?"+$e+"+"+je,Be+"+"+Ve,"\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])|\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",Re,We].join("|"),"g"),et=RegExp("["+qe+ve+Ee+_e+"]"),tt=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,rt=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],nt=-1,st={};st[L]=st[D]=st[M]=st[N]=st[O]=st[U]=st[F]=st[B]=st[q]=!0,st[f]=st[g]=st[P]=st[m]=st[R]=st[y]=st[b]=st[w]=st[E]=st[S]=st[A]=st[_]=st[C]=st[x]=st[T]=!1;var it={};it[f]=it[g]=it[P]=it[R]=it[m]=it[y]=it[L]=it[D]=it[M]=it[N]=it[O]=it[E]=it[S]=it[A]=it[_]=it[C]=it[x]=it[k]=it[U]=it[F]=it[B]=it[q]=!0,it[b]=it[w]=it[T]=!1;var ot={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},at=parseFloat,ct=parseInt,lt="object"==typeof cs&&cs&&cs.Object===Object&&cs,ut="object"==typeof self&&self&&self.Object===Object&&self,ht=lt||ut||Function("return this")(),dt=t&&!t.nodeType&&t,pt=dt&&e&&!e.nodeType&&e,ft=pt&&pt.exports===dt,gt=ft&&lt.process,mt=(()=>{try{var e=pt&&pt.require&&pt.require("util").types;return e||gt&&gt.binding&&gt.binding("util")}catch(e){}})(),yt=mt&&mt.isArrayBuffer,bt=mt&&mt.isDate,wt=mt&&mt.isMap,vt=mt&&mt.isRegExp,Et=mt&&mt.isSet,St=mt&&mt.isTypedArray;function At(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)}function It(e,t,r,n){for(var s=-1,i=null==e?0:e.length;++s<i;){var o=e[s];t(n,o,r(o),e)}return n}function _t(e,t){for(var r=-1,n=null==e?0:e.length;++r<n&&!1!==t(e[r],r,e););return e}function Ct(e,t){for(var r=null==e?0:e.length;r--&&!1!==t(e[r],r,e););return e}function xt(e,t){for(var r=-1,n=null==e?0:e.length;++r<n;)if(!t(e[r],r,e))return!1;return!0}function kt(e,t){for(var r=-1,n=null==e?0:e.length,s=0,i=[];++r<n;){var o=e[r];t(o,r,e)&&(i[s++]=o)}return i}function Tt(e,t){return!(null==e||!e.length)&&Bt(e,t,0)>-1}function Pt(e,t,r){for(var n=-1,s=null==e?0:e.length;++n<s;)if(r(t,e[n]))return!0;return!1}function Rt(e,t){for(var r=-1,n=null==e?0:e.length,s=Array(n);++r<n;)s[r]=t(e[r],r,e);return s}function Lt(e,t){for(var r=-1,n=t.length,s=e.length;++r<n;)e[s+r]=t[r];return e}function Dt(e,t,r,n){var s=-1,i=null==e?0:e.length;for(n&&i&&(r=e[++s]);++s<i;)r=t(r,e[s],s,e);return r}function Mt(e,t,r,n){var s=null==e?0:e.length;for(n&&s&&(r=e[--s]);s--;)r=t(r,e[s],s,e);return r}function Nt(e,t){for(var r=-1,n=null==e?0:e.length;++r<n;)if(t(e[r],r,e))return!0;return!1}var Ot=jt("length");function Ut(e,t,r){var n;return r(e,((e,r,s)=>{if(t(e,r,s))return n=r,!1})),n}function Ft(e,t,r,n){for(var s=e.length,i=r+(n?1:-1);n?i--:++i<s;)if(t(e[i],i,e))return i;return-1}function Bt(e,t,r){return t==t?((e,t,r)=>{for(var n=r-1,s=e.length;++n<s;)if(e[n]===t)return n;return-1})(e,t,r):Ft(e,$t,r)}function qt(e,t,r,n){for(var s=r-1,i=e.length;++s<i;)if(n(e[s],t))return s;return-1}function $t(e){return e!=e}function zt(e,t){var r=null==e?0:e.length;return r?Ht(e,t)/r:h}function jt(e){return t=>null==t?r:t[e]}function Vt(e){return t=>null==e?r:e[t]}function Kt(e,t,r,n,s){return s(e,((e,s,i)=>{r=n?(n=!1,e):t(r,e,s,i)})),r}function Ht(e,t){for(var n,s=-1,i=e.length;++s<i;){var o=t(e[s]);o!==r&&(n=n===r?o:n+o)}return n}function Gt(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}function Wt(e){return e?e.slice(0,hr(e)+1).replace(re,""):e}function Xt(e){return t=>e(t)}function Zt(e,t){return Rt(t,(t=>e[t]))}function Yt(e,t){return e.has(t)}function Qt(e,t){for(var r=-1,n=e.length;++r<n&&Bt(t,e[r],0)>-1;);return r}function Jt(e,t){for(var r=e.length;r--&&Bt(t,e[r],0)>-1;);return r}var er=Vt({Ã€:"A",Ã:"A",Ã‚:"A",Ãƒ:"A",Ã„:"A",Ã…:"A",Ã :"a",Ã¡:"a",Ã¢:"a",Ã£:"a",Ã¤:"a",Ã¥:"a",Ã‡:"C",Ã§:"c",Ã:"D",Ã°:"d",Ãˆ:"E",Ã‰:"E",ÃŠ:"E",Ã‹:"E",Ã¨:"e",Ã©:"e",Ãª:"e",Ã«:"e",ÃŒ:"I",Ã:"I",ÃŽ:"I",Ã:"I",Ã¬:"i",Ã­:"i",Ã®:"i",Ã¯:"i",Ã‘:"N",Ã±:"n",Ã’:"O",Ã“:"O",Ã”:"O",Ã•:"O",Ã–:"O",Ã˜:"O",Ã²:"o",Ã³:"o",Ã´:"o",Ãµ:"o",Ã¶:"o",Ã¸:"o",Ã™:"U",Ãš:"U",Ã›:"U",Ãœ:"U",Ã¹:"u",Ãº:"u",Ã»:"u",Ã¼:"u",Ã:"Y",Ã½:"y",Ã¿:"y",Ã†:"Ae",Ã¦:"ae",Ãž:"Th",Ã¾:"th",ÃŸ:"ss",Ä€:"A",Ä‚:"A",Ä„:"A",Ä:"a",Äƒ:"a",Ä…:"a",Ä†:"C",Äˆ:"C",ÄŠ:"C",ÄŒ:"C",Ä‡:"c",Ä‰:"c",Ä‹:"c",Ä:"c",ÄŽ:"D",Ä:"D",Ä:"d",Ä‘:"d",Ä’:"E",Ä”:"E",Ä–:"E",Ä˜:"E",Äš:"E",Ä“:"e",Ä•:"e",Ä—:"e",Ä™:"e",Ä›:"e",Äœ:"G",Äž:"G",Ä :"G",Ä¢:"G",Ä:"g",ÄŸ:"g",Ä¡:"g",Ä£:"g",Ä¤:"H",Ä¦:"H",Ä¥:"h",Ä§:"h",Ä¨:"I",Äª:"I",Ä¬:"I",Ä®:"I",Ä°:"I",Ä©:"i",Ä«:"i",Ä­:"i",Ä¯:"i",Ä±:"i",Ä´:"J",Äµ:"j",Ä¶:"K",Ä·:"k",Ä¸:"k",Ä¹:"L",Ä»:"L",Ä½:"L",Ä¿:"L",Å:"L",Äº:"l",Ä¼:"l",Ä¾:"l",Å€:"l",Å‚:"l",Åƒ:"N",Å…:"N",Å‡:"N",ÅŠ:"N",Å„:"n",Å†:"n",Åˆ:"n",Å‹:"n",ÅŒ:"O",ÅŽ:"O",Å:"O",Å:"o",Å:"o",Å‘:"o",Å”:"R",Å–:"R",Å˜:"R",Å•:"r",Å—:"r",Å™:"r",Åš:"S",Åœ:"S",Åž:"S",Å :"S",Å›:"s",Å:"s",ÅŸ:"s",Å¡:"s",Å¢:"T",Å¤:"T",Å¦:"T",Å£:"t",Å¥:"t",Å§:"t",Å¨:"U",Åª:"U",Å¬:"U",Å®:"U",Å°:"U",Å²:"U",Å©:"u",Å«:"u",Å­:"u",Å¯:"u",Å±:"u",Å³:"u",Å´:"W",Åµ:"w",Å¶:"Y",Å·:"y",Å¸:"Y",Å¹:"Z",Å»:"Z",Å½:"Z",Åº:"z",Å¼:"z",Å¾:"z",Ä²:"IJ",Ä³:"ij",Å’:"Oe",Å“:"oe",Å‰:"'n",Å¿:"s"}),tr=Vt({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"});function rr(e){return"\\"+ot[e]}function nr(e){return et.test(e)}function sr(e){var t=-1,r=Array(e.size);return e.forEach(((e,n)=>{r[++t]=[n,e]})),r}function ir(e,t){return r=>e(t(r))}function or(e,t){for(var r=-1,n=e.length,s=0,o=[];++r<n;){var a=e[r];a!==t&&a!==i||(e[r]=i,o[s++]=r)}return o}function ar(e){var t=-1,r=Array(e.size);return e.forEach((e=>{r[++t]=e})),r}function cr(e){var t=-1,r=Array(e.size);return e.forEach((e=>{r[++t]=[e,e]})),r}function lr(e){return nr(e)?(e=>{for(var t=Qe.lastIndex=0;Qe.test(e);)++t;return t})(e):Ot(e)}function ur(e){return nr(e)?(e=>e.match(Qe)||[])(e):(e=>e.split(""))(e)}function hr(e){for(var t=e.length;t--&&ne.test(e.charAt(t)););return t}var dr=Vt({"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"}),pr=function e(t){var ne,ve=(t=null==t?ht:pr.defaults(ht.Object(),t,pr.pick(ht,rt))).Array,Ee=t.Date,Se=t.Error,Ae=t.Function,Ie=t.Math,_e=t.Object,Ce=t.RegExp,xe=t.String,ke=t.TypeError,Te=ve.prototype,Pe=Ae.prototype,Re=_e.prototype,Le=t["__core-js_shared__"],De=Pe.toString,Me=Re.hasOwnProperty,Ne=0,Oe=(ne=/[^.]+$/.exec(Le&&Le.keys&&Le.keys.IE_PROTO||""))?"Symbol(src)_1."+ne:"",Ue=Re.toString,Fe=De.call(_e),Be=ht._,qe=Ce("^"+De.call(Me).replace(ee,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),$e=ft?t.Buffer:r,ze=t.Symbol,je=t.Uint8Array,Ve=$e?$e.allocUnsafe:r,Ke=ir(_e.getPrototypeOf,_e),He=_e.create,Ge=Re.propertyIsEnumerable,We=Te.splice,Xe=ze?ze.isConcatSpreadable:r,Qe=ze?ze.iterator:r,et=ze?ze.toStringTag:r,ot=(()=>{try{var e=ui(_e,"defineProperty");return e({},"",{}),e}catch(e){}})(),lt=t.clearTimeout!==ht.clearTimeout&&t.clearTimeout,ut=Ee&&Ee.now!==ht.Date.now&&Ee.now,dt=t.setTimeout!==ht.setTimeout&&t.setTimeout,pt=Ie.ceil,gt=Ie.floor,mt=_e.getOwnPropertySymbols,Ot=$e?$e.isBuffer:r,Vt=t.isFinite,fr=Te.join,gr=ir(_e.keys,_e),mr=Ie.max,yr=Ie.min,br=Ee.now,wr=t.parseInt,vr=Ie.random,Er=Te.reverse,Sr=ui(t,"DataView"),Ar=ui(t,"Map"),Ir=ui(t,"Promise"),_r=ui(t,"Set"),Cr=ui(t,"WeakMap"),xr=ui(_e,"create"),kr=Cr&&new Cr,Tr={},Pr=Oi(Sr),Rr=Oi(Ar),Lr=Oi(Ir),Dr=Oi(_r),Mr=Oi(Cr),Nr=ze?ze.prototype:r,Or=Nr?Nr.valueOf:r,Ur=Nr?Nr.toString:r;function Fr(e){if(ea(e)&&!jo(e)&&!(e instanceof zr)){if(e instanceof $r)return e;if(Me.call(e,"__wrapped__"))return Ui(e)}return new $r(e)}var Br=(()=>{function e(){}return t=>{if(!Jo(t))return{};if(He)return He(t);e.prototype=t;var n=new e;return e.prototype=r,n}})();function qr(){}function $r(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=r}function zr(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=d,this.__views__=[]}function jr(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Vr(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Kr(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Hr(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new Kr;++t<r;)this.add(e[t])}function Gr(e){var t=this.__data__=new Vr(e);this.size=t.size}function Wr(e,t){var r=jo(e),n=!r&&zo(e),s=!r&&!n&&Go(e),i=!r&&!n&&!s&&ca(e),o=r||n||s||i,a=o?Gt(e.length,xe):[],c=a.length;for(var l in e)!t&&!Me.call(e,l)||o&&("length"==l||s&&("offset"==l||"parent"==l)||i&&("buffer"==l||"byteLength"==l||"byteOffset"==l)||yi(l,c))||a.push(l);return a}function Xr(e){var t=e.length;return t?e[Gn(0,t-1)]:r}function Zr(e,t){return Di(ks(e),on(t,0,e.length))}function Yr(e){return Di(ks(e))}function Qr(e,t,n){(n!==r&&!Bo(e[t],n)||n===r&&!(t in e))&&nn(e,t,n)}function Jr(e,t,n){var s=e[t];Me.call(e,t)&&Bo(s,n)&&(n!==r||t in e)||nn(e,t,n)}function en(e,t){for(var r=e.length;r--;)if(Bo(e[r][0],t))return r;return-1}function tn(e,t,r,n){return hn(e,((e,s,i)=>{t(n,e,r(e),i)})),n}function rn(e,t){return e&&Ts(t,Pa(t),e)}function nn(e,t,r){"__proto__"==t&&ot?ot(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}function sn(e,t){for(var n=-1,s=t.length,i=ve(s),o=null==e;++n<s;)i[n]=o?r:_a(e,t[n]);return i}function on(e,t,n){return e==e&&(n!==r&&(e=e<=n?e:n),t!==r&&(e=e>=t?e:t)),e}function an(e,t,n,s,i,o){var a,c=1&t,l=2&t,u=4&t;if(n&&(a=i?n(e,s,i,o):n(e)),a!==r)return a;if(!Jo(e))return e;var h=jo(e);if(h){if(a=(e=>{var t=e.length,r=new e.constructor(t);return t&&"string"==typeof e[0]&&Me.call(e,"index")&&(r.index=e.index,r.input=e.input),r})(e),!c)return ks(e,a)}else{var d=pi(e),p=d==w||d==v;if(Go(e))return Ss(e,c);if(d==A||d==f||p&&!i){if(a=l||p?{}:gi(e),!c)return l?((e,t)=>Ts(e,di(e),t))(e,((e,t)=>e&&Ts(t,Ra(t),e))(a,e)):((e,t)=>Ts(e,hi(e),t))(e,rn(a,e))}else{if(!it[d])return i?e:{};a=((e,t,r)=>{var n=e.constructor;switch(t){case P:return As(e);case m:case y:return new n(+e);case R:return((e,t)=>{var r=t?As(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)})(e,r);case L:case D:case M:case N:case O:case U:case F:case B:case q:return Is(e,r);case E:return new n;case S:case x:return new n(e);case _:return(e=>{var t=new e.constructor(e.source,he.exec(e));return t.lastIndex=e.lastIndex,t})(e);case C:return new n;case k:return(e=>Or?_e(Or.call(e)):{})(e)}})(e,d,c)}}o||(o=new Gr);var g=o.get(e);if(g)return g;o.set(e,a),ia(e)?e.forEach((r=>{a.add(an(r,t,n,r,e,o))})):ta(e)&&e.forEach(((r,s)=>{a.set(s,an(r,t,n,s,e,o))}));var b=h?r:(u?l?ni:ri:l?Ra:Pa)(e);return _t(b||e,((r,s)=>{b&&(r=e[s=r]),Jr(a,s,an(r,t,n,s,e,o))})),a}function cn(e,t,n){var s=n.length;if(null==e)return!s;for(e=_e(e);s--;){var i=n[s],o=t[i],a=e[i];if(a===r&&!(i in e)||!o(a))return!1}return!0}function ln(e,t,s){if("function"!=typeof e)throw new ke(n);return Ti((()=>{e.apply(r,s)}),t)}function un(e,t,r,n){var s=-1,i=Tt,o=!0,a=e.length,c=[],l=t.length;if(!a)return c;r&&(t=Rt(t,Xt(r))),n?(i=Pt,o=!1):t.length>=200&&(i=Yt,o=!1,t=new Hr(t));e:for(;++s<a;){var u=e[s],h=null==r?u:r(u);if(u=n||0!==u?u:0,o&&h==h){for(var d=l;d--;)if(t[d]===h)continue e;c.push(u)}else i(t,h,n)||c.push(u)}return c}Fr.templateSettings={escape:W,evaluate:X,interpolate:Z,variable:"",imports:{_:Fr}},Fr.prototype=qr.prototype,Fr.prototype.constructor=Fr,$r.prototype=Br(qr.prototype),$r.prototype.constructor=$r,zr.prototype=Br(qr.prototype),zr.prototype.constructor=zr,jr.prototype.clear=function(){this.__data__=xr?xr(null):{},this.size=0},jr.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},jr.prototype.get=function(e){var t=this.__data__;if(xr){var n=t[e];return n===s?r:n}return Me.call(t,e)?t[e]:r},jr.prototype.has=function(e){var t=this.__data__;return xr?t[e]!==r:Me.call(t,e)},jr.prototype.set=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=xr&&t===r?s:t,this},Vr.prototype.clear=function(){this.__data__=[],this.size=0},Vr.prototype.delete=function(e){var t=this.__data__,r=en(t,e);return!(r<0||(r==t.length-1?t.pop():We.call(t,r,1),--this.size,0))},Vr.prototype.get=function(e){var t=this.__data__,n=en(t,e);return n<0?r:t[n][1]},Vr.prototype.has=function(e){return en(this.__data__,e)>-1},Vr.prototype.set=function(e,t){var r=this.__data__,n=en(r,e);return n<0?(++this.size,r.push([e,t])):r[n][1]=t,this},Kr.prototype.clear=function(){this.size=0,this.__data__={hash:new jr,map:new(Ar||Vr),string:new jr}},Kr.prototype.delete=function(e){var t=ci(this,e).delete(e);return this.size-=t?1:0,t},Kr.prototype.get=function(e){return ci(this,e).get(e)},Kr.prototype.has=function(e){return ci(this,e).has(e)},Kr.prototype.set=function(e,t){var r=ci(this,e),n=r.size;return r.set(e,t),this.size+=r.size==n?0:1,this},Hr.prototype.add=Hr.prototype.push=function(e){return this.__data__.set(e,s),this},Hr.prototype.has=function(e){return this.__data__.has(e)},Gr.prototype.clear=function(){this.__data__=new Vr,this.size=0},Gr.prototype.delete=function(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r},Gr.prototype.get=function(e){return this.__data__.get(e)},Gr.prototype.has=function(e){return this.__data__.has(e)},Gr.prototype.set=function(e,t){var r=this.__data__;if(r instanceof Vr){var n=r.__data__;if(!Ar||n.length<199)return n.push([e,t]),this.size=++r.size,this;r=this.__data__=new Kr(n)}return r.set(e,t),this.size=r.size,this};var hn=Ls(wn),dn=Ls(vn,!0);function pn(e,t){var r=!0;return hn(e,((e,n,s)=>r=!!t(e,n,s))),r}function fn(e,t,n){for(var s=-1,i=e.length;++s<i;){var o=e[s],a=t(o);if(null!=a&&(c===r?a==a&&!aa(a):n(a,c)))var c=a,l=o}return l}function gn(e,t){var r=[];return hn(e,((e,n,s)=>{t(e,n,s)&&r.push(e)})),r}function mn(e,t,r,n,s){var i=-1,o=e.length;for(r||(r=mi),s||(s=[]);++i<o;){var a=e[i];t>0&&r(a)?t>1?mn(a,t-1,r,n,s):Lt(s,a):n||(s[s.length]=a)}return s}var yn=Ds(),bn=Ds(!0);function wn(e,t){return e&&yn(e,t,Pa)}function vn(e,t){return e&&bn(e,t,Pa)}function En(e,t){return kt(t,(t=>Zo(e[t])))}function Sn(e,t){for(var n=0,s=(t=bs(t,e)).length;null!=e&&n<s;)e=e[Ni(t[n++])];return n&&n==s?e:r}function An(e,t,r){var n=t(e);return jo(e)?n:Lt(n,r(e))}function In(e){return null==e?e===r?"[object Undefined]":"[object Null]":et&&et in _e(e)?(e=>{var t=Me.call(e,et),n=e[et];try{e[et]=r;var s=!0}catch(e){}var i=Ue.call(e);return s&&(t?e[et]=n:delete e[et]),i})(e):(e=>Ue.call(e))(e)}function _n(e,t){return e>t}function Cn(e,t){return null!=e&&Me.call(e,t)}function xn(e,t){return null!=e&&t in _e(e)}function kn(e,t,n){for(var s=n?Pt:Tt,i=e[0].length,o=e.length,a=o,c=ve(o),l=1/0,u=[];a--;){var h=e[a];a&&t&&(h=Rt(h,Xt(t))),l=yr(h.length,l),c[a]=!n&&(t||i>=120&&h.length>=120)?new Hr(a&&h):r}h=e[0];var d=-1,p=c[0];e:for(;++d<i&&u.length<l;){var f=h[d],g=t?t(f):f;if(f=n||0!==f?f:0,!(p?Yt(p,g):s(u,g,n))){for(a=o;--a;){var m=c[a];if(!(m?Yt(m,g):s(e[a],g,n)))continue e}p&&p.push(g),u.push(f)}}return u}function Tn(e,t,n){var s=null==(e=Ci(e,t=bs(t,e)))?e:e[Ni(Wi(t))];return null==s?r:At(s,e,n)}function Pn(e){return ea(e)&&In(e)==f}function Rn(e,t,n,s,i){return e===t||(null==e||null==t||!ea(e)&&!ea(t)?e!=e&&t!=t:((e,t,n,s,i,o)=>{var a=jo(e),c=jo(t),l=a?g:pi(e),u=c?g:pi(t),h=(l=l==f?A:l)==A,d=(u=u==f?A:u)==A,p=l==u;if(p&&Go(e)){if(!Go(t))return!1;a=!0,h=!1}if(p&&!h)return o||(o=new Gr),a||ca(e)?ei(e,t,n,s,i,o):((e,t,r,n,s,i,o)=>{switch(r){case R:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case P:return!(e.byteLength!=t.byteLength||!i(new je(e),new je(t)));case m:case y:case S:return Bo(+e,+t);case b:return e.name==t.name&&e.message==t.message;case _:case x:return e==t+"";case E:var a=sr;case C:var c=1&n;if(a||(a=ar),e.size!=t.size&&!c)return!1;var l=o.get(e);if(l)return l==t;n|=2,o.set(e,t);var u=ei(a(e),a(t),n,s,i,o);return o.delete(e),u;case k:if(Or)return Or.call(e)==Or.call(t)}return!1})(e,t,l,n,s,i,o);if(!(1&n)){var w=h&&Me.call(e,"__wrapped__"),v=d&&Me.call(t,"__wrapped__");if(w||v){var I=w?e.value():e,T=v?t.value():t;return o||(o=new Gr),i(I,T,n,s,o)}}return!!p&&(o||(o=new Gr),((e,t,n,s,i,o)=>{var a=1&n,c=ri(e),l=c.length,u=ri(t),h=u.length;if(l!=h&&!a)return!1;for(var d=l;d--;){var p=c[d];if(!(a?p in t:Me.call(t,p)))return!1}var f=o.get(e),g=o.get(t);if(f&&g)return f==t&&g==e;var m=!0;o.set(e,t),o.set(t,e);for(var y=a;++d<l;){var b=e[p=c[d]],w=t[p];if(s)var v=a?s(w,b,p,t,e,o):s(b,w,p,e,t,o);if(!(v===r?b===w||i(b,w,n,s,o):v)){m=!1;break}y||(y="constructor"==p)}if(m&&!y){var E=e.constructor,S=t.constructor;E==S||!("constructor"in e)||!("constructor"in t)||"function"==typeof E&&E instanceof E&&"function"==typeof S&&S instanceof S||(m=!1)}return o.delete(e),o.delete(t),m})(e,t,n,s,i,o))})(e,t,n,s,Rn,i))}function Ln(e,t,n,s){var i=n.length,o=i,a=!s;if(null==e)return!o;for(e=_e(e);i--;){var c=n[i];if(a&&c[2]?c[1]!==e[c[0]]:!(c[0]in e))return!1}for(;++i<o;){var l=(c=n[i])[0],u=e[l],h=c[1];if(a&&c[2]){if(u===r&&!(l in e))return!1}else{var d=new Gr;if(s)var p=s(u,h,l,e,t,d);if(!(p===r?Rn(h,u,3,s,d):p))return!1}}return!0}function Dn(e){return!(!Jo(e)||(e=>!!Oe&&Oe in e)(e))&&(Zo(e)?qe:fe).test(Oi(e))}function Mn(e){return"function"==typeof e?e:null==e?rc:"object"==typeof e?jo(e)?qn(e[0],e[1]):Bn(e):hc(e)}function Nn(e){if(!Si(e))return gr(e);var t=[];for(var r in _e(e))Me.call(e,r)&&"constructor"!=r&&t.push(r);return t}function On(e){if(!Jo(e))return(e=>{var t=[];if(null!=e)for(var r in _e(e))t.push(r);return t})(e);var t=Si(e),r=[];for(var n in e)("constructor"!=n||!t&&Me.call(e,n))&&r.push(n);return r}function Un(e,t){return e<t}function Fn(e,t){var r=-1,n=Ko(e)?ve(e.length):[];return hn(e,((e,s,i)=>{n[++r]=t(e,s,i)})),n}function Bn(e){var t=li(e);return 1==t.length&&t[0][2]?Ii(t[0][0],t[0][1]):r=>r===e||Ln(r,e,t)}function qn(e,t){return wi(e)&&Ai(t)?Ii(Ni(e),t):n=>{var s=_a(n,e);return s===r&&s===t?Ca(n,e):Rn(t,s,3)}}function $n(e,t,n,s,i){e!==t&&yn(t,((o,a)=>{if(i||(i=new Gr),Jo(o))((e,t,n,s,i,o,a)=>{var c=xi(e,n),l=xi(t,n),u=a.get(l);if(u)Qr(e,n,u);else{var h=o?o(c,l,n+"",e,t,a):r,d=h===r;if(d){var p=jo(l),f=!p&&Go(l),g=!p&&!f&&ca(l);h=l,p||f||g?jo(c)?h=c:Ho(c)?h=ks(c):f?(d=!1,h=Ss(l,!0)):g?(d=!1,h=Is(l,!0)):h=[]:na(l)||zo(l)?(h=c,zo(c)?h=ma(c):Jo(c)&&!Zo(c)||(h=gi(l))):d=!1}d&&(a.set(l,h),i(h,l,s,o,a),a.delete(l)),Qr(e,n,h)}})(e,t,a,n,$n,s,i);else{var c=s?s(xi(e,a),o,a+"",e,t,i):r;c===r&&(c=o),Qr(e,a,c)}}),Ra)}function zn(e,t){var n=e.length;if(n)return yi(t+=t<0?n:0,n)?e[t]:r}function jn(e,t,r){t=t.length?Rt(t,(e=>jo(e)?t=>Sn(t,1===e.length?e[0]:e):e)):[rc];var n=-1;t=Rt(t,Xt(ai()));var s=Fn(e,(e=>{var r=Rt(t,(t=>t(e)));return{criteria:r,index:++n,value:e}}));return((e,t)=>{var r=e.length;for(e.sort(t);r--;)e[r]=e[r].value;return e})(s,((e,t)=>((e,t,r)=>{for(var n=-1,s=e.criteria,i=t.criteria,o=s.length,a=r.length;++n<o;){var c=_s(s[n],i[n]);if(c)return n>=a?c:c*("desc"==r[n]?-1:1)}return e.index-t.index})(e,t,r)))}function Vn(e,t,r){for(var n=-1,s=t.length,i={};++n<s;){var o=t[n],a=Sn(e,o);r(a,o)&&Qn(i,bs(o,e),a)}return i}function Kn(e,t,r,n){var s=n?qt:Bt,i=-1,o=t.length,a=e;for(e===t&&(t=ks(t)),r&&(a=Rt(e,Xt(r)));++i<o;)for(var c=0,l=t[i],u=r?r(l):l;(c=s(a,u,c,n))>-1;)a!==e&&We.call(a,c,1),We.call(e,c,1);return e}function Hn(e,t){for(var r=e?t.length:0,n=r-1;r--;){var s=t[r];if(r==n||s!==i){var i=s;yi(s)?We.call(e,s,1):us(e,s)}}return e}function Gn(e,t){return e+gt(vr()*(t-e+1))}function Wn(e,t){var r="";if(!e||t<1||t>u)return r;do{t%2&&(r+=e),(t=gt(t/2))&&(e+=e)}while(t);return r}function Xn(e,t){return Pi(_i(e,t,rc),e+"")}function Zn(e){return Xr(Ba(e))}function Yn(e,t){var r=Ba(e);return Di(r,on(t,0,r.length))}function Qn(e,t,n,s){if(!Jo(e))return e;for(var i=-1,o=(t=bs(t,e)).length,a=o-1,c=e;null!=c&&++i<o;){var l=Ni(t[i]),u=n;if("__proto__"===l||"constructor"===l||"prototype"===l)return e;if(i!=a){var h=c[l];(u=s?s(h,l,c):r)===r&&(u=Jo(h)?h:yi(t[i+1])?[]:{})}Jr(c,l,u),c=c[l]}return e}var Jn=kr?(e,t)=>(kr.set(e,t),e):rc,es=ot?(e,t)=>ot(e,"toString",{configurable:!0,enumerable:!1,value:Ja(t),writable:!0}):rc;function ts(e){return Di(Ba(e))}function rs(e,t,r){var n=-1,s=e.length;t<0&&(t=-t>s?0:s+t),(r=r>s?s:r)<0&&(r+=s),s=t>r?0:r-t>>>0,t>>>=0;for(var i=ve(s);++n<s;)i[n]=e[n+t];return i}function ns(e,t){var r;return hn(e,((e,n,s)=>!(r=t(e,n,s)))),!!r}function ss(e,t,r){var n=0,s=null==e?n:e.length;if("number"==typeof t&&t==t&&s<=2147483647){for(;n<s;){var i=n+s>>>1,o=e[i];null!==o&&!aa(o)&&(r?o<=t:o<t)?n=i+1:s=i}return s}return is(e,t,rc,r)}function is(e,t,n,s){var i=0,o=null==e?0:e.length;if(0===o)return 0;for(var a=(t=n(t))!=t,c=null===t,l=aa(t),u=t===r;i<o;){var h=gt((i+o)/2),d=n(e[h]),p=d!==r,f=null===d,g=d==d,m=aa(d);if(a)var y=s||g;else y=u?g&&(s||p):c?g&&p&&(s||!f):l?g&&p&&!f&&(s||!m):!f&&!m&&(s?d<=t:d<t);y?i=h+1:o=h}return yr(o,4294967294)}function os(e,t){for(var r=-1,n=e.length,s=0,i=[];++r<n;){var o=e[r],a=t?t(o):o;if(!r||!Bo(a,c)){var c=a;i[s++]=0===o?0:o}}return i}function as(e){return"number"==typeof e?e:aa(e)?h:+e}function cs(e){if("string"==typeof e)return e;if(jo(e))return Rt(e,cs)+"";if(aa(e))return Ur?Ur.call(e):"";var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function ls(e,t,r){var n=-1,s=Tt,i=e.length,o=!0,a=[],c=a;if(r)o=!1,s=Pt;else if(i>=200){var l=t?null:Ws(e);if(l)return ar(l);o=!1,s=Yt,c=new Hr}else c=t?[]:a;e:for(;++n<i;){var u=e[n],h=t?t(u):u;if(u=r||0!==u?u:0,o&&h==h){for(var d=c.length;d--;)if(c[d]===h)continue e;t&&c.push(h),a.push(u)}else s(c,h,r)||(c!==a&&c.push(h),a.push(u))}return a}function us(e,t){return null==(e=Ci(e,t=bs(t,e)))||delete e[Ni(Wi(t))]}function hs(e,t,r,n){return Qn(e,t,r(Sn(e,t)),n)}function ds(e,t,r,n){for(var s=e.length,i=n?s:-1;(n?i--:++i<s)&&t(e[i],i,e););return r?rs(e,n?0:i,n?i+1:s):rs(e,n?i+1:0,n?s:i)}function ps(e,t){var r=e;return r instanceof zr&&(r=r.value()),Dt(t,((e,t)=>t.func.apply(t.thisArg,Lt([e],t.args))),r)}function fs(e,t,r){var n=e.length;if(n<2)return n?ls(e[0]):[];for(var s=-1,i=ve(n);++s<n;)for(var o=e[s],a=-1;++a<n;)a!=s&&(i[s]=un(i[s]||o,e[a],t,r));return ls(mn(i,1),t,r)}function gs(e,t,n){for(var s=-1,i=e.length,o=t.length,a={};++s<i;){var c=s<o?t[s]:r;n(a,e[s],c)}return a}function ms(e){return Ho(e)?e:[]}function ys(e){return"function"==typeof e?e:rc}function bs(e,t){return jo(e)?e:wi(e,t)?[e]:Mi(ya(e))}var ws=Xn;function vs(e,t,n){var s=e.length;return n=n===r?s:n,!t&&n>=s?e:rs(e,t,n)}var Es=lt||(e=>ht.clearTimeout(e));function Ss(e,t){if(t)return e.slice();var r=e.length,n=Ve?Ve(r):new e.constructor(r);return e.copy(n),n}function As(e){var t=new e.constructor(e.byteLength);return new je(t).set(new je(e)),t}function Is(e,t){var r=t?As(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}function _s(e,t){if(e!==t){var n=e!==r,s=null===e,i=e==e,o=aa(e),a=t!==r,c=null===t,l=t==t,u=aa(t);if(!c&&!u&&!o&&e>t||o&&a&&l&&!c&&!u||s&&a&&l||!n&&l||!i)return 1;if(!s&&!o&&!u&&e<t||u&&n&&i&&!s&&!o||c&&n&&i||!a&&i||!l)return-1}return 0}function Cs(e,t,r,n){for(var s=-1,i=e.length,o=r.length,a=-1,c=t.length,l=mr(i-o,0),u=ve(c+l),h=!n;++a<c;)u[a]=t[a];for(;++s<o;)(h||s<i)&&(u[r[s]]=e[s]);for(;l--;)u[a++]=e[s++];return u}function xs(e,t,r,n){for(var s=-1,i=e.length,o=-1,a=r.length,c=-1,l=t.length,u=mr(i-a,0),h=ve(u+l),d=!n;++s<u;)h[s]=e[s];for(var p=s;++c<l;)h[p+c]=t[c];for(;++o<a;)(d||s<i)&&(h[p+r[o]]=e[s++]);return h}function ks(e,t){var r=-1,n=e.length;for(t||(t=ve(n));++r<n;)t[r]=e[r];return t}function Ts(e,t,n,s){var i=!n;n||(n={});for(var o=-1,a=t.length;++o<a;){var c=t[o],l=s?s(n[c],e[c],c,n,e):r;l===r&&(l=e[c]),i?nn(n,c,l):Jr(n,c,l)}return n}function Ps(e,t){return(r,n)=>{var s=jo(r)?It:tn,i=t?t():{};return s(r,e,ai(n,2),i)}}function Rs(e){return Xn(((t,n)=>{var s=-1,i=n.length,o=i>1?n[i-1]:r,a=i>2?n[2]:r;for(o=e.length>3&&"function"==typeof o?(i--,o):r,a&&bi(n[0],n[1],a)&&(o=i<3?r:o,i=1),t=_e(t);++s<i;){var c=n[s];c&&e(t,c,s,o)}return t}))}function Ls(e,t){return(r,n)=>{if(null==r)return r;if(!Ko(r))return e(r,n);for(var s=r.length,i=t?s:-1,o=_e(r);(t?i--:++i<s)&&!1!==n(o[i],i,o););return r}}function Ds(e){return(t,r,n)=>{for(var s=-1,i=_e(t),o=n(t),a=o.length;a--;){var c=o[e?a:++s];if(!1===r(i[c],c,i))break}return t}}function Ms(e){return t=>{var n=nr(t=ya(t))?ur(t):r,s=n?n[0]:t.charAt(0),i=n?vs(n,1).join(""):t.slice(1);return s[e]()+i}}function Ns(e){return t=>Dt(Za(za(t).replace(Ze,"")),e,"")}function Os(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var r=Br(e.prototype),n=e.apply(r,t);return Jo(n)?n:r}}function Us(e){return(t,n,s)=>{var i=_e(t);if(!Ko(t)){var o=ai(n,3);t=Pa(t),n=e=>o(i[e],e,i)}var a=e(t,n,s);return a>-1?i[o?t[a]:a]:r}}function Fs(e){return ti((function(t){var s=t.length,i=s,o=$r.prototype.thru;for(e&&t.reverse();i--;){var a=t[i];if("function"!=typeof a)throw new ke(n);if(o&&!c&&"wrapper"==ii(a))var c=new $r([],!0)}for(i=c?i:s;++i<s;){var l=ii(a=t[i]),u="wrapper"==l?si(a):r;c=u&&vi(u[0])&&424==u[1]&&!u[4].length&&1==u[9]?c[ii(u[0])].apply(c,u[3]):1==a.length&&vi(a)?c[l]():c.thru(a)}return function(){var e=arguments,r=e[0];if(c&&1==e.length&&jo(r))return c.plant(r).value();for(var n=0,i=s?t[n].apply(this,e):r;++n<s;)i=t[n].call(this,i);return i}}))}function Bs(e,t,n,s,i,o,c,l,u,h){var d=t&a,p=1&t,f=2&t,g=24&t,m=512&t,y=f?r:Os(e);return function a(){for(var b=arguments.length,w=ve(b),v=b;v--;)w[v]=arguments[v];if(g)var E=oi(a),S=((e,t)=>{for(var r=e.length,n=0;r--;)e[r]===t&&++n;return n})(w,E);if(s&&(w=Cs(w,s,i,g)),o&&(w=xs(w,o,c,g)),b-=S,g&&b<h){var A=or(w,E);return Hs(e,t,Bs,a.placeholder,n,w,A,l,u,h-b)}var I=p?n:this,_=f?I[e]:e;return b=w.length,l?w=((e,t)=>{for(var n=e.length,s=yr(t.length,n),i=ks(e);s--;){var o=t[s];e[s]=yi(o,n)?i[o]:r}return e})(w,l):m&&b>1&&w.reverse(),d&&u<b&&(w.length=u),this&&this!==ht&&this instanceof a&&(_=y||Os(_)),_.apply(I,w)}}function qs(e,t){return(r,n)=>((e,t,r,n)=>(wn(e,((e,s,i)=>{t(n,r(e),s,i)})),n))(r,e,t(n),{})}function $s(e,t){return(n,s)=>{var i;if(n===r&&s===r)return t;if(n!==r&&(i=n),s!==r){if(i===r)return s;"string"==typeof n||"string"==typeof s?(n=cs(n),s=cs(s)):(n=as(n),s=as(s)),i=e(n,s)}return i}}function zs(e){return ti((function(t){return t=Rt(t,Xt(ai())),Xn((function(r){var n=this;return e(t,(e=>At(e,n,r)))}))}))}function js(e,t){var n=(t=t===r?" ":cs(t)).length;if(n<2)return n?Wn(t,e):t;var s=Wn(t,pt(e/lr(t)));return nr(t)?vs(ur(s),0,e).join(""):s.slice(0,e)}function Vs(e){return(t,n,s)=>(s&&"number"!=typeof s&&bi(t,n,s)&&(n=s=r),t=da(t),n===r?(n=t,t=0):n=da(n),((e,t,r,n)=>{for(var s=-1,i=mr(pt((t-e)/(r||1)),0),o=ve(i);i--;)o[n?i:++s]=e,e+=r;return o})(t,n,s=s===r?t<n?1:-1:da(s),e))}function Ks(e){return(t,r)=>("string"==typeof t&&"string"==typeof r||(t=ga(t),r=ga(r)),e(t,r))}function Hs(e,t,n,s,i,a,c,l,u,h){var d=8&t;t|=d?o:64,4&(t&=~(d?64:o))||(t&=-4);var p=[e,t,i,d?a:r,d?c:r,d?r:a,d?r:c,l,u,h],f=n.apply(r,p);return vi(e)&&ki(f,p),f.placeholder=s,Ri(f,e,t)}function Gs(e){var t=Ie[e];return(e,r)=>{if(e=ga(e),(r=null==r?0:yr(pa(r),292))&&Vt(e)){var n=(ya(e)+"e").split("e");return+((n=(ya(t(n[0]+"e"+(+n[1]+r)))+"e").split("e"))[0]+"e"+(+n[1]-r))}return t(e)}}var Ws=_r&&1/ar(new _r([,-0]))[1]==l?e=>new _r(e):ac;function Xs(e){return t=>{var r=pi(t);return r==E?sr(t):r==C?cr(t):((e,t)=>Rt(t,(t=>[t,e[t]])))(t,e(t))}}function Zs(e,t,s,l,u,h,d,p){var f=2&t;if(!f&&"function"!=typeof e)throw new ke(n);var g=l?l.length:0;if(g||(t&=-97,l=u=r),d=d===r?d:mr(pa(d),0),p=p===r?p:pa(p),g-=u?u.length:0,64&t){var m=l,y=u;l=u=r}var b=f?r:si(e),w=[e,t,s,l,u,m,y,h,d,p];if(b&&((e,t)=>{var r=e[1],n=t[1],s=r|n,o=s<131,l=n==a&&8==r||n==a&&r==c&&e[7].length<=t[8]||384==n&&t[7].length<=t[8]&&8==r;if(!o&&!l)return e;1&n&&(e[2]=t[2],s|=1&r?0:4);var u=t[3];if(u){var h=e[3];e[3]=h?Cs(h,u,t[4]):u,e[4]=h?or(e[3],i):t[4]}(u=t[5])&&(h=e[5],e[5]=h?xs(h,u,t[6]):u,e[6]=h?or(e[5],i):t[6]),(u=t[7])&&(e[7]=u),n&a&&(e[8]=null==e[8]?t[8]:yr(e[8],t[8])),null==e[9]&&(e[9]=t[9]),e[0]=t[0],e[1]=s})(w,b),e=w[0],t=w[1],s=w[2],l=w[3],u=w[4],!(p=w[9]=w[9]===r?f?0:e.length:mr(w[9]-g,0))&&24&t&&(t&=-25),t&&1!=t)v=8==t||16==t?function(e,t,n){var s=Os(e);return function i(){for(var o=arguments.length,a=ve(o),c=o,l=oi(i);c--;)a[c]=arguments[c];var u=o<3&&a[0]!==l&&a[o-1]!==l?[]:or(a,l);return(o-=u.length)<n?Hs(e,t,Bs,i.placeholder,r,a,u,r,r,n-o):At(this&&this!==ht&&this instanceof i?s:e,this,a)}}(e,t,p):t!=o&&33!=t||u.length?Bs.apply(r,w):function(e,t,r,n){var s=1&t,i=Os(e);return function t(){for(var o=-1,a=arguments.length,c=-1,l=n.length,u=ve(l+a),h=this&&this!==ht&&this instanceof t?i:e;++c<l;)u[c]=n[c];for(;a--;)u[c++]=arguments[++o];return At(h,s?r:this,u)}}(e,t,s,l);else var v=function(e,t,r){var n=1&t,s=Os(e);return function t(){return(this&&this!==ht&&this instanceof t?s:e).apply(n?r:this,arguments)}}(e,t,s);return Ri((b?Jn:ki)(v,w),e,t)}function Ys(e,t,n,s){return e===r||Bo(e,Re[n])&&!Me.call(s,n)?t:e}function Qs(e,t,n,s,i,o){return Jo(e)&&Jo(t)&&(o.set(t,e),$n(e,t,r,Qs,o),o.delete(t)),e}function Js(e){return na(e)?r:e}function ei(e,t,n,s,i,o){var a=1&n,c=e.length,l=t.length;if(c!=l&&!(a&&l>c))return!1;var u=o.get(e),h=o.get(t);if(u&&h)return u==t&&h==e;var d=-1,p=!0,f=2&n?new Hr:r;for(o.set(e,t),o.set(t,e);++d<c;){var g=e[d],m=t[d];if(s)var y=a?s(m,g,d,t,e,o):s(g,m,d,e,t,o);if(y!==r){if(y)continue;p=!1;break}if(f){if(!Nt(t,((e,t)=>{if(!Yt(f,t)&&(g===e||i(g,e,n,s,o)))return f.push(t)}))){p=!1;break}}else if(g!==m&&!i(g,m,n,s,o)){p=!1;break}}return o.delete(e),o.delete(t),p}function ti(e){return Pi(_i(e,r,ji),e+"")}function ri(e){return An(e,Pa,hi)}function ni(e){return An(e,Ra,di)}var si=kr?e=>kr.get(e):ac;function ii(e){for(var t=e.name+"",r=Tr[t],n=Me.call(Tr,t)?r.length:0;n--;){var s=r[n],i=s.func;if(null==i||i==e)return s.name}return t}function oi(e){return(Me.call(Fr,"placeholder")?Fr:e).placeholder}function ai(){var e=Fr.iteratee||nc;return e=e===nc?Mn:e,arguments.length?e(arguments[0],arguments[1]):e}function ci(e,t){var r,n,s=e.__data__;return("string"==(n=typeof(r=t))||"number"==n||"symbol"==n||"boolean"==n?"__proto__"!==r:null===r)?s["string"==typeof t?"string":"hash"]:s.map}function li(e){for(var t=Pa(e),r=t.length;r--;){var n=t[r],s=e[n];t[r]=[n,s,Ai(s)]}return t}function ui(e,t){var n=((e,t)=>null==e?r:e[t])(e,t);return Dn(n)?n:r}var hi=mt?e=>null==e?[]:(e=_e(e),kt(mt(e),(t=>Ge.call(e,t)))):fc,di=mt?e=>{for(var t=[];e;)Lt(t,hi(e)),e=Ke(e);return t}:fc,pi=In;function fi(e,t,r){for(var n=-1,s=(t=bs(t,e)).length,i=!1;++n<s;){var o=Ni(t[n]);if(!(i=null!=e&&r(e,o)))break;e=e[o]}return i||++n!=s?i:!!(s=null==e?0:e.length)&&Qo(s)&&yi(o,s)&&(jo(e)||zo(e))}function gi(e){return"function"!=typeof e.constructor||Si(e)?{}:Br(Ke(e))}function mi(e){return jo(e)||zo(e)||!!(Xe&&e&&e[Xe])}function yi(e,t){var r=typeof e;return!!(t=null==t?u:t)&&("number"==r||"symbol"!=r&&me.test(e))&&e>-1&&e%1==0&&e<t}function bi(e,t,r){if(!Jo(r))return!1;var n=typeof t;return!!("number"==n?Ko(r)&&yi(t,r.length):"string"==n&&t in r)&&Bo(r[t],e)}function wi(e,t){if(jo(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!aa(e))||Q.test(e)||!Y.test(e)||null!=t&&e in _e(t)}function vi(e){var t=ii(e),r=Fr[t];if("function"!=typeof r||!(t in zr.prototype))return!1;if(e===r)return!0;var n=si(r);return!!n&&e===n[0]}(Sr&&pi(new Sr(new ArrayBuffer(1)))!=R||Ar&&pi(new Ar)!=E||Ir&&pi(Ir.resolve())!=I||_r&&pi(new _r)!=C||Cr&&pi(new Cr)!=T)&&(pi=e=>{var t=In(e),n=t==A?e.constructor:r,s=n?Oi(n):"";if(s)switch(s){case Pr:return R;case Rr:return E;case Lr:return I;case Dr:return C;case Mr:return T}return t});var Ei=Le?Zo:gc;function Si(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Re)}function Ai(e){return e==e&&!Jo(e)}function Ii(e,t){return n=>null!=n&&n[e]===t&&(t!==r||e in _e(n))}function _i(e,t,n){return t=mr(t===r?e.length-1:t,0),function(){for(var r=arguments,s=-1,i=mr(r.length-t,0),o=ve(i);++s<i;)o[s]=r[t+s];s=-1;for(var a=ve(t+1);++s<t;)a[s]=r[s];return a[t]=n(o),At(e,this,a)}}function Ci(e,t){return t.length<2?e:Sn(e,rs(t,0,-1))}function xi(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}var ki=Li(Jn),Ti=dt||((e,t)=>ht.setTimeout(e,t)),Pi=Li(es);function Ri(e,t,r){var n=t+"";return Pi(e,((e,t)=>{var r=t.length;if(!r)return e;var n=r-1;return t[n]=(r>1?"& ":"")+t[n],t=t.join(r>2?", ":" "),e.replace(se,"{\n/* [wrapped with "+t+"] */\n")})(n,((e,t)=>(_t(p,(r=>{var n="_."+r[0];t&r[1]&&!Tt(e,n)&&e.push(n)})),e.sort()))((e=>{var t=e.match(ie);return t?t[1].split(oe):[]})(n),r)))}function Li(e){var t=0,n=0;return function(){var s=br(),i=16-(s-n);if(n=s,i>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(r,arguments)}}function Di(e,t){var n=-1,s=e.length,i=s-1;for(t=t===r?s:t;++n<t;){var o=Gn(n,i),a=e[o];e[o]=e[n],e[n]=a}return e.length=t,e}var Mi=(e=>{var t=Do(e,(e=>(500===r.size&&r.clear(),e))),r=t.cache;return t})((e=>{var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(J,((e,r,n,s)=>{t.push(n?s.replace(le,"$1"):r||e)})),t}));function Ni(e){if("string"==typeof e||aa(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function Oi(e){if(null!=e){try{return De.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function Ui(e){if(e instanceof zr)return e.clone();var t=new $r(e.__wrapped__,e.__chain__);return t.__actions__=ks(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}var Fi=Xn(((e,t)=>Ho(e)?un(e,mn(t,1,Ho,!0)):[])),Bi=Xn(((e,t)=>{var n=Wi(t);return Ho(n)&&(n=r),Ho(e)?un(e,mn(t,1,Ho,!0),ai(n,2)):[]})),qi=Xn(((e,t)=>{var n=Wi(t);return Ho(n)&&(n=r),Ho(e)?un(e,mn(t,1,Ho,!0),r,n):[]}));function $i(e,t,r){var n=null==e?0:e.length;if(!n)return-1;var s=null==r?0:pa(r);return s<0&&(s=mr(n+s,0)),Ft(e,ai(t,3),s)}function zi(e,t,n){var s=null==e?0:e.length;if(!s)return-1;var i=s-1;return n!==r&&(i=pa(n),i=n<0?mr(s+i,0):yr(i,s-1)),Ft(e,ai(t,3),i,!0)}function ji(e){return null!=e&&e.length?mn(e,1):[]}function Vi(e){return e&&e.length?e[0]:r}var Ki=Xn((e=>{var t=Rt(e,ms);return t.length&&t[0]===e[0]?kn(t):[]})),Hi=Xn((e=>{var t=Wi(e),n=Rt(e,ms);return t===Wi(n)?t=r:n.pop(),n.length&&n[0]===e[0]?kn(n,ai(t,2)):[]})),Gi=Xn((e=>{var t=Wi(e),n=Rt(e,ms);return(t="function"==typeof t?t:r)&&n.pop(),n.length&&n[0]===e[0]?kn(n,r,t):[]}));function Wi(e){var t=null==e?0:e.length;return t?e[t-1]:r}var Xi=Xn(Zi);function Zi(e,t){return e&&e.length&&t&&t.length?Kn(e,t):e}var Yi=ti(((e,t)=>{var r=null==e?0:e.length,n=sn(e,t);return Hn(e,Rt(t,(e=>yi(e,r)?+e:e)).sort(_s)),n}));function Qi(e){return null==e?e:Er.call(e)}var Ji=Xn((e=>ls(mn(e,1,Ho,!0)))),eo=Xn((e=>{var t=Wi(e);return Ho(t)&&(t=r),ls(mn(e,1,Ho,!0),ai(t,2))})),to=Xn((e=>{var t=Wi(e);return t="function"==typeof t?t:r,ls(mn(e,1,Ho,!0),r,t)}));function ro(e){if(!e||!e.length)return[];var t=0;return e=kt(e,(e=>{if(Ho(e))return t=mr(e.length,t),!0})),Gt(t,(t=>Rt(e,jt(t))))}function no(e,t){if(!e||!e.length)return[];var n=ro(e);return null==t?n:Rt(n,(e=>At(t,r,e)))}var so=Xn(((e,t)=>Ho(e)?un(e,t):[])),io=Xn((e=>fs(kt(e,Ho)))),oo=Xn((e=>{var t=Wi(e);return Ho(t)&&(t=r),fs(kt(e,Ho),ai(t,2))})),ao=Xn((e=>{var t=Wi(e);return t="function"==typeof t?t:r,fs(kt(e,Ho),r,t)})),co=Xn(ro),lo=Xn((e=>{var t=e.length,n=t>1?e[t-1]:r;return n="function"==typeof n?(e.pop(),n):r,no(e,n)}));function uo(e){var t=Fr(e);return t.__chain__=!0,t}function ho(e,t){return t(e)}var po=ti((function(e){var t=e.length,n=t?e[0]:0,s=this.__wrapped__,i=t=>sn(t,e);return!(t>1||this.__actions__.length)&&s instanceof zr&&yi(n)?((s=s.slice(n,+n+(t?1:0))).__actions__.push({func:ho,args:[i],thisArg:r}),new $r(s,this.__chain__).thru((e=>(t&&!e.length&&e.push(r),e)))):this.thru(i)})),fo=Ps(((e,t,r)=>{Me.call(e,r)?++e[r]:nn(e,r,1)})),go=Us($i),mo=Us(zi);function yo(e,t){return(jo(e)?_t:hn)(e,ai(t,3))}function bo(e,t){return(jo(e)?Ct:dn)(e,ai(t,3))}var wo=Ps(((e,t,r)=>{Me.call(e,r)?e[r].push(t):nn(e,r,[t])})),vo=Xn(((e,t,r)=>{var n=-1,s="function"==typeof t,i=Ko(e)?ve(e.length):[];return hn(e,(e=>{i[++n]=s?At(t,e,r):Tn(e,t,r)})),i})),Eo=Ps(((e,t,r)=>{nn(e,r,t)}));function So(e,t){return(jo(e)?Rt:Fn)(e,ai(t,3))}var Ao=Ps(((e,t,r)=>{e[r?0:1].push(t)}),(()=>[[],[]])),Io=Xn(((e,t)=>{if(null==e)return[];var r=t.length;return r>1&&bi(e,t[0],t[1])?t=[]:r>2&&bi(t[0],t[1],t[2])&&(t=[t[0]]),jn(e,mn(t,1),[])})),_o=ut||(()=>ht.Date.now());function Co(e,t,n){return t=n?r:t,t=e&&null==t?e.length:t,Zs(e,a,r,r,r,r,t)}function xo(e,t){var s;if("function"!=typeof t)throw new ke(n);return e=pa(e),function(){return--e>0&&(s=t.apply(this,arguments)),e<=1&&(t=r),s}}var ko=Xn(((e,t,r)=>{var n=1;if(r.length){var s=or(r,oi(ko));n|=o}return Zs(e,n,t,r,s)})),To=Xn(((e,t,r)=>{var n=3;if(r.length){var s=or(r,oi(To));n|=o}return Zs(t,n,e,r,s)}));function Po(e,t,s){var i,o,a,c,l,u,h=0,d=!1,p=!1,f=!0;if("function"!=typeof e)throw new ke(n);function g(t){var n=i,s=o;return i=o=r,h=t,c=e.apply(s,n)}function m(e){var n=e-u;return u===r||n>=t||n<0||p&&e-h>=a}function y(){var e=_o();if(m(e))return b(e);l=Ti(y,(e=>{var r=t-(e-u);return p?yr(r,a-(e-h)):r})(e))}function b(e){return l=r,f&&i?g(e):(i=o=r,c)}function w(){var e=_o(),n=m(e);if(i=arguments,o=this,u=e,n){if(l===r)return(e=>(h=e,l=Ti(y,t),d?g(e):c))(u);if(p)return Es(l),l=Ti(y,t),g(u)}return l===r&&(l=Ti(y,t)),c}return t=ga(t)||0,Jo(s)&&(d=!!s.leading,a=(p="maxWait"in s)?mr(ga(s.maxWait)||0,t):a,f="trailing"in s?!!s.trailing:f),w.cancel=()=>{l!==r&&Es(l),h=0,i=u=o=l=r},w.flush=()=>l===r?c:b(_o()),w}var Ro=Xn(((e,t)=>ln(e,1,t))),Lo=Xn(((e,t,r)=>ln(e,ga(t)||0,r)));function Do(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new ke(n);var r=function(){var n=arguments,s=t?t.apply(this,n):n[0],i=r.cache;if(i.has(s))return i.get(s);var o=e.apply(this,n);return r.cache=i.set(s,o)||i,o};return r.cache=new(Do.Cache||Kr),r}function Mo(e){if("function"!=typeof e)throw new ke(n);return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}Do.Cache=Kr;var No=ws((function(e,t){var r=(t=1==t.length&&jo(t[0])?Rt(t[0],Xt(ai())):Rt(mn(t,1),Xt(ai()))).length;return Xn((function(n){for(var s=-1,i=yr(n.length,r);++s<i;)n[s]=t[s].call(this,n[s]);return At(e,this,n)}))})),Oo=Xn(((e,t)=>{var n=or(t,oi(Oo));return Zs(e,o,r,t,n)})),Uo=Xn(((e,t)=>{var n=or(t,oi(Uo));return Zs(e,64,r,t,n)})),Fo=ti(((e,t)=>Zs(e,c,r,r,r,t)));function Bo(e,t){return e===t||e!=e&&t!=t}var qo=Ks(_n),$o=Ks(((e,t)=>e>=t)),zo=Pn(function(){return arguments}())?Pn:e=>ea(e)&&Me.call(e,"callee")&&!Ge.call(e,"callee"),jo=ve.isArray,Vo=yt?Xt(yt):e=>ea(e)&&In(e)==P;function Ko(e){return null!=e&&Qo(e.length)&&!Zo(e)}function Ho(e){return ea(e)&&Ko(e)}var Go=Ot||gc,Wo=bt?Xt(bt):e=>ea(e)&&In(e)==y;function Xo(e){if(!ea(e))return!1;var t=In(e);return t==b||"[object DOMException]"==t||"string"==typeof e.message&&"string"==typeof e.name&&!na(e)}function Zo(e){if(!Jo(e))return!1;var t=In(e);return t==w||t==v||"[object AsyncFunction]"==t||"[object Proxy]"==t}function Yo(e){return"number"==typeof e&&e==pa(e)}function Qo(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=u}function Jo(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function ea(e){return null!=e&&"object"==typeof e}var ta=wt?Xt(wt):e=>ea(e)&&pi(e)==E;function ra(e){return"number"==typeof e||ea(e)&&In(e)==S}function na(e){if(!ea(e)||In(e)!=A)return!1;var t=Ke(e);if(null===t)return!0;var r=Me.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&De.call(r)==Fe}var sa=vt?Xt(vt):e=>ea(e)&&In(e)==_,ia=Et?Xt(Et):e=>ea(e)&&pi(e)==C;function oa(e){return"string"==typeof e||!jo(e)&&ea(e)&&In(e)==x}function aa(e){return"symbol"==typeof e||ea(e)&&In(e)==k}var ca=St?Xt(St):e=>ea(e)&&Qo(e.length)&&!!st[In(e)],la=Ks(Un),ua=Ks(((e,t)=>e<=t));function ha(e){if(!e)return[];if(Ko(e))return oa(e)?ur(e):ks(e);if(Qe&&e[Qe])return(e=>{for(var t,r=[];!(t=e.next()).done;)r.push(t.value);return r})(e[Qe]());var t=pi(e);return(t==E?sr:t==C?ar:Ba)(e)}function da(e){return e?(e=ga(e))===l||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}function pa(e){var t=da(e),r=t%1;return t==t?r?t-r:t:0}function fa(e){return e?on(pa(e),0,d):0}function ga(e){if("number"==typeof e)return e;if(aa(e))return h;if(Jo(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=Jo(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=Wt(e);var r=pe.test(e);return r||ge.test(e)?ct(e.slice(2),r?2:8):de.test(e)?h:+e}function ma(e){return Ts(e,Ra(e))}function ya(e){return null==e?"":cs(e)}var ba=Rs(((e,t)=>{if(Si(t)||Ko(t))Ts(t,Pa(t),e);else for(var r in t)Me.call(t,r)&&Jr(e,r,t[r])})),wa=Rs(((e,t)=>{Ts(t,Ra(t),e)})),va=Rs(((e,t,r,n)=>{Ts(t,Ra(t),e,n)})),Ea=Rs(((e,t,r,n)=>{Ts(t,Pa(t),e,n)})),Sa=ti(sn),Aa=Xn(((e,t)=>{e=_e(e);var n=-1,s=t.length,i=s>2?t[2]:r;for(i&&bi(t[0],t[1],i)&&(s=1);++n<s;)for(var o=t[n],a=Ra(o),c=-1,l=a.length;++c<l;){var u=a[c],h=e[u];(h===r||Bo(h,Re[u])&&!Me.call(e,u))&&(e[u]=o[u])}return e})),Ia=Xn((e=>(e.push(r,Qs),At(Da,r,e))));function _a(e,t,n){var s=null==e?r:Sn(e,t);return s===r?n:s}function Ca(e,t){return null!=e&&fi(e,t,xn)}var xa=qs(((e,t,r)=>{null!=t&&"function"!=typeof t.toString&&(t=Ue.call(t)),e[t]=r}),Ja(rc)),ka=qs(((e,t,r)=>{null!=t&&"function"!=typeof t.toString&&(t=Ue.call(t)),Me.call(e,t)?e[t].push(r):e[t]=[r]}),ai),Ta=Xn(Tn);function Pa(e){return Ko(e)?Wr(e):Nn(e)}function Ra(e){return Ko(e)?Wr(e,!0):On(e)}var La=Rs(((e,t,r)=>{$n(e,t,r)})),Da=Rs(((e,t,r,n)=>{$n(e,t,r,n)})),Ma=ti(((e,t)=>{var r={};if(null==e)return r;var n=!1;t=Rt(t,(t=>(t=bs(t,e),n||(n=t.length>1),t))),Ts(e,ni(e),r),n&&(r=an(r,7,Js));for(var s=t.length;s--;)us(r,t[s]);return r})),Na=ti(((e,t)=>null==e?{}:((e,t)=>Vn(e,t,((t,r)=>Ca(e,r))))(e,t)));function Oa(e,t){if(null==e)return{};var r=Rt(ni(e),(e=>[e]));return t=ai(t),Vn(e,r,((e,r)=>t(e,r[0])))}var Ua=Xs(Pa),Fa=Xs(Ra);function Ba(e){return null==e?[]:Zt(e,Pa(e))}var qa=Ns(((e,t,r)=>(t=t.toLowerCase(),e+(r?$a(t):t))));function $a(e){return Xa(ya(e).toLowerCase())}function za(e){return(e=ya(e))&&e.replace(ye,er).replace(Ye,"")}var ja=Ns(((e,t,r)=>e+(r?"-":"")+t.toLowerCase())),Va=Ns(((e,t,r)=>e+(r?" ":"")+t.toLowerCase())),Ka=Ms("toLowerCase"),Ha=Ns(((e,t,r)=>e+(r?"_":"")+t.toLowerCase())),Ga=Ns(((e,t,r)=>e+(r?" ":"")+Xa(t))),Wa=Ns(((e,t,r)=>e+(r?" ":"")+t.toUpperCase())),Xa=Ms("toUpperCase");function Za(e,t,n){return e=ya(e),(t=n?r:t)===r?(e=>tt.test(e))(e)?(e=>e.match(Je)||[])(e):(e=>e.match(ae)||[])(e):e.match(t)||[]}var Ya=Xn(((e,t)=>{try{return At(e,r,t)}catch(e){return Xo(e)?e:new Se(e)}})),Qa=ti(((e,t)=>(_t(t,(t=>{t=Ni(t),nn(e,t,ko(e[t],e))})),e)));function Ja(e){return()=>e}var ec=Fs(),tc=Fs(!0);function rc(e){return e}function nc(e){return Mn("function"==typeof e?e:an(e,1))}var sc=Xn(((e,t)=>r=>Tn(r,e,t))),ic=Xn(((e,t)=>r=>Tn(e,r,t)));function oc(e,t,r){var n=Pa(t),s=En(t,n);null!=r||Jo(t)&&(s.length||!n.length)||(r=t,t=e,e=this,s=En(t,Pa(t)));var i=!(Jo(r)&&"chain"in r&&!r.chain),o=Zo(e);return _t(s,(function(r){var n=t[r];e[r]=n,o&&(e.prototype[r]=function(){var t=this.__chain__;if(i||t){var r=e(this.__wrapped__);return(r.__actions__=ks(this.__actions__)).push({func:n,args:arguments,thisArg:e}),r.__chain__=t,r}return n.apply(e,Lt([this.value()],arguments))})})),e}function ac(){}var cc=zs(Rt),lc=zs(xt),uc=zs(Nt);function hc(e){return wi(e)?jt(Ni(e)):(e=>t=>Sn(t,e))(e)}var dc=Vs(),pc=Vs(!0);function fc(){return[]}function gc(){return!1}var mc=$s(((e,t)=>e+t),0),yc=Gs("ceil"),bc=$s(((e,t)=>e/t),1),wc=Gs("floor"),vc=$s(((e,t)=>e*t),1),Ec=Gs("round"),Sc=$s(((e,t)=>e-t),0);return Fr.after=function(e,t){if("function"!=typeof t)throw new ke(n);return e=pa(e),function(){if(--e<1)return t.apply(this,arguments)}},Fr.ary=Co,Fr.assign=ba,Fr.assignIn=wa,Fr.assignInWith=va,Fr.assignWith=Ea,Fr.at=Sa,Fr.before=xo,Fr.bind=ko,Fr.bindAll=Qa,Fr.bindKey=To,Fr.castArray=function(){if(!arguments.length)return[];var e=arguments[0];return jo(e)?e:[e]},Fr.chain=uo,Fr.chunk=(e,t,n)=>{t=(n?bi(e,t,n):t===r)?1:mr(pa(t),0);var s=null==e?0:e.length;if(!s||t<1)return[];for(var i=0,o=0,a=ve(pt(s/t));i<s;)a[o++]=rs(e,i,i+=t);return a},Fr.compact=e=>{for(var t=-1,r=null==e?0:e.length,n=0,s=[];++t<r;){var i=e[t];i&&(s[n++]=i)}return s},Fr.concat=function(){var e=arguments.length;if(!e)return[];for(var t=ve(e-1),r=arguments[0],n=e;n--;)t[n-1]=arguments[n];return Lt(jo(r)?ks(r):[r],mn(t,1))},Fr.cond=function(e){var t=null==e?0:e.length,r=ai();return e=t?Rt(e,(e=>{if("function"!=typeof e[1])throw new ke(n);return[r(e[0]),e[1]]})):[],Xn((function(r){for(var n=-1;++n<t;){var s=e[n];if(At(s[0],this,r))return At(s[1],this,r)}}))},Fr.conforms=e=>(e=>{var t=Pa(e);return r=>cn(r,e,t)})(an(e,1)),Fr.constant=Ja,Fr.countBy=fo,Fr.create=(e,t)=>{var r=Br(e);return null==t?r:rn(r,t)},Fr.curry=function e(t,n,s){var i=Zs(t,8,r,r,r,r,r,n=s?r:n);return i.placeholder=e.placeholder,i},Fr.curryRight=function e(t,n,s){var i=Zs(t,16,r,r,r,r,r,n=s?r:n);return i.placeholder=e.placeholder,i},Fr.debounce=Po,Fr.defaults=Aa,Fr.defaultsDeep=Ia,Fr.defer=Ro,Fr.delay=Lo,Fr.difference=Fi,Fr.differenceBy=Bi,Fr.differenceWith=qi,Fr.drop=(e,t,n)=>{var s=null==e?0:e.length;return s?rs(e,(t=n||t===r?1:pa(t))<0?0:t,s):[]},Fr.dropRight=(e,t,n)=>{var s=null==e?0:e.length;return s?rs(e,0,(t=s-(t=n||t===r?1:pa(t)))<0?0:t):[]},Fr.dropRightWhile=(e,t)=>e&&e.length?ds(e,ai(t,3),!0,!0):[],Fr.dropWhile=(e,t)=>e&&e.length?ds(e,ai(t,3),!0):[],Fr.fill=(e,t,n,s)=>{var i=null==e?0:e.length;return i?(n&&"number"!=typeof n&&bi(e,t,n)&&(n=0,s=i),((e,t,n,s)=>{var i=e.length;for((n=pa(n))<0&&(n=-n>i?0:i+n),(s=s===r||s>i?i:pa(s))<0&&(s+=i),s=n>s?0:fa(s);n<s;)e[n++]=t;return e})(e,t,n,s)):[]},Fr.filter=(e,t)=>(jo(e)?kt:gn)(e,ai(t,3)),Fr.flatMap=(e,t)=>mn(So(e,t),1),Fr.flatMapDeep=(e,t)=>mn(So(e,t),l),Fr.flatMapDepth=(e,t,n)=>(n=n===r?1:pa(n),mn(So(e,t),n)),Fr.flatten=ji,Fr.flattenDeep=e=>null!=e&&e.length?mn(e,l):[],Fr.flattenDepth=(e,t)=>null!=e&&e.length?mn(e,t=t===r?1:pa(t)):[],Fr.flip=e=>Zs(e,512),Fr.flow=ec,Fr.flowRight=tc,Fr.fromPairs=e=>{for(var t=-1,r=null==e?0:e.length,n={};++t<r;){var s=e[t];n[s[0]]=s[1]}return n},Fr.functions=e=>null==e?[]:En(e,Pa(e)),Fr.functionsIn=e=>null==e?[]:En(e,Ra(e)),Fr.groupBy=wo,Fr.initial=e=>null!=e&&e.length?rs(e,0,-1):[],Fr.intersection=Ki,Fr.intersectionBy=Hi,Fr.intersectionWith=Gi,Fr.invert=xa,Fr.invertBy=ka,Fr.invokeMap=vo,Fr.iteratee=nc,Fr.keyBy=Eo,Fr.keys=Pa,Fr.keysIn=Ra,Fr.map=So,Fr.mapKeys=(e,t)=>{var r={};return t=ai(t,3),wn(e,((e,n,s)=>{nn(r,t(e,n,s),e)})),r},Fr.mapValues=(e,t)=>{var r={};return t=ai(t,3),wn(e,((e,n,s)=>{nn(r,n,t(e,n,s))})),r},Fr.matches=e=>Bn(an(e,1)),Fr.matchesProperty=(e,t)=>qn(e,an(t,1)),Fr.memoize=Do,Fr.merge=La,Fr.mergeWith=Da,Fr.method=sc,Fr.methodOf=ic,Fr.mixin=oc,Fr.negate=Mo,Fr.nthArg=e=>(e=pa(e),Xn((t=>zn(t,e)))),Fr.omit=Ma,Fr.omitBy=(e,t)=>Oa(e,Mo(ai(t))),Fr.once=e=>xo(2,e),Fr.orderBy=(e,t,n,s)=>null==e?[]:(jo(t)||(t=null==t?[]:[t]),jo(n=s?r:n)||(n=null==n?[]:[n]),jn(e,t,n)),Fr.over=cc,Fr.overArgs=No,Fr.overEvery=lc,Fr.overSome=uc,Fr.partial=Oo,Fr.partialRight=Uo,Fr.partition=Ao,Fr.pick=Na,Fr.pickBy=Oa,Fr.property=hc,Fr.propertyOf=e=>t=>null==e?r:Sn(e,t),Fr.pull=Xi,Fr.pullAll=Zi,Fr.pullAllBy=(e,t,r)=>e&&e.length&&t&&t.length?Kn(e,t,ai(r,2)):e,Fr.pullAllWith=(e,t,n)=>e&&e.length&&t&&t.length?Kn(e,t,r,n):e,Fr.pullAt=Yi,Fr.range=dc,Fr.rangeRight=pc,Fr.rearg=Fo,Fr.reject=(e,t)=>(jo(e)?kt:gn)(e,Mo(ai(t,3))),Fr.remove=(e,t)=>{var r=[];if(!e||!e.length)return r;var n=-1,s=[],i=e.length;for(t=ai(t,3);++n<i;){var o=e[n];t(o,n,e)&&(r.push(o),s.push(n))}return Hn(e,s),r},Fr.rest=(e,t)=>{if("function"!=typeof e)throw new ke(n);return Xn(e,t=t===r?t:pa(t))},Fr.reverse=Qi,Fr.sampleSize=(e,t,n)=>(t=(n?bi(e,t,n):t===r)?1:pa(t),(jo(e)?Zr:Yn)(e,t)),Fr.set=(e,t,r)=>null==e?e:Qn(e,t,r),Fr.setWith=(e,t,n,s)=>(s="function"==typeof s?s:r,null==e?e:Qn(e,t,n,s)),Fr.shuffle=e=>(jo(e)?Yr:ts)(e),Fr.slice=(e,t,n)=>{var s=null==e?0:e.length;return s?(n&&"number"!=typeof n&&bi(e,t,n)?(t=0,n=s):(t=null==t?0:pa(t),n=n===r?s:pa(n)),rs(e,t,n)):[]},Fr.sortBy=Io,Fr.sortedUniq=e=>e&&e.length?os(e):[],Fr.sortedUniqBy=(e,t)=>e&&e.length?os(e,ai(t,2)):[],Fr.split=(e,t,n)=>(n&&"number"!=typeof n&&bi(e,t,n)&&(t=n=r),(n=n===r?d:n>>>0)?(e=ya(e))&&("string"==typeof t||null!=t&&!sa(t))&&!(t=cs(t))&&nr(e)?vs(ur(e),0,n):e.split(t,n):[]),Fr.spread=function(e,t){if("function"!=typeof e)throw new ke(n);return t=null==t?0:mr(pa(t),0),Xn((function(r){var n=r[t],s=vs(r,0,t);return n&&Lt(s,n),At(e,this,s)}))},Fr.tail=e=>{var t=null==e?0:e.length;return t?rs(e,1,t):[]},Fr.take=(e,t,n)=>e&&e.length?rs(e,0,(t=n||t===r?1:pa(t))<0?0:t):[],Fr.takeRight=(e,t,n)=>{var s=null==e?0:e.length;return s?rs(e,(t=s-(t=n||t===r?1:pa(t)))<0?0:t,s):[]},Fr.takeRightWhile=(e,t)=>e&&e.length?ds(e,ai(t,3),!1,!0):[],Fr.takeWhile=(e,t)=>e&&e.length?ds(e,ai(t,3)):[],Fr.tap=(e,t)=>(t(e),e),Fr.throttle=(e,t,r)=>{var s=!0,i=!0;if("function"!=typeof e)throw new ke(n);return Jo(r)&&(s="leading"in r?!!r.leading:s,i="trailing"in r?!!r.trailing:i),Po(e,t,{leading:s,maxWait:t,trailing:i})},Fr.thru=ho,Fr.toArray=ha,Fr.toPairs=Ua,Fr.toPairsIn=Fa,Fr.toPath=e=>jo(e)?Rt(e,Ni):aa(e)?[e]:ks(Mi(ya(e))),Fr.toPlainObject=ma,Fr.transform=(e,t,r)=>{var n=jo(e),s=n||Go(e)||ca(e);if(t=ai(t,4),null==r){var i=e&&e.constructor;r=s?n?new i:[]:Jo(e)&&Zo(i)?Br(Ke(e)):{}}return(s?_t:wn)(e,((e,n,s)=>t(r,e,n,s))),r},Fr.unary=e=>Co(e,1),Fr.union=Ji,Fr.unionBy=eo,Fr.unionWith=to,Fr.uniq=e=>e&&e.length?ls(e):[],Fr.uniqBy=(e,t)=>e&&e.length?ls(e,ai(t,2)):[],Fr.uniqWith=(e,t)=>(t="function"==typeof t?t:r,e&&e.length?ls(e,r,t):[]),Fr.unset=(e,t)=>null==e||us(e,t),Fr.unzip=ro,Fr.unzipWith=no,Fr.update=(e,t,r)=>null==e?e:hs(e,t,ys(r)),Fr.updateWith=(e,t,n,s)=>(s="function"==typeof s?s:r,null==e?e:hs(e,t,ys(n),s)),Fr.values=Ba,Fr.valuesIn=e=>null==e?[]:Zt(e,Ra(e)),Fr.without=so,Fr.words=Za,Fr.wrap=(e,t)=>Oo(ys(t),e),Fr.xor=io,Fr.xorBy=oo,Fr.xorWith=ao,Fr.zip=co,Fr.zipObject=(e,t)=>gs(e||[],t||[],Jr),Fr.zipObjectDeep=(e,t)=>gs(e||[],t||[],Qn),Fr.zipWith=lo,Fr.entries=Ua,Fr.entriesIn=Fa,Fr.extend=wa,Fr.extendWith=va,oc(Fr,Fr),Fr.add=mc,Fr.attempt=Ya,Fr.camelCase=qa,Fr.capitalize=$a,Fr.ceil=yc,Fr.clamp=(e,t,n)=>(n===r&&(n=t,t=r),n!==r&&(n=(n=ga(n))==n?n:0),t!==r&&(t=(t=ga(t))==t?t:0),on(ga(e),t,n)),Fr.clone=e=>an(e,4),Fr.cloneDeep=e=>an(e,5),Fr.cloneDeepWith=(e,t)=>an(e,5,t="function"==typeof t?t:r),Fr.cloneWith=(e,t)=>an(e,4,t="function"==typeof t?t:r),Fr.conformsTo=(e,t)=>null==t||cn(e,t,Pa(t)),Fr.deburr=za,Fr.defaultTo=(e,t)=>null==e||e!=e?t:e,Fr.divide=bc,Fr.endsWith=(e,t,n)=>{e=ya(e),t=cs(t);var s=e.length,i=n=n===r?s:on(pa(n),0,s);return(n-=t.length)>=0&&e.slice(n,i)==t},Fr.eq=Bo,Fr.escape=e=>(e=ya(e))&&G.test(e)?e.replace(K,tr):e,Fr.escapeRegExp=e=>(e=ya(e))&&te.test(e)?e.replace(ee,"\\$&"):e,Fr.every=(e,t,n)=>{var s=jo(e)?xt:pn;return n&&bi(e,t,n)&&(t=r),s(e,ai(t,3))},Fr.find=go,Fr.findIndex=$i,Fr.findKey=(e,t)=>Ut(e,ai(t,3),wn),Fr.findLast=mo,Fr.findLastIndex=zi,Fr.findLastKey=(e,t)=>Ut(e,ai(t,3),vn),Fr.floor=wc,Fr.forEach=yo,Fr.forEachRight=bo,Fr.forIn=(e,t)=>null==e?e:yn(e,ai(t,3),Ra),Fr.forInRight=(e,t)=>null==e?e:bn(e,ai(t,3),Ra),Fr.forOwn=(e,t)=>e&&wn(e,ai(t,3)),Fr.forOwnRight=(e,t)=>e&&vn(e,ai(t,3)),Fr.get=_a,Fr.gt=qo,Fr.gte=$o,Fr.has=(e,t)=>null!=e&&fi(e,t,Cn),Fr.hasIn=Ca,Fr.head=Vi,Fr.identity=rc,Fr.includes=(e,t,r,n)=>{e=Ko(e)?e:Ba(e),r=r&&!n?pa(r):0;var s=e.length;return r<0&&(r=mr(s+r,0)),oa(e)?r<=s&&e.indexOf(t,r)>-1:!!s&&Bt(e,t,r)>-1},Fr.indexOf=(e,t,r)=>{var n=null==e?0:e.length;if(!n)return-1;var s=null==r?0:pa(r);return s<0&&(s=mr(n+s,0)),Bt(e,t,s)},Fr.inRange=(e,t,n)=>(t=da(t),n===r?(n=t,t=0):n=da(n),((e,t,r)=>e>=yr(t,r)&&e<mr(t,r))(e=ga(e),t,n)),Fr.invoke=Ta,Fr.isArguments=zo,Fr.isArray=jo,Fr.isArrayBuffer=Vo,Fr.isArrayLike=Ko,Fr.isArrayLikeObject=Ho,Fr.isBoolean=e=>!0===e||!1===e||ea(e)&&In(e)==m,Fr.isBuffer=Go,Fr.isDate=Wo,Fr.isElement=e=>ea(e)&&1===e.nodeType&&!na(e),Fr.isEmpty=e=>{if(null==e)return!0;if(Ko(e)&&(jo(e)||"string"==typeof e||"function"==typeof e.splice||Go(e)||ca(e)||zo(e)))return!e.length;var t=pi(e);if(t==E||t==C)return!e.size;if(Si(e))return!Nn(e).length;for(var r in e)if(Me.call(e,r))return!1;return!0},Fr.isEqual=(e,t)=>Rn(e,t),Fr.isEqualWith=(e,t,n)=>{var s=(n="function"==typeof n?n:r)?n(e,t):r;return s===r?Rn(e,t,r,n):!!s},Fr.isError=Xo,Fr.isFinite=e=>"number"==typeof e&&Vt(e),Fr.isFunction=Zo,Fr.isInteger=Yo,Fr.isLength=Qo,Fr.isMap=ta,Fr.isMatch=(e,t)=>e===t||Ln(e,t,li(t)),Fr.isMatchWith=(e,t,n)=>(n="function"==typeof n?n:r,Ln(e,t,li(t),n)),Fr.isNaN=e=>ra(e)&&e!=+e,Fr.isNative=e=>{if(Ei(e))throw new Se("Unsupported core-js use. Try https://npms.io/search?q=ponyfill.");return Dn(e)},Fr.isNil=e=>null==e,Fr.isNull=e=>null===e,Fr.isNumber=ra,Fr.isObject=Jo,Fr.isObjectLike=ea,Fr.isPlainObject=na,Fr.isRegExp=sa,Fr.isSafeInteger=e=>Yo(e)&&e>=-9007199254740991&&e<=u,Fr.isSet=ia,Fr.isString=oa,Fr.isSymbol=aa,Fr.isTypedArray=ca,Fr.isUndefined=e=>e===r,Fr.isWeakMap=e=>ea(e)&&pi(e)==T,Fr.isWeakSet=e=>ea(e)&&"[object WeakSet]"==In(e),Fr.join=(e,t)=>null==e?"":fr.call(e,t),Fr.kebabCase=ja,Fr.last=Wi,Fr.lastIndexOf=(e,t,n)=>{var s=null==e?0:e.length;if(!s)return-1;var i=s;return n!==r&&(i=(i=pa(n))<0?mr(s+i,0):yr(i,s-1)),t==t?((e,t,r)=>{for(var n=r+1;n--;)if(e[n]===t)return n;return n})(e,t,i):Ft(e,$t,i,!0)},Fr.lowerCase=Va,Fr.lowerFirst=Ka,Fr.lt=la,Fr.lte=ua,Fr.max=e=>e&&e.length?fn(e,rc,_n):r,Fr.maxBy=(e,t)=>e&&e.length?fn(e,ai(t,2),_n):r,Fr.mean=e=>zt(e,rc),Fr.meanBy=(e,t)=>zt(e,ai(t,2)),Fr.min=e=>e&&e.length?fn(e,rc,Un):r,Fr.minBy=(e,t)=>e&&e.length?fn(e,ai(t,2),Un):r,Fr.stubArray=fc,Fr.stubFalse=gc,Fr.stubObject=()=>({}),Fr.stubString=()=>"",Fr.stubTrue=()=>!0,Fr.multiply=vc,Fr.nth=(e,t)=>e&&e.length?zn(e,pa(t)):r,Fr.noConflict=function(){return ht._===this&&(ht._=Be),this},Fr.noop=ac,Fr.now=_o,Fr.pad=(e,t,r)=>{e=ya(e);var n=(t=pa(t))?lr(e):0;if(!t||n>=t)return e;var s=(t-n)/2;return js(gt(s),r)+e+js(pt(s),r)},Fr.padEnd=(e,t,r)=>{e=ya(e);var n=(t=pa(t))?lr(e):0;return t&&n<t?e+js(t-n,r):e},Fr.padStart=(e,t,r)=>{e=ya(e);var n=(t=pa(t))?lr(e):0;return t&&n<t?js(t-n,r)+e:e},Fr.parseInt=(e,t,r)=>(r||null==t?t=0:t&&(t=+t),wr(ya(e).replace(re,""),t||0)),Fr.random=(e,t,n)=>{if(n&&"boolean"!=typeof n&&bi(e,t,n)&&(t=n=r),n===r&&("boolean"==typeof t?(n=t,t=r):"boolean"==typeof e&&(n=e,e=r)),e===r&&t===r?(e=0,t=1):(e=da(e),t===r?(t=e,e=0):t=da(t)),e>t){var s=e;e=t,t=s}if(n||e%1||t%1){var i=vr();return yr(e+i*(t-e+at("1e-"+((i+"").length-1))),t)}return Gn(e,t)},Fr.reduce=function(e,t,r){var n=jo(e)?Dt:Kt,s=arguments.length<3;return n(e,ai(t,4),r,s,hn)},Fr.reduceRight=function(e,t,r){var n=jo(e)?Mt:Kt,s=arguments.length<3;return n(e,ai(t,4),r,s,dn)},Fr.repeat=(e,t,n)=>(t=(n?bi(e,t,n):t===r)?1:pa(t),Wn(ya(e),t)),Fr.replace=function(){var e=arguments,t=ya(e[0]);return e.length<3?t:t.replace(e[1],e[2])},Fr.result=(e,t,n)=>{var s=-1,i=(t=bs(t,e)).length;for(i||(i=1,e=r);++s<i;){var o=null==e?r:e[Ni(t[s])];o===r&&(s=i,o=n),e=Zo(o)?o.call(e):o}return e},Fr.round=Ec,Fr.runInContext=e,Fr.sample=e=>(jo(e)?Xr:Zn)(e),Fr.size=e=>{if(null==e)return 0;if(Ko(e))return oa(e)?lr(e):e.length;var t=pi(e);return t==E||t==C?e.size:Nn(e).length},Fr.snakeCase=Ha,Fr.some=(e,t,n)=>{var s=jo(e)?Nt:ns;return n&&bi(e,t,n)&&(t=r),s(e,ai(t,3))},Fr.sortedIndex=(e,t)=>ss(e,t),Fr.sortedIndexBy=(e,t,r)=>is(e,t,ai(r,2)),Fr.sortedIndexOf=(e,t)=>{var r=null==e?0:e.length;if(r){var n=ss(e,t);if(n<r&&Bo(e[n],t))return n}return-1},Fr.sortedLastIndex=(e,t)=>ss(e,t,!0),Fr.sortedLastIndexBy=(e,t,r)=>is(e,t,ai(r,2),!0),Fr.sortedLastIndexOf=(e,t)=>{if(null!=e&&e.length){var r=ss(e,t,!0)-1;if(Bo(e[r],t))return r}return-1},Fr.startCase=Ga,Fr.startsWith=(e,t,r)=>(e=ya(e),r=null==r?0:on(pa(r),0,e.length),t=cs(t),e.slice(r,r+t.length)==t),Fr.subtract=Sc,Fr.sum=e=>e&&e.length?Ht(e,rc):0,Fr.sumBy=(e,t)=>e&&e.length?Ht(e,ai(t,2)):0,Fr.template=(e,t,n)=>{var s=Fr.templateSettings;n&&bi(e,t,n)&&(t=r),e=ya(e),t=va({},t,s,Ys);var i,o,a=va({},t.imports,s.imports,Ys),c=Pa(a),l=Zt(a,c),u=0,h=t.interpolate||be,d="__p += '",p=Ce((t.escape||be).source+"|"+h.source+"|"+(h===Z?ue:be).source+"|"+(t.evaluate||be).source+"|$","g"),f="//# sourceURL="+(Me.call(t,"sourceURL")?(t.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++nt+"]")+"\n";e.replace(p,((t,r,n,s,a,c)=>(n||(n=s),d+=e.slice(u,c).replace(we,rr),r&&(i=!0,d+="' +\n__e("+r+") +\n'"),a&&(o=!0,d+="';\n"+a+";\n__p += '"),n&&(d+="' +\n((__t = ("+n+")) == null ? '' : __t) +\n'"),u=c+t.length,t))),d+="';\n";var g=Me.call(t,"variable")&&t.variable;if(g){if(ce.test(g))throw new Se("Invalid `variable` option passed into `_.template`")}else d="with (obj) {\n"+d+"\n}\n";d=(o?d.replace($,""):d).replace(z,"$1").replace(j,"$1;"),d="function("+(g||"obj")+") {\n"+(g?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(i?", __e = _.escape":"")+(o?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+d+"return __p\n}";var m=Ya((()=>Ae(c,f+"return "+d).apply(r,l)));if(m.source=d,Xo(m))throw m;return m},Fr.times=(e,t)=>{if((e=pa(e))<1||e>u)return[];var r=d,n=yr(e,d);t=ai(t),e-=d;for(var s=Gt(n,t);++r<e;)t(r);return s},Fr.toFinite=da,Fr.toInteger=pa,Fr.toLength=fa,Fr.toLower=e=>ya(e).toLowerCase(),Fr.toNumber=ga,Fr.toSafeInteger=e=>e?on(pa(e),-9007199254740991,u):0===e?e:0,Fr.toString=ya,Fr.toUpper=e=>ya(e).toUpperCase(),Fr.trim=(e,t,n)=>{if((e=ya(e))&&(n||t===r))return Wt(e);if(!e||!(t=cs(t)))return e;var s=ur(e),i=ur(t);return vs(s,Qt(s,i),Jt(s,i)+1).join("")},Fr.trimEnd=(e,t,n)=>{if((e=ya(e))&&(n||t===r))return e.slice(0,hr(e)+1);if(!e||!(t=cs(t)))return e;var s=ur(e);return vs(s,0,Jt(s,ur(t))+1).join("")},Fr.trimStart=(e,t,n)=>{if((e=ya(e))&&(n||t===r))return e.replace(re,"");if(!e||!(t=cs(t)))return e;var s=ur(e);return vs(s,Qt(s,ur(t))).join("")},Fr.truncate=(e,t)=>{var n=30,s="...";if(Jo(t)){var i="separator"in t?t.separator:i;n="length"in t?pa(t.length):n,s="omission"in t?cs(t.omission):s}var o=(e=ya(e)).length;if(nr(e)){var a=ur(e);o=a.length}if(n>=o)return e;var c=n-lr(s);if(c<1)return s;var l=a?vs(a,0,c).join(""):e.slice(0,c);if(i===r)return l+s;if(a&&(c+=l.length-c),sa(i)){if(e.slice(c).search(i)){var u,h=l;for(i.global||(i=Ce(i.source,ya(he.exec(i))+"g")),i.lastIndex=0;u=i.exec(h);)var d=u.index;l=l.slice(0,d===r?c:d)}}else if(e.indexOf(cs(i),c)!=c){var p=l.lastIndexOf(i);p>-1&&(l=l.slice(0,p))}return l+s},Fr.unescape=e=>(e=ya(e))&&H.test(e)?e.replace(V,dr):e,Fr.uniqueId=e=>{var t=++Ne;return ya(e)+t},Fr.upperCase=Wa,Fr.upperFirst=Xa,Fr.each=yo,Fr.eachRight=bo,Fr.first=Vi,oc(Fr,(()=>{var e={};return wn(Fr,((t,r)=>{Me.call(Fr.prototype,r)||(e[r]=t)})),e})(),{chain:!1}),Fr.VERSION="4.17.21",_t(["bind","bindKey","curry","curryRight","partial","partialRight"],(e=>{Fr[e].placeholder=Fr})),_t(["drop","take"],(function(e,t){zr.prototype[e]=function(n){n=n===r?1:mr(pa(n),0);var s=this.__filtered__&&!t?new zr(this):this.clone();return s.__filtered__?s.__takeCount__=yr(n,s.__takeCount__):s.__views__.push({size:yr(n,d),type:e+(s.__dir__<0?"Right":"")}),s},zr.prototype[e+"Right"]=function(t){return this.reverse()[e](t).reverse()}})),_t(["filter","map","takeWhile"],(function(e,t){var r=t+1,n=1==r||3==r;zr.prototype[e]=function(e){var t=this.clone();return t.__iteratees__.push({iteratee:ai(e,3),type:r}),t.__filtered__=t.__filtered__||n,t}})),_t(["head","last"],(function(e,t){var r="take"+(t?"Right":"");zr.prototype[e]=function(){return this[r](1).value()[0]}})),_t(["initial","tail"],(function(e,t){var r="drop"+(t?"":"Right");zr.prototype[e]=function(){return this.__filtered__?new zr(this):this[r](1)}})),zr.prototype.compact=function(){return this.filter(rc)},zr.prototype.find=function(e){return this.filter(e).head()},zr.prototype.findLast=function(e){return this.reverse().find(e)},zr.prototype.invokeMap=Xn((function(e,t){return"function"==typeof e?new zr(this):this.map((r=>Tn(r,e,t)))})),zr.prototype.reject=function(e){return this.filter(Mo(ai(e)))},zr.prototype.slice=function(e,t){e=pa(e);var n=this;return n.__filtered__&&(e>0||t<0)?new zr(n):(e<0?n=n.takeRight(-e):e&&(n=n.drop(e)),t!==r&&(n=(t=pa(t))<0?n.dropRight(-t):n.take(t-e)),n)},zr.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},zr.prototype.toArray=function(){return this.take(d)},wn(zr.prototype,(function(e,t){var n=/^(?:filter|find|map|reject)|While$/.test(t),s=/^(?:head|last)$/.test(t),i=Fr[s?"take"+("last"==t?"Right":""):t],o=s||/^find/.test(t);i&&(Fr.prototype[t]=function(){var t=this.__wrapped__,a=s?[1]:arguments,c=t instanceof zr,l=a[0],u=c||jo(t),h=e=>{var t=i.apply(Fr,Lt([e],a));return s&&d?t[0]:t};u&&n&&"function"==typeof l&&1!=l.length&&(c=u=!1);var d=this.__chain__,p=!!this.__actions__.length,f=o&&!d,g=c&&!p;if(!o&&u){t=g?t:new zr(this);var m=e.apply(t,a);return m.__actions__.push({func:ho,args:[h],thisArg:r}),new $r(m,d)}return f&&g?e.apply(this,a):(m=this.thru(h),f?s?m.value()[0]:m.value():m)})})),_t(["pop","push","shift","sort","splice","unshift"],(function(e){var t=Te[e],r=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",n=/^(?:pop|shift)$/.test(e);Fr.prototype[e]=function(){var e=arguments;if(n&&!this.__chain__){var s=this.value();return t.apply(jo(s)?s:[],e)}return this[r]((r=>t.apply(jo(r)?r:[],e)))}})),wn(zr.prototype,((e,t)=>{var r=Fr[t];if(r){var n=r.name+"";Me.call(Tr,n)||(Tr[n]=[]),Tr[n].push({name:t,func:r})}})),Tr[Bs(r,2).name]=[{name:"wrapper",func:r}],zr.prototype.clone=function(){var e=new zr(this.__wrapped__);return e.__actions__=ks(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=ks(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=ks(this.__views__),e},zr.prototype.reverse=function(){if(this.__filtered__){var e=new zr(this);e.__dir__=-1,e.__filtered__=!0}else(e=this.clone()).__dir__*=-1;return e},zr.prototype.value=function(){var e=this.__wrapped__.value(),t=this.__dir__,r=jo(e),n=t<0,s=r?e.length:0,i=((e,t,r)=>{for(var n=-1,s=r.length;++n<s;){var i=r[n],o=i.size;switch(i.type){case"drop":e+=o;break;case"dropRight":t-=o;break;case"take":t=yr(t,e+o);break;case"takeRight":e=mr(e,t-o)}}return{start:e,end:t}})(0,s,this.__views__),o=i.start,a=i.end,c=a-o,l=n?a:o-1,u=this.__iteratees__,h=u.length,d=0,p=yr(c,this.__takeCount__);if(!r||!n&&s==c&&p==c)return ps(e,this.__actions__);var f=[];e:for(;c--&&d<p;){for(var g=-1,m=e[l+=t];++g<h;){var y=u[g],b=y.iteratee,w=y.type,v=b(m);if(2==w)m=v;else if(!v){if(1==w)continue e;break e}}f[d++]=m}return f},Fr.prototype.at=po,Fr.prototype.chain=function(){return uo(this)},Fr.prototype.commit=function(){return new $r(this.value(),this.__chain__)},Fr.prototype.next=function(){this.__values__===r&&(this.__values__=ha(this.value()));var e=this.__index__>=this.__values__.length;return{done:e,value:e?r:this.__values__[this.__index__++]}},Fr.prototype.plant=function(e){for(var t,n=this;n instanceof qr;){var s=Ui(n);s.__index__=0,s.__values__=r,t?i.__wrapped__=s:t=s;var i=s;n=n.__wrapped__}return i.__wrapped__=e,t},Fr.prototype.reverse=function(){var e=this.__wrapped__;if(e instanceof zr){var t=e;return this.__actions__.length&&(t=new zr(this)),(t=t.reverse()).__actions__.push({func:ho,args:[Qi],thisArg:r}),new $r(t,this.__chain__)}return this.thru(Qi)},Fr.prototype.toJSON=Fr.prototype.valueOf=Fr.prototype.value=function(){return ps(this.__wrapped__,this.__actions__)},Fr.prototype.first=Fr.prototype.head,Qe&&(Fr.prototype[Qe]=function(){return this}),Fr}();pt?((pt.exports=pr)._=pr,dt._=pr):ht._=pr}()}(WA,WA.exports)),new vs("sds:message"),new vs("sds:message-channel"),new vs("sdk:query-on-connect"),(e=>{e.MessagesRetrieved="messages:retrieved"})(GA||(GA={})),new vs("sdk:missing-message-retriever"),new vs("sdk:reliable-channel"),Rs.ENCODE_FAILED,Rs.EMPTY_PAYLOAD,Rs.SIZE_TOO_BIG,Rs.RLN_PROOF_GENERATION;const{floor:XA,random:ZA}=Math,YA="Trystero",QA=(e,t)=>Array(e).fill().map(t),JA="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",eI=QA(20,(()=>JA[XA(62*ZA())])).join("");const tI=Promise.all.bind(Promise),rI="undefined"!=typeof window,{entries:nI,fromEntries:sI,keys:iI}=Object,oI=()=>{},aI=e=>Error(`${YA}: ${e}`),cI=new TextEncoder,lI=new TextDecoder,uI=e=>cI.encode(e),hI=e=>lI.decode(e),dI=(...e)=>e.join("@"),pI=JSON.stringify,fI=JSON.parse;let gI=null,mI=null;const yI=()=>{gI||(gI=new Promise((e=>{mI=e})).finally((()=>{mI=null,gI=null})))},bI=()=>mI?.(),wI="AES-GCM",vI={},EI=async e=>vI[e]||=Array.from(await(async(e,t)=>new Uint8Array(await crypto.subtle.digest(e,uI(t))))("SHA-1",e)).map((e=>e.toString(36))).join(""),SI=async(e,t)=>{const r=crypto.getRandomValues(new Uint8Array(16));return r.join(",")+"$"+(n=await crypto.subtle.encrypt({name:wI,iv:r},await e,uI(t)),btoa(String.fromCharCode.apply(null,new Uint8Array(n))));var n},AI=async(e,t)=>{const[r,n]=t.split("$");return hI(await crypto.subtle.decrypt({name:wI,iv:new Uint8Array(r.split(","))},await e,(e=>{const t=atob(e);return new Uint8Array(t.length).map(((e,r)=>t.charCodeAt(r))).buffer})(n)))},II="icegatheringstatechange",_I="offer";var CI=(e,{rtcConfig:t,rtcPolyfill:r,turnConfig:n})=>{const s=new(r||RTCPeerConnection)({iceServers:xI.concat(n||[]),...t}),i={};let o=!1,a=!1,c=null;const l=e=>{e.binaryType="arraybuffer",e.bufferedAmountLowThreshold=65535,e.onmessage=e=>i.data?.(e.data),e.onopen=()=>i.connect?.(),e.onclose=()=>i.close?.(),e.onerror=e=>i.error?.(e)},u=e=>Promise.race([new Promise((t=>{const r=()=>{"complete"===e.iceGatheringState&&(e.removeEventListener(II,r),t())};e.addEventListener(II,r),r()})),new Promise((e=>setTimeout(e,5e3)))]).then((()=>({type:e.localDescription.type,sdp:e.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")})));return e?(c=s.createDataChannel("data"),l(c)):s.ondatachannel=({channel:e})=>{c=e,l(e)},s.onnegotiationneeded=async()=>{try{o=!0,await s.setLocalDescription();const e=await u(s);i.signal?.(e)}catch(e){i.error?.(e)}finally{o=!1}},s.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(s.connectionState)&&i.close?.()},s.ontrack=e=>{i.track?.(e.track,e.streams[0]),i.stream?.(e.streams[0])},s.onremovestream=e=>i.stream?.(e.stream),e&&(s.canTrickleIceCandidates||s.onnegotiationneeded()),{created:Date.now(),connection:s,get channel(){return c},get isDead(){return"closed"===s.connectionState},async signal(t){if("open"!==c?.readyState||t.sdp?.includes("a=rtpmap"))try{if(t.type===_I){if(o||"stable"!==s.signalingState&&!a){if(e)return;await tI([s.setLocalDescription({type:"rollback"}),s.setRemoteDescription(t)])}else await s.setRemoteDescription(t);await s.setLocalDescription();const r=await u(s);return i.signal?.(r),r}if("answer"===t.type){a=!0;try{await s.setRemoteDescription(t)}finally{a=!1}}}catch(e){i.error?.(e)}},sendData(e){return c.send(e)},destroy(){c?.close(),s.close(),o=!1,a=!1},setHandlers(e){return Object.assign(i,e)},offerPromise:e?new Promise((e=>i.signal=t=>{t.type===_I&&e(t)})):Promise.resolve(),addStream(e){return e.getTracks().forEach((t=>s.addTrack(t,e)))},removeStream(e){return s.getSenders().filter((t=>e.getTracks().includes(t.track))).forEach((e=>s.removeTrack(e)))},addTrack(e,t){return s.addTrack(e,t)},removeTrack(e){const t=s.getSenders().find((t=>t.track===e));t&&s.removeTrack(t)},replaceTrack(e,t){const r=s.getSenders().find((t=>t.track===e));if(r)return r.replaceTrack(t)}}};const xI=[...QA(3,((e,t)=>`stun:stun${t||""}.l.google.com:19302`)),"stun:stun.cloudflare.com:3478"].map((e=>({urls:e}))),kI=Object.getPrototypeOf(Uint8Array),TI=16369,PI=255,RI="bufferedamountlow",LI=e=>"@_"+e;var DI=(e,t,r)=>{const n={},s={},i={},o={},a={},c={},l={},u={onPeerJoin:oI,onPeerLeave:oI,onPeerStream:oI,onPeerTrack:oI},h=(e,t)=>(e?Array.isArray(e)?e:[e]:iI(n)).flatMap((e=>{const r=n[e];return r?t(e,r):(console.warn(`${YA}: no peer with id ${e} found`),[])})),d=e=>{n[e]&&(n[e].destroy(),delete n[e],delete o[e],delete a[e],u.onPeerLeave(e),t(e))},p=e=>{if(s[e])return i[e];if(!e)throw aI("action type argument is required");const t=uI(e);if(t.byteLength>12)throw aI(`action type string "${e}" (${t.byteLength}b) exceeds byte limit (12). Hint: choose a shorter name.`);const r=new Uint8Array(12);r.set(t);let o=0;return s[e]={onComplete:oI,onProgress:oI,setOnComplete(t){return s[e]={...s[e],onComplete:t}},setOnProgress(t){return s[e]={...s[e],onProgress:t}},async send(e,t,s,i){if(s&&"object"!=typeof s)throw aI("action meta argument must be an object");const a=typeof e;if("undefined"===a)throw aI("action data cannot be undefined");const c="string"!==a,l=e instanceof Blob,u=l||e instanceof ArrayBuffer||e instanceof kI;if(s&&!u)throw aI("action meta argument can only be used with binary data");const d=u?new Uint8Array(l?await e.arrayBuffer():e):uI(c?pI(e):e),p=s?uI(pI(s)):null,f=Math.ceil(d.byteLength/TI)+(s?1:0)||1,g=QA(f,((e,t)=>{const n=t===f-1,i=s&&0===t,a=new Uint8Array(15+(i?p.byteLength:n?d.byteLength-TI*(f-(s?2:1)):TI));return a.set(r),a.set([o],12),a.set([n|i<<1|u<<2|c<<3],13),a.set([Math.round((t+1)/f*PI)],14),a.set(s?i?p:d.subarray((t-1)*TI,t*TI):d.subarray(t*TI,(t+1)*TI),15),a}));return o=o+1&PI,tI(h(t,(async(e,t)=>{const{channel:r}=t;let o=0;for(;o<f;){const a=g[o];if(r.bufferedAmount>r.bufferedAmountLowThreshold&&await new Promise((e=>{const t=()=>{r.removeEventListener(RI,t),e()};r.addEventListener(RI,t)})),!n[e])break;t.sendData(a),o++,i?.(a[14]/PI,e,s)}})))}},i[e]||=[s[e].send,s[e].setOnComplete,s[e].setOnProgress]},f=async()=>{await _(""),await new Promise((e=>setTimeout(e,99))),nI(n).forEach((([e,t])=>{t.destroy(),delete n[e]})),r()},[g,m]=p(LI("ping")),[y,b]=p(LI("pong")),[w,v]=p(LI("signal")),[E,S]=p(LI("stream")),[A,I]=p(LI("track")),[_,C]=p(LI("leave"));return e(((e,t)=>{n[t]||(n[t]=e,e.setHandlers({data(e){return((e,t)=>{const r=new Uint8Array(t),n=hI(r.subarray(0,12)).replaceAll("\0",""),[i]=r.subarray(12,13),[a]=r.subarray(13,14),[c]=r.subarray(14,15),l=r.subarray(15),u=!!(1&a),h=!!(2&a),d=!!(4&a),p=!!(8&a);if(!s[n])return void console.warn(`${YA}: received message with unregistered type (${n})`);o[e]||={},o[e][n]||={};const f=o[e][n][i]||={chunks:[]};if(h?f.meta=fI(hI(l)):f.chunks.push(l),s[n].onProgress(c/PI,e,f.meta),!u)return;const g=new Uint8Array(f.chunks.reduce(((e,t)=>e+t.byteLength),0));if(f.chunks.reduce(((e,t)=>(g.set(t,e),e+t.byteLength)),0),delete o[e][n][i],d)s[n].onComplete(g,e,f.meta);else{const t=hI(g);s[n].onComplete(p?fI(t):t,e)}})(t,e)},stream(e){u.onPeerStream(e,t,c[t]),delete c[t]},track(e,r){u.onPeerTrack(e,r,t,l[t]),delete l[t]},signal(e){return w(e,t)},close(){return d(t)},error(e){console.error(e),d(t)}}),u.onPeerJoin(t))})),m(((e,t)=>y("",t))),b(((e,t)=>{a[t]?.(),delete a[t]})),v(((e,t)=>n[t]?.signal(e))),S(((e,t)=>c[t]=e)),I(((e,t)=>l[t]=e)),C(((e,t)=>d(t))),rI&&addEventListener("beforeunload",f),{makeAction:p,leave:f,async ping(e){if(!e)throw aI("ping() must be called with target peer ID");const t=Date.now();return g("",e),await new Promise((t=>a[e]=t)),Date.now()-t},getPeers(){return sI(nI(n).map((([e,t])=>[e,t.connection])))},addStream(e,t,r){return h(t,(async(t,n)=>{r&&await E(r,t),n.addStream(e)}))},removeStream(e,t){return h(t,((t,r)=>r.removeStream(e)))},addTrack(e,t,r,n){return h(r,(async(r,s)=>{n&&await A(n,r),s.addTrack(e,t)}))},removeTrack(e,t){return h(t,((t,r)=>r.removeTrack(e)))},replaceTrack(e,t,r,n){return h(r,(async(r,s)=>{n&&await A(n,r),s.replaceTrack(e,t)}))},onPeerJoin(e){return u.onPeerJoin=e},onPeerLeave(e){return u.onPeerLeave=e},onPeerStream(e){return u.onPeerStream=e},onPeerTrack(e){return u.onPeerTrack=e}}};const MI=e=>`/${YA}-${e}/0/msg/json`,NI=(e,t,r)=>e.lightPush.send(e.createEncoder({contentTopic:MI(t),ephemeral:!0}),{payload:uI(r)},{autoRetry:!0}),OI=(({init:e,subscribe:t,announce:r})=>{const n={};let s,i,o,a,c=!1;return(l,u,h)=>{const{appId:d}=l;if(n[d]?.[u])return n[d][u];const p={},f={},g=dI(YA,d,u),m=EI(g),y=EI(dI(g,eI)),b=(async(e,t,r)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},uI(`${e}:${t}:${r}`)),{name:wI},!1,["encrypt","decrypt"]))(l.password||"",d,u),w=e=>async t=>({type:t.type,sdp:await e(b,t.sdp)}),v=w(AI),E=w(SI),S=()=>CI(!0,l),A=(e,t,r)=>{f[t]?f[t]!==e&&e.destroy():(f[t]=e,R(e,t),p[t]?.forEach(((e,t)=>{t!==r&&e.destroy()})),delete p[t])},I=(e,t)=>{f[t]===e&&delete f[t]},_=e=>(i.push(...QA(e,S)),tI(i.splice(0,e).map((e=>e.offerPromise.then(E).then((t=>({peer:e,offer:t}))))))),C=(e,t)=>h?.({error:`incorrect password (${l.password}) when decrypting ${t}`,appId:d,peerId:e,roomId:u}),x=e=>async(t,r,n)=>{const[s,i]=await tI([m,y]);if(t!==s&&t!==i)return;const{peerId:o,offer:a,answer:c,peer:u}="string"==typeof r?fI(r):r;if(o!==eI&&!f[o])if(!o||a||c){if(a){const t=p[o]?.[e];if(t&&eI>o)return;const r=CI(!1,l);let s;r.setHandlers({connect(){return A(r,o,e)},close(){return I(r,o)}});try{s=await v(a)}catch{return void C(o,"offer")}if(r.isDead)return;const[i,c]=await tI([EI(dI(g,o)),r.signal(s)]);n(i,pI({peerId:eI,answer:await E(c)}))}else if(c){let t;try{t=await v(c)}catch(e){return void C(o,"answer")}if(u)u.setHandlers({connect(){return A(u,o,e)},close(){return I(u,o)}}),u.signal(t);else{const r=p[o]?.[e];r&&!r.isDead&&r.signal(t)}}}else{if(p[o]?.[e])return;const[[{peer:t,offer:r}],s]=await tI([_(1),EI(dI(g,o))]);p[o]||=[],p[o][e]=t,setTimeout((()=>((e,t)=>{if(f[e])return;const r=p[e]?.[t];r&&(delete p[e][t],r.destroy())})(o,e)),.9*k[e]),t.setHandlers({connect(){return A(t,o,e)},close(){return I(t,o)}}),n(s,pI({peerId:eI,offer:r}))}};if(!l)throw aI("requires a config map as the first argument");if(!d&&!l.firebaseApp)throw aI("config map is missing appId field");if(!u)throw aI("roomId argument required");if(!c){const t=e(l);i=QA(20,S),s=Array.isArray(t)?t:[t],c=!0,o=setInterval((()=>i=i.filter((e=>{const t=Date.now()-e.created<57333;return t||e.destroy(),t}))),59052.99),a=l.manualRelayReconnection?oI:(()=>{if(rI){const e=new AbortController;return addEventListener("online",bI,{signal:e.signal}),addEventListener("offline",yI,{signal:e.signal}),()=>e.abort()}return oI})()}const k=s.map((()=>5333)),T=[],P=s.map((async(e,r)=>t(await e,await m,await y,x(r),_)));tI([m,y]).then((([e,t])=>{const n=async(s,i)=>{const o=await r(s,e,t);"number"==typeof o&&(k[i]=o),T[i]=setTimeout((()=>n(s,i)),k[i])};P.forEach((async(e,t)=>{await e,n(await s[t],t)}))}));let R=oI;return n[d]||={},n[d][u]=DI((e=>R=e),(e=>delete f[e]),(()=>{delete n[d][u],T.forEach(clearTimeout),P.forEach((async e=>(await e)())),clearInterval(o),a(),c=!1}))}})({init(){return async function(e={}){const t=await tA(e),r=new $u(e,t,{store:!0,lightpush:!0,filter:!0});return!1!==e?.autoStart&&await r.start(),r}({defaultBootstrap:!0,discovery:{dns:!0,peerExchange:!0,peerCache:!0}}).then((async e=>(await e.start(),await e.waitForPeers(),e)))},async subscribe(e,t,r,n){const s=await tI([t,r].map((t=>{const r=e.createDecoder({contentTopic:MI(t)});return e.filter.subscribe(r,(t=>r=>{r.payload&&n(t,hI(r.payload),((t,r)=>NI(e,t,r)))})(t)),()=>e.filter.unsubscribe(r)})));return()=>s.forEach((e=>e()))},announce(e,t){return NI(e,t,pI({peerId:eI}))}});export{OI as joinRoom,eI as selfId};